# 币安U本位永续合约K线服务器

这是一个使用Rust实现的高性能K线数据服务器，专门用于管理和提供币安U本位永续合约的K线数据。该工具仅使用`https://fapi.binance.com`作为唯一的API端点，采用SQLite的WAL模式提供接近内存数据库的性能。

## 特点

- 使用Rust语言实现，性能高效
- 支持并发下载多个交易对的K线数据
- 仅使用币安的fapi端点，简化访问逻辑
- 支持多种K线周期（1分钟、5分钟、30分钟、4小时、1天、1周）
- 自动处理API限制和错误重试
- 采用SQLite的WAL模式，提供接近内存数据库的性能
  - 高性能：读写速度接近内存数据库
  - 数据持久化：所有数据安全存储在磁盘上
  - 内存占用低：不会因数据增长而导致OOM
- 详细的日志记录和进度报告
- 启动时自动检查数据库和历史K线数据，必要时自动下载
- 下载完成后自动统计主要币种K线数量并验证是否正确
- 为Windows系统设计的高性能应用

## 安装

确保您已安装Rust和Cargo。然后，您可以通过以下方式构建项目：

```bash
cargo build --release
```

编译后的可执行文件将位于`target/release/kline_server`。

## 使用方法

程序提供了启动批处理文件：

```batch
# 启动程序
.\start_app.bat
```

程序会自动使用SQLite的WAL模式，提供高性能的数据库操作。

## 启动流程

程序启动后会执行以下检查流程：

1. 检查数据库文件是否存在
   - 如果数据库不存在，直接执行历史K线下载

2. 如果数据库存在，检查BTC 1分钟K线数量是否大于4000根
   - 如果K线数量不足，执行历史K线下载
   - 如果满足条件，程序继续执行后续流程

程序使用SQLite的WAL模式，提供高性能的数据库操作，同时确保数据的持久性和可靠性。

## 下载参数

历史K线下载时使用的参数：

- **K线周期**: 1分钟、5分钟、30分钟、4小时、1天、1周
- **并发数量**: 15
- **存储方式**: SQLite数据库
- **交易对**: 所有U本位永续合约
- **API端点**: 自动切换机制
- **K线数量**:
  - 1分钟K线：5000根
  - 5分钟K线：5000根
  - 30分钟K线：3000根
  - 4小时K线：3000根
  - 1天K线：2000根
  - 1周K线：1000根

## 数据格式

下载的数据将保存到SQLite数据库中，每个交易对和周期组合有自己的表（例如：btc_1m、eth_5m）。每个表包含以下字段：

- `open_time`: K线开盘时间（毫秒时间戳）
- `open`: 开盘价
- `high`: 最高价
- `low`: 最低价
- `close`: 收盘价
- `volume`: 成交量
- `close_time`: K线收盘时间（毫秒时间戳）
- `quote_asset_volume`: 报价资产成交量
- `number_of_trades`: 成交笔数
- `taker_buy_base_asset_volume`: 主动买入基础资产成交量
- `taker_buy_quote_asset_volume`: 主动买入报价资产成交量

## API访问说明

该工具仅使用币安的`fapi.binance.com`端点：

1. 直接访问`https://fapi.binance.com`端点
2. 使用标准HTTP请求获取交易所信息和K线数据
3. 简化了代码逻辑，提高了程序的可维护性

这种方式简化了程序的访问逻辑，使得代码更加清晰和易于维护。

## SQLite WAL模式

本项目采用SQLite的WAL（Write-Ahead Logging）模式，这是一种高性能的数据库运行模式。WAL模式具有以下主要特点：

- **接近内存数据库的性能**：WAL模式下的SQLite性能可以达到内存数据库的70%-100%
- **消除了写入阻塞读取**：写入和读取可以并发进行，显著提高并发性能
- **顺序写入代替随机写入**：顺序写入比随机写入快10-100倍
- **数据持久化**：所有数据变更都安全地存储在磁盘上
- **内存占用可控**：不会因为数据增长而导致内存溢出（OOM）

在本项目中，WAL模式特别适用于以下场景：

1. **高性能服务器应用**：当项目作为服务器应用运行时，WAL模式提供接近内存数据库的性能
2. **内存受限的环境**：在内存有限（4GB）但数据量大的环境中，WAL模式是理想的选择
3. **高频数据查询**：对于需要频繁查询历史K线数据的场景，WAL模式提供高效的读取性能

要了解更多关于SQLite WAL模式的详细信息，请参阅[SQLite WAL模式详解](docs/sqlite_wal_mode.md)文档。

## 注意事项

- 该工具使用币安的公共API，请注意API使用限制
- 下载大量数据可能需要较长时间
- 数据存储在SQLite数据库中，位于`./data/klines.db`
- 采用WAL模式提供高性能的数据库操作，同时确保数据安全

## 流程图

详细的启动流程可以在`docs/startup_flow.md`文件中查看。
