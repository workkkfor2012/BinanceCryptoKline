# 币安U本位永续合约K线服务架构

本文档描述了币安U本位永续合约K线服务的架构设计，包括模块结构、数据流和组件交互。

## 模块结构

项目分为三个主要模块：

1. **klcommon**: 共享的数据模型、工具和数据库操作
2. **kldata**: 负责数据获取、处理和存储
3. **klserver**: 负责Web服务和API

### klcommon 模块

`klcommon` 模块包含所有共享的数据模型、工具和数据库操作，是其他模块的基础。

主要组件：
- `models.rs`: 共享数据模型（如 `Kline`、`Symbol` 等）
- `db.rs`: 数据库操作（如表创建、数据读写）
- `error.rs`: 错误类型和结果类型

### kldata 模块

`kldata` 模块负责数据获取、处理和存储，包括历史数据下载、实时数据更新和K线合成。

主要组件：
- `downloader`: 历史K线数据下载
  - `config.rs`: 下载配置
  - `api.rs`: API客户端
  - `mod.rs`: 下载器实现
- `streamer`: WebSocket实时数据
  - `config.rs`: WebSocket配置
  - `connection.rs`: 连接管理
  - `message.rs`: 消息处理
  - `mod.rs`: 客户端实现
- `aggregator`: K线合成
  - `processor.rs`: 合成处理器
  - `mod.rs`: 合成器实现

### klserver 模块

`klserver` 模块负责Web服务和API，提供K线数据的Web界面和API接口。

主要组件：
- `web`: Web服务
  - `server.rs`: 服务器实现
  - `handlers.rs`: 请求处理器
  - `mod.rs`: 模块导出

## 数据流

系统的数据流如下：

1. **历史数据下载**:
   - `kldata/downloader` 从币安API下载历史K线数据
   - 数据通过 `klcommon/db` 保存到SQLite数据库

2. **实时数据更新**:
   - `kldata/streamer` 通过WebSocket接收实时K线更新
   - 实时数据通过 `klcommon/db` 保存到SQLite数据库
   - 1分钟K线数据传递给 `kldata/aggregator` 进行合成

3. **K线合成**:
   - `kldata/aggregator` 接收1分钟K线数据
   - 合成5分钟、30分钟、4小时、1天、1周K线
   - 合成结果通过 `klcommon/db` 保存到SQLite数据库

4. **Web服务**:
   - `klserver/web` 从SQLite数据库读取K线数据
   - 提供Web界面和API接口

## 组件交互

组件间的交互如下：

```
+----------------+      +----------------+      +----------------+
|                |      |                |      |                |
|   klcommon     |<-----|    kldata     |<-----|   klserver    |
|                |      |                |      |                |
+----------------+      +----------------+      +----------------+
        ^                      ^                       ^
        |                      |                       |
        v                      v                       v
+---------------------------------------------------------------+
|                                                               |
|                      SQLite Database                          |
|                                                               |
+---------------------------------------------------------------+
```

- `klcommon` 提供共享的数据模型、工具和数据库操作
- `kldata` 使用 `klcommon` 中的组件，负责数据获取、处理和存储
- `klserver` 使用 `klcommon` 中的组件，负责Web服务和API
- 所有模块通过SQLite数据库交互，实现完全解耦

## 可执行文件

项目包含两个可执行文件：

1. **kline_data_service**: 
   - 使用 `kldata` 模块
   - 下载历史K线数据
   - 实时更新K线数据
   - 合成其他周期的K线

2. **kline_server**:
   - 使用 `klserver` 模块
   - 提供Web界面和API接口
   - 从数据库读取K线数据

## 三级实时性架构

系统采用三级实时性架构：

1. **第一级（毫秒级）**: WebSocket实时数据
   - 通过WebSocket接收实时K线更新
   - 毫秒级延迟，直接反映市场变化

2. **第二级（秒级）**: K线合成
   - 每秒合成一次其他周期的K线
   - 秒级延迟，提供多周期视角

3. **第三级（分钟级）**: 数据持久化
   - 将数据保存到SQLite数据库
   - 分钟级持久化，确保数据安全

这种架构确保了系统既能提供高实时性的数据，又能确保数据的持久性和可靠性。

## 总结

币安U本位永续合约K线服务采用模块化设计，通过SQLite数据库实现模块间的完全解耦。系统包含三个主要模块：`klcommon`、`kldata` 和 `klserver`，分别负责共享组件、数据处理和Web服务。

系统采用三级实时性架构，确保了数据的实时性、多周期视角和持久性。通过这种设计，系统既能提供高性能的实时数据，又能确保数据的可靠性和可维护性。
