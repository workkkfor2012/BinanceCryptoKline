# 高频数据合成K线优化方案 (简化版)

## 1. 方案概述

本方案通过“按品种分发，独立处理”提高并发，利用内存存储满足实时性，并通过批量写入降低持久化存储压力，实现高性能高频数据K线合成。

## 2. 核心组成部分

*   **数据接收与分发层**: 从 WebSocket 接收 AggTrade 数据，解析并按交易对分发。
*   **品种处理单元**: 每个品种一个独立单元，内部使用 `KlineBuilder` 合成 K 线。**其内部的 K 线构建器集合是私有的，不与其他品种处理单元共享。**
*   **内存数据存储层**: 存储正在形成的 K 线最新状态和最近完成但未同步的 K 线，供实时访问和批量写入。
*   **SQLite 持久化存储**: 长期存储已完成 K 线，通过批量写入更新。
*   **同步任务**: 定期将内存中完成的 K 线批量同步到 SQLite。

## 3. 数据流程

1.  AggTrade 数据接收 -> 分发到品种处理单元。
2.  品种处理单元合成 K 线，更新内存存储层。
3.  内存存储层供实时访问。
4.  K线完成，保留在内存层。
5.  同步任务批量读取内存中完成 K 线。
6.  同步任务批量写入 SQLite，并从内存移除。

## 4. 关键考虑

*   **并发控制与锁的减少**: **“按品种分发，独立处理”消除了保护所有品种 K 线构建器的全局锁。** 如果品种处理单元内部串行处理消息，其内部 K 线构建器集合无需锁。锁可能存在于内存数据存储层（需并发安全）以及与 SQLite 交互时。
*   **内存管理**: 及时清理内存中已同步数据。
*   **数据持久性**: 评估内存数据丢失风险。
*   **错误处理**: 实现全面的错误捕获和恢复。