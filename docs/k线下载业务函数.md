
日志埋点实施规约 (综合最终版)
1. 综述

本文档是根据 核心任务与顶层方法论 (V5.1) 对代码库进行全面分析后生成的日志埋点实施蓝图。它为代码库中的每一个函数提供了明确的【业务流程类型】和【建议日志级别】，并陈述了其背后的决策逻辑。

核心目标: 确保日志系统的【信息完备性】，在提供充足诊断信息的同时，通过合理的级别和分类来管理日志流量。

2. 模块分析: src/bin/kline_data_service.rs (主程序入口)

模块核心职责: 作为应用程序的启动器，负责初始化配置、日志系统，并触发核心的K线数据补齐业务流程。

业务流程类型: 低频业务

建议日志级别: None (责任已转移)

分析与理由:

(类型): 应用的唯一入口点，只执行一次。

(级别): 作为顶层容器，其核心业务逻辑的开始、结束和错误的日志责任已完全由其调用的 run_app 函数承担。main 函数本身无需产生额外日志。

业务目标: 启动、执行、并确保应用优雅关闭。

业务流程类型: 低频业务

建议日志级别: Info

分析与理由:

(类型): 核心业务逻辑的顶层封装，在一次运行中只被调用一次。

(级别): 此函数的开始和成功结束代表了整个业务流程的启动和完成，是关键的业务里程碑，必须使用 Info 级别记录。

业务目标: 完整地执行一次K线数据补齐任务。

业务流程类型: 低频业务

建议日志级别: Info

分析与理由:

(类型): 日志系统初始化是应用启动的一部分，只执行一次。

(级别): 日志系统的成功初始化是程序可观测性的前提。此过程的最终成功状态是一个重要的 Info 级别里程碑。

业务目标: 建立完整的日志和追踪系统。

业务流程类型: 低频业务

建议日志级别: Warn

分析与理由:

(类型): 在初始化流程中仅被调用一次。

(级别): 这是一个【决策型函数】。它决定了日志系统的配置来源。当配置文件不存在或解析失败时，系统会回退到环境变量，这是一个需要关注的“非理想”状态，必须使用 Warn 级别记录此回退行为。

业务目标: 从配置文件或环境变量中加载日志参数。

3. 模块分析: src/klcommon/api.rs

模块核心职责: 封装与币安API的所有HTTP交互，包括获取市场信息和下载K线数据。

业务流程类型: 低频业务 (工具函数)

建议日志级别: None

分析与理由:

(类型/级别): 完美的 None 级别范例。它们是无副作用的纯计算工具函数，不执行I/O，其结果的记录责任已由使用它们的API调用者完全承担。

业务流程类型: 低频业务

建议日志级别: None

分析与理由: 简单的构造函数，无记录必要。

业务流程类型: 高频业务

建议日志级别: Trace

分析与理由:

(类型): 在每个API请求前都会调用，是典型的高频操作。

(级别): 此函数处理的是纯技术实现细节（创建HTTP客户端）。记录此操作会产生大量噪音。Trace 级别最适合这种场景，仅在需要深度网络调试时启用。

业务流程类型: 低频业务

建议日志级别: Debug

分析与理由:

(类型): 程序启动时调用，是准备阶段的一部分。

(级别): 这是 get_trading_usdt_perpetual_symbols 的底层实现。根据【日志责任归属原则H】，其成功日志由调用者承担。Debug 级别足以在需要时追踪底层API调用细节。

业务流程类型: 低频业务

建议日志级别: Info

分析与理由:

(类型): 在准备阶段被调用一次。

(级别): 这是一个关键的【决策型函数】。它决定了整个补齐任务的工作范围。获取到的交易对数量是启动流程中的一个核心业务里程碑，必须用 Info 记录。其内部的重试和最终失败逻辑也需要用 Error 级别记录。

业务流程类型: 高频业务

建议日志级别: Warn (用于记录失败)

分析与理由:

(类型): 在并发流中为每个DownloadTask执行一次，是典型的“处理单个实体”的高频业务。

(级别): 成功的调用无需记录（会被父级Span覆盖）。但API请求失败（返回非200状态码）是一个需要关注的“非理想”状态，应使用 Warn 记录，代码中已有的warn!实现是恰当的。

业务流程类型: 低频业务

建议日志级别: Debug

分析与理由: 工具性质的API调用，用于辅助更高层业务。Debug 级别适合在排查连通性问题时使用，而不会干扰主流程日志。

4. 模块分析: src/klcommon/db.rs

模块核心职责: 提供数据库的所有操作，通过异步队列进行高效的数据写入。

业务流程类型: 低频业务

建议日志级别: Info

分析与理由: start 函数启动了一个关键的后台任务。这个任务的启动是一个重要的 Info 级别的里程碑事件，标志着数据库写入服务已就绪。

业务流程类型: 高频业务

建议日志级别: None

分析与理由: 纯粹的“管道工”函数，负责spawn_blocking和Span上下文传播，不含业务逻辑，记录会产生噪音。

业务流程类型: 高频业务

建议日志级别: Error / Debug

分析与理由:

(级别): 数据库I/O的最终执行点。任何事务或语句执行失败都必须是 Error 级别。单次成功的批量写入应为 Debug 级别，以确认操作完成，同时避免日志泛滥。定期的聚合统计日志是监控其整体健康状况的更佳方式。

业务流程类型: 低频业务 (因缓存而实际执行频率低)

建议日志级别: Info

分析与理由: 首次为一个(symbol, interval)对执行 CREATE TABLE 是一个重要的结构性变更事件，标志着系统开始处理一个新实体，是Info级别的业务里程碑。后续因缓存命中的调用则无操作。

业务流程类型: 低频业务

建议日志级别: Info / Debug

分析与理由: new 的成功完成代表数据库服务就绪，是 Info 级里程碑。init_db 作为其子步骤，可视为 Debug 级实现细节。

业务流程类型: 高频业务

建议日志级别: Trace

分析与理由: 此函数的核心工作是将一个 WriteTask 推入异步队列。这是一个非常底层的、非阻塞的“管道”操作。记录“已将任务推入队列”是 Trace 级别的细节。

涵盖: get_latest_kline_timestamp, get_earliest_kline_timestamp, get_kline_count 等。

业务流程类型: 高频或低频 (取决于上下文)

建议日志级别: None

分析与理由: 这些都是只读的数据库查询。根据【日志责任归属原则H】，它们的执行日志是噪音。调用者应该记录基于这些查询结果所做出的业务决策。#[instrument]宏已为深度调试提供了追踪能力。

5. 模块分析: src/kldata/backfill.rs

模块核心职责: 实施K线数据补齐的核心业务逻辑。

业务流程类型: 低频业务

建议日志级别: None

分析与理由: 简单的构造函数。

业务流程类型: 高频业务

建议日志级别: Info (条件性)

分析与理由: 此函数本身被高频调用，但其核心价值在于内部的条件性 Info 日志。这是监控长时间运行任务进度的最佳实践。

业务流程类型: 低频业务

建议日志级别: Info

分析与理由: 模块主入口点。其启动、关键子步骤的完成（如获取交易对、创建任务）和最终的整体完成情况，都是必须在 Info 级别记录的核心业务里程碑。

业务流程类型: 低频业务

建议日志级别: None

分析与理由: 这是一个并发流程驱动器。其日志责任已完全被 (a) 内部每个任务的Span和Warn日志，(b) update_backfill_stats的进度日志，和 (c) run_once的摘要日志所覆盖。为其自身添加日志是冗余的。

业务流程类型: 高频业务

建议日志级别: Warn / Debug

分析与理由:

...instrumented: Wrapper函数，通过#[instrument]宏创建Span，无需额外日志。

...task: 真正的业务逻辑。失败路径（API或DB错误）是需要关注的Warn事件。成功的路径由Span的生命周期和update_backfill_stats的聚合日志来体现，单次成功可降级为Debug。

业务流程类型: 低频业务

建议日志级别: Info

分析与理由: 【决策型函数豁免】规则的完美应用。其核心价值在于筛选决策。这个决策过程和结果（例如，“从100个失败任务中，筛选出20个可重试任务”）是诊断系统行为的关键信息，必须用 Info 记录。

业务流程类型: 低频业务

建议日志级别: Warn

分析与理由: 报告最终未能解决的问题。这些是“非理想”状态的最终总结，应使用 Warn 级别引起关注。

业务流程类型: 低频业务

建议日志级别: Info

分析与理由: 这是一个至关重要的【决策型函数】。它通过复杂的内部逻辑（遍历、查询、计算）来生成所有待处理的任务。这个决策过程的最终产物（总任务数）是流程中的一个关键里程碑，必须用Info记录。其责任不应被推给调用者。

业务流程类型: 高频业务 (在循环内)

建议日志级别: Debug

分析与理由: 这两个是 create_all_download_tasks 的决策辅助函数。记录它们的执行细节（为特定交易对生成的具体任务参数）对于调试单个实体的行为非常有用，适合Debug级别。

get_symbols, ensure_all_tables: Info。是run_once流程中的关键准备步骤和里程碑。

get_existing_kline_tables, parse_table_name, calculate_historical_start_time: None。分别是ensure_all_tables的实现细节和纯计算工具函数。