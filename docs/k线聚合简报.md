K线聚合服务架构简报
核心使命 (Core Mission)
本系统是一个高性能的实时K线聚合服务，它通过静态分区和纯内存计算，为海量交易对（如数字货币对）提供低延迟、高吞吐量的K线数据生成与查询能力。
主要功能模块 (Key Features)
Worker (计算核心):
独立的计算单元，设计上可绑定单个CPU核心以消除上下文切换开销。每个Worker负责订阅一部分固定交易对的实时成交数据，在完全隔离的私有内存中高效完成K线聚合计算，并通过专属句柄响应外部的数据读取请求。
PersistenceTask (持久化任务):
全局唯一的后台服务，按固定周期（如30秒）被唤醒。它的职责是并发地从所有Worker中拉取“已更新”的K线数据快照，并将这些数据一次性批量写入数据库，确保数据最终安全落地。
SymbolManager (品种管理器):
负责动态发现并管理新品种。当监听到有新品种上线时，它会为新品种分配全局唯一的ID，并向一个固定的、专职的Worker发送指令，让其开始订阅和聚合该新品种的数据，实现系统的“热添加”能力。
GlobalClock (全局时钟):
提供一个全局统一、精确对齐的时间节拍。所有Worker都监听此时钟信号来同步创建和完结各个周期的K线。这确保了即使是成交稀疏的品种，也能在正确的时间点拥有完整的K线记录，是系统时间一致性的基石。

聚合 (Aggregation):
Worker从其专属的WebSocket连接收到实时成交数据后，会根据交易的品种和时间戳定位到内存中对应的KlineState。然后，它会原子性地更新该KlineState的最高价、最低价、收盘价和成交量。这个过程完全在Worker的私有内存中进行，无任何跨线程锁竞争。每一次更新后，该K线会被标记为 “已更新” (is_updated = true)。
快照与重置 (Snapshot & Reset):
当PersistenceTask或API服务需要数据时，它会向所有Worker发出拉取请求。收到请求后，Worker内部会执行两个关键动作：
A. 筛选与打包: 遍历其管理的K线，筛选出所有被标记为“已更新”的数据，并将这些数据的副本打包成一个“快照”返回给请求方。
B. 状态重置: 立即将这些已被打包的K线数据的“已更新”标记重置为false。这一步至关重要，它确保了下次拉取时不会重复发送相同的数据，从而高效地实现了增量数据提取。
持久化 (Persistence):
PersistenceTask从所有Worker收集到增量数据快照后，会将它们汇总成一个大列表，然后通过一次批量数据库操作 (upsert)，将这些K线数据高效地写入或更新到数据库中，完成其生命周期的最终环节。
动态扩展 (Dynamic Addition):
当SymbolManager发现新品种时，它会将添加指令固定发送给专职的Worker。该Worker会在其预先分配好的巨大内存数组中，为新品种找到一个空位并初始化其KlineState，然后开始订阅和聚合新数据。这个过程不会引起全局停顿或内存重新分配，实现了平滑的水平扩展。