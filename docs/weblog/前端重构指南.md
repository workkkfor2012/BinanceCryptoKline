# å‰ç«¯é‡æ„æŒ‡å—

## 1. é‡æ„ç›®æ ‡

å°†å‰ç«¯ä»å¤æ‚çš„èšåˆé€»è¾‘ä¸­è§£æ”¾å‡ºæ¥ï¼Œä¸“æ³¨äºï¼š
- æ•°æ®å±•ç¤ºå’Œæ¸²æŸ“
- ç”¨æˆ·äº¤äº’å¤„ç†
- ç•Œé¢çŠ¶æ€ç®¡ç†
- æ€§èƒ½ä¼˜åŒ–

## 2. éœ€è¦ç§»é™¤çš„ä»£ç 

### 2.1 èšåˆç›¸å…³ä»£ç 
```javascript
// éœ€è¦åˆ é™¤çš„ä»£ç å—
- calculateSimilarity() å‡½æ•°
- findSimilarMessage() å‡½æ•°
- addToLogAggregator() å‡½æ•°
- cleanupExpiredAggregations() å‡½æ•°
- refreshAggregatedDisplay() å‡½æ•°
- logAggregators å…¨å±€å˜é‡
- messageFrequency ç›¸å…³é€»è¾‘
- processedLogs è·Ÿè¸ªé€»è¾‘
```

### 2.2 å¤æ‚çš„æ—¥å¿—å¤„ç†é€»è¾‘
```javascript
// éœ€è¦ç®€åŒ–çš„ä»£ç 
- updateModuleWithLogEntry() å‡½æ•°
- updateAllModuleLogs() å‡½æ•°ä¸­çš„èšåˆéƒ¨åˆ†
- updateRawLogSnapshot() å‡½æ•°ä¸­çš„èšåˆéƒ¨åˆ†
- moduleLogHistory ç›¸å…³é€»è¾‘
```

## 3. æ–°çš„å‰ç«¯æ¶æ„

### 3.1 ç®€åŒ–çš„æ•°æ®æµ
```
WebSocketæ¥æ”¶æ•°æ® â†’ ç›´æ¥æ¸²æŸ“æ˜¾ç¤º â†’ ç”¨æˆ·äº¤äº’å¤„ç†
```

### 3.2 æ ¸å¿ƒå‡½æ•°é‡æ„

#### 3.2.1 ç®€åŒ–çš„ä»ªè¡¨æ¿æ›´æ–°
```javascript
function updateDashboard(data) {
    console.log('æ¥æ”¶åˆ°ä»ªè¡¨æ¿æ•°æ®:', data);
    
    // ç›´æ¥ä½¿ç”¨åç«¯æä¾›çš„èšåˆæ•°æ®
    if (data.module_logs) {
        updateModuleLogs(data.module_logs);
    }
    
    if (data.realtime_log_data) {
        updateRealtimeLogs(data.realtime_log_data);
    }
    
    if (data.raw_log_snapshot) {
        updateRawLogSnapshot(data.raw_log_snapshot);
    }
    
    // æ›´æ–°ç³»ç»ŸçŠ¶æ€
    updateSystemStatus(data);
}
```

#### 3.2.2 ç®€åŒ–çš„æ¨¡å—æ—¥å¿—æ›´æ–°
```javascript
function updateModuleLogs(moduleLogs) {
    for (const [moduleName, moduleData] of Object.entries(moduleLogs)) {
        // ç¡®ä¿æ¨¡å—å®¹å™¨å­˜åœ¨
        ensureModuleContainer(moduleName);
        
        // æ›´æ–°æ¨¡å—ç»Ÿè®¡
        updateModuleStats(moduleName, moduleData);
        
        // ç›´æ¥æ¸²æŸ“åç«¯æä¾›çš„èšåˆæ—¥å¿—
        renderModuleDisplayLogs(moduleName, moduleData.displayed_logs);
    }
}

function renderModuleDisplayLogs(moduleName, displayedLogs) {
    const containerId = getModuleContainerId(moduleName);
    const container = document.getElementById(containerId + '-logs');
    
    if (!container) return;
    
    // æ¸…ç©ºå®¹å™¨
    container.innerHTML = '';
    
    if (!displayedLogs || displayedLogs.length === 0) {
        container.innerHTML = '<div class="log-entry">ç­‰å¾…æ—¥å¿—æ•°æ®...</div>';
        return;
    }
    
    // æ¸²æŸ“æ¯ä¸ªèšåˆæ—¥å¿—æ¡ç›®
    displayedLogs.forEach((logEntry, index) => {
        const logElement = createLogElement(logEntry, containerId, index);
        container.appendChild(logElement);
        
        // åªæ˜¾ç¤ºå‰20æ¡ï¼Œå…¶ä»–éšè—
        if (index >= 20) {
            logElement.style.display = 'none';
        }
    });
}
```

#### 3.2.3 æ—¥å¿—å…ƒç´ åˆ›å»º
```javascript
function createLogElement(logEntry, containerId, index) {
    const logWrapper = document.createElement('div');
    const logId = `${containerId}-log-${Date.now()}-${index}`;
    
    // æ„å»ºæ˜¾ç¤ºæ¶ˆæ¯
    const displayMessage = logEntry.is_aggregated && logEntry.count > 1
        ? `${logEntry.message} (Ã—${logEntry.count})`
        : logEntry.message;
    
    // æ„å»ºJSONå†…å®¹
    const jsonContent = logEntry.is_aggregated
        ? {
            message: logEntry.message,
            level: logEntry.level,
            count: logEntry.count,
            timestamp: logEntry.timestamp,
            variations: logEntry.variations || [],
            all_logs: logEntry.all_logs || []
          }
        : logEntry.all_logs[0] || logEntry;
    
    logWrapper.innerHTML = `
        <!-- JSONè¯¦æƒ… (é»˜è®¤éšè—) -->
        <div id="json-${logId}" class="raw-json">
            <div class="json-container">
                <div class="json-header">
                    <span>ğŸ“„ ${logEntry.is_aggregated ? `èšåˆæ—¥å¿—è¯¦æƒ… (${logEntry.count}æ¡)` : 'åŸå§‹JSON'}</span>
                    <span class="json-close" onclick="hideJson('${logId}')">âœ•</span>
                </div>
                <div class="json-content">${JSON.stringify(jsonContent, null, 2)}</div>
            </div>
        </div>

        <!-- æ—¥å¿—æ¡ç›® -->
        <div class="log-entry log-level-${logEntry.level} ${logEntry.is_aggregated ? 'aggregated-log' : ''}"
             onclick="toggleJson('${logId}')" data-log-id="${logId}" 
             title="${logEntry.is_aggregated ? `èšåˆæ—¥å¿—: ${logEntry.variations?.length || 1}ç§å˜ä½“` : logEntry.message}">
            <div class="log-message">${escapeHtml(displayMessage)}</div>
        </div>
    `;
    
    return logWrapper;
}
```

#### 3.2.4 ç®€åŒ–çš„åŸå§‹æ—¥å¿—å¿«ç…§æ›´æ–°
```javascript
function updateRawLogSnapshot(snapshot) {
    if (!snapshot) return;
    
    console.log('æ›´æ–°åŸå§‹æ—¥å¿—å¿«ç…§:', snapshot);
    
    // æ›´æ–°çŠ¶æ€ä¿¡æ¯
    const statusEl = document.getElementById('raw-logs-status');
    if (statusEl) {
        statusEl.textContent = 'æŠ˜å å·²æ›´æ–°';
        statusEl.className = 'module-status status-running';
    }
    
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    const timestampEl = document.getElementById('snapshot-timestamp');
    const totalCountEl = document.getElementById('total-log-count');
    const displayedCountEl = document.getElementById('displayed-log-count');
    
    if (timestampEl) timestampEl.textContent = snapshot.timestamp;
    if (totalCountEl) totalCountEl.textContent = snapshot.total_count;
    if (displayedCountEl) displayedCountEl.textContent = snapshot.displayed_logs?.length || 0;
    
    // ç›´æ¥æ¸²æŸ“åç«¯æä¾›çš„èšåˆæ—¥å¿—
    const container = document.getElementById('raw-logs-display');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!snapshot.displayed_logs || snapshot.displayed_logs.length === 0) {
        container.innerHTML = '<div class="log-entry">æš‚æ— æ—¥å¿—æ•°æ®</div>';
        return;
    }
    
    snapshot.displayed_logs.forEach((logEntry, index) => {
        const logElement = createLogElement(logEntry, 'raw-logs', index);
        container.appendChild(logElement);
        
        // åªæ˜¾ç¤ºå‰20æ¡
        if (index >= 20) {
            logElement.style.display = 'none';
        }
    });
}
```

#### 3.2.5 ç®€åŒ–çš„å®æ—¶æ—¥å¿—æ›´æ–°
```javascript
function updateRealtimeLogs(realtimeData) {
    if (!realtimeData || !realtimeData.recent_logs) return;
    
    const container = document.getElementById('realtime-logs-display');
    if (!container) return;
    
    // æ¸…ç©ºå®¹å™¨
    container.innerHTML = '';
    
    if (realtimeData.recent_logs.length === 0) {
        container.innerHTML = '<div class="log-entry">æš‚æ— å®æ—¶æ—¥å¿—</div>';
        return;
    }
    
    // åªæ˜¾ç¤ºæœ€æ–°çš„20æ¡å®æ—¶æ—¥å¿—
    const logsToShow = realtimeData.recent_logs.slice(0, 20);
    
    logsToShow.forEach(logLine => {
        const logEl = document.createElement('div');
        logEl.className = 'log-entry';
        logEl.style.fontSize = '12px';
        logEl.style.lineHeight = '1.3';
        logEl.style.marginBottom = '2px';
        logEl.style.wordBreak = 'break-all';

        // ç®€å•çš„æ—¥å¿—ç€è‰²
        if (logLine.includes('ERROR')) {
            logEl.style.color = '#ff0000';
        } else if (logLine.includes('WARN')) {
            logEl.style.color = '#ffff00';
        } else if (logLine.includes('INFO')) {
            logEl.style.color = '#00ff00';
        } else {
            logEl.style.color = '#cccccc';
        }

        logEl.textContent = logLine;
        container.appendChild(logEl);
    });
}
```

## 4. ä¿ç•™çš„åŠŸèƒ½

### 4.1 ç”¨æˆ·äº¤äº’åŠŸèƒ½
```javascript
// ä¿ç•™è¿™äº›å‡½æ•°ï¼Œæ— éœ€ä¿®æ”¹
- toggleJson()
- showJson()
- hideJson()
- escapeHtml()
- copyToClipboard()
- toggleRealtimeLogs()
```

### 4.2 æ»šåŠ¨å’Œå†å²æŸ¥çœ‹
```javascript
// ç®€åŒ–çš„æ»šåŠ¨å¤„ç†
function handleLogScroll(event, containerId, moduleName) {
    event.stopPropagation();
    
    const container = document.getElementById(containerId);
    if (!container) return;
    
    // æ£€æŸ¥æ˜¯å¦æ»šåŠ¨åˆ°é¡¶éƒ¨
    if (container.scrollTop === 0) {
        // æ˜¾ç¤ºæ›´å¤šéšè—çš„å†å²æ—¥å¿—
        const hiddenElements = Array.from(container.children)
            .filter(el => el.style.display === 'none');
        const toShow = Math.min(10, hiddenElements.length);
        
        for (let i = 0; i < toShow; i++) {
            hiddenElements[i].style.display = '';
        }
        
        // è°ƒæ•´æ»šåŠ¨ä½ç½®
        if (toShow > 0) {
            container.scrollTop = toShow * 35;
        }
    }
}
```

### 4.3 æ¨¡å—ç®¡ç†
```javascript
// ä¿ç•™ä½†ç®€åŒ–çš„æ¨¡å—ç®¡ç†
function ensureModuleContainer(moduleName) {
    // ä¿æŒç°æœ‰é€»è¾‘ï¼Œæ— éœ€ä¿®æ”¹
}

function updateModuleStats(moduleName, moduleData) {
    const containerId = getModuleContainerId(moduleName);
    
    // ç›´æ¥ä½¿ç”¨åç«¯æä¾›çš„ç»Ÿè®¡æ•°æ®
    const totalEl = document.getElementById(containerId + '-total');
    const errorsEl = document.getElementById(containerId + '-errors');
    const lastUpdateEl = document.getElementById(containerId + '-last-update');
    
    if (totalEl) totalEl.textContent = moduleData.total_logs || 0;
    if (errorsEl) errorsEl.textContent = moduleData.error_count || 0;
    if (lastUpdateEl) {
        const latestLog = moduleData.displayed_logs?.[0];
        if (latestLog) {
            lastUpdateEl.textContent = new Date(latestLog.timestamp).toLocaleTimeString();
        }
    }
}
```

## 5. æ€§èƒ½ä¼˜åŒ–

### 5.1 å‡å°‘DOMæ“ä½œ
```javascript
// ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µæ‰¹é‡æ·»åŠ å…ƒç´ 
function renderModuleDisplayLogs(moduleName, displayedLogs) {
    const containerId = getModuleContainerId(moduleName);
    const container = document.getElementById(containerId + '-logs');
    
    if (!container) return;
    
    // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µæé«˜æ€§èƒ½
    const fragment = document.createDocumentFragment();
    
    displayedLogs.forEach((logEntry, index) => {
        const logElement = createLogElement(logEntry, containerId, index);
        fragment.appendChild(logElement);
        
        if (index >= 20) {
            logElement.style.display = 'none';
        }
    });
    
    // ä¸€æ¬¡æ€§æ›´æ–°DOM
    container.innerHTML = '';
    container.appendChild(fragment);
}
```

### 5.2 äº‹ä»¶å§”æ‰˜
```javascript
// ä½¿ç”¨äº‹ä»¶å§”æ‰˜å‡å°‘äº‹ä»¶ç›‘å¬å™¨æ•°é‡
document.addEventListener('click', function(event) {
    const target = event.target;
    
    // å¤„ç†JSONåˆ‡æ¢
    if (target.closest('.log-entry[data-log-id]')) {
        const logId = target.closest('.log-entry').getAttribute('data-log-id');
        toggleJson(logId);
        return;
    }
    
    // å¤„ç†JSONå…³é—­
    if (target.classList.contains('json-close')) {
        const logId = target.getAttribute('onclick').match(/'([^']+)'/)[1];
        hideJson(logId);
        return;
    }
});
```

## 6. é”™è¯¯å¤„ç†

### 6.1 æ•°æ®éªŒè¯
```javascript
function validateDisplayLogEntry(logEntry) {
    if (!logEntry || typeof logEntry !== 'object') {
        console.warn('Invalid log entry:', logEntry);
        return false;
    }
    
    const required = ['message', 'level', 'timestamp'];
    for (const field of required) {
        if (!logEntry[field]) {
            console.warn(`Missing required field '${field}' in log entry:`, logEntry);
            return false;
        }
    }
    
    return true;
}
```

### 6.2 å®¹é”™å¤„ç†
```javascript
function safeRenderLogs(moduleName, displayedLogs) {
    try {
        if (!Array.isArray(displayedLogs)) {
            console.warn('displayedLogs is not an array:', displayedLogs);
            return;
        }
        
        const validLogs = displayedLogs.filter(validateDisplayLogEntry);
        renderModuleDisplayLogs(moduleName, validLogs);
        
    } catch (error) {
        console.error('Error rendering logs for module', moduleName, ':', error);
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        const containerId = getModuleContainerId(moduleName);
        const container = document.getElementById(containerId + '-logs');
        if (container) {
            container.innerHTML = '<div class="log-entry error">æ—¥å¿—æ¸²æŸ“é”™è¯¯</div>';
        }
    }
}
```

## 7. è¿ç§»æ­¥éª¤

### 7.1 ç¬¬ä¸€æ­¥ï¼šå¤‡ä»½ç°æœ‰ä»£ç 
```bash
# åˆ›å»ºå¤‡ä»½åˆ†æ”¯
git checkout -b frontend-backup-before-refactor
git add .
git commit -m "Backup frontend before refactor"
git checkout main
```

### 7.2 ç¬¬äºŒæ­¥ï¼šé€æ­¥ç§»é™¤èšåˆä»£ç 
1. æ³¨é‡Šæ‰èšåˆç›¸å…³å‡½æ•°
2. ä¿®æ”¹æ•°æ®å¤„ç†æµç¨‹
3. æµ‹è¯•åŸºæœ¬æ˜¾ç¤ºåŠŸèƒ½
4. åˆ é™¤æ— ç”¨ä»£ç 

### 7.3 ç¬¬ä¸‰æ­¥ï¼šé€‚é…æ–°çš„æ•°æ®æ ¼å¼
1. ä¿®æ”¹WebSocketæ¶ˆæ¯å¤„ç†
2. æ›´æ–°æ¸²æŸ“å‡½æ•°
3. æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
4. æ€§èƒ½ä¼˜åŒ–

### 7.4 ç¬¬å››æ­¥ï¼šæ¸…ç†å’Œä¼˜åŒ–
1. åˆ é™¤æ— ç”¨çš„å…¨å±€å˜é‡
2. ç®€åŒ–CSSæ ·å¼
3. ä¼˜åŒ–äº‹ä»¶å¤„ç†
4. æ·»åŠ é”™è¯¯å¤„ç†

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2024å¹´12æœˆ  
**æœ€åæ›´æ–°**: 2024å¹´12æœˆ
