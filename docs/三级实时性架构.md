# K线数据实时性三层分级策略

为了在保证关键 K 线图低延迟更新的同时，高效利用浏览器和服务器资源，并优化大量品种切换时的体验，特制定 K 线数据的三层实时性更新策略。

## 层级一：当前显示品种 (最高优先级)

*   **目标品种:** 用户当前正在屏幕上积极查看的 K 线图。
*   **更新机制:** 前端浏览器与 **币安官方** 服务器建立 **直接的 WebSocket 连接**，实时接收该品种/周期的 K 线更新。
*   **实时性目标:** **最低延迟** (毫秒级)，力求与数据源完全同步。
*   **核心目的:** 为用户当前关注的核心内容提供最佳的实时数据体验。

## 层级二：热点名单品种 (次高优先级)

*   **目标品种:** “热点名单”中的 K 线图。该名单动态组成，通常包括：
    *   按成交量（或其他指标）排序的 **Top N** 活跃品种。
    *   用户 **最近显示过** 的品种（可能有数量或时间限制）。
    *   名单总数会设定一个合理的上限（例如 50-100 个）。
*   **更新机制:** 前端浏览器与 **自建的云端后端服务器** 建立 **WebSocket 连接**。后端负责汇总这些热点品种的 K 线更新，并以较高频率（例如 **秒级**）推送给前端。
*   **实时性目标:** **近实时** 更新。数据相对新鲜，但相比层级一会有少量后端中转延迟。
*   **核心目的:** 在可控的资源消耗下，保持用户最可能接下来会查看的品种的数据新鲜度，优化快速切换图表时的加载体验。

## 层级三：其他非热点品种 (按需更新)

*   **目标品种:** **所有其他** 未在当前显示（层级一）也未在热点名单（层级二）中的 K 线图。
*   **更新机制:** **不进行任何后台实时更新**。当用户 **选择并切换到** 此类品种进行查看时：
    1.  前端首先检查本地缓存（IndexedDB）中该品种/周期的最新数据时间戳。
    2.  然后向 **自建的云端后端服务器** 发起一次性请求，获取从该时间戳开始的所有缺失的 **增量 K 线数据**。
    3.  数据获取并更新本地缓存后，该品种的更新机制会 **提升至层级一**（建立直连币安 WebSocket），并可能被加入“最近显示”列表进入层级二。
*   **实时性目标:** **按需更新**，非后台实时。切换时需要短暂的数据同步时间。
*   **核心目的:** **最大限度地节省** 浏览器和服务器的计算、内存及网络资源，避免为大量当前不活跃或用户不关心的品种维持不必要的实时连接和数据处理。

---

**总结:** 该三层策略通过区分不同场景下的实时性需求，实现了在保证核心体验的同时，显著降低系统整体资源消耗的目标。