# K线数据空洞检测工具使用指南

## 概述

本项目提供了两个数据空洞检测工具，用于检测和修复K线数据库中的数据缺失问题：

1. **快速数据完整性检查器** (`quick_gap_check`) - 快速检查，适合日常监控
2. **完整数据空洞检测器** (`gap_detector`) - 详细检测和自动修复

## 工具对比

| 特性 | 快速检查器 | 完整检测器 |
|------|------------|------------|
| 检测速度 | 快速 (秒级) | 较慢 (分钟级) |
| 检测精度 | 基本 (统计方法) | 精确 (逐条检查) |
| 检测范围 | 主要间隔 (1m, 1h, 1d) | 所有间隔 |
| 修复功能 | 无 | 有 |
| 适用场景 | 日常监控 | 详细分析和修复 |

## 快速数据完整性检查器

### 功能特点
- 快速检查主要时间间隔的数据完整性
- 通过统计方法识别明显的数据空洞
- 适合日常监控和快速诊断

### 使用方法

#### 基本用法
```powershell
# 快速检查所有数据
.\quick_gap_check.ps1

# 详细输出模式
.\quick_gap_check.ps1 -Verbose

# 自定义数据库路径
.\quick_gap_check.ps1 -DatabasePath "custom\path\klines.db"
```

#### 通过启动器使用
1. 运行 `.\启动器.ps1` 启动图形界面
2. 在"数据工具"标签页中找到"快速数据完整性检查"
3. 点击"🚀 启动"按钮

### 输出示例
```
📊 1m 时间间隔:
  有空洞的品种数: 5
  缺失周期总数: 1250
  缺失时间总计: 20.83 小时
  最严重空洞: BTCUSDT (缺失 500 个周期)
```

## 完整数据空洞检测器

### 功能特点
- 精确检测所有时间间隔的数据空洞
- 自动修复功能
- 生成详细的修复脚本
- 支持批量修复和单独修复

### 使用方法

#### 基本检测
```powershell
# 检测所有空洞
.\start_gap_detector.ps1

# 检测指定品种
.\start_gap_detector.ps1 -Symbol BTCUSDT

# 检测指定时间间隔
.\start_gap_detector.ps1 -Interval 1m

# 检测指定品种和时间间隔
.\start_gap_detector.ps1 -Symbol BTCUSDT -Interval 1m
```

#### 自动修复
```powershell
# 检测并自动修复空洞
.\start_gap_detector.ps1 -Repair

# 限制修复数量
.\start_gap_detector.ps1 -Repair -MaxRepair 10

# 详细输出模式
.\start_gap_detector.ps1 -Repair -Verbose
```

#### 通过启动器使用
1. 运行 `.\启动器.ps1` 启动图形界面
2. 在"数据工具"标签页中找到"数据空洞检测器"
3. 点击"🚀 启动"进行检测，或点击"🔧 检测+修复"进行自动修复

### 命令行参数详解

| 参数 | 说明 | 默认值 | 示例 |
|------|------|--------|------|
| `-DatabasePath` | 数据库文件路径 | `data\klines.db` | `-DatabasePath "custom\db.db"` |
| `-Intervals` | 检测的时间间隔 | `1m,5m,30m,1h,4h,1d` | `-Intervals "1m,5m"` |
| `-Repair` | 启用自动修复 | 关闭 | `-Repair` |
| `-MaxRepair` | 最大修复数量 | 50 | `-MaxRepair 20` |
| `-Symbol` | 指定品种 | 所有品种 | `-Symbol BTCUSDT` |
| `-Interval` | 指定间隔 | 所有间隔 | `-Interval 1m` |
| `-Verbose` | 详细输出 | 关闭 | `-Verbose` |

## 输出文件

### 修复脚本 (repair_gaps.ps1)
检测器会自动生成修复脚本，包含所有检测到的空洞的修复命令：

```powershell
# 预览修复命令
.\repair_gaps.ps1 -DryRun

# 执行实际修复
.\repair_gaps.ps1
```

## 工作流程建议

### 日常监控流程
1. 每日运行快速检查器进行基本监控
2. 如发现问题，运行完整检测器进行详细分析
3. 根据需要执行自动修复或手动修复

### 问题排查流程
1. 运行快速检查器确认问题范围
2. 运行完整检测器获取详细信息
3. 分析空洞原因（网络中断、服务停机等）
4. 执行修复操作
5. 重新检测验证修复效果

### 修复策略
- **轻微空洞** (≤10个周期): 可以忽略或批量修复
- **重要空洞** (10-100个周期): 建议及时修复
- **严重空洞** (>100个周期): 优先修复，可能需要分批处理

## 注意事项

### 性能考虑
- 快速检查器适合频繁运行
- 完整检测器建议在低峰期运行
- 自动修复会产生网络请求，注意API限制

### 数据安全
- 修复操作会向数据库写入数据
- 建议在修复前备份重要数据
- 使用 `-DryRun` 参数预览修复操作

### 故障排除
- 确保数据库文件存在且可访问
- 检查网络连接（修复功能需要）
- 查看日志输出了解详细错误信息

## 相关工具

- **历史数据回填服务** (`start_kldata_service.ps1`) - 大规模历史数据补充
- **K线数据服务** (`data.ps1`) - 实时数据收集
- **启动器UI** (`启动器.ps1`) - 图形化管理界面

## 技术实现

### 检测算法
- **快速检查**: 通过统计表中记录数量与时间跨度比较
- **完整检测**: 逐条检查时间戳连续性

### 修复机制
- 调用币安API获取缺失数据
- 批量写入数据库
- 支持并发修复以提高效率

### 错误处理
- 网络错误自动重试
- 数据库错误详细记录
- 修复失败的任务单独报告
