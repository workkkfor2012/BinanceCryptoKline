# é€šç”¨æ—¥å¿—ç³»ç»Ÿæ¥å…¥åè®®

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£å®šä¹‰äº†ä»»ä½•ç³»ç»Ÿæ¥å…¥WebRTCæ—¥å¿—ç³»ç»Ÿçš„æ ‡å‡†åè®®ã€‚éµå¾ªæ­¤åè®®ï¼Œä»»ä½•åº”ç”¨ç¨‹åºéƒ½å¯ä»¥å°†æ—¥å¿—å®æ—¶ä¼ è¾“åˆ°Webç•Œé¢ã€‚

## ğŸ”Œ æ¥å…¥æµç¨‹

### 1. è¿æ¥ä¿¡ä»¤æœåŠ¡å™¨

```javascript
// WebSocketè¿æ¥
const signalingWs = new WebSocket('ws://localhost:8080/signaling');
```

### 2. æ³¨å†Œä¸ºæ—¥å¿—ç”Ÿäº§è€…

```json
{
  "type": "register",
  "role": "producer",
  "client_id": "your_system_name",
  "metadata": {
    "system_name": "Your System Name",
    "version": "1.0.0",
    "description": "ç³»ç»Ÿæè¿°"
  }
}
```

### 3. ç­‰å¾…æ¶ˆè´¹è€…è¿æ¥

ä¿¡ä»¤æœåŠ¡å™¨ä¼šé€šçŸ¥æœ‰æ¶ˆè´¹è€…ï¼ˆæµè§ˆå™¨ï¼‰è¿æ¥ï¼š

```json
{
  "type": "consumer_connected",
  "consumer_id": "browser_client_123"
}
```

### 4. å»ºç«‹WebRTCè¿æ¥

#### 4.1 åˆ›å»ºRTCPeerConnection

```javascript
const peerConnection = new RTCPeerConnection({
  iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
});

const dataChannel = peerConnection.createDataChannel('logs', {
  ordered: true
});
```

#### 4.2 åˆ›å»ºå¹¶å‘é€Offer

```javascript
const offer = await peerConnection.createOffer();
await peerConnection.setLocalDescription(offer);

// é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨å‘é€
signalingWs.send(JSON.stringify({
  "type": "webrtc_offer",
  "to": "browser_client_123",
  "sdp": offer.sdp
}));
```

#### 4.3 å¤„ç†Answerå’ŒICEå€™é€‰

```javascript
// æ¥æ”¶Answer
signalingWs.onmessage = (event) => {
  const message = JSON.parse(event.data);
  
  if (message.type === 'webrtc_answer') {
    peerConnection.setRemoteDescription({
      type: 'answer',
      sdp: message.sdp
    });
  }
  
  if (message.type === 'ice_candidate') {
    peerConnection.addIceCandidate({
      candidate: message.candidate,
      sdpMLineIndex: message.sdpMLineIndex
    });
  }
};
```

### 5. å‘é€æ—¥å¿—æ•°æ®

è¿æ¥å»ºç«‹åï¼Œç›´æ¥å‘é€æ—¥å¿—ï¼š

```javascript
dataChannel.onopen = () => {
  console.log('P2Pè¿æ¥å·²å»ºç«‹ï¼Œå¯ä»¥å‘é€æ—¥å¿—');
};

// å‘é€æ—¥å¿—
function sendLog(logEntry) {
  if (dataChannel.readyState === 'open') {
    dataChannel.send(JSON.stringify(logEntry));
  }
}
```

## ğŸ“Š æ—¥å¿—æ•°æ®æ ¼å¼

### æ ‡å‡†æ—¥å¿—æ ¼å¼

```json
{
  "timestamp": "2024-01-01T12:00:00.000Z",
  "level": "INFO",
  "target": "module_name",
  "message": "æ—¥å¿—æ¶ˆæ¯å†…å®¹",
  "fields": {
    "user_id": "12345",
    "request_id": "req_abc123"
  },
  "span": {
    "id": "span_123",
    "trace_id": "trace_456",
    "parent_id": "span_789"
  }
}
```

### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| timestamp | string | âœ… | ISO 8601æ ¼å¼æ—¶é—´æˆ³ |
| level | string | âœ… | æ—¥å¿—çº§åˆ«ï¼šERROR/WARN/INFO/DEBUG |
| target | string | âœ… | æ—¥å¿—æ¥æºæ¨¡å— |
| message | string | âœ… | æ—¥å¿—æ¶ˆæ¯å†…å®¹ |
| fields | object | âŒ | ç»“æ„åŒ–å­—æ®µ |
| span | object | âŒ | åˆ†å¸ƒå¼è¿½è¸ªä¿¡æ¯ |

## ğŸ”§ å„è¯­è¨€æ¥å…¥ç¤ºä¾‹

### Rustæ¥å…¥ç¤ºä¾‹

```rust
use serde_json::json;
use tokio_tungstenite::{connect_async, tungstenite::Message};

async fn connect_to_log_system() -> Result<(), Box<dyn std::error::Error>> {
    // 1. è¿æ¥ä¿¡ä»¤æœåŠ¡å™¨
    let (ws_stream, _) = connect_async("ws://localhost:8080/signaling").await?;
    
    // 2. æ³¨å†Œä¸ºç”Ÿäº§è€…
    let register_msg = json!({
        "type": "register",
        "role": "producer",
        "client_id": "rust_app",
        "metadata": {
            "system_name": "Rust Application",
            "version": "1.0.0"
        }
    });
    
    ws_stream.send(Message::Text(register_msg.to_string())).await?;
    
    // 3. å»ºç«‹WebRTCè¿æ¥ï¼ˆä½¿ç”¨webrtc-rsåº“ï¼‰
    // ... WebRTCè¿æ¥ä»£ç  ...
    
    // 4. å‘é€æ—¥å¿—
    let log_entry = json!({
        "timestamp": chrono::Utc::now().to_rfc3339(),
        "level": "INFO",
        "target": "rust_app::main",
        "message": "åº”ç”¨ç¨‹åºå¯åŠ¨"
    });
    
    data_channel.send(&log_entry.to_string().into()).await?;
    
    Ok(())
}
```

### Pythonæ¥å…¥ç¤ºä¾‹

```python
import asyncio
import json
import websockets
from datetime import datetime

async def connect_to_log_system():
    # 1. è¿æ¥ä¿¡ä»¤æœåŠ¡å™¨
    async with websockets.connect("ws://localhost:8080/signaling") as websocket:
        # 2. æ³¨å†Œä¸ºç”Ÿäº§è€…
        register_msg = {
            "type": "register",
            "role": "producer",
            "client_id": "python_app",
            "metadata": {
                "system_name": "Python Application",
                "version": "1.0.0"
            }
        }
        await websocket.send(json.dumps(register_msg))
        
        # 3. å»ºç«‹WebRTCè¿æ¥ï¼ˆä½¿ç”¨aiortcåº“ï¼‰
        # ... WebRTCè¿æ¥ä»£ç  ...
        
        # 4. å‘é€æ—¥å¿—
        log_entry = {
            "timestamp": datetime.utcnow().isoformat() + "Z",
            "level": "INFO",
            "target": "python_app.main",
            "message": "Pythonåº”ç”¨ç¨‹åºå¯åŠ¨"
        }
        
        await data_channel.send(json.dumps(log_entry))

# è¿è¡Œ
asyncio.run(connect_to_log_system())
```

### Node.jsæ¥å…¥ç¤ºä¾‹

```javascript
const WebSocket = require('ws');
const wrtc = require('wrtc');

async function connectToLogSystem() {
    // 1. è¿æ¥ä¿¡ä»¤æœåŠ¡å™¨
    const signalingWs = new WebSocket('ws://localhost:8080/signaling');
    
    // 2. æ³¨å†Œä¸ºç”Ÿäº§è€…
    signalingWs.on('open', () => {
        signalingWs.send(JSON.stringify({
            type: 'register',
            role: 'producer',
            client_id: 'nodejs_app',
            metadata: {
                system_name: 'Node.js Application',
                version: '1.0.0'
            }
        }));
    });
    
    // 3. å»ºç«‹WebRTCè¿æ¥
    const peerConnection = new wrtc.RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    });
    
    const dataChannel = peerConnection.createDataChannel('logs');
    
    // 4. å‘é€æ—¥å¿—
    dataChannel.onopen = () => {
        const logEntry = {
            timestamp: new Date().toISOString(),
            level: 'INFO',
            target: 'nodejs_app.main',
            message: 'Node.jsåº”ç”¨ç¨‹åºå¯åŠ¨'
        };
        
        dataChannel.send(JSON.stringify(logEntry));
    };
}

connectToLogSystem();
```

## ğŸ”„ é”™è¯¯å¤„ç†å’Œé‡è¿

### è‡ªåŠ¨é‡è¿æœºåˆ¶

```javascript
class LogSystemClient {
    constructor(clientId, systemName) {
        this.clientId = clientId;
        this.systemName = systemName;
        this.reconnectInterval = 5000;
        this.maxReconnectAttempts = -1; // æ— é™é‡è¯•
    }
    
    async connect() {
        let attempts = 0;
        
        while (this.maxReconnectAttempts === -1 || attempts < this.maxReconnectAttempts) {
            try {
                await this.establishConnection();
                console.log('âœ… å·²è¿æ¥åˆ°æ—¥å¿—ç³»ç»Ÿ');
                return;
            } catch (error) {
                attempts++;
                console.log(`âŒ è¿æ¥å¤±è´¥ (å°è¯• ${attempts}): ${error.message}`);
                console.log(`â³ ${this.reconnectInterval/1000}ç§’åé‡è¯•...`);
                await this.sleep(this.reconnectInterval);
            }
        }
    }
    
    async establishConnection() {
        // å®ç°è¿æ¥é€»è¾‘
    }
    
    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}
```

## ğŸ“š å®Œæ•´æ¥å…¥æ¸…å•

### âœ… å¿…éœ€æ­¥éª¤
- [ ] è¿æ¥ä¿¡ä»¤æœåŠ¡å™¨ (ws://localhost:8080/signaling)
- [ ] å‘é€æ³¨å†Œæ¶ˆæ¯å£°æ˜ä¸ºç”Ÿäº§è€…
- [ ] å®ç°WebRTCè¿æ¥å»ºç«‹é€»è¾‘
- [ ] å®ç°æ—¥å¿—æ•°æ®å‘é€
- [ ] å®ç°è‡ªåŠ¨é‡è¿æœºåˆ¶

### âœ… æ¨èæ­¥éª¤
- [ ] å®ç°è¿æ¥çŠ¶æ€ç›‘æ§
- [ ] å®ç°æ—¥å¿—ç¼“å†²ï¼ˆè¿æ¥æ–­å¼€æ—¶ï¼‰
- [ ] å®ç°æ—¥å¿—çº§åˆ«è¿‡æ»¤
- [ ] æ·»åŠ æ€§èƒ½ç›‘æ§ï¼ˆå‘é€é€Ÿç‡ç­‰ï¼‰

### âœ… å¯é€‰æ­¥éª¤
- [ ] å®ç°æ—¥å¿—å‹ç¼©
- [ ] å®ç°æ‰¹é‡å‘é€
- [ ] æ·»åŠ åŠ å¯†ä¼ è¾“
- [ ] å®ç°å¤šæ¶ˆè´¹è€…æ”¯æŒ

## ğŸ¯ æ€»ç»“

é€šè¿‡éµå¾ªè¿™ä¸ªåè®®ï¼Œä»»ä½•ç³»ç»Ÿéƒ½å¯ä»¥è½»æ¾æ¥å…¥æ—¥å¿—ç³»ç»Ÿï¼š

1. **é›¶ä¾èµ–**ï¼šåªéœ€è¦WebSocketå’ŒWebRTCæ”¯æŒ
2. **è¯­è¨€æ— å…³**ï¼šæ”¯æŒä»»ä½•ç¼–ç¨‹è¯­è¨€
3. **é«˜æ€§èƒ½**ï¼šP2Pç›´è¿ï¼Œæ— æœåŠ¡å™¨ç“¶é¢ˆ
4. **æ˜“æ‰©å±•**ï¼šæ ‡å‡†åŒ–åè®®ï¼Œæ˜“äºæ‰©å±•åŠŸèƒ½
