# Rustæ–‡ä»¶æŒç»­ç›‘æ§è½¬æ¢ä¸ºtxtè„šæœ¬
$targetFolderName = "tempfold"

# å®šä¹‰è¦ç›‘æ§çš„æ–‡ä»¶åˆ—è¡¨
$sourceFiles = @(
    "src\bin\kline_data_service.rs",
    "src\bin\kline_aggregate_service.rs",
    "src\kldata\backfill.rs",
    "src\klcommon\log\trace_distiller.rs",
    "src\klcommon\log\trace_visualization.rs",
    "src\klcommon\api.rs",
    "src\klcommon\db.rs",
    "src\klcommon\log\module_logging.rs",
    "src\klcommon\log\observability.rs"
)

$htmlFilePath = "src\weblog\static\index.html"
$currentPath = Get-Location

# å‡†å¤‡ç›®æ ‡æ–‡ä»¶å¤¹
$targetFolderPath = Join-Path -Path $currentPath -ChildPath $targetFolderName

if (Test-Path -Path $targetFolderPath -PathType Container) {
    Write-Host "æ¸…ç©ºç›®æ ‡æ–‡ä»¶å¤¹..." -ForegroundColor Yellow
    Get-ChildItem -Path $targetFolderPath -Force | Remove-Item -Recurse -Force
} else {
    Write-Host "åˆ›å»ºç›®æ ‡æ–‡ä»¶å¤¹..." -ForegroundColor Yellow
    New-Item -Path $targetFolderPath -ItemType Directory | Out-Null
}

# å¤åˆ¶æ–‡ä»¶çš„å‡½æ•°
function Copy-FileToTxt {
    param(
        [string]$SourcePath,
        [string]$TargetFolder
    )

    if (Test-Path -Path $SourcePath -PathType Leaf) {
        $fileName = [System.IO.Path]::GetFileNameWithoutExtension($SourcePath)
        $extension = [System.IO.Path]::GetExtension($SourcePath)

        if ($extension -eq ".rs") {
            $newFileName = "$fileName.txt"
        } elseif ($extension -eq ".html") {
            $newFileName = "index.html"
        } else {
            $newFileName = "$fileName.txt"
        }

        $destinationPath = Join-Path -Path $TargetFolder -ChildPath $newFileName
        Copy-Item -Path $SourcePath -Destination $destinationPath -Force
        $timestamp = Get-Date -Format "HH:mm:ss"
        Write-Host "[$timestamp] âœ… æ–‡ä»¶å·²æ›´æ–°: $SourcePath -> $newFileName" -ForegroundColor Green
        return $true
    }
    return $false
}

# åˆå§‹å¤åˆ¶æ‰€æœ‰æ–‡ä»¶
Write-Host "å¼€å§‹åˆå§‹å¤åˆ¶..." -ForegroundColor Cyan
$copiedCount = 0
$notFoundFiles = @()

foreach ($filePath in $sourceFiles) {
    if (Copy-FileToTxt -SourcePath $filePath -TargetFolder $targetFolderPath) {
        $copiedCount++
    } else {
        $notFoundFiles += $filePath
        Write-Host "  âŒ æœªæ‰¾åˆ°: $filePath" -ForegroundColor Red
    }
}

# å¤åˆ¶HTMLæ–‡ä»¶
if (Copy-FileToTxt -SourcePath $htmlFilePath -TargetFolder $targetFolderPath) {
    Write-Host "âœ… HTMLæ–‡ä»¶åˆå§‹å¤åˆ¶å®Œæˆ" -ForegroundColor Green
}

Write-Host "âœ… åˆå§‹å¤åˆ¶å®Œæˆï¼ŒæˆåŠŸå¤åˆ¶ $copiedCount ä¸ªæ–‡ä»¶" -ForegroundColor Green
if ($notFoundFiles.Count -gt 0) {
    Write-Host "âŒ æœªæ‰¾åˆ° $($notFoundFiles.Count) ä¸ªæ–‡ä»¶" -ForegroundColor Red
}

# åˆ›å»ºæ–‡ä»¶ç›‘æ§å™¨
Write-Host "`nğŸ” å¼€å§‹ç›‘æ§æ–‡ä»¶å˜åŒ–..." -ForegroundColor Cyan
Write-Host "æŒ‰ Ctrl+C åœæ­¢ç›‘æ§" -ForegroundColor Yellow

# æ¸…ç†ä¹‹å‰å¯èƒ½æ®‹ç•™çš„äº‹ä»¶è®¢é˜…
Write-Host "  [æ¸…ç†] æ¸…é™¤ä¹‹å‰çš„äº‹ä»¶è®¢é˜…..." -ForegroundColor Gray
Get-EventSubscriber | Where-Object { $_.SourceIdentifier -like "FileChanged_*" -or $_.SourceIdentifier -like "FileRenamed_*" } | Unregister-Event

# å°†æ‰€æœ‰è¦ç›‘æ§çš„æ–‡ä»¶è·¯å¾„è½¬æ¢ä¸ºç»å¯¹è·¯å¾„
$allFilesToWatch = $sourceFiles + @($htmlFilePath)
$watchedFiles = @{}

foreach ($file in $allFilesToWatch) {
    # ç¡®ä¿æˆ‘ä»¬åªå¤„ç†å­˜åœ¨çš„æ–‡ä»¶
    if (Test-Path -Path $file -PathType Leaf) {
        $absolutePath = (Resolve-Path $file).Path
        $watchedFiles[$absolutePath] = $file # é”®: ç»å¯¹è·¯å¾„, å€¼: åŸå§‹ç›¸å¯¹è·¯å¾„
        Write-Host "  [å‡†å¤‡ç›‘æ§] $absolutePath" -ForegroundColor Gray
    }
}

# åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç›‘æ§å™¨
$watchers = @()

# è·å–æ‰€æœ‰éœ€è¦ç›‘æ§çš„ç›®å½• (å¹¶å»é‡)
$dirsToWatch = @()
$watchedFiles.Keys | ForEach-Object {
    $dir = Split-Path -Path $_ -Parent
    if ($dirsToWatch -notcontains $dir) {
        $dirsToWatch += $dir
    }
}

# ä¸ºæ¯ä¸ªç›®å½•åˆ›å»ºç›‘æ§å™¨
foreach ($dir in $dirsToWatch) {
    Write-Host "  [è®¾ç½®ç›‘æ§å™¨] ç›®å½•: $dir" -ForegroundColor Gray
    $watcher = New-Object System.IO.FileSystemWatcher
    $watcher.Path = $dir
    $watcher.Filter = "*.*" # ç›‘æ§æ‰€æœ‰æ–‡ä»¶ï¼Œå› ä¸ºæˆ‘ä»¬ä¼šåœ¨ action ä¸­è¿›è¡Œç²¾ç¡®è¿‡æ»¤

    # åŒæ—¶ç›‘æ§å†…å®¹å†™å…¥ã€æ–‡ä»¶åˆ›å»ºå’Œé‡å‘½åï¼Œä»¥åº”å¯¹æ‰€æœ‰ç±»å‹çš„ç¼–è¾‘å™¨ä¿å­˜æ“ä½œ
    $watcher.NotifyFilter = [System.IO.NotifyFilters]::LastWrite `
                         -bor [System.IO.NotifyFilters]::FileName

    # å®šä¹‰äº‹ä»¶å¤„ç†å™¨ (Action)
    $action = {
        $path = $Event.SourceEventArgs.FullPath
        $changeType = $Event.SourceEventArgs.ChangeType
        $timestamp = Get-Date -Format "HH:mm:ss"

        Write-Host "[$timestamp] âš¡ äº‹ä»¶è§¦å‘: ç±»å‹[$changeType] è·¯å¾„[$path]" -ForegroundColor DarkGray

        # ä½¿ç”¨ $using: è®¿é—®ä¸»è„šæœ¬ä¸­çš„å˜é‡
        $localWatchedFiles = $using:watchedFiles
        $localTargetFolder = $using:targetFolderPath

        # æ£€æŸ¥å‘ç”Ÿå˜åŒ–çš„ç»å¯¹è·¯å¾„æ˜¯å¦åœ¨æˆ‘ä»¬å…³å¿ƒçš„æ–‡ä»¶åˆ—è¡¨ä¸­
        if ($localWatchedFiles.ContainsKey($path)) {

            # çŸ­æš‚ç­‰å¾…ï¼Œç¡®ä¿æ–‡ä»¶å·²å®Œå…¨å†™å…¥ç£ç›˜
            Start-Sleep -Milliseconds 200

            try {
                # ã€æ ¸å¿ƒä¿®å¤ã€‘ç›´æ¥å°†ç»å¯¹è·¯å¾„ $path ä¼ é€’ç»™å‡½æ•°
                & $using:Function:Copy-FileToTxt -SourcePath $path -TargetFolder $localTargetFolder
            } catch {
                Write-Host "[$timestamp] âŒ åœ¨äº‹ä»¶å¤„ç†å™¨ä¸­å¤åˆ¶æ–‡ä»¶æ—¶å‡ºé”™: $($_.Exception.Message)" -ForegroundColor Red
            }
        }
    }

    # æ³¨å†Œ 'Changed' å’Œ 'Renamed' äº‹ä»¶ã€‚'Created' é€šå¸¸ä¼šè¢« 'Renamed' è¦†ç›–ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªè¶³å¤Ÿäº†ã€‚
    # ä½¿ç”¨ -SourceIdentifier æ¥ç»™æ¯ä¸ªäº‹ä»¶è®¢é˜…ä¸€ä¸ªå”¯ä¸€çš„åå­—ï¼Œé¿å…å†²çª
    $id_suffix = ($dir -replace '[^a-zA-Z0-9]', '_') # åˆ›å»ºä¸€ä¸ªåˆæ³•çš„æ ‡è¯†ç¬¦
    Register-ObjectEvent -InputObject $watcher -EventName "Changed" -Action $action -SourceIdentifier "FileChanged_$id_suffix" | Out-Null
    Register-ObjectEvent -InputObject $watcher -EventName "Renamed" -Action $action -SourceIdentifier "FileRenamed_$id_suffix" | Out-Null

    $watcher.EnableRaisingEvents = $true
    $watchers += $watcher
}

try {
    # ä¿æŒè„šæœ¬è¿è¡Œ
    while ($true) {
        Start-Sleep -Seconds 1
    }
} finally {
    # æ¸…ç†èµ„æº
    Write-Host "`nğŸ›‘ åœæ­¢ç›‘æ§..." -ForegroundColor Yellow
    foreach ($watcher in $watchers) {
        if ($watcher -ne $null) {
            $watcher.EnableRaisingEvents = $false
            $watcher.Dispose()
        }
    }
    # æ¸…ç†æ‰€æœ‰ç›¸å…³çš„äº‹ä»¶è®¢é˜…
    Get-EventSubscriber | Where-Object { $_.SourceIdentifier -like "FileChanged_*" -or $_.SourceIdentifier -like "FileRenamed_*" } | Unregister-Event
    Write-Host "âœ… ç›‘æ§å·²åœæ­¢ï¼Œèµ„æºå·²æ¸…ç†" -ForegroundColor Green
}
