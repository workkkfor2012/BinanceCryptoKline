<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xterm.js è°ƒè¯•é¡µé¢</title>
    
    <!-- Xterm.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.3.0/css/xterm.css" />
    
    <style>
        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background-color: #1a1a1a;
            color: #00ff00;
            padding: 20px;
        }
        
        .debug-info {
            background-color: #333;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .terminal-container {
            width: 100%;
            height: 400px;
            background-color: #000;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
        }
        
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        
        .status.success { background-color: #006600; }
        .status.error { background-color: #660000; }
        .status.warning { background-color: #666600; }
        
        button {
            background-color: #0066ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background-color: #3388ff;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ Xterm.js è°ƒè¯•é¡µé¢</h1>
    
    <div class="debug-info">
        <h3>ğŸ“Š è°ƒè¯•ä¿¡æ¯</h3>
        <div id="debug-log"></div>
    </div>
    
    <div class="status" id="status">
        <strong>çŠ¶æ€ï¼š</strong><span id="status-text">åˆå§‹åŒ–ä¸­...</span>
    </div>
    
    <div>
        <button onclick="testWebSocket()">æµ‹è¯• WebSocket è¿æ¥</button>
        <button onclick="testTerminal()">æµ‹è¯•ç»ˆç«¯å†™å…¥</button>
        <button onclick="clearTerminal()">æ¸…ç©ºç»ˆç«¯</button>
        <button onclick="clearDebugLog()">æ¸…ç©ºè°ƒè¯•æ—¥å¿—</button>
    </div>
    
    <h3>ğŸ–¥ï¸ ç»ˆç«¯æµ‹è¯•</h3>
    <div class="terminal-container" id="terminal-container"></div>

    <!-- Xterm.js JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.8.0/lib/addon-fit.js"></script>
    
    <script>
        let terminal = null;
        let fitAddon = null;
        let ws = null;
        
        function log(message, type = 'info') {
            const debugLog = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff0000' : type === 'success' ? '#00ff00' : '#ffffff';
            debugLog.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function updateStatus(text, type = 'info') {
            const statusEl = document.getElementById('status');
            const statusText = document.getElementById('status-text');
            statusText.textContent = text;
            
            statusEl.className = 'status';
            if (type === 'success') statusEl.classList.add('success');
            else if (type === 'error') statusEl.classList.add('error');
            else if (type === 'warning') statusEl.classList.add('warning');
        }
        
        function initializeTerminal() {
            try {
                log('ğŸš€ å¼€å§‹åˆå§‹åŒ– Xterm.js...', 'info');
                
                // æ£€æŸ¥ Xterm.js æ˜¯å¦åŠ è½½
                if (typeof Terminal === 'undefined') {
                    throw new Error('Xterm.js æœªåŠ è½½');
                }
                
                if (typeof FitAddon === 'undefined') {
                    throw new Error('FitAddon æœªåŠ è½½');
                }
                
                log('âœ… Xterm.js åº“åŠ è½½æˆåŠŸ', 'success');
                
                // åˆ›å»ºç»ˆç«¯å®ä¾‹
                terminal = new Terminal({
                    theme: {
                        background: '#000000',
                        foreground: '#00ff00',
                        cursor: '#00ff00'
                    },
                    fontFamily: 'Consolas, Monaco, "Courier New", monospace',
                    fontSize: 14,
                    cursorBlink: false,
                    convertEol: true,
                    disableStdin: true
                });
                
                log('âœ… ç»ˆç«¯å®ä¾‹åˆ›å»ºæˆåŠŸ', 'success');
                
                // åˆ›å»º FitAddon
                fitAddon = new FitAddon.FitAddon();
                terminal.loadAddon(fitAddon);
                
                log('âœ… FitAddon åŠ è½½æˆåŠŸ', 'success');
                
                // æ‰“å¼€ç»ˆç«¯
                const container = document.getElementById('terminal-container');
                terminal.open(container);
                
                log('âœ… ç»ˆç«¯å·²æ‰“å¼€åˆ°å®¹å™¨', 'success');
                
                // è°ƒæ•´å¤§å°
                fitAddon.fit();
                
                log('âœ… ç»ˆç«¯å¤§å°è°ƒæ•´å®Œæˆ', 'success');
                
                // å†™å…¥æ¬¢è¿ä¿¡æ¯
                terminal.write('ğŸ‰ Xterm.js ç»ˆç«¯åˆå§‹åŒ–æˆåŠŸï¼\r\n');
                terminal.write('ğŸ“ è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç»ˆç«¯\r\n');
                terminal.write('ğŸ”— å‡†å¤‡æµ‹è¯• WebSocket è¿æ¥...\r\n\r\n');
                
                updateStatus('ç»ˆç«¯åˆå§‹åŒ–æˆåŠŸ', 'success');
                
            } catch (error) {
                log(`âŒ ç»ˆç«¯åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                updateStatus(`ç»ˆç«¯åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function testWebSocket() {
            try {
                log('ğŸ”— å¼€å§‹æµ‹è¯• WebSocket è¿æ¥...', 'info');
                
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws`;
                
                log(`ğŸ“¡ è¿æ¥ URL: ${wsUrl}`, 'info');
                
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function() {
                    log('âœ… WebSocket è¿æ¥æˆåŠŸï¼', 'success');
                    updateStatus('WebSocket å·²è¿æ¥', 'success');
                    if (terminal) {
                        terminal.write('âœ… WebSocket è¿æ¥æˆåŠŸï¼\r\n');
                    }
                };
                
                ws.onmessage = function(event) {
                    log(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${event.data.substring(0, 100)}...`, 'info');
                    if (terminal) {
                        terminal.write(`ğŸ“¨ æ”¶åˆ°æ•°æ®: ${event.data.substring(0, 50)}...\r\n`);
                    }
                };
                
                ws.onclose = function() {
                    log('ğŸ”Œ WebSocket è¿æ¥å·²å…³é—­', 'warning');
                    updateStatus('WebSocket è¿æ¥å·²å…³é—­', 'warning');
                    if (terminal) {
                        terminal.write('ğŸ”Œ WebSocket è¿æ¥å·²å…³é—­\r\n');
                    }
                };
                
                ws.onerror = function(error) {
                    log(`âŒ WebSocket é”™è¯¯: ${error}`, 'error');
                    updateStatus('WebSocket è¿æ¥é”™è¯¯', 'error');
                    if (terminal) {
                        terminal.write('âŒ WebSocket è¿æ¥é”™è¯¯\r\n');
                    }
                };
                
            } catch (error) {
                log(`âŒ WebSocket æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                updateStatus(`WebSocket æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function testTerminal() {
            if (!terminal) {
                log('âŒ ç»ˆç«¯æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            const testMessages = [
                '\x1b[32mâœ… ç»¿è‰²æµ‹è¯•æ¶ˆæ¯ (INFO)\x1b[0m\r\n',
                '\x1b[33mâš ï¸ é»„è‰²æµ‹è¯•æ¶ˆæ¯ (WARN)\x1b[0m\r\n',
                '\x1b[31mâŒ çº¢è‰²æµ‹è¯•æ¶ˆæ¯ (ERROR)\x1b[0m\r\n',
                '\x1b[36mğŸ” é’è‰²æµ‹è¯•æ¶ˆæ¯ (DEBUG)\x1b[0m\r\n',
                'ğŸ“ æ™®é€šæµ‹è¯•æ¶ˆæ¯\r\n'
            ];
            
            testMessages.forEach((msg, index) => {
                setTimeout(() => {
                    terminal.write(msg);
                }, index * 500);
            });
            
            log('ğŸ§ª ç»ˆç«¯æµ‹è¯•æ¶ˆæ¯å·²å‘é€', 'info');
        }
        
        function clearTerminal() {
            if (terminal) {
                terminal.clear();
                log('ğŸ§¹ ç»ˆç«¯å·²æ¸…ç©º', 'info');
            }
        }
        
        function clearDebugLog() {
            document.getElementById('debug-log').innerHTML = '';
            log('ğŸ§¹ è°ƒè¯•æ—¥å¿—å·²æ¸…ç©º', 'info');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆ', 'info');
            
            // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿ CDN èµ„æºåŠ è½½å®Œæˆ
            setTimeout(() => {
                initializeTerminal();
            }, 1000);
        });
        
        // çª—å£å¤§å°å˜åŒ–æ—¶è°ƒæ•´ç»ˆç«¯
        window.addEventListener('resize', function() {
            if (fitAddon) {
                setTimeout(() => fitAddon.fit(), 100);
            }
        });
    </script>
</body>
</html>
