<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kçº¿èšåˆç³»ç»Ÿ - æ¨¡å—ç›‘æ§ v3.11</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background-color: #1a1a1a;
            color: #00ff00;
            padding: 10px;
            font-size: 16px;
            line-height: 1.5;
        }

        .header {
            text-align: center;
            padding: 10px;
            border-bottom: 2px solid #333;
            margin-bottom: 15px;
        }

        .header h1 {
            color: #00ffff;
            font-size: 24px;
            margin-bottom: 8px;
        }

        .system-status {
            color: #ffff00;
            font-size: 14px;
        }

        .modules-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 15px;
            height: calc(100vh - 120px);
        }

        .module {
            border: 1px solid #333;
            border-radius: 5px;
            background-color: #0a0a0a;
            display: flex;
            flex-direction: column;
        }

        .module-header {
            padding: 8px 12px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .module-title {
            font-weight: bold;
            font-size: 16px;
        }

        .module-status {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-running { background-color: #006600; color: #00ff00; }
        .status-waiting { background-color: #666600; color: #ffff00; }
        .status-error { background-color: #660000; color: #ff0000; }
        .status-disconnected { background-color: #663300; color: #ff9900; }

        .module-stats {
            padding: 10px 15px;
            border-bottom: 1px solid #333;
            font-size: 13px;
            color: #cccccc;
        }

        .stat-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }

        .module-logs {
            flex: 1;
            padding: 10px 15px;
            overflow-y: auto;
            overflow-x: hidden;
            font-size: 13px;
            line-height: 1.4;
            /* ç¡®ä¿æ»šåŠ¨å®¹å™¨èƒ½å¤Ÿæ•è·é¼ æ ‡äº‹ä»¶ */
            position: relative;
            /* é˜²æ­¢æ»šåŠ¨äº‹ä»¶å†’æ³¡åˆ°çˆ¶å…ƒç´  */
            overscroll-behavior: contain;
            /* è®¾ç½®æœ€å°é«˜åº¦ç¡®ä¿æ»šåŠ¨åŒºåŸŸè¶³å¤Ÿå¤§ */
            min-height: 200px;
            /* ç¡®ä¿å®¹å™¨æœ‰æ˜ç¡®çš„è¾¹ç•Œ */
            border: 1px solid transparent;
            /* ç¡®ä¿å®¹å™¨å¯ä»¥æ»šåŠ¨ - è®¾ç½®å›ºå®šé«˜åº¦å¼ºåˆ¶äº§ç”Ÿæ»šåŠ¨æ¡ */
            max-height: 400px;
            /* ç„¦ç‚¹æ—¶çš„è§†è§‰åé¦ˆ */
            outline: none;
        }

        /* é¼ æ ‡æ‚¬åœæ—¶çš„è§†è§‰åé¦ˆ */
        .module-logs:hover {
            border-color: #333;
            background-color: rgba(255, 255, 255, 0.02);
        }

        /* è·å¾—ç„¦ç‚¹æ—¶çš„è§†è§‰åé¦ˆ */
        .module-logs:focus {
            border-color: #00ffff;
            background-color: rgba(0, 255, 255, 0.05);
            box-shadow: 0 0 0 2px rgba(0, 255, 255, 0.2);
        }

        /* æ»šåŠ¨æç¤ºæ ·å¼ */
        .scroll-hint {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 255, 255, 0.8);
            color: #000;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 10;
        }

        .module-logs:focus .scroll-hint {
            opacity: 1;
        }

        .log-entry {
            margin-bottom: 3px;
            word-wrap: break-word;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }

        .log-entry:hover {
            background-color: #2a2a2a;
            transform: translateX(2px);
        }

        .log-entry.active {
            background-color: #333;
            box-shadow: 0 2px 4px rgba(0,255,0,0.3);
        }

        /* æ—¥å¿—çº§åˆ«é¢œè‰² - åªç”¨è¾¹æ¡†é¢œè‰²åŒºåˆ† */
        .log-level-INFO { border-left-color: #00ff00; }
        .log-level-WARN { border-left-color: #ffff00; }
        .log-level-ERROR { border-left-color: #ff0000; }
        .log-level-DEBUG { border-left-color: #00ffff; }

        /* èšåˆæ—¥å¿—æ ·å¼ */
        .aggregated-log {
            border-left: 3px solid #4dabf7 !important;
            background: rgba(77, 171, 247, 0.1);
        }

        .aggregated-log .log-message {
            font-weight: 500;
        }

        .aggregated-log:hover {
            background: rgba(77, 171, 247, 0.2);
        }

        .log-message {
            color: #cccccc;
            font-size: 13px;
            /* é™åˆ¶æœ€å¤šæ˜¾ç¤º1è¡Œ */
            display: -webkit-box;
            -webkit-line-clamp: 1;
            line-clamp: 1; /* æ ‡å‡†å±æ€§ */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4;
            max-height: calc(1.4em * 1); /* 1è¡Œçš„é«˜åº¦ */
            word-wrap: break-word;
            word-break: break-word;
        }

        /* èšåˆæ—¥å¿—æ ·å¼ */
        .aggregated-log {
            background-color: #1a1a2e !important;
            border-left-width: 6px !important;
        }

        .aggregated-log:hover {
            background-color: #2a2a3e !important;
        }

        .aggregated-log .log-message {
            font-weight: bold;
            color: #ffffff;
            /* èšåˆæ—¥å¿—ä¹Ÿé™åˆ¶1è¡Œæ˜¾ç¤º */
            display: -webkit-box;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4;
            max-height: calc(1.4em * 1);
            word-wrap: break-word;
            word-break: break-word;
        }

        /* æ—¥å¿—ç§»åŠ¨åŠ¨ç”» */

        .log-updated {
            background-color: #2a4a2a !important;
            animation: logUpdate 0.5s ease-out;
        }

        @keyframes logUpdate {
            0% {
                background-color: #4a6a4a;
                transform: scale(1.02);
            }
            100% {
                background-color: #2a4a2a;
                transform: scale(1);
            }
        }

        /* åŸå§‹JSONå±•å¼€æ ·å¼ */
        .raw-json {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
            margin-bottom: 6px;
        }

        .raw-json.expanded {
            max-height: 300px;
        }

        .json-container {
            background-color: #000;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 8px;
            margin-top: 4px;
        }

        .json-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 6px;
            color: #00ff00;
            font-size: 12px;
        }

        .json-close {
            color: #666;
            cursor: pointer;
            font-size: 14px;
            margin-left: auto;
        }

        .json-close:hover {
            color: #fff;
        }

        .json-content {
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.4;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        /* åŠ¨æ€æ¨¡å—æ ·å¼ */
        .module-title { color: #00ffff; }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .module-logs::-webkit-scrollbar {
            width: 6px;
        }

        .module-logs::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .module-logs::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        .connection-status {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
        }

        .connected { background-color: #006600; color: #00ff00; }
        .disconnected { background-color: #660000; color: #ff0000; }

        /* æ¨¡å—åç§°æ˜¾ç¤ºåŒºåŸŸæ ·å¼ */
        .module-names-section {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 5px;
            background-color: #0a0a0a;
        }

        .module-names-header {
            color: #00ffff;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }





        /* é¡¶éƒ¨å¤åˆ¶æŒ‰é’® */
        .header-copy-button {
            background-color: #ff6600;
            color: #ffffff;
            border: 2px solid #ff8833;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Consolas', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(255, 102, 0, 0.4);
            margin-left: 15px;
        }

        .header-copy-button:hover {
            background-color: #ff8833;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(255, 102, 0, 0.6);
        }

        .header-copy-button.copied {
            background-color: #44ff44;
            color: #000000;
            border-color: #66ff66;
        }

        /* é¡¶éƒ¨åˆ‡æ¢æŒ‰é’® */
        .header-toggle-button {
            background-color: #0066ff;
            color: #ffffff;
            border: 2px solid #3388ff;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Consolas', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 102, 255, 0.4);
            margin-left: 10px;
        }

        .header-toggle-button:hover {
            background-color: #3388ff;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 102, 255, 0.6);
        }

        .header-toggle-button.active {
            background-color: #44ff44;
            color: #000000;
            border-color: #66ff66;
            box-shadow: 0 2px 6px rgba(68, 255, 68, 0.4);
        }



        .module-names-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 30px;
            align-items: center;
        }

        .module-name-tag {
            background-color: #1a4a1a;
            color: #00ff00;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-family: 'Consolas', monospace;
            cursor: pointer;
            border: 1px solid #006600;
            transition: all 0.2s ease;
        }

        .module-name-tag:hover {
            background-color: #2a5a2a;
            border-color: #00ff00;
            transform: scale(1.05);
        }

        .module-name-tag.copied {
            background-color: #4a4a1a;
            color: #ffff00;
            border-color: #ffff00;
        }

        .no-modules {
            color: #666;
            font-style: italic;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">è¿æ¥ä¸­...</div>
    
    <div class="header">
        <h1>Kçº¿èšåˆç³»ç»Ÿ - æ¨¡å—ç›‘æ§ v3.11</h1>
            <button class="header-copy-button" id="header-copy-modules" title="å¤åˆ¶æ‰€æœ‰æ¨¡å—åç§°">ğŸ”¥ å¤åˆ¶å…¨éƒ¨æ¨¡å—</button>
            <button class="header-toggle-button" id="toggle-realtime-logs" title="æ˜¾ç¤º/éšè—å®æ—¶åŸå§‹æ—¥å¿—">ğŸ“Š æ˜¾ç¤ºå®æ—¶åŸå§‹æ—¥å¿—</button>
        </h1>
        <div class="system-status">
            è¿è¡Œæ—¶é—´: <span id="uptime">--:--:--</span> |
            å¥åº·åˆ†æ•°: <span id="health-score">--%</span> |
            éªŒè¯äº‹ä»¶: <span id="validation-events">--</span> |
            æ€§èƒ½ç›‘æ§: <span id="performance-spans">--</span>
        </div>

        <!-- æ¨¡å—åç§°æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="module-names-section">
            <div class="module-names-header">
                <span>ğŸ“‹ æ£€æµ‹åˆ°çš„æ¨¡å—åç§° (ç‚¹å‡»å•ä¸ªå¤åˆ¶):</span>
            </div>
            <div class="module-names-list" id="module-names-list">
                <span class="no-modules">æš‚æ— æ¨¡å—æ•°æ®</span>
            </div>
        </div>
    </div>

    <div class="modules-container">
        <!-- å®æ—¶åŸå§‹æ—¥å¿—æ¨¡å— (é»˜è®¤éšè—) -->
        <div class="module" id="realtime-logs-module" style="display: none;">
            <div class="module-header">
                <div class="module-title">å®æ—¶åŸå§‹æ—¥å¿— (RealtimeLogs)</div>
                <div class="module-status status-waiting" id="realtime-logs-status">ç­‰å¾…æ—¥å¿—</div>
            </div>
            <div class="module-stats">
                <div class="stat-line">
                    <span>å®æ—¶æ—¥å¿—æ•°:</span>
                    <span id="realtime-log-count">0</span>
                </div>
                <div class="stat-line">
                    <span>æœ€åæ›´æ–°:</span>
                    <span id="last-log-time">--:--:--</span>
                </div>
                <div class="stat-line">
                    <span>æ—¥å¿—é¢‘ç‡:</span>
                    <span id="log-frequency">-- æ¡/ç§’</span>
                </div>
            </div>
            <div class="module-logs" id="realtime-logs-display" tabindex="0" title="ç‚¹å‡»è·å¾—ç„¦ç‚¹ï¼Œç„¶åæ»šåŠ¨æŸ¥çœ‹å†å²æ—¥å¿—">
                <div class="scroll-hint">å¯æ»šåŠ¨</div>
                <div class="log-entry">ç­‰å¾…å®æ—¶æ—¥å¿—æ•°æ®...</div>
            </div>
        </div>

        <!-- åŸå§‹æ—¥å¿—ä½é¢‘å¿«ç…§æ¨¡å— -->
        <div class="module" id="raw-logs-module">
            <div class="module-header">
                <div class="module-title">åŸå§‹æ—¥å¿—é«˜é¢‘æŠ˜å  (RawLogSnapshot)</div>
                <div class="module-status status-waiting" id="raw-logs-status">ç­‰å¾…æŠ˜å </div>
            </div>
            <div class="module-stats">
                <div class="stat-line">
                    <span>æŠ˜å æ—¶é—´:</span>
                    <span id="snapshot-timestamp">--:--:--</span>
                </div>
                <div class="stat-line">
                    <span>åŸå§‹æ—¥å¿—æ•°:</span>
                    <span id="total-log-count">--</span>
                </div>
                <div class="stat-line">
                    <span>æŠ˜å åæ¡æ•°:</span>
                    <span id="displayed-log-count">--</span>
                </div>
            </div>
            <div class="module-logs" id="raw-logs-display" tabindex="0" title="ç‚¹å‡»è·å¾—ç„¦ç‚¹ï¼Œç„¶åæ»šåŠ¨æŸ¥çœ‹å†å²æ—¥å¿—">
                <div class="scroll-hint">å¯æ»šåŠ¨</div>
                <button onclick="diagnoseContainer('raw-logs-display')" style="position: absolute; top: 25px; right: 5px; z-index: 20; padding: 2px 6px; font-size: 10px; background: #ff00ff; color: white; border: none; border-radius: 3px;">è¯Šæ–­å®¹å™¨</button>
                <div class="log-entry">ç­‰å¾…æ—¥å¿—å¿«ç…§æ•°æ®...</div>
            </div>
        </div>

        <!-- åŠ¨æ€æ¨¡å—å°†åœ¨è¿™é‡Œåˆ›å»º -->
    </div>





    <script>
        // WebSocketè¿æ¥
        let ws = null;
        let reconnectInterval = null;

        // ç®€åŒ–çš„å‰ç«¯çŠ¶æ€ç®¡ç†ï¼ˆç§»é™¤å¤æ‚èšåˆé€»è¾‘ï¼‰
        let createdModules = new Set();
        let moduleHistoryPages = {}; // è®°å½•æ¯ä¸ªæ¨¡å—çš„å†å²æ•°æ®é¡µç 
        let moduleLoadingHistory = {}; // è®°å½•æ¯ä¸ªæ¨¡å—æ˜¯å¦æ­£åœ¨åŠ è½½å†å²æ•°æ®
        let moduleHasMoreHistory = {}; // è®°å½•æ¯ä¸ªæ¨¡å—æ˜¯å¦è¿˜æœ‰æ›´å¤šå†å²æ•°æ®

        // ç„¦ç‚¹çŠ¶æ€ç®¡ç†
        let moduleFocusStates = {}; // è®°å½•æ¯ä¸ªæ¨¡å—çš„ç„¦ç‚¹çŠ¶æ€
        let moduleAutoScrollStates = {}; // è®°å½•æ¯ä¸ªæ¨¡å—æ˜¯å¦åº”è¯¥è‡ªåŠ¨æ»šåŠ¨



        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('ğŸ”— WebSocketå·²è¿æ¥');
                updateConnectionStatus(true);
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };
            
            ws.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);

                    // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯
                    if (message.type === 'DashboardUpdate') {
                        // å¤„ç†èšåˆä»ªè¡¨æ¿æ•°æ®ï¼ˆç»Ÿä¸€æ ¼å¼ï¼‰
                        updateDashboardWithAggregatedData(message.data);
                    } else if (message.type === 'LogEntry') {
                        // å¤„ç†å•ä¸ªæ—¥å¿—æ¡ç›®ï¼ˆä»…ç”¨äºå®æ—¶æ—¥å¿—æ˜¾ç¤ºï¼‰
                        const logEntry = message.data;
                        addLogEntryToRealtimeDisplay(logEntry);
                    } else {
                        console.log('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', message.type);
                    }
                } catch (e) {
                    console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', e);
                }
            };
            
            ws.onclose = function() {
                console.log('WebSocketè¿æ¥å·²å…³é—­');
                updateConnectionStatus(false);
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(connectWebSocket, 5000);
                }
            };
            
            ws.onerror = function(error) {
                console.error('WebSocketé”™è¯¯:', error);
                updateConnectionStatus(false);
            };
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');

            if (connected) {
                statusEl.textContent = 'å·²è¿æ¥';
                statusEl.className = 'connection-status connected';
            } else {
                statusEl.textContent = 'è¿æ¥æ–­å¼€';
                statusEl.className = 'connection-status disconnected';
            }
        }

        // æ—§ç‰ˆæœ¬çš„ addLogEntryToRealtimeDisplay å‡½æ•°å·²ç§»é™¤ï¼Œä½¿ç”¨æ–‡ä»¶æœ«å°¾çš„æ–°ç‰ˆæœ¬ï¼ˆåŒ…å«ç„¦ç‚¹é€»è¾‘ï¼‰







        // å¤„ç†èšåˆä»ªè¡¨æ¿æ•°æ®
        function updateDashboardWithAggregatedData(data) {

            // æ›´æ–°ç³»ç»ŸçŠ¶æ€
            updateSystemStatusFromAggregatedData(data);

            // æ›´æ–°å®æ—¶æ—¥å¿—
            updateRealtimeLogsFromAggregatedData(data.realtime_log_data);

            // æ›´æ–°åŸå§‹æ—¥å¿—å¿«ç…§
            updateRawLogSnapshotFromAggregatedData(data.raw_log_snapshot);

            // æ›´æ–°æ¨¡å—æ—¥å¿—ï¼ˆä½¿ç”¨åç«¯èšåˆæ•°æ®ï¼‰
            if (data.module_logs) {
                updateModuleLogsFromAggregatedData(data.module_logs);
            }
        }

        // ç§»é™¤æ—§çš„updateDashboardå‡½æ•°ï¼Œç»Ÿä¸€ä½¿ç”¨updateDashboardWithAggregatedData









        // ä»æ—¥å¿—è¡Œä¸­æå–æ¶ˆæ¯
        function extractMessageFromLogLine(logLine) {
            try {
                // é¦–å…ˆå°è¯•è§£æä¸ºJSON
                const jsonLog = JSON.parse(logLine);
                if (jsonLog.message) {
                    return jsonLog.message;
                }
            } catch (e) {
                // å¦‚æœä¸æ˜¯JSONï¼Œå°è¯•ä»æ–‡æœ¬æ ¼å¼ä¸­æå–
                // æ ¼å¼é€šå¸¸æ˜¯: [æ—¶é—´æˆ³] LEVEL target: message
                const parts = logLine.split(': ');
                if (parts.length > 1) {
                    return parts.slice(1).join(': ').trim();
                }

                // å¦‚æœæ²¡æœ‰å†’å·ï¼Œå°è¯•å…¶ä»–åˆ†éš”ç¬¦
                const bracketParts = logLine.split('] ');
                if (bracketParts.length > 1) {
                    return bracketParts.slice(1).join('] ').trim();
                }
            }

            // å¦‚æœéƒ½å¤±è´¥äº†ï¼Œè¿”å›æ•´è¡Œï¼ˆä½†è¿™ä¸åº”è¯¥å‘ç”Ÿï¼‰
            return logLine.trim();
        }

        // ä»æ—¥å¿—è¡Œä¸­æå–çº§åˆ«
        function extractLevelFromLogLine(logLine) {
            try {
                // é¦–å…ˆå°è¯•è§£æä¸ºJSON
                const jsonLog = JSON.parse(logLine);
                if (jsonLog.level) {
                    return jsonLog.level.toUpperCase();
                }
            } catch (e) {
                // å¦‚æœä¸æ˜¯JSONï¼Œä»æ–‡æœ¬ä¸­æŸ¥æ‰¾çº§åˆ«
                if (logLine.includes('ERROR')) return 'ERROR';
                if (logLine.includes('WARN')) return 'WARN';
                if (logLine.includes('INFO')) return 'INFO';
                if (logLine.includes('DEBUG')) return 'DEBUG';
                if (logLine.includes('TRACE')) return 'TRACE';
            }
            return 'INFO';
        }

        // è·Ÿè¸ªå·²åˆ›å»ºçš„æ¨¡å—ï¼ˆå·²åœ¨ä¸Šé¢å£°æ˜ï¼‰

        function getModuleContainerId(moduleName) {
            // å°†æ¨¡å—åè½¬æ¢ä¸ºæœ‰æ•ˆçš„HTML ID
            return 'module-' + moduleName.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
        }

        function ensureModuleContainer(moduleName) {
            if (createdModules.has(moduleName)) {
                return; // æ¨¡å—å·²å­˜åœ¨
            }

            console.log('ğŸ†• åˆ›å»ºæ¨¡å—:', moduleName);
            const containerId = getModuleContainerId(moduleName);
            const logsId = containerId + '-logs';

            // åˆ›å»ºæ¨¡å—å®¹å™¨
            const moduleDiv = document.createElement('div');
            moduleDiv.className = 'module';
            moduleDiv.innerHTML = `
                <div class="module-header">
                    <div class="module-title">${moduleName}</div>
                    <div class="module-status status-running" id="${containerId}-status">è¿è¡Œä¸­</div>
                </div>
                <div class="module-stats">
                    <div class="stat-line">
                        <span>æ€»æ—¥å¿—æ•°:</span>
                        <span id="${containerId}-total">0</span>
                    </div>
                    <div class="stat-line">
                        <span>é”™è¯¯æ•°:</span>
                        <span id="${containerId}-errors">0</span>
                    </div>
                    <div class="stat-line">
                        <span>æœ€åæ›´æ–°:</span>
                        <span id="${containerId}-last-update">--:--:--</span>
                    </div>
                </div>
                <div class="module-logs" id="${logsId}" tabindex="0" title="ç‚¹å‡»è·å¾—ç„¦ç‚¹ï¼Œç„¶åæ»šåŠ¨æŸ¥çœ‹å†å²æ—¥å¿—">
                    <div class="scroll-hint">å¯æ»šåŠ¨</div>
                    <button onclick="testScroll('${logsId}')" style="position: absolute; top: 25px; right: 5px; z-index: 20; padding: 2px 6px; font-size: 10px; background: #ff6600; color: white; border: none; border-radius: 3px;">æµ‹è¯•æ»šåŠ¨</button>
                    <button onclick="addTestContent('${logsId}')" style="position: absolute; top: 45px; right: 5px; z-index: 20; padding: 2px 6px; font-size: 10px; background: #00ff00; color: black; border: none; border-radius: 3px;">æ·»åŠ æµ‹è¯•å†…å®¹</button>
                    <button onclick="diagnoseContainer('${logsId}')" style="position: absolute; top: 65px; right: 5px; z-index: 20; padding: 2px 6px; font-size: 10px; background: #ff00ff; color: white; border: none; border-radius: 3px;">è¯Šæ–­å®¹å™¨</button>
                    <div class="log-entry">ç­‰å¾…æ—¥å¿—æ•°æ®...</div>
                </div>
            `;

            // æ·»åŠ åˆ°æ¨¡å—å®¹å™¨ä¸­
            const modulesContainer = document.querySelector('.modules-container');
            modulesContainer.appendChild(moduleDiv);

            // ä¸ºæ–°åˆ›å»ºçš„æ—¥å¿—å®¹å™¨ç»‘å®šæ»šåŠ¨äº‹ä»¶
            const logsContainer = moduleDiv.querySelector('.module-logs');
            if (logsContainer) {
                // åˆå§‹åŒ–æ¨¡å—ç„¦ç‚¹çŠ¶æ€
                moduleFocusStates[moduleName] = false;
                moduleAutoScrollStates[moduleName] = true; // é»˜è®¤å¯ç”¨è‡ªåŠ¨æ»šåŠ¨

                // ç‚¹å‡»è·å¾—ç„¦ç‚¹ï¼Œä½¿é¼ æ ‡æ»šè½®èƒ½å¤Ÿæ­£å¸¸å·¥ä½œ
                logsContainer.addEventListener('click', function(event) {
                    // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯æ—¥å¿—æ¡ç›®ï¼Œåˆ™è·å¾—ç„¦ç‚¹
                    if (!event.target.closest('.log-entry')) {
                        logsContainer.focus();
                        console.log(`ğŸ¯ æ¨¡å— [${moduleName}] ç‚¹å‡»è·å¾—ç„¦ç‚¹`, {
                            hasFocus: document.activeElement === logsContainer,
                            tabIndex: logsContainer.tabIndex,
                            canScroll: logsContainer.scrollHeight > logsContainer.clientHeight
                        });
                    }
                });

                // é¼ æ ‡è¿›å…¥æ—¶è‡ªåŠ¨è·å¾—ç„¦ç‚¹ï¼ˆæ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼‰
                logsContainer.addEventListener('mouseenter', function(event) {
                    logsContainer.focus();
                    console.log(`ğŸ–±ï¸ æ¨¡å— [${moduleName}] é¼ æ ‡è¿›å…¥è·å¾—ç„¦ç‚¹`, {
                        hasFocus: document.activeElement === logsContainer,
                        tabIndex: logsContainer.tabIndex,
                        canScroll: logsContainer.scrollHeight > logsContainer.clientHeight
                    });
                });

                // ç„¦ç‚¹è·å¾—äº‹ä»¶
                logsContainer.addEventListener('focus', function(event) {
                    moduleFocusStates[moduleName] = true;
                    moduleAutoScrollStates[moduleName] = false; // æœ‰ç„¦ç‚¹æ—¶ç¦ç”¨è‡ªåŠ¨æ»šåŠ¨
                    console.log(`ğŸ¯ æ¨¡å— [${moduleName}] è·å¾—ç„¦ç‚¹ - ç¦ç”¨è‡ªåŠ¨æ»šåŠ¨`);
                });

                // ç„¦ç‚¹å¤±å»äº‹ä»¶
                logsContainer.addEventListener('blur', function(event) {
                    moduleFocusStates[moduleName] = false;
                    moduleAutoScrollStates[moduleName] = true; // å¤±å»ç„¦ç‚¹æ—¶å¯ç”¨è‡ªåŠ¨æ»šåŠ¨
                    console.log(`ğŸ¯ æ¨¡å— [${moduleName}] å¤±å»ç„¦ç‚¹ - å¯ç”¨è‡ªåŠ¨æ»šåŠ¨`);
                });

                // æ·»åŠ è¯¦ç»†çš„æ»šåŠ¨äº‹ä»¶æ—¥å¿—
                logsContainer.addEventListener('wheel', function(event) {
                    const canScroll = logsContainer.scrollHeight > logsContainer.clientHeight;
                    console.log(`ğŸ–±ï¸ æ¨¡å— [${moduleName}] é¼ æ ‡æ»šè½®äº‹ä»¶:`, {
                        deltaY: event.deltaY,
                        deltaX: event.deltaX,
                        target: event.target.tagName,
                        scrollTop: logsContainer.scrollTop,
                        scrollHeight: logsContainer.scrollHeight,
                        clientHeight: logsContainer.clientHeight,
                        canScroll: canScroll
                    });

                    // æ‰‹åŠ¨å¤„ç†æ»šåŠ¨ï¼Œç¡®ä¿æ»šåŠ¨äº‹ä»¶è¢«è§¦å‘
                    if (canScroll) {
                        const currentScrollTop = logsContainer.scrollTop;
                        const scrollAmount = event.deltaY * 0.5; // è°ƒæ•´æ»šåŠ¨é€Ÿåº¦
                        const newScrollTop = Math.max(0, Math.min(
                            logsContainer.scrollHeight - logsContainer.clientHeight,
                            currentScrollTop + scrollAmount
                        ));

                        console.log(`ğŸ”„ æ¨¡å— [${moduleName}] æ‰‹åŠ¨æ»šåŠ¨: ${currentScrollTop} -> ${newScrollTop}`);
                        logsContainer.scrollTop = newScrollTop;

                        // æ‰‹åŠ¨è§¦å‘æ»šåŠ¨äº‹ä»¶
                        const scrollEvent = new Event('scroll', { bubbles: true });
                        logsContainer.dispatchEvent(scrollEvent);
                    }

                    // é˜»æ­¢é»˜è®¤æ»šåŠ¨å’Œäº‹ä»¶å†’æ³¡
                    event.preventDefault();
                    event.stopPropagation();
                });

                // é˜»æ­¢è§¦æ‘¸æ»šåŠ¨äº‹ä»¶å†’æ³¡ï¼ˆç§»åŠ¨è®¾å¤‡æ”¯æŒï¼‰
                logsContainer.addEventListener('touchmove', function(event) {
                    console.log(`ğŸ‘† æ¨¡å— [${moduleName}] è§¦æ‘¸æ»šåŠ¨äº‹ä»¶`);
                    event.stopPropagation();
                });

                // æ·»åŠ æ»šåŠ¨äº‹ä»¶ç›‘å¬å™¨ï¼Œç”¨äºåŠ è½½å†å²æ•°æ®
                logsContainer.addEventListener('scroll', function(event) {
                    console.log(`ğŸ“œ æ¨¡å— [${moduleName}] æ»šåŠ¨äº‹ä»¶:`, {
                        scrollTop: logsContainer.scrollTop,
                        scrollHeight: logsContainer.scrollHeight,
                        clientHeight: logsContainer.clientHeight,
                        canScrollMore: logsContainer.scrollHeight > logsContainer.clientHeight
                    });
                    handleModuleScroll(event, moduleName, logsContainer);
                });
            }

            createdModules.add(moduleName);
        }

        // æ›´æ–°æ¨¡å—åç§°åˆ—è¡¨ï¼ˆä»èšåˆæ•°æ®ä¸­æå–ï¼‰
        function updateModuleNamesFromAggregatedData(moduleLogs) {
            const moduleNames = Object.keys(moduleLogs || {});
            updateModuleNamesList(moduleNames);
        }





        // è·Ÿè¸ªå½“å‰å±•å¼€çš„æ—¥å¿—
        let activeLogId = null;

        // æµ‹è¯•æ»šåŠ¨å‡½æ•°
        function testScroll(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                console.log(`ğŸ§ª æµ‹è¯•æ»šåŠ¨ [${containerId}]:`, {
                    scrollTop: container.scrollTop,
                    scrollHeight: container.scrollHeight,
                    clientHeight: container.clientHeight,
                    canScroll: container.scrollHeight > container.clientHeight,
                    hasFocus: document.activeElement === container,
                    tabIndex: container.tabIndex
                });

                // æ‰‹åŠ¨è§¦å‘æ»šåŠ¨åˆ°é¡¶éƒ¨
                container.scrollTop = 0;
                console.log(`ğŸ§ª æ‰‹åŠ¨æ»šåŠ¨åˆ°é¡¶éƒ¨å:`, {
                    scrollTop: container.scrollTop
                });

                // æ‰‹åŠ¨è§¦å‘æ»šåŠ¨äº‹ä»¶
                const scrollEvent = new Event('scroll', { bubbles: true });
                container.dispatchEvent(scrollEvent);
                console.log(`ğŸ§ª æ‰‹åŠ¨è§¦å‘æ»šåŠ¨äº‹ä»¶å®Œæˆ`);
            } else {
                console.error(`ğŸ§ª æ‰¾ä¸åˆ°å®¹å™¨: ${containerId}`);
            }
        }

        // æ·»åŠ æµ‹è¯•å†…å®¹å‡½æ•°
        function addTestContent(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                console.log(`ğŸ§ª ä¸ºå®¹å™¨ [${containerId}] æ·»åŠ æµ‹è¯•å†…å®¹`);

                // æ¸…ç©ºç°æœ‰å†…å®¹
                container.innerHTML = `
                    <div class="scroll-hint">å¯æ»šåŠ¨</div>
                    <button onclick="testScroll('${containerId}')" style="position: absolute; top: 25px; right: 5px; z-index: 20; padding: 2px 6px; font-size: 10px; background: #ff6600; color: white; border: none; border-radius: 3px;">æµ‹è¯•æ»šåŠ¨</button>
                    <button onclick="addTestContent('${containerId}')" style="position: absolute; top: 45px; right: 5px; z-index: 20; padding: 2px 6px; font-size: 10px; background: #00ff00; color: black; border: none; border-radius: 3px;">æ·»åŠ æµ‹è¯•å†…å®¹</button>
                    <button onclick="diagnoseContainer('${containerId}')" style="position: absolute; top: 65px; right: 5px; z-index: 20; padding: 2px 6px; font-size: 10px; background: #ff00ff; color: white; border: none; border-radius: 3px;">è¯Šæ–­å®¹å™¨</button>
                `;

                // æ·»åŠ 50æ¡æµ‹è¯•æ—¥å¿—
                for (let i = 1; i <= 50; i++) {
                    const logEntry = document.createElement('div');
                    logEntry.className = 'log-entry log-level-INFO';
                    logEntry.innerHTML = `<div class="log-message">æµ‹è¯•æ—¥å¿—æ¡ç›® ${i} - è¿™æ˜¯ä¸€æ¡ç”¨äºæµ‹è¯•æ»šåŠ¨åŠŸèƒ½çš„æ—¥å¿—</div>`;
                    container.appendChild(logEntry);
                }

                // å­˜å‚¨æµ‹è¯•æ•°æ®åˆ°å®¹å™¨å±æ€§
                const testLogs = [];
                for (let i = 1; i <= 100; i++) {
                    testLogs.push({
                        message: `å†å²æµ‹è¯•æ—¥å¿— ${i} - è¿™æ˜¯å†å²æ•°æ®`,
                        level: 'INFO',
                        timestamp: new Date().toISOString(),
                        is_aggregated: false
                    });
                }
                container.setAttribute('data-all-logs', JSON.stringify(testLogs));
                container.setAttribute('data-current-display-count', '50');

                console.log(`ğŸ§ª æ·»åŠ å®Œæˆï¼Œå®¹å™¨ç°åœ¨å¯ä»¥æ»šåŠ¨:`, {
                    scrollHeight: container.scrollHeight,
                    clientHeight: container.clientHeight,
                    canScroll: container.scrollHeight > container.clientHeight,
                    totalTestLogs: testLogs.length
                });
            } else {
                console.error(`ğŸ§ª æ‰¾ä¸åˆ°å®¹å™¨: ${containerId}`);
            }
        }

        // è¯Šæ–­å®¹å™¨å‡½æ•°
        function diagnoseContainer(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                const computedStyle = window.getComputedStyle(container);
                const children = Array.from(container.children);

                console.log(`ğŸ” å®¹å™¨ [${containerId}] è¯Šæ–­æŠ¥å‘Š:`);
                console.log(`ğŸ“ å°ºå¯¸ä¿¡æ¯:`, {
                    scrollHeight: container.scrollHeight,
                    clientHeight: container.clientHeight,
                    offsetHeight: container.offsetHeight,
                    scrollWidth: container.scrollWidth,
                    clientWidth: container.clientWidth,
                    offsetWidth: container.offsetWidth
                });
                console.log(`ğŸ¨ CSSæ ·å¼:`, {
                    height: computedStyle.height,
                    maxHeight: computedStyle.maxHeight,
                    minHeight: computedStyle.minHeight,
                    overflowY: computedStyle.overflowY,
                    overflowX: computedStyle.overflowX,
                    display: computedStyle.display,
                    position: computedStyle.position,
                    boxSizing: computedStyle.boxSizing
                });
                console.log(`ğŸ‘¶ å­å…ƒç´ ä¿¡æ¯:`, {
                    childCount: children.length,
                    childTypes: children.map(child => child.tagName + '.' + child.className),
                    totalChildHeight: children.reduce((sum, child) => sum + child.offsetHeight, 0)
                });
                console.log(`ğŸ”„ æ»šåŠ¨çŠ¶æ€:`, {
                    canScroll: container.scrollHeight > container.clientHeight,
                    scrollTop: container.scrollTop,
                    maxScrollTop: container.scrollHeight - container.clientHeight,
                    hasScrollbar: container.scrollHeight > container.clientHeight
                });
            } else {
                console.error(`ğŸ” æ‰¾ä¸åˆ°å®¹å™¨: ${containerId}`);
            }
        }

        // å¤„ç†æ¨¡å—æ»šåŠ¨äº‹ä»¶ï¼ŒåŠ è½½æ›´å¤šæ˜¾ç¤ºæ•°æ®
        function handleModuleScroll(event, moduleName, container) {
            // æ£€æŸ¥æ˜¯å¦æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼ˆå…è®¸5pxè¯¯å·®ï¼‰
            if (container.scrollTop <= 5) {
                console.log(`ğŸ”„ æ¨¡å— [${moduleName}] æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼ŒscrollTop: ${container.scrollTop}`);
                loadMoreDisplayLogsForModule(moduleName, container);
            }
        }

        // ä¸ºæŒ‡å®šæ¨¡å—åŠ è½½æ›´å¤šæ˜¾ç¤ºæ•°æ®ï¼ˆä»æœ¬åœ°æ•°æ®ï¼‰
        function loadMoreDisplayLogsForModule(moduleName, container) {
            // é˜²æ­¢é‡å¤åŠ è½½
            if (moduleLoadingHistory[moduleName]) {
                return;
            }

            // è·å–å­˜å‚¨çš„å®Œæ•´æ•°æ®
            const allLogsJson = container.getAttribute('data-all-logs');
            if (!allLogsJson) {
                console.log(`â„¹ï¸ æ¨¡å— [${moduleName}] æ²¡æœ‰æ›´å¤šæ•°æ®`);
                return;
            }

            const allLogs = JSON.parse(allLogsJson);
            const currentDisplayCount = parseInt(container.getAttribute('data-current-display-count') || '20');

            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
            if (currentDisplayCount >= allLogs.length) {
                console.log(`â„¹ï¸ æ¨¡å— [${moduleName}] å·²æ˜¾ç¤ºæ‰€æœ‰æ•°æ®`);
                return;
            }

            moduleLoadingHistory[moduleName] = true;

            try {
                console.log(`ğŸ“œ åŠ è½½æ¨¡å— [${moduleName}] çš„æ›´å¤šæ˜¾ç¤ºæ•°æ®ï¼Œå½“å‰: ${currentDisplayCount}/${allLogs.length}`);

                // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                showLoadingIndicator(container);

                // æ¨¡æ‹Ÿå¼‚æ­¥åŠ è½½ï¼ˆç»™ç”¨æˆ·åé¦ˆï¼‰
                setTimeout(() => {
                    const nextBatchSize = 20;
                    const nextDisplayCount = Math.min(currentDisplayCount + nextBatchSize, allLogs.length);
                    const newLogs = allLogs.slice(currentDisplayCount, nextDisplayCount);

                    if (newLogs.length > 0) {
                        prependDisplayLogsToContainer(container, newLogs, moduleName, currentDisplayCount);
                        container.setAttribute('data-current-display-count', nextDisplayCount.toString());
                        console.log(`âœ… æˆåŠŸåŠ è½½ ${newLogs.length} æ¡æ˜¾ç¤ºæ—¥å¿—`);

                        // æ›´æ–°"åŠ è½½æ›´å¤š"æç¤º
                        updateLoadMoreIndicator(container, allLogs.length, nextDisplayCount);
                    }

                    moduleLoadingHistory[moduleName] = false;
                    hideLoadingIndicator(container);
                }, 100); // 100mså»¶è¿Ÿï¼Œç»™ç”¨æˆ·åé¦ˆ

            } catch (error) {
                console.error(`âŒ åŠ è½½æ¨¡å— [${moduleName}] æ˜¾ç¤ºæ•°æ®å¤±è´¥:`, error);
                moduleLoadingHistory[moduleName] = false;
                hideLoadingIndicator(container);
            }
        }

        // åœ¨å®¹å™¨é¡¶éƒ¨æ·»åŠ æ˜¾ç¤ºæ—¥å¿—
        function prependDisplayLogsToContainer(container, newLogs, moduleName, startIndex) {
            const containerId = getModuleContainerId(moduleName);
            const fragment = document.createDocumentFragment();

            // è®°å½•å½“å‰æ»šåŠ¨ä½ç½®
            const currentScrollTop = container.scrollTop;
            const currentScrollHeight = container.scrollHeight;

            // ä¸ºæ¯ä¸ªæ–°æ—¥å¿—åˆ›å»ºå…ƒç´ 
            newLogs.forEach((logEntry, index) => {
                const logElement = createAggregatedLogElement(logEntry, containerId, startIndex + index);
                fragment.appendChild(logElement);
            });

            // æ‰¾åˆ°åŠ è½½æ›´å¤šæŒ‡ç¤ºå™¨çš„ä½ç½®ï¼Œåœ¨å®ƒä¹‹å‰æ’å…¥
            const loadMoreIndicator = container.querySelector('.load-more-indicator');
            if (loadMoreIndicator) {
                container.insertBefore(fragment, loadMoreIndicator);
            } else {
                // å¦‚æœæ²¡æœ‰æŒ‡ç¤ºå™¨ï¼Œæ’å…¥åˆ°å®¹å™¨é¡¶éƒ¨
                container.insertBefore(fragment, container.firstChild);
            }

            // è°ƒæ•´æ»šåŠ¨ä½ç½®ï¼Œä¿æŒç”¨æˆ·å½“å‰çš„è§†å›¾
            const newScrollHeight = container.scrollHeight;
            const heightDifference = newScrollHeight - currentScrollHeight;
            container.scrollTop = currentScrollTop + heightDifference;
        }

        // æ›´æ–°"åŠ è½½æ›´å¤š"æŒ‡ç¤ºå™¨
        function updateLoadMoreIndicator(container, totalLogs, currentDisplayCount) {
            const indicator = container.querySelector('.load-more-indicator');
            if (indicator) {
                if (currentDisplayCount >= totalLogs) {
                    indicator.textContent = 'å·²æ˜¾ç¤ºæ‰€æœ‰æ—¥å¿—';
                    indicator.style.cursor = 'default';
                } else {
                    indicator.textContent = `è¿˜æœ‰ ${totalLogs - currentDisplayCount} æ¡æ—¥å¿—ï¼Œæ»šåŠ¨åˆ°é¡¶éƒ¨åŠ è½½æ›´å¤š`;
                }
            }
        }

        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
        function showLoadingIndicator(container) {
            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰åŠ è½½æŒ‡ç¤ºå™¨
            let indicator = container.querySelector('.loading-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.className = 'loading-indicator';
                indicator.style.cssText = `
                    padding: 10px;
                    text-align: center;
                    color: #888;
                    font-size: 12px;
                    border-bottom: 1px solid #333;
                `;
                indicator.textContent = 'â³ åŠ è½½å†å²æ•°æ®...';
                container.insertBefore(indicator, container.firstChild);
            }
        }

        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function hideLoadingIndicator(container) {
            const indicator = container.querySelector('.loading-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // ä¸ºåŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å—åŠ è½½æ›´å¤šæ•°æ®ï¼ˆä¸“ç”¨å‡½æ•°ï¼‰
        function loadMoreDisplayLogsForRawSnapshot(container) {
            const moduleName = 'RawLogSnapshot';

            if (moduleLoadingHistory[moduleName]) {
                console.log(`â³ åŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å—æ­£åœ¨åŠ è½½å†å²æ•°æ®ï¼Œè·³è¿‡é‡å¤è¯·æ±‚`);
                return;
            }

            const allLogsJson = container.getAttribute('data-all-logs');
            if (!allLogsJson) {
                console.log(`âš ï¸ åŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å—æ²¡æœ‰å­˜å‚¨çš„å®Œæ•´æ•°æ®`);
                return;
            }

            const allLogs = JSON.parse(allLogsJson);
            const currentDisplayCount = parseInt(container.getAttribute('data-current-display-count') || '0');

            if (currentDisplayCount >= allLogs.length) {
                console.log(`âœ… åŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å—å·²æ˜¾ç¤ºæ‰€æœ‰æ•°æ® (${currentDisplayCount}/${allLogs.length})`);
                return;
            }

            console.log(`ğŸ”„ åŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å—å¼€å§‹åŠ è½½æ›´å¤šæ•°æ®: å½“å‰æ˜¾ç¤º ${currentDisplayCount}/${allLogs.length}`);

            // è®¾ç½®åŠ è½½çŠ¶æ€
            moduleLoadingHistory[moduleName] = true;
            showLoadingIndicator(container);

            // æ¨¡æ‹Ÿå¼‚æ­¥åŠ è½½ï¼ˆç»™ç”¨æˆ·åé¦ˆï¼‰
            setTimeout(() => {
                const nextBatchSize = 20;
                const nextDisplayCount = Math.min(currentDisplayCount + nextBatchSize, allLogs.length);
                const newLogs = allLogs.slice(currentDisplayCount, nextDisplayCount);

                if (newLogs.length > 0) {
                    // ä¸ºåŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å—æ·»åŠ æ–°çš„æ—¥å¿—å…ƒç´ 
                    prependDisplayLogsToRawSnapshotContainer(container, newLogs, currentDisplayCount);
                    container.setAttribute('data-current-display-count', nextDisplayCount.toString());
                    console.log(`âœ… åŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å—æˆåŠŸåŠ è½½ ${newLogs.length} æ¡æ˜¾ç¤ºæ—¥å¿—`);

                    // æ›´æ–°"åŠ è½½æ›´å¤š"æç¤º
                    updateLoadMoreIndicator(container, allLogs.length, nextDisplayCount);
                }

                moduleLoadingHistory[moduleName] = false;
                hideLoadingIndicator(container);
            }, 100); // 100mså»¶è¿Ÿï¼Œç»™ç”¨æˆ·åé¦ˆ
        }

        // åœ¨åŸå§‹æ—¥å¿—å¿«ç…§å®¹å™¨é¡¶éƒ¨æ·»åŠ æ˜¾ç¤ºæ—¥å¿—ï¼ˆä¸“ç”¨å‡½æ•°ï¼‰
        function prependDisplayLogsToRawSnapshotContainer(container, newLogs, startIndex) {
            const fragment = document.createDocumentFragment();

            // è®°å½•å½“å‰æ»šåŠ¨ä½ç½®
            const currentScrollTop = container.scrollTop;
            const currentScrollHeight = container.scrollHeight;

            // ä¸ºæ¯ä¸ªæ–°æ—¥å¿—åˆ›å»ºå…ƒç´ 
            newLogs.forEach((logEntry, index) => {
                const logElement = createAggregatedLogElement(logEntry, 'raw-logs', startIndex + index);
                fragment.appendChild(logElement);
            });

            // æ‰¾åˆ°åŠ è½½æ›´å¤šæŒ‡ç¤ºå™¨çš„ä½ç½®ï¼Œåœ¨å®ƒä¹‹å‰æ’å…¥
            const loadMoreIndicator = container.querySelector('.load-more-indicator');
            if (loadMoreIndicator) {
                container.insertBefore(fragment, loadMoreIndicator);
            } else {
                // å¦‚æœæ²¡æœ‰æŒ‡ç¤ºå™¨ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ—¥å¿—æ¡ç›®ï¼Œåœ¨å®ƒä¹‹å‰æ’å…¥
                const firstLogEntry = container.querySelector('.log-entry');
                if (firstLogEntry) {
                    container.insertBefore(fragment, firstLogEntry);
                } else {
                    // å¦‚æœæ²¡æœ‰æ—¥å¿—æ¡ç›®ï¼Œç›´æ¥æ·»åŠ åˆ°å®¹å™¨æœ«å°¾
                    container.appendChild(fragment);
                }
            }

            // è°ƒæ•´æ»šåŠ¨ä½ç½®ï¼Œä¿æŒç”¨æˆ·å½“å‰çš„è§†å›¾
            const newScrollHeight = container.scrollHeight;
            const heightDifference = newScrollHeight - currentScrollHeight;
            container.scrollTop = currentScrollTop + heightDifference;
        }



        // åˆ‡æ¢JSONæ˜¾ç¤º
        function toggleJson(logId) {
            // éšè—å…¶ä»–å·²å±•å¼€çš„JSON
            if (activeLogId && activeLogId !== logId) {
                hideJson(activeLogId);
            }

            const jsonDiv = document.getElementById(`json-${logId}`);
            const logEntry = document.querySelector(`[data-log-id="${logId}"]`);

            if (jsonDiv.classList.contains('expanded')) {
                hideJson(logId);
            } else {
                showJson(logId);
            }
        }

        // æ˜¾ç¤ºJSON
        function showJson(logId) {
            const jsonDiv = document.getElementById(`json-${logId}`);
            const logEntry = document.querySelector(`[data-log-id="${logId}"]`);

            if (jsonDiv && logEntry) {
                jsonDiv.classList.add('expanded');
                logEntry.classList.add('active');
                activeLogId = logId;
            }
        }

        // éšè—JSON
        function hideJson(logId) {
            const jsonDiv = document.getElementById(`json-${logId}`);
            const logEntry = document.querySelector(`[data-log-id="${logId}"]`);

            if (jsonDiv && logEntry) {
                jsonDiv.classList.remove('expanded');
                logEntry.classList.remove('active');
                if (activeLogId === logId) {
                    activeLogId = null;
                }
            }
        }

        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // è·å–å½“å‰æ—¶é—´çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²
        function getCurrentTimeString() {
            return new Date().toLocaleTimeString('zh-CN', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // å­˜å‚¨æ¯ä¸ªæ¨¡å—çš„æœ€åæ›´æ–°æ—¶é—´å’Œæ—¥å¿—è®¡æ•°
        let moduleLastUpdateTimes = {};
        let moduleLogCounts = {};

        // è·å–æ—¥å¿—çº§åˆ«ä¼˜å…ˆçº§ï¼ˆç”¨äºæ—§ä»£ç å…¼å®¹ï¼‰
        function getLogLevelPriority(level) {
            const priorities = {
                'TRACE': 1,
                'DEBUG': 2,
                'INFO': 3,
                'WARN': 4,
                'ERROR': 5
            };
            return priorities[level] || 3;
        }

        // å­˜å‚¨å½“å‰çš„æ¨¡å—åç§°åˆ—è¡¨
        let currentModuleNames = [];

        // æ›´æ–°æ¨¡å—åç§°åˆ—è¡¨
        function updateModuleNamesList(moduleNames) {
            const container = document.getElementById('module-names-list');

            // æ›´æ–°å…¨å±€æ¨¡å—åç§°åˆ—è¡¨
            currentModuleNames = moduleNames || [];

            if (!moduleNames || moduleNames.length === 0) {
                container.innerHTML = '<span class="no-modules">æš‚æ— æ¨¡å—æ•°æ®</span>';
                return;
            }

            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';

            // ä¸ºæ¯ä¸ªæ¨¡å—ååˆ›å»ºå¯ç‚¹å‡»çš„æ ‡ç­¾
            moduleNames.forEach(moduleName => {
                const tag = document.createElement('span');
                tag.className = 'module-name-tag';
                tag.textContent = moduleName;
                tag.title = 'ç‚¹å‡»å¤åˆ¶æ¨¡å—åç§°';

                // æ·»åŠ ç‚¹å‡»å¤åˆ¶åŠŸèƒ½
                tag.addEventListener('click', function() {
                    copyToClipboard(moduleName, tag);
                });

                container.appendChild(tag);
            });
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿åŠŸèƒ½
        function copyToClipboard(text, element) {
            navigator.clipboard.writeText(text).then(function() {
                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„è§†è§‰åé¦ˆ
                element.classList.add('copied');
                const originalText = element.textContent;
                element.textContent = 'å·²å¤åˆ¶!';

                setTimeout(function() {
                    element.classList.remove('copied');
                    element.textContent = originalText;
                }, 1000);
            }).catch(function(err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨æ—§çš„å¤åˆ¶æ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    element.classList.add('copied');
                    const originalText = element.textContent;
                    element.textContent = 'å·²å¤åˆ¶!';

                    setTimeout(function() {
                        element.classList.remove('copied');
                        element.textContent = originalText;
                    }, 1000);
                } catch (err) {
                    console.error('é™çº§å¤åˆ¶æ–¹æ³•ä¹Ÿå¤±è´¥:', err);
                }
                document.body.removeChild(textArea);
            });
        }

        // å¤åˆ¶æ‰€æœ‰æ¨¡å—åç§°çš„å‡½æ•°
        function copyAllModuleNames(buttonElement) {
            if (currentModuleNames.length === 0) {
                alert('æš‚æ— æ¨¡å—æ•°æ®å¯å¤åˆ¶');
                return;
            }

            // å°†æ‰€æœ‰æ¨¡å—åç§°ç”¨æ¢è¡Œç¬¦è¿æ¥
            const allModuleNames = currentModuleNames.join('\n');
            const button = buttonElement;

            navigator.clipboard.writeText(allModuleNames).then(function() {
                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„è§†è§‰åé¦ˆ
                button.classList.add('copied');
                const originalText = button.textContent;
                button.textContent = 'âœ… å·²å¤åˆ¶!';

                setTimeout(function() {
                    button.classList.remove('copied');
                    button.textContent = originalText;
                }, 2000);
            }).catch(function(err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨æ—§çš„å¤åˆ¶æ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = allModuleNames;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    button.classList.add('copied');
                    const originalText = button.textContent;
                    button.textContent = 'âœ… å·²å¤åˆ¶!';

                    setTimeout(function() {
                        button.classList.remove('copied');
                        button.textContent = originalText;
                    }, 2000);
                } catch (err) {
                    console.error('é™çº§å¤åˆ¶æ–¹æ³•ä¹Ÿå¤±è´¥:', err);
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶æ¨¡å—åç§°');
                }
                document.body.removeChild(textArea);
            });
        }

        // åˆ‡æ¢å®æ—¶åŸå§‹æ—¥å¿—æ˜¾ç¤º/éšè—
        function toggleRealtimeLogs(buttonElement) {
            const realtimeModule = document.getElementById('realtime-logs-module');
            const button = buttonElement;

            if (!realtimeModule) {
                console.error('æ‰¾ä¸åˆ°å®æ—¶åŸå§‹æ—¥å¿—æ¨¡å—');
                return;
            }

            const isCurrentlyHidden = realtimeModule.style.display === 'none';

            if (isCurrentlyHidden) {
                // æ˜¾ç¤ºæ¨¡å—
                realtimeModule.style.display = '';
                button.classList.add('active');
                button.textContent = 'ğŸ“Š éšè—å®æ—¶åŸå§‹æ—¥å¿—';
                button.title = 'éšè—å®æ—¶åŸå§‹æ—¥å¿—';
            } else {
                // éšè—æ¨¡å—
                realtimeModule.style.display = 'none';
                button.classList.remove('active');
                button.textContent = 'ğŸ“Š æ˜¾ç¤ºå®æ—¶åŸå§‹æ—¥å¿—';
                button.title = 'æ˜¾ç¤ºå®æ—¶åŸå§‹æ—¥å¿—';
            }
        }

        // å®šæœŸæ¸…ç†è¿‡æœŸçŠ¶æ€
        function startCleanup() {
            setInterval(() => {
                // æ¸…ç†è¿‡æœŸçš„å±•å¼€JSONçŠ¶æ€
                if (activeLogId) {
                    const jsonDiv = document.getElementById(`json-${activeLogId}`);
                    if (!jsonDiv) {
                        activeLogId = null;
                    }
                }
            }, 10000); // æ¯10ç§’æ¸…ç†ä¸€æ¬¡
        }



        // é¡µé¢åŠ è½½æ—¶è¿æ¥WebSocketå¹¶ç»‘å®šäº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');
            connectWebSocket();
            startCleanup();

            // ç»‘å®šé¡¶éƒ¨å¤åˆ¶æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            const headerCopyButton = document.getElementById('header-copy-modules');
            if (headerCopyButton) {
                headerCopyButton.addEventListener('click', function() {
                    copyAllModuleNames(this);
                });
            }

            // ç»‘å®šå®æ—¶åŸå§‹æ—¥å¿—åˆ‡æ¢æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            const toggleRealtimeButton = document.getElementById('toggle-realtime-logs');
            if (toggleRealtimeButton) {
                toggleRealtimeButton.addEventListener('click', function() {
                    toggleRealtimeLogs(this);
                });
            }

            // ä¸ºåŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å—ç»‘å®šæ»šåŠ¨äº‹ä»¶å¤„ç†
            const rawLogsDisplay = document.getElementById('raw-logs-display');
            if (rawLogsDisplay) {
                // åˆå§‹åŒ–åŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å—ç„¦ç‚¹çŠ¶æ€
                const rawModuleName = 'RawLogSnapshot';
                moduleFocusStates[rawModuleName] = false;
                moduleAutoScrollStates[rawModuleName] = true; // é»˜è®¤å¯ç”¨è‡ªåŠ¨æ»šåŠ¨

                // ç‚¹å‡»è·å¾—ç„¦ç‚¹ï¼Œä½¿é¼ æ ‡æ»šè½®èƒ½å¤Ÿæ­£å¸¸å·¥ä½œ
                rawLogsDisplay.addEventListener('click', function(event) {
                    if (!event.target.closest('.log-entry')) {
                        rawLogsDisplay.focus();
                        console.log('ğŸ¯ åŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å—è·å¾—ç„¦ç‚¹');
                    }
                });

                // é¼ æ ‡è¿›å…¥æ—¶è‡ªåŠ¨è·å¾—ç„¦ç‚¹
                rawLogsDisplay.addEventListener('mouseenter', function(event) {
                    rawLogsDisplay.focus();
                });

                // ç„¦ç‚¹è·å¾—äº‹ä»¶
                rawLogsDisplay.addEventListener('focus', function(event) {
                    moduleFocusStates[rawModuleName] = true;
                    moduleAutoScrollStates[rawModuleName] = false; // æœ‰ç„¦ç‚¹æ—¶ç¦ç”¨è‡ªåŠ¨æ»šåŠ¨
                    console.log(`ğŸ¯ åŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å—è·å¾—ç„¦ç‚¹ - ç¦ç”¨è‡ªåŠ¨æ»šåŠ¨`);
                });

                // ç„¦ç‚¹å¤±å»äº‹ä»¶
                rawLogsDisplay.addEventListener('blur', function(event) {
                    moduleFocusStates[rawModuleName] = false;
                    moduleAutoScrollStates[rawModuleName] = true; // å¤±å»ç„¦ç‚¹æ—¶å¯ç”¨è‡ªåŠ¨æ»šåŠ¨
                    console.log(`ğŸ¯ åŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å—å¤±å»ç„¦ç‚¹ - å¯ç”¨è‡ªåŠ¨æ»šåŠ¨`);
                });

                // æ·»åŠ è¯¦ç»†çš„æ»šåŠ¨äº‹ä»¶æ—¥å¿—
                rawLogsDisplay.addEventListener('wheel', function(event) {
                    const canScroll = rawLogsDisplay.scrollHeight > rawLogsDisplay.clientHeight;
                    console.log(`ğŸ–±ï¸ åŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å— é¼ æ ‡æ»šè½®äº‹ä»¶:`, {
                        deltaY: event.deltaY,
                        deltaX: event.deltaX,
                        target: event.target.tagName,
                        scrollTop: rawLogsDisplay.scrollTop,
                        scrollHeight: rawLogsDisplay.scrollHeight,
                        clientHeight: rawLogsDisplay.clientHeight,
                        canScroll: canScroll,
                        è®¡ç®—: `${rawLogsDisplay.scrollHeight} > ${rawLogsDisplay.clientHeight} = ${canScroll}`
                    });

                    // æ‰‹åŠ¨å¤„ç†æ»šåŠ¨ï¼Œç¡®ä¿æ»šåŠ¨äº‹ä»¶è¢«è§¦å‘
                    if (canScroll) {
                        console.log(`âœ… å¼€å§‹æ‰‹åŠ¨æ»šåŠ¨å¤„ç†`);
                        const currentScrollTop = rawLogsDisplay.scrollTop;
                        const scrollAmount = event.deltaY * 0.5; // è°ƒæ•´æ»šåŠ¨é€Ÿåº¦
                        const newScrollTop = Math.max(0, Math.min(
                            rawLogsDisplay.scrollHeight - rawLogsDisplay.clientHeight,
                            currentScrollTop + scrollAmount
                        ));

                        console.log(`ğŸ”„ æ‰‹åŠ¨æ»šåŠ¨: ${currentScrollTop} -> ${newScrollTop} (scrollAmount: ${scrollAmount})`);
                        rawLogsDisplay.scrollTop = newScrollTop;

                        // æ‰‹åŠ¨è§¦å‘æ»šåŠ¨äº‹ä»¶
                        const scrollEvent = new Event('scroll', { bubbles: true });
                        rawLogsDisplay.dispatchEvent(scrollEvent);
                        console.log(`ğŸ“¤ å·²æ‰‹åŠ¨è§¦å‘æ»šåŠ¨äº‹ä»¶`);
                    } else {
                        console.log(`âŒ æ— æ³•æ»šåŠ¨: scrollHeight=${rawLogsDisplay.scrollHeight}, clientHeight=${rawLogsDisplay.clientHeight}`);
                    }

                    // é˜»æ­¢é»˜è®¤æ»šåŠ¨å’Œäº‹ä»¶å†’æ³¡
                    event.preventDefault();
                    event.stopPropagation();
                });

                // é˜»æ­¢è§¦æ‘¸æ»šåŠ¨äº‹ä»¶å†’æ³¡ï¼ˆç§»åŠ¨è®¾å¤‡æ”¯æŒï¼‰
                rawLogsDisplay.addEventListener('touchmove', function(event) {
                    console.log(`ğŸ‘† åŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å— è§¦æ‘¸æ»šåŠ¨äº‹ä»¶`);
                    event.stopPropagation();
                });

                // æ·»åŠ æ»šåŠ¨äº‹ä»¶ç›‘å¬å™¨ï¼Œç”¨äºåŠ è½½å†å²æ•°æ®
                rawLogsDisplay.addEventListener('scroll', function(event) {
                    console.log(`ğŸ“œ åŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å— æ»šåŠ¨äº‹ä»¶:`, {
                        scrollTop: rawLogsDisplay.scrollTop,
                        scrollHeight: rawLogsDisplay.scrollHeight,
                        clientHeight: rawLogsDisplay.clientHeight,
                        canScrollMore: rawLogsDisplay.scrollHeight > rawLogsDisplay.clientHeight
                    });
                    // å¯ç”¨åŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å—çš„å†å²åŠ è½½åŠŸèƒ½
                    if (rawLogsDisplay.scrollTop <= 5) {
                        console.log(`ğŸ”„ åŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å—æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼ŒscrollTop: ${rawLogsDisplay.scrollTop}`);
                        loadMoreDisplayLogsForRawSnapshot(rawLogsDisplay);
                    }
                });
            }

            // ä¸ºå®æ—¶åŸå§‹æ—¥å¿—æ¨¡å—ç»‘å®šå®Œæ•´çš„æ»šåŠ¨äº‹ä»¶å¤„ç†
            const realtimeLogsDisplay = document.getElementById('realtime-logs-display');
            if (realtimeLogsDisplay) {
                // åˆå§‹åŒ–å®æ—¶æ—¥å¿—æ¨¡å—ç„¦ç‚¹çŠ¶æ€
                const realtimeModuleName = 'RealtimeLogs';
                moduleFocusStates[realtimeModuleName] = false;
                moduleAutoScrollStates[realtimeModuleName] = true; // é»˜è®¤å¯ç”¨è‡ªåŠ¨æ»šåŠ¨

                // ç‚¹å‡»è·å¾—ç„¦ç‚¹ï¼Œä½¿é¼ æ ‡æ»šè½®èƒ½å¤Ÿæ­£å¸¸å·¥ä½œ
                realtimeLogsDisplay.addEventListener('click', function(event) {
                    if (!event.target.closest('.log-entry')) {
                        realtimeLogsDisplay.focus();
                        console.log('ğŸ¯ å®æ—¶åŸå§‹æ—¥å¿—æ¨¡å—è·å¾—ç„¦ç‚¹');
                    }
                });

                // é¼ æ ‡è¿›å…¥æ—¶è‡ªåŠ¨è·å¾—ç„¦ç‚¹
                realtimeLogsDisplay.addEventListener('mouseenter', function(event) {
                    realtimeLogsDisplay.focus();
                });

                // ç„¦ç‚¹è·å¾—äº‹ä»¶
                realtimeLogsDisplay.addEventListener('focus', function(event) {
                    moduleFocusStates[realtimeModuleName] = true;
                    moduleAutoScrollStates[realtimeModuleName] = false; // æœ‰ç„¦ç‚¹æ—¶ç¦ç”¨è‡ªåŠ¨æ»šåŠ¨
                    console.log(`ğŸ¯ å®æ—¶åŸå§‹æ—¥å¿—æ¨¡å—è·å¾—ç„¦ç‚¹ - ç¦ç”¨è‡ªåŠ¨æ»šåŠ¨`);
                });

                // ç„¦ç‚¹å¤±å»äº‹ä»¶
                realtimeLogsDisplay.addEventListener('blur', function(event) {
                    moduleFocusStates[realtimeModuleName] = false;
                    moduleAutoScrollStates[realtimeModuleName] = true; // å¤±å»ç„¦ç‚¹æ—¶å¯ç”¨è‡ªåŠ¨æ»šåŠ¨
                    console.log(`ğŸ¯ å®æ—¶åŸå§‹æ—¥å¿—æ¨¡å—å¤±å»ç„¦ç‚¹ - å¯ç”¨è‡ªåŠ¨æ»šåŠ¨`);
                });

                // æ·»åŠ è¯¦ç»†çš„æ»šåŠ¨äº‹ä»¶æ—¥å¿—
                realtimeLogsDisplay.addEventListener('wheel', function(event) {
                    const canScroll = realtimeLogsDisplay.scrollHeight > realtimeLogsDisplay.clientHeight;
                    console.log(`ğŸ–±ï¸ å®æ—¶åŸå§‹æ—¥å¿—æ¨¡å— é¼ æ ‡æ»šè½®äº‹ä»¶:`, {
                        deltaY: event.deltaY,
                        deltaX: event.deltaX,
                        target: event.target.tagName,
                        scrollTop: realtimeLogsDisplay.scrollTop,
                        scrollHeight: realtimeLogsDisplay.scrollHeight,
                        clientHeight: realtimeLogsDisplay.clientHeight,
                        canScroll: canScroll
                    });

                    // æ‰‹åŠ¨å¤„ç†æ»šåŠ¨ï¼Œç¡®ä¿æ»šåŠ¨äº‹ä»¶è¢«è§¦å‘
                    if (canScroll) {
                        const currentScrollTop = realtimeLogsDisplay.scrollTop;
                        const scrollAmount = event.deltaY * 0.5; // è°ƒæ•´æ»šåŠ¨é€Ÿåº¦
                        const newScrollTop = Math.max(0, Math.min(
                            realtimeLogsDisplay.scrollHeight - realtimeLogsDisplay.clientHeight,
                            currentScrollTop + scrollAmount
                        ));

                        console.log(`ğŸ”„ å®æ—¶æ—¥å¿—æ¨¡å— æ‰‹åŠ¨æ»šåŠ¨: ${currentScrollTop} -> ${newScrollTop}`);
                        realtimeLogsDisplay.scrollTop = newScrollTop;

                        // æ‰‹åŠ¨è§¦å‘æ»šåŠ¨äº‹ä»¶
                        const scrollEvent = new Event('scroll', { bubbles: true });
                        realtimeLogsDisplay.dispatchEvent(scrollEvent);
                    }

                    // é˜»æ­¢é»˜è®¤æ»šåŠ¨å’Œäº‹ä»¶å†’æ³¡
                    event.preventDefault();
                    event.stopPropagation();
                });

                // é˜»æ­¢è§¦æ‘¸æ»šåŠ¨äº‹ä»¶å†’æ³¡ï¼ˆç§»åŠ¨è®¾å¤‡æ”¯æŒï¼‰
                realtimeLogsDisplay.addEventListener('touchmove', function(event) {
                    console.log(`ğŸ‘† å®æ—¶åŸå§‹æ—¥å¿—æ¨¡å— è§¦æ‘¸æ»šåŠ¨äº‹ä»¶`);
                    event.stopPropagation();
                });
            }

            // é”®ç›˜äº‹ä»¶ - ESCé”®å…³é—­å±•å¼€çš„JSON
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && activeLogId) {
                    hideJson(activeLogId);
                }
            });
        });

        // ===== æ–°çš„èšåˆæ•°æ®å¤„ç†å‡½æ•° =====

        // æ›´æ–°ç³»ç»ŸçŠ¶æ€ï¼ˆä»èšåˆæ•°æ®ï¼‰
        function updateSystemStatusFromAggregatedData(data) {
            const uptimeEl = document.getElementById('uptime');
            const healthScoreEl = document.getElementById('health-score');

            if (uptimeEl) {
                const hours = Math.floor(data.uptime_seconds / 3600);
                const minutes = Math.floor((data.uptime_seconds % 3600) / 60);
                const seconds = data.uptime_seconds % 60;
                uptimeEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            if (healthScoreEl) {
                healthScoreEl.textContent = `${data.health_score}%`;
            }
        }

        // æ›´æ–°æ¨¡å—æ—¥å¿—ï¼ˆä»èšåˆæ•°æ®ï¼‰
        function updateModuleLogsFromAggregatedData(moduleLogs) {
            console.log('updateModuleLogsFromAggregatedData è¢«è°ƒç”¨ï¼Œæ¨¡å—æ•°é‡:', Object.keys(moduleLogs).length);

            // æ›´æ–°æ¨¡å—åç§°åˆ—è¡¨
            updateModuleNamesList(Object.keys(moduleLogs));

            for (const [moduleName, moduleData] of Object.entries(moduleLogs)) {
                console.log('å¤„ç†æ¨¡å—:', moduleName, 'æ•°æ®:', moduleData);

                // ç¡®ä¿æ¨¡å—å®¹å™¨å­˜åœ¨
                ensureModuleContainer(moduleName);

                // åˆå§‹åŒ–æ¨¡å—å†å²æ•°æ®çŠ¶æ€
                if (!(moduleName in moduleHistoryPages)) {
                    moduleHistoryPages[moduleName] = 0;
                    moduleLoadingHistory[moduleName] = false;
                    moduleHasMoreHistory[moduleName] = moduleData.has_more_history !== false; // é»˜è®¤å‡è®¾æœ‰æ›´å¤šæ•°æ®
                }

                // æ›´æ–°æ¨¡å—ç»Ÿè®¡
                updateModuleStatsFromAggregatedData(moduleName, moduleData);

                // æ™ºèƒ½æ•°æ®é€‰æ‹©ï¼šä¼˜å…ˆä½¿ç”¨æ•°æ®é‡æ›´å¤šçš„æº
                const displayedCount = moduleData.displayed_logs ? moduleData.displayed_logs.length : 0;
                const recentCount = moduleData.recent_logs ? moduleData.recent_logs.length : 0;

                console.log(`ğŸ“Š æ¨¡å— [${moduleName}] æ•°æ®ç»Ÿè®¡: displayed_logs=${displayedCount}, recent_logs=${recentCount}`);

                if (displayedCount >= 20 || (displayedCount > 0 && recentCount === 0)) {
                    // å¦‚æœèšåˆæ—¥å¿—è¶³å¤Ÿå¤šï¼Œæˆ–è€…åªæœ‰èšåˆæ—¥å¿—ï¼Œä½¿ç”¨èšåˆæ—¥å¿—
                    console.log(`ğŸ“¦ æ¸²æŸ“æ¨¡å— [${moduleName}] çš„ ${displayedCount} æ¡èšåˆæ—¥å¿—`);
                    renderAggregatedDisplayLogs(moduleName, moduleData.displayed_logs);
                } else if (recentCount > 0) {
                    // å¦‚æœåŸå§‹æ—¥å¿—æ›´å¤šï¼Œä½¿ç”¨åŸå§‹æ—¥å¿—ï¼ˆè½¬æ¢ä¸ºæ˜¾ç¤ºæ ¼å¼ï¼‰
                    console.log(`ğŸ“¦ æ¸²æŸ“æ¨¡å— [${moduleName}] çš„ ${recentCount} æ¡åŸå§‹æ—¥å¿—ï¼ˆè½¬æ¢ä¸ºæ»šåŠ¨æ ¼å¼ï¼‰`);
                    renderRecentLogsWithScrollSupport(moduleName, moduleData.recent_logs);
                } else {
                    console.log(`âš ï¸ æ¨¡å— [${moduleName}] æ²¡æœ‰æ—¥å¿—æ•°æ®`);
                    const containerId = getModuleContainerId(moduleName) + '-logs';
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.innerHTML = '<div class="log-entry">ç­‰å¾…æ—¥å¿—æ•°æ®...</div>';
                    }
                }
            }
        }

        // æ›´æ–°æ¨¡å—ç»Ÿè®¡ï¼ˆä»èšåˆæ•°æ®ï¼‰
        function updateModuleStatsFromAggregatedData(moduleName, moduleData) {
            const containerId = getModuleContainerId(moduleName);

            const totalEl = document.getElementById(containerId + '-total');
            const errorsEl = document.getElementById(containerId + '-errors');
            const lastUpdateEl = document.getElementById(containerId + '-last-update');

            const currentLogCount = moduleData.total_logs || 0;
            const previousLogCount = moduleLogCounts[moduleName] || 0;

            if (totalEl) totalEl.textContent = currentLogCount;
            if (errorsEl) errorsEl.textContent = moduleData.error_count || 0;

            if (lastUpdateEl) {
                // åªæœ‰å½“æ—¥å¿—æ•°é‡å¢åŠ æ—¶æ‰æ›´æ–°æ—¶é—´
                if (currentLogCount > previousLogCount) {
                    const currentTime = getCurrentTimeString();
                    moduleLastUpdateTimes[moduleName] = currentTime;
                    lastUpdateEl.textContent = currentTime;
                    console.log(`æ¨¡å— ${moduleName} æœ‰æ–°æ—¥å¿—: ${previousLogCount} -> ${currentLogCount}, æ›´æ–°æ—¶é—´: ${currentTime}`);
                } else {
                    // æ—¥å¿—æ•°é‡æ²¡æœ‰å˜åŒ–ï¼Œæ˜¾ç¤ºä¹‹å‰è®°å½•çš„æ—¶é—´
                    lastUpdateEl.textContent = moduleLastUpdateTimes[moduleName] || '--:--:--';
                }
            }

            // æ›´æ–°è®°å½•çš„æ—¥å¿—æ•°é‡
            moduleLogCounts[moduleName] = currentLogCount;
        }

        // æ¸²æŸ“èšåˆçš„æ˜¾ç¤ºæ—¥å¿—
        function renderAggregatedDisplayLogs(moduleName, displayedLogs) {
            const containerId = getModuleContainerId(moduleName);
            const container = document.getElementById(containerId + '-logs');

            if (!container) return;

            // æ£€æŸ¥æ¨¡å—æ˜¯å¦æœ‰ç„¦ç‚¹
            const hasFocus = moduleFocusStates[moduleName] || false;
            const shouldAutoScroll = moduleAutoScrollStates[moduleName] !== false; // é»˜è®¤ä¸ºtrue

            console.log(`ğŸ“¦ æ¸²æŸ“æ¨¡å— [${moduleName}] èšåˆæ—¥å¿— - ç„¦ç‚¹çŠ¶æ€: ${hasFocus}, è‡ªåŠ¨æ»šåŠ¨: ${shouldAutoScroll}`);

            // å¦‚æœæ¨¡å—æœ‰ç„¦ç‚¹ï¼Œä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
            let savedScrollTop = 0;
            let savedScrollHeight = 0;
            if (hasFocus) {
                savedScrollTop = container.scrollTop;
                savedScrollHeight = container.scrollHeight;
                console.log(`ğŸ’¾ æ¨¡å— [${moduleName}] æœ‰ç„¦ç‚¹ï¼Œä¿å­˜æ»šåŠ¨ä½ç½®: ${savedScrollTop}/${savedScrollHeight}`);
            }

            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';

            if (!displayedLogs || displayedLogs.length === 0) {
                container.innerHTML = '<div class="log-entry">ç­‰å¾…æ—¥å¿—æ•°æ®...</div>';
                return;
            }

            // å­˜å‚¨å®Œæ•´æ•°æ®åˆ°å®¹å™¨çš„æ•°æ®å±æ€§ä¸­ï¼Œä¾›æ»šåŠ¨åŠ è½½ä½¿ç”¨
            container.setAttribute('data-all-logs', JSON.stringify(displayedLogs));
            container.setAttribute('data-current-display-count', '20');
            console.log(`ğŸ“Š æ¨¡å— [${moduleName}] å­˜å‚¨äº† ${displayedLogs.length} æ¡å®Œæ•´æ•°æ®ï¼Œå½“å‰æ˜¾ç¤º 20 æ¡`);

            // åªæ¸²æŸ“å‰20æ¡åˆ°DOMï¼ˆUIå±‚é¢çš„é™åˆ¶ï¼‰
            const logsToRender = displayedLogs.slice(0, 20);
            logsToRender.forEach((logEntry, index) => {
                const logElement = createAggregatedLogElement(logEntry, containerId, index);
                container.appendChild(logElement);
            });

            // å¦‚æœæœ‰æ›´å¤šæ•°æ®ï¼Œæ·»åŠ "åŠ è½½æ›´å¤š"æç¤º
            if (displayedLogs.length > 20) {
                const loadMoreIndicator = document.createElement('div');
                loadMoreIndicator.className = 'load-more-indicator';
                loadMoreIndicator.style.cssText = `
                    padding: 10px;
                    text-align: center;
                    color: #888;
                    font-size: 12px;
                    border-top: 1px solid #333;
                    cursor: pointer;
                `;
                loadMoreIndicator.textContent = `è¿˜æœ‰ ${displayedLogs.length - 20} æ¡æ—¥å¿—ï¼Œæ»šåŠ¨åˆ°é¡¶éƒ¨åŠ è½½æ›´å¤š`;
                container.appendChild(loadMoreIndicator);
            }

            // æ ¹æ®ç„¦ç‚¹çŠ¶æ€å†³å®šæ˜¯å¦è‡ªåŠ¨æ»šåŠ¨
            setTimeout(() => {
                if (hasFocus && !shouldAutoScroll) {
                    // æœ‰ç„¦ç‚¹æ—¶ï¼Œå°è¯•æ¢å¤ä¹‹å‰çš„æ»šåŠ¨ä½ç½®
                    const newScrollHeight = container.scrollHeight;
                    const maxScrollTop = Math.max(0, newScrollHeight - container.clientHeight);

                    // å¦‚æœä¹‹å‰åœ¨é¡¶éƒ¨é™„è¿‘ï¼ˆå‰10%ï¼‰ï¼Œä¿æŒåœ¨é¡¶éƒ¨
                    if (savedScrollTop <= savedScrollHeight * 0.1) {
                        container.scrollTop = 0;
                        console.log(`ğŸ”„ æ¨¡å— [${moduleName}] ä¿æŒåœ¨é¡¶éƒ¨ä½ç½®`);
                    } else {
                        // å¦åˆ™å°è¯•ä¿æŒç›¸å¯¹ä½ç½®
                        const relativePosition = savedScrollHeight > 0 ? savedScrollTop / savedScrollHeight : 0;
                        const newScrollTop = Math.min(maxScrollTop, relativePosition * newScrollHeight);
                        container.scrollTop = newScrollTop;
                        console.log(`ğŸ”„ æ¨¡å— [${moduleName}] æ¢å¤ç›¸å¯¹æ»šåŠ¨ä½ç½®: ${savedScrollTop}/${savedScrollHeight} -> ${newScrollTop}/${newScrollHeight} (ç›¸å¯¹ä½ç½®: ${(relativePosition * 100).toFixed(1)}%)`);
                    }
                } else {
                    // æ— ç„¦ç‚¹æ—¶ï¼Œå¼ºåˆ¶æ»šåŠ¨åˆ°æœ€æ–°ä½ç½®ï¼ˆé¡¶éƒ¨ï¼‰
                    container.scrollTop = 0;
                    console.log(`ğŸ“œ æ¨¡å— [${moduleName}] è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°ä½ç½®ï¼ˆé¡¶éƒ¨ï¼‰`);
                }
            }, 50); // å¢åŠ å»¶è¿Ÿç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
        }

        // åˆ›å»ºèšåˆæ—¥å¿—å…ƒç´ 
        function createAggregatedLogElement(logEntry, containerId, index) {
            const logWrapper = document.createElement('div');
            const logId = `${containerId}-log-${Date.now()}-${index}`;

            // æ„å»ºæ˜¾ç¤ºæ¶ˆæ¯
            const displayMessage = logEntry.is_aggregated && logEntry.count > 1
                ? `${logEntry.message} (Ã—${logEntry.count})`
                : logEntry.message;

            // æ„å»ºJSONå†…å®¹
            const jsonContent = logEntry.is_aggregated
                ? {
                    message: logEntry.message,
                    level: logEntry.level,
                    count: logEntry.count,
                    timestamp: logEntry.timestamp,
                    variations: logEntry.variations || [],
                    all_logs: logEntry.all_logs || []
                  }
                : logEntry.all_logs[0] || logEntry;

            logWrapper.innerHTML = `
                <!-- JSONè¯¦æƒ… (é»˜è®¤éšè—) -->
                <div id="json-${logId}" class="raw-json">
                    <div class="json-container">
                        <div class="json-header">
                            <span>ğŸ“„ ${logEntry.is_aggregated ? `èšåˆæ—¥å¿—è¯¦æƒ… (${logEntry.count}æ¡)` : 'åŸå§‹JSON'}</span>
                            <span class="json-close" onclick="hideJson('${logId}')">âœ•</span>
                        </div>
                        <div class="json-content">${JSON.stringify(jsonContent, null, 2)}</div>
                    </div>
                </div>

                <!-- æ—¥å¿—æ¡ç›® -->
                <div class="log-entry log-level-${logEntry.level} ${logEntry.is_aggregated ? 'aggregated-log' : ''}"
                     onclick="toggleJson('${logId}')" data-log-id="${logId}"
                     title="${logEntry.is_aggregated ? `èšåˆæ—¥å¿—: ${logEntry.variations?.length || 1}ç§å˜ä½“` : logEntry.message}">
                    <div class="log-message">${escapeHtml(displayMessage)}</div>
                </div>
            `;

            return logWrapper;
        }

        // å°†åŸå§‹æ—¥å¿—æ¸²æŸ“ä¸ºæ”¯æŒæ»šåŠ¨çš„æ˜¾ç¤ºæ ¼å¼
        function renderRecentLogsWithScrollSupport(moduleName, recentLogs) {
            const containerId = getModuleContainerId(moduleName);
            const container = document.getElementById(containerId + '-logs');

            if (!container) {
                console.error('æ‰¾ä¸åˆ°æ¨¡å—å®¹å™¨:', containerId + '-logs');
                return;
            }

            // æ£€æŸ¥æ¨¡å—æ˜¯å¦æœ‰ç„¦ç‚¹
            const hasFocus = moduleFocusStates[moduleName] || false;
            const shouldAutoScroll = moduleAutoScrollStates[moduleName] !== false; // é»˜è®¤ä¸ºtrue

            console.log(`ğŸ“¦ æ¸²æŸ“æ¨¡å— [${moduleName}] åŸå§‹æ—¥å¿— - ç„¦ç‚¹çŠ¶æ€: ${hasFocus}, è‡ªåŠ¨æ»šåŠ¨: ${shouldAutoScroll}`);

            // å¦‚æœæ¨¡å—æœ‰ç„¦ç‚¹ï¼Œä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
            let savedScrollTop = 0;
            let savedScrollHeight = 0;
            if (hasFocus) {
                savedScrollTop = container.scrollTop;
                savedScrollHeight = container.scrollHeight;
                console.log(`ğŸ’¾ æ¨¡å— [${moduleName}] æœ‰ç„¦ç‚¹ï¼Œä¿å­˜æ»šåŠ¨ä½ç½®: ${savedScrollTop}/${savedScrollHeight}`);
            }

            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';

            if (!recentLogs || recentLogs.length === 0) {
                container.innerHTML = '<div class="log-entry">ç­‰å¾…æ—¥å¿—æ•°æ®...</div>';
                return;
            }

            // å°†åŸå§‹æ—¥å¿—è½¬æ¢ä¸ºDisplayLogEntryæ ¼å¼ä»¥æ”¯æŒæ»šåŠ¨
            const displayLogs = recentLogs.map(logEntry => ({
                message: logEntry.message,
                level: logEntry.level,
                timestamp: logEntry.timestamp,
                count: 1,
                is_aggregated: false,
                variations: [logEntry.message],
                all_logs: [logEntry]
            }));

            // å­˜å‚¨å®Œæ•´æ•°æ®åˆ°å®¹å™¨çš„æ•°æ®å±æ€§ä¸­ï¼Œä¾›æ»šåŠ¨åŠ è½½ä½¿ç”¨
            container.setAttribute('data-all-logs', JSON.stringify(displayLogs));
            container.setAttribute('data-current-display-count', '20');
            console.log(`ğŸ“Š æ¨¡å— [${moduleName}] å­˜å‚¨äº† ${displayLogs.length} æ¡å®Œæ•´æ•°æ®ï¼ˆä»åŸå§‹æ—¥å¿—è½¬æ¢ï¼‰ï¼Œå½“å‰æ˜¾ç¤º 20 æ¡`);

            // åªæ¸²æŸ“å‰20æ¡åˆ°DOMï¼ˆUIå±‚é¢çš„é™åˆ¶ï¼‰
            const logsToRender = displayLogs.slice(0, 20);
            logsToRender.forEach((logEntry, index) => {
                const logElement = createAggregatedLogElement(logEntry, containerId, index);
                container.appendChild(logElement);
            });

            // å¦‚æœæœ‰æ›´å¤šæ•°æ®ï¼Œæ·»åŠ "åŠ è½½æ›´å¤š"æç¤º
            if (displayLogs.length > 20) {
                const loadMoreIndicator = document.createElement('div');
                loadMoreIndicator.className = 'load-more-indicator';
                loadMoreIndicator.style.cssText = `
                    padding: 10px;
                    text-align: center;
                    color: #888;
                    font-size: 12px;
                    border-top: 1px solid #333;
                    cursor: pointer;
                `;
                loadMoreIndicator.textContent = `è¿˜æœ‰ ${displayLogs.length - 20} æ¡æ—¥å¿—ï¼Œæ»šåŠ¨åˆ°é¡¶éƒ¨åŠ è½½æ›´å¤š`;
                container.appendChild(loadMoreIndicator);
            }

            // æ ¹æ®ç„¦ç‚¹çŠ¶æ€å†³å®šæ˜¯å¦è‡ªåŠ¨æ»šåŠ¨
            setTimeout(() => {
                if (hasFocus && !shouldAutoScroll) {
                    // æœ‰ç„¦ç‚¹æ—¶ï¼Œå°è¯•æ¢å¤ä¹‹å‰çš„æ»šåŠ¨ä½ç½®
                    const newScrollHeight = container.scrollHeight;
                    const maxScrollTop = Math.max(0, newScrollHeight - container.clientHeight);

                    // å¦‚æœä¹‹å‰åœ¨é¡¶éƒ¨é™„è¿‘ï¼ˆå‰10%ï¼‰ï¼Œä¿æŒåœ¨é¡¶éƒ¨
                    if (savedScrollTop <= savedScrollHeight * 0.1) {
                        container.scrollTop = 0;
                        console.log(`ğŸ”„ æ¨¡å— [${moduleName}] ä¿æŒåœ¨é¡¶éƒ¨ä½ç½®`);
                    } else {
                        // å¦åˆ™å°è¯•ä¿æŒç›¸å¯¹ä½ç½®
                        const relativePosition = savedScrollHeight > 0 ? savedScrollTop / savedScrollHeight : 0;
                        const newScrollTop = Math.min(maxScrollTop, relativePosition * newScrollHeight);
                        container.scrollTop = newScrollTop;
                        console.log(`ğŸ”„ æ¨¡å— [${moduleName}] æ¢å¤ç›¸å¯¹æ»šåŠ¨ä½ç½®: ${savedScrollTop}/${savedScrollHeight} -> ${newScrollTop}/${newScrollHeight} (ç›¸å¯¹ä½ç½®: ${(relativePosition * 100).toFixed(1)}%)`);
                    }
                } else {
                    // æ— ç„¦ç‚¹æ—¶ï¼Œå¼ºåˆ¶æ»šåŠ¨åˆ°æœ€æ–°ä½ç½®ï¼ˆé¡¶éƒ¨ï¼‰
                    container.scrollTop = 0;
                    console.log(`ğŸ“œ æ¨¡å— [${moduleName}] è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°ä½ç½®ï¼ˆé¡¶éƒ¨ï¼‰`);
                }
            }, 50); // å¢åŠ å»¶è¿Ÿç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
        }

        // å°†åŸå§‹æ—¥å¿—æ¸²æŸ“ä¸ºæ˜¾ç¤ºæ ¼å¼ï¼ˆå…¼å®¹recent_logsï¼Œæ—§ç‰ˆæœ¬ï¼‰
        function renderRecentLogsAsDisplay(moduleName, recentLogs) {
            const containerId = getModuleContainerId(moduleName);
            const container = document.getElementById(containerId + '-logs');

            if (!container) {
                console.error('æ‰¾ä¸åˆ°æ¨¡å—å®¹å™¨:', containerId + '-logs');
                return;
            }

            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';

            if (!recentLogs || recentLogs.length === 0) {
                container.innerHTML = '<div class="log-entry">ç­‰å¾…æ—¥å¿—æ•°æ®...</div>';
                return;
            }

            // æ˜¾ç¤ºæœ€æ–°çš„20æ¡æ—¥å¿—
            const logsToShow = recentLogs.slice(0, 20);
            logsToShow.forEach((logEntry, index) => {
                const logElement = createRecentLogElement(logEntry, containerId, index);
                container.appendChild(logElement);
            });
        }

        // åˆ›å»ºåŸå§‹æ—¥å¿—å…ƒç´ 
        function createRecentLogElement(logEntry, containerId, index) {
            const logWrapper = document.createElement('div');
            const logId = `${containerId}-recent-${Date.now()}-${index}`;

            // æ„å»ºå®Œæ•´çš„JSONå¯¹è±¡ç”¨äºè¯¦æƒ…æ˜¾ç¤º
            const fullLogJson = {
                timestamp: logEntry.timestamp,
                level: logEntry.level,
                target: logEntry.target,
                message: logEntry.message,
                module_path: logEntry.module_path,
                file: logEntry.file,
                line: logEntry.line,
                fields: logEntry.fields,
                span: logEntry.span
            };

            logWrapper.innerHTML = `
                <!-- åŸå§‹JSON (é»˜è®¤éšè—) -->
                <div id="json-${logId}" class="raw-json">
                    <div class="json-container">
                        <div class="json-header">
                            <span>ğŸ“„ åŸå§‹æ—¥å¿—è¯¦æƒ…</span>
                            <span class="json-close" onclick="hideJson('${logId}')">âœ•</span>
                        </div>
                        <div class="json-content">${JSON.stringify(fullLogJson, null, 2)}</div>
                    </div>
                </div>

                <!-- æ—¥å¿—æ¡ç›® -->
                <div class="log-entry log-level-${logEntry.level}"
                     onclick="toggleJson('${logId}')" data-log-id="${logId}"
                     title="${logEntry.message}">
                    <div class="log-message">${escapeHtml(logEntry.message)}</div>
                </div>
            `;

            return logWrapper;
        }

        // æ›´æ–°å®æ—¶æ—¥å¿—ï¼ˆä»èšåˆæ•°æ®ï¼‰
        function updateRealtimeLogsFromAggregatedData(realtimeData) {
            if (!realtimeData || !realtimeData.recent_logs) return;

            const container = document.getElementById('realtime-logs-display');
            if (!container) return;

            // æ£€æŸ¥å®æ—¶æ—¥å¿—æ¨¡å—æ˜¯å¦æœ‰ç„¦ç‚¹
            const moduleName = 'RealtimeLogs';
            const hasFocus = moduleFocusStates[moduleName] || false;
            const shouldAutoScroll = moduleAutoScrollStates[moduleName] !== false; // é»˜è®¤ä¸ºtrue

            console.log(`ğŸ“¦ æ›´æ–°å®æ—¶æ—¥å¿—æ¨¡å— - ç„¦ç‚¹çŠ¶æ€: ${hasFocus}, è‡ªåŠ¨æ»šåŠ¨: ${shouldAutoScroll}`);

            // å¦‚æœæ¨¡å—æœ‰ç„¦ç‚¹ï¼Œä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
            let savedScrollTop = 0;
            let savedScrollHeight = 0;
            if (hasFocus) {
                savedScrollTop = container.scrollTop;
                savedScrollHeight = container.scrollHeight;
                console.log(`ğŸ’¾ å®æ—¶æ—¥å¿—æ¨¡å—æœ‰ç„¦ç‚¹ï¼Œä¿å­˜æ»šåŠ¨ä½ç½®: ${savedScrollTop}/${savedScrollHeight}`);
            }

            // æ›´æ–°çŠ¶æ€ä¿¡æ¯
            const statusEl = document.getElementById('realtime-logs-status');
            const logCountEl = document.getElementById('realtime-log-count');
            const lastLogTimeEl = document.getElementById('last-log-time');
            const logFrequencyEl = document.getElementById('log-frequency');

            if (statusEl) {
                if (realtimeData.recent_logs.length > 0) {
                    statusEl.textContent = 'å®æ—¶æ¥æ”¶';
                    statusEl.className = 'module-status status-running';
                } else {
                    statusEl.textContent = 'ç­‰å¾…æ—¥å¿—';
                    statusEl.className = 'module-status status-waiting';
                }
            }

            if (logCountEl) logCountEl.textContent = realtimeData.total_count || realtimeData.recent_logs.length;
            if (lastLogTimeEl) lastLogTimeEl.textContent = realtimeData.last_update_time || getCurrentTimeString();
            if (logFrequencyEl) logFrequencyEl.textContent = `${realtimeData.logs_per_second || 0} æ¡/ç§’`;

            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';

            if (realtimeData.recent_logs.length === 0) {
                container.innerHTML = '<div class="log-entry">æš‚æ— å®æ—¶æ—¥å¿—</div>';
                return;
            }

            // åªæ˜¾ç¤ºæœ€æ–°çš„20æ¡å®æ—¶æ—¥å¿—
            const logsToShow = realtimeData.recent_logs.slice(0, 20);

            logsToShow.forEach(logLine => {
                const logEl = document.createElement('div');
                logEl.className = 'log-entry';
                logEl.style.fontSize = '12px';
                logEl.style.lineHeight = '1.3';
                logEl.style.marginBottom = '2px';
                logEl.style.wordBreak = 'break-all';

                // ç®€å•çš„æ—¥å¿—ç€è‰²
                if (logLine.includes('ERROR')) {
                    logEl.style.color = '#ff0000';
                } else if (logLine.includes('WARN')) {
                    logEl.style.color = '#ffff00';
                } else if (logLine.includes('INFO')) {
                    logEl.style.color = '#00ff00';
                } else {
                    logEl.style.color = '#cccccc';
                }

                logEl.textContent = logLine;
                container.appendChild(logEl);
            });

            // æ ¹æ®ç„¦ç‚¹çŠ¶æ€å†³å®šæ˜¯å¦è‡ªåŠ¨æ»šåŠ¨
            setTimeout(() => {
                if (hasFocus && !shouldAutoScroll) {
                    // æœ‰ç„¦ç‚¹æ—¶ï¼Œå°è¯•æ¢å¤ä¹‹å‰çš„æ»šåŠ¨ä½ç½®
                    const newScrollHeight = container.scrollHeight;
                    const maxScrollTop = Math.max(0, newScrollHeight - container.clientHeight);

                    // å¦‚æœä¹‹å‰åœ¨é¡¶éƒ¨é™„è¿‘ï¼ˆå‰10%ï¼‰ï¼Œä¿æŒåœ¨é¡¶éƒ¨
                    if (savedScrollTop <= savedScrollHeight * 0.1) {
                        container.scrollTop = 0;
                        console.log(`ğŸ”„ å®æ—¶æ—¥å¿—æ¨¡å—ä¿æŒåœ¨é¡¶éƒ¨ä½ç½®`);
                    } else {
                        // å¦åˆ™å°è¯•ä¿æŒç›¸å¯¹ä½ç½®
                        const relativePosition = savedScrollHeight > 0 ? savedScrollTop / savedScrollHeight : 0;
                        const newScrollTop = Math.min(maxScrollTop, relativePosition * newScrollHeight);
                        container.scrollTop = newScrollTop;
                        console.log(`ğŸ”„ å®æ—¶æ—¥å¿—æ¨¡å—æ¢å¤ç›¸å¯¹æ»šåŠ¨ä½ç½®: ${savedScrollTop}/${savedScrollHeight} -> ${newScrollTop}/${newScrollHeight} (ç›¸å¯¹ä½ç½®: ${(relativePosition * 100).toFixed(1)}%)`);
                    }
                } else {
                    // æ— ç„¦ç‚¹æ—¶ï¼Œå¼ºåˆ¶æ»šåŠ¨åˆ°æœ€æ–°ä½ç½®ï¼ˆé¡¶éƒ¨ï¼‰
                    container.scrollTop = 0;
                    console.log(`ğŸ“œ å®æ—¶æ—¥å¿—æ¨¡å—è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°ä½ç½®ï¼ˆé¡¶éƒ¨ï¼‰`);
                }
            }, 50); // å¢åŠ å»¶è¿Ÿç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
        }

        // æ›´æ–°åŸå§‹æ—¥å¿—å¿«ç…§ï¼ˆä»èšåˆæ•°æ®ï¼‰
        function updateRawLogSnapshotFromAggregatedData(snapshot) {
            if (!snapshot) {
                return;
            }

            // æ£€æŸ¥åŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å—æ˜¯å¦æœ‰ç„¦ç‚¹
            const moduleName = 'RawLogSnapshot';
            const hasFocus = moduleFocusStates[moduleName] || false;
            const shouldAutoScroll = moduleAutoScrollStates[moduleName] !== false; // é»˜è®¤ä¸ºtrue

            console.log(`ğŸ“¦ æ›´æ–°åŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å— - ç„¦ç‚¹çŠ¶æ€: ${hasFocus}, è‡ªåŠ¨æ»šåŠ¨: ${shouldAutoScroll}`);

            // æ›´æ–°çŠ¶æ€ä¿¡æ¯
            const statusEl = document.getElementById('raw-logs-status');
            if (statusEl) {
                statusEl.textContent = 'æŠ˜å å·²æ›´æ–°';
                statusEl.className = 'module-status status-running';
            }

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            const timestampEl = document.getElementById('snapshot-timestamp');
            const totalCountEl = document.getElementById('total-log-count');
            const displayedCountEl = document.getElementById('displayed-log-count');

            if (timestampEl) timestampEl.textContent = getCurrentTimeString();
            if (totalCountEl) totalCountEl.textContent = snapshot.total_count;
            if (displayedCountEl) displayedCountEl.textContent = snapshot.displayed_logs?.length || 0;

            // ç›´æ¥æ¸²æŸ“åç«¯æä¾›çš„èšåˆæ—¥å¿—
            const container = document.getElementById('raw-logs-display');
            if (!container) return;

            // å¦‚æœæ¨¡å—æœ‰ç„¦ç‚¹ï¼Œä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
            let savedScrollTop = 0;
            let savedScrollHeight = 0;
            if (hasFocus) {
                savedScrollTop = container.scrollTop;
                savedScrollHeight = container.scrollHeight;
                console.log(`ğŸ’¾ åŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å—æœ‰ç„¦ç‚¹ï¼Œä¿å­˜æ»šåŠ¨ä½ç½®: ${savedScrollTop}/${savedScrollHeight}`);
            }

            // ä¿å­˜å›ºå®šçš„UIå…ƒç´ ï¼ˆæ»šåŠ¨æç¤ºå’Œè¯Šæ–­æŒ‰é’®ï¼‰
            const scrollHint = container.querySelector('.scroll-hint');
            const diagnoseButton = container.querySelector('button[onclick*="diagnoseContainer"]');

            // æ¸…ç©ºå®¹å™¨ä½†ä¿ç•™å›ºå®šUIå…ƒç´ 
            container.innerHTML = '';

            // é‡æ–°æ·»åŠ å›ºå®šUIå…ƒç´ 
            if (scrollHint) container.appendChild(scrollHint);
            if (diagnoseButton) container.appendChild(diagnoseButton);

            if (!snapshot.displayed_logs || snapshot.displayed_logs.length === 0) {
                const noDataEntry = document.createElement('div');
                noDataEntry.className = 'log-entry';
                noDataEntry.textContent = 'æš‚æ— æ—¥å¿—æ•°æ®';
                container.appendChild(noDataEntry);
                return;
            }

            // å­˜å‚¨å®Œæ•´æ•°æ®åˆ°å®¹å™¨çš„æ•°æ®å±æ€§ä¸­ï¼Œä¾›æ»šåŠ¨åŠ è½½ä½¿ç”¨
            container.setAttribute('data-all-logs', JSON.stringify(snapshot.displayed_logs));
            container.setAttribute('data-current-display-count', '20');
            console.log(`ğŸ“Š åŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å—å­˜å‚¨äº† ${snapshot.displayed_logs.length} æ¡å®Œæ•´æ•°æ®ï¼Œå½“å‰æ˜¾ç¤º 20 æ¡`);

            // åªæ¸²æŸ“å‰20æ¡åˆ°DOMï¼ˆUIå±‚é¢çš„é™åˆ¶ï¼‰
            const logsToRender = snapshot.displayed_logs.slice(0, 20);
            logsToRender.forEach((logEntry, index) => {
                const logElement = createAggregatedLogElement(logEntry, 'raw-logs', index);
                container.appendChild(logElement);
            });

            // å¦‚æœæœ‰æ›´å¤šæ•°æ®ï¼Œæ·»åŠ "åŠ è½½æ›´å¤š"æç¤º
            if (snapshot.displayed_logs.length > 20) {
                const loadMoreIndicator = document.createElement('div');
                loadMoreIndicator.className = 'load-more-indicator';
                loadMoreIndicator.style.cssText = `
                    padding: 10px;
                    text-align: center;
                    color: #888;
                    font-size: 12px;
                    border-top: 1px solid #333;
                    cursor: pointer;
                `;
                loadMoreIndicator.textContent = `è¿˜æœ‰ ${snapshot.displayed_logs.length - 20} æ¡æ—¥å¿—ï¼Œæ»šåŠ¨åˆ°é¡¶éƒ¨åŠ è½½æ›´å¤š`;
                container.appendChild(loadMoreIndicator);
            }

            // æ ¹æ®ç„¦ç‚¹çŠ¶æ€å†³å®šæ˜¯å¦è‡ªåŠ¨æ»šåŠ¨
            setTimeout(() => {
                if (hasFocus && !shouldAutoScroll) {
                    // æœ‰ç„¦ç‚¹æ—¶ï¼Œå°è¯•æ¢å¤ä¹‹å‰çš„æ»šåŠ¨ä½ç½®
                    const newScrollHeight = container.scrollHeight;
                    const maxScrollTop = Math.max(0, newScrollHeight - container.clientHeight);

                    // å¦‚æœä¹‹å‰åœ¨é¡¶éƒ¨é™„è¿‘ï¼ˆå‰10%ï¼‰ï¼Œä¿æŒåœ¨é¡¶éƒ¨
                    if (savedScrollTop <= savedScrollHeight * 0.1) {
                        container.scrollTop = 0;
                        console.log(`ğŸ”„ åŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å—ä¿æŒåœ¨é¡¶éƒ¨ä½ç½®`);
                    } else {
                        // å¦åˆ™å°è¯•ä¿æŒç›¸å¯¹ä½ç½®
                        const relativePosition = savedScrollHeight > 0 ? savedScrollTop / savedScrollHeight : 0;
                        const newScrollTop = Math.min(maxScrollTop, relativePosition * newScrollHeight);
                        container.scrollTop = newScrollTop;
                        console.log(`ğŸ”„ åŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å—æ¢å¤ç›¸å¯¹æ»šåŠ¨ä½ç½®: ${savedScrollTop}/${savedScrollHeight} -> ${newScrollTop}/${newScrollHeight} (ç›¸å¯¹ä½ç½®: ${(relativePosition * 100).toFixed(1)}%)`);
                    }
                } else {
                    // æ— ç„¦ç‚¹æ—¶ï¼Œå¼ºåˆ¶æ»šåŠ¨åˆ°æœ€æ–°ä½ç½®ï¼ˆé¡¶éƒ¨ï¼‰
                    container.scrollTop = 0;
                    console.log(`ğŸ“œ åŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å—è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°ä½ç½®ï¼ˆé¡¶éƒ¨ï¼‰`);
                }
            }, 50); // å¢åŠ å»¶è¿Ÿç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
        }



        // ç®€åŒ–çš„å®æ—¶æ—¥å¿—æ¡ç›®æ·»åŠ ï¼ˆä»…ç”¨äºå®æ—¶æ˜¾ç¤ºï¼‰
        function addLogEntryToRealtimeDisplay(logEntry) {
            const container = document.getElementById('realtime-logs-display');
            if (!container) return;

            // æ£€æŸ¥å®æ—¶æ—¥å¿—æ¨¡å—æ˜¯å¦æœ‰ç„¦ç‚¹
            const moduleName = 'RealtimeLogs';
            const hasFocus = moduleFocusStates[moduleName] || false;
            const shouldAutoScroll = moduleAutoScrollStates[moduleName] !== false; // é»˜è®¤ä¸ºtrue

            // å¦‚æœæ¨¡å—æœ‰ç„¦ç‚¹ï¼Œä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
            let savedScrollTop = 0;
            let savedScrollHeight = 0;
            if (hasFocus) {
                savedScrollTop = container.scrollTop;
                savedScrollHeight = container.scrollHeight;
            }

            const logEl = document.createElement('div');
            logEl.className = 'log-entry';
            logEl.style.fontSize = '12px';
            logEl.style.lineHeight = '1.3';
            logEl.style.marginBottom = '2px';
            logEl.style.wordBreak = 'break-all';

            // æ ¹æ®æ—¥å¿—çº§åˆ«ç€è‰²
            if (logEntry.level === 'ERROR') {
                logEl.style.color = '#ff0000';
            } else if (logEntry.level === 'WARN') {
                logEl.style.color = '#ffff00';
            } else if (logEntry.level === 'INFO') {
                logEl.style.color = '#00ff00';
            } else {
                logEl.style.color = '#cccccc';
            }

            // æ ¼å¼åŒ–æ—¥å¿—å†…å®¹ï¼ˆä½¿ç”¨å½“å‰æ—¶é—´ï¼‰
            const timestamp = getCurrentTimeString();
            logEl.textContent = `[${timestamp}] ${logEntry.level} ${logEntry.target}: ${logEntry.message}`;

            // æ·»åŠ åˆ°å®¹å™¨é¡¶éƒ¨ï¼ˆæœ€æ–°çš„åœ¨ä¸Šé¢ï¼‰
            container.insertBefore(logEl, container.firstChild);

            // é™åˆ¶å®æ—¶æ—¥å¿—æ˜¾ç¤ºæ•°é‡ä¸º20æ¡
            const children = Array.from(container.children);
            if (children.length > 20) {
                for (let i = 20; i < children.length; i++) {
                    container.removeChild(children[i]);
                }
            }

            // æ ¹æ®ç„¦ç‚¹çŠ¶æ€å†³å®šæ˜¯å¦è‡ªåŠ¨æ»šåŠ¨
            setTimeout(() => {
                if (hasFocus && !shouldAutoScroll) {
                    // æœ‰ç„¦ç‚¹æ—¶ï¼Œå°è¯•æ¢å¤ä¹‹å‰çš„æ»šåŠ¨ä½ç½®
                    const newScrollHeight = container.scrollHeight;
                    const maxScrollTop = Math.max(0, newScrollHeight - container.clientHeight);

                    // å¦‚æœä¹‹å‰åœ¨é¡¶éƒ¨é™„è¿‘ï¼ˆå‰10%ï¼‰ï¼Œä¿æŒåœ¨é¡¶éƒ¨
                    if (savedScrollTop <= savedScrollHeight * 0.1) {
                        container.scrollTop = 0;
                        console.log(`ğŸ”„ å®æ—¶æ—¥å¿—æ¨¡å—å•æ¡æ·»åŠ åä¿æŒåœ¨é¡¶éƒ¨ä½ç½®`);
                    } else {
                        // å¦åˆ™å°è¯•ä¿æŒç›¸å¯¹ä½ç½®
                        const relativePosition = savedScrollHeight > 0 ? savedScrollTop / savedScrollHeight : 0;
                        const newScrollTop = Math.min(maxScrollTop, relativePosition * newScrollHeight);
                        container.scrollTop = newScrollTop;
                        console.log(`ğŸ”„ å®æ—¶æ—¥å¿—æ¨¡å—å•æ¡æ·»åŠ åæ¢å¤ç›¸å¯¹æ»šåŠ¨ä½ç½®: ${savedScrollTop}/${savedScrollHeight} -> ${newScrollTop}/${newScrollHeight}`);
                    }
                } else {
                    // æ— ç„¦ç‚¹æ—¶ï¼Œå¼ºåˆ¶æ»šåŠ¨åˆ°æœ€æ–°ä½ç½®ï¼ˆé¡¶éƒ¨ï¼‰
                    container.scrollTop = 0;
                    console.log(`ğŸ“œ å®æ—¶æ—¥å¿—æ¨¡å—å•æ¡æ·»åŠ åè‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°ä½ç½®ï¼ˆé¡¶éƒ¨ï¼‰`);
                }
            }, 50); // å¢åŠ å»¶è¿Ÿç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
        }
    </script>
</body>
</html>
