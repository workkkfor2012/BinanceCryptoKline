<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebLog - å‰ç«¯èšåˆç‰ˆæœ¬ v2.6</title>

    <!-- Xterm.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/@xterm/xterm@5.5.0/css/xterm.css" />

    <!-- Xterm.js JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-web-links@0.11.0/lib/addon-web-links.js" defer></script>
    <!-- [æœ€ç»ˆã€å®Œç¾æ–¹æ¡ˆ] ä½¿ç”¨ç”¨æˆ·éªŒè¯å¯ç”¨çš„æœ€æ–°ç‰ˆ v0.15.0 -->
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-search@0.15.0/lib/addon-search.js" defer></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background-color: #1a1a1a;
            color: #00ff00;
            padding: 10px;
            font-size: 16px;
            line-height: 1.5;
        }

        .header {
            padding: 5px 10px;
            border-bottom: 2px solid #333;
            margin-bottom: 10px;
        }

        .header-top-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            flex-wrap: wrap;
        }

        .header h1 {
            color: #00ffff;
            font-size: 18px;
            margin: 0;
            flex-shrink: 0;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
            margin-right: 150px; /* å‘å·¦ç§»åŠ¨100pxï¼Œé¿å…ä¸å³ä¸Šè§’è¿æ¥çŠ¶æ€é‡å  */
        }

        .main-content {
            display: flex;
            gap: 15px;
            height: calc(100vh - 120px);
        }

        .static-modules-area {
            flex: 0 0 820px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: 100%;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 10px;
            background-color: #0f0f0f;
        }

        .static-modules-title {
            color: #00ffff;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            padding: 5px 0;
            border-bottom: 1px solid #444;
            margin-bottom: 5px;
            flex-shrink: 0;
        }

        .static-modules-content {
            flex: 1;
            display: flex;
            gap: 15px;
            min-height: 0;
        }

        /* ç¡®ä¿é™æ€æ¨¡å—åŒºåŸŸä¸­çš„ä¸¤ä¸ªæ¨¡å—å¹³åˆ†ç©ºé—´ */
        .static-modules-content .static-module {
            flex: 1;
            min-height: 0;
        }

        .dynamic-modules-area {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 15px;
            overflow-y: auto;
            height: 100%;
        }

        .module {
            border: 1px solid #333;
            border-radius: 5px;
            background-color: #0a0a0a;
            display: flex;
            flex-direction: column;
        }

        .static-module {
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .static-modules-area .module-header {
            background-color: #1a1a2e;
            border-bottom: 2px solid #16213e;
            flex-shrink: 0;
        }

        .static-modules-area .module-title {
            color: #0ff;
            font-weight: bold;
        }

        .static-modules-area .module-stats {
            flex-shrink: 0;
        }

        .static-modules-area .module-terminal {
            flex: 1;
            min-height: 0; /* ç¡®ä¿ç»ˆç«¯å¯ä»¥è¢«å‹ç¼© */
        }

        .module-header {
            padding: 8px 12px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .module-title {
            font-weight: bold;
            font-size: 16px;
            color: #00ffff;
        }

        .module-status {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-running { background-color: #006600; color: #00ff00; }
        .status-waiting { background-color: #666600; color: #ffff00; }
        .status-error { background-color: #660000; color: #ff0000; }
        .status-disconnected { background-color: #663300; color: #ff9900; }

        .module-stats {
            padding: 10px 15px;
            border-bottom: 1px solid #333;
            font-size: 13px;
            color: #cccccc;
        }

        .stat-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }

        .module-terminal {
            flex: 1;
            padding: 5px;
            background-color: #000000;
            overflow: hidden;
            min-height: 100px;
        }

        .xterm {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;
            font-size: 13px !important;
        }

        .xterm .xterm-viewport {
            background-color: #000000 !important;
        }

        .xterm .xterm-screen {
            background-color: #000000 !important;
        }

        /* è®©xterm.jsç»ˆç«¯å®ä¾‹å’Œå®ƒçš„è§†å£100%å¡«å……å…¶çˆ¶å®¹å™¨(.module-terminal) */
        .module-terminal .xterm,
        .module-terminal .xterm-viewport,
        .module-terminal .xterm-screen {
            height: 100% !important;
        }

        .connection-status {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
        }

        .connected { background-color: #006600; color: #00ff00; }
        .disconnected { background-color: #660000; color: #ff0000; }

        .header-copy-button {
            background-color: #ff6600;
            color: #ffffff;
            border: 2px solid #ff8833;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-family: 'Consolas', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(255, 102, 0, 0.4);
        }

        .header-copy-button:hover {
            background-color: #ff8833;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(255, 102, 0, 0.6);
        }

        .header-copy-button.copied {
            background-color: #44ff44;
            color: #000000;
            border-color: #66ff66;
        }

        .header-toggle-button {
            background-color: #0066ff;
            color: #ffffff;
            border: 2px solid #3388ff;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-family: 'Consolas', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 102, 255, 0.4);
        }

        .header-toggle-button:hover {
            background-color: #3388ff;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 102, 255, 0.6);
        }

        .header-toggle-button.active {
            background-color: #44ff44;
            color: #000000;
            border-color: #66ff66;
            box-shadow: 0 2px 6px rgba(68, 255, 68, 0.4);
        }

        .module-names-section {
            flex: 1;
            min-width: 300px;
        }

        .module-names-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .module-name-tag {
            background-color: #1a4a1a;
            color: #00ff00;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-family: 'Consolas', monospace;
            cursor: pointer;
            border: 1px solid #006600;
            transition: all 0.2s ease;
        }

        .module-name-tag:hover {
            background-color: #2a5a2a;
            border-color: #00ff00;
            transform: scale(1.05);
        }

        .module-name-tag.copied {
            background-color: #4a4a1a;
            color: #ffff00;
            border-color: #ffff00;
        }

        .no-modules {
            color: #666;
            font-style: italic;
            font-size: 12px;
        }

        html, body {
            height: 100%;
            overflow-x: hidden;
        }

        .dynamic-modules-area .module {
            min-height: 400px;
        }

        /* æœç´¢é¢æ¿æ ·å¼ */
        .search-panel {
            padding: 8px 12px;
            border-bottom: 1px solid #333;
            background-color: #1a1a1a;
            font-size: 12px;
            flex-shrink: 0; /* ç¡®ä¿æœç´¢é¢æ¿ä¸ä¼šè¢«å‹ç¼© */
        }

        .search-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 5px;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 4px 8px;
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 3px;
            color: #00ff00;
            font-family: 'Consolas', monospace;
            font-size: 12px;
        }

        .search-input:focus {
            outline: none;
            border-color: #00ff00;
            box-shadow: 0 0 3px rgba(0, 255, 0, 0.3);
        }

        .search-btn, .search-nav-btn {
            padding: 4px 8px;
            background-color: #0066ff;
            color: white;
            border: 1px solid #3388ff;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .search-btn:hover, .search-nav-btn:hover:not(:disabled) {
            background-color: #3388ff;
            transform: scale(1.05);
        }

        .search-btn:disabled, .search-nav-btn:disabled {
            background-color: #333;
            color: #666;
            cursor: not-allowed;
            border-color: #444;
        }

        .search-option {
            display: flex;
            align-items: center;
            gap: 3px;
            color: #cccccc;
            font-size: 11px;
            cursor: pointer;
        }

        .search-option input[type="checkbox"] {
            margin: 0;
        }

        .search-status {
            color: #888;
            font-size: 11px;
            font-style: italic;
            padding: 2px 4px;
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        .search-status.has-results {
            color: #00ff00;
            background-color: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
        }

        .search-status.no-results {
            color: #ff6600;
            background-color: rgba(255, 102, 0, 0.1);
            border: 1px solid rgba(255, 102, 0, 0.3);
        }

        /* [æ–°å¢] æœç´¢æ’ä»¶é«˜äº®æ ·å¼ */
        .xterm .xterm-search-layer .xterm-search-layer__term {
            background-color: #fce100; /* æ‰€æœ‰åŒ¹é…é¡¹ï¼šäº®é»„è‰²èƒŒæ™¯ */
            color: #000; /* é»‘è‰²æ–‡å­—ï¼Œå½¢æˆé«˜å¯¹æ¯”åº¦ */
            border-radius: 2px;
            box-sizing: border-box; /* ç¡®ä¿è¾¹æ¡†å’Œå†…è¾¹è·ä¸å½±å“å¸ƒå±€ */
        }

        .xterm .xterm-search-layer .xterm-search-layer__term.xterm-search-layer__term-active {
            background-color: #ff6600; /* å½“å‰æ¿€æ´»çš„åŒ¹é…é¡¹ï¼šäº®æ©™è‰²èƒŒæ™¯ */
            color: #fff; /* ç™½è‰²æ–‡å­—ï¼ŒåŒæ ·é«˜å¯¹æ¯”åº¦ */
        }

        @media (max-width: 1200px) {
            .static-modules-area {
                flex: 0 0 600px;
            }

            .static-modules-area .module-terminal {
                min-height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">è¿æ¥ä¸­...</div>

    <div class="header">
        <div class="header-top-row">
            <h1>WebLog - å‰ç«¯èšåˆç‰ˆæœ¬</h1>

            <div class="module-names-section">
                <div class="module-names-list" id="module-names-list">
                    <span class="no-modules">æš‚æ— æ¨¡å—æ•°æ®</span>
                </div>
            </div>

            <div class="header-buttons">
                <button class="header-copy-button" id="header-copy-modules" title="å¤åˆ¶æ‰€æœ‰æ¨¡å—åç§°">ğŸ”¥ å¤åˆ¶å…¨éƒ¨æ¨¡å—</button>
                <button class="header-toggle-button" id="toggle-realtime-logs" title="æ˜¾ç¤º/éšè—å®æ—¶åŸå§‹æ—¥å¿—">ğŸ“Š æ˜¾ç¤ºå®æ—¶åŸå§‹æ—¥å¿—</button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <!-- å·¦ä¾§é™æ€æ¨¡å—åŒºåŸŸ -->
        <div class="static-modules-area">
            <div class="static-modules-title">ğŸ“Š é™æ€æ¨¡å—åŒºåŸŸ - æ—¥å¿—ç›‘æ§</div>
            <div class="static-modules-content">
                <!-- å®æ—¶åŸå§‹æ—¥å¿—æ¨¡å— (é»˜è®¤éšè—) -->
                <div class="module static-module" id="realtime-logs-module" style="display: none;">
                    <div class="module-header">
                        <div class="module-title">åŸå§‹æ—¥å¿— | æ—¥å¿—æ•°: <span id="realtime-log-count">0</span> | æœ€åæ›´æ–°: <span id="last-log-time">--:--:--</span></div>
                        <div class="module-status status-waiting" id="realtime-logs-status">ç­‰å¾…æ—¥å¿—</div>
                    </div>
                    <!-- æœç´¢æ§åˆ¶é¢æ¿ -->
                    <div class="search-panel" id="realtime-logs-search-panel">
                        <div class="search-controls">
                            <input type="text" id="realtime-logs-search-input" placeholder="æœç´¢æ—¥å¿—å†…å®¹..." class="search-input">
                            <button id="realtime-logs-search-btn" class="search-btn" title="å¼€å§‹æœç´¢">ğŸ”</button>
                            <button id="realtime-logs-search-clear" class="search-btn" title="æ¸…é™¤æœç´¢">âœ–</button>
                            <button id="realtime-logs-search-prev" class="search-nav-btn" title="ä¸Šä¸€ä¸ªåŒ¹é…" disabled>â†‘</button>
                            <button id="realtime-logs-search-next" class="search-nav-btn" title="ä¸‹ä¸€ä¸ªåŒ¹é…" disabled>â†“</button>
                            <label class="search-option">
                                <input type="checkbox" id="realtime-logs-search-case"> åŒºåˆ†å¤§å°å†™
                            </label>
                            <label class="search-option">
                                <input type="checkbox" id="realtime-logs-search-regex"> æ­£åˆ™è¡¨è¾¾å¼
                            </label>
                        </div>
                        <div class="search-status" id="realtime-logs-search-status">è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢</div>
                    </div>
                    <div class="module-terminal" id="realtime-logs-terminal"></div>
                </div>

                <!-- åŸå§‹æ—¥å¿—é«˜é¢‘æŠ˜å æ¨¡å— -->
                <div class="module static-module" id="raw-logs-module">
                    <div class="module-header">
                        <div class="module-title">åŸå§‹æ—¥å¿—æŠ˜å  | æ€»æ•°: <span id="total-log-count">--</span> | æŠ˜å å: <span id="displayed-log-count">--</span> | æ—¶é—´: <span id="collapse-timestamp">--:--:--</span></div>
                        <div class="module-status status-waiting" id="raw-logs-status">ç­‰å¾…æ—¥å¿—</div>
                    </div>
                    <!-- æœç´¢æ§åˆ¶é¢æ¿ -->
                    <div class="search-panel" id="raw-logs-search-panel">
                        <div class="search-controls">
                            <input type="text" id="raw-logs-search-input" placeholder="æœç´¢æ—¥å¿—å†…å®¹..." class="search-input">
                            <button id="raw-logs-search-btn" class="search-btn" title="å¼€å§‹æœç´¢">ğŸ”</button>
                            <button id="raw-logs-search-clear" class="search-btn" title="æ¸…é™¤æœç´¢">âœ–</button>
                            <button id="raw-logs-search-prev" class="search-nav-btn" title="ä¸Šä¸€ä¸ªåŒ¹é…" disabled>â†‘</button>
                            <button id="raw-logs-search-next" class="search-nav-btn" title="ä¸‹ä¸€ä¸ªåŒ¹é…" disabled>â†“</button>
                            <label class="search-option">
                                <input type="checkbox" id="raw-logs-search-case"> åŒºåˆ†å¤§å°å†™
                            </label>
                            <label class="search-option">
                                <input type="checkbox" id="raw-logs-search-regex"> æ­£åˆ™è¡¨è¾¾å¼
                            </label>
                        </div>
                        <div class="search-status" id="raw-logs-search-status">è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢</div>
                    </div>
                    <div class="module-terminal" id="raw-logs-terminal"></div>
                </div>

            </div>
        </div>

        <!-- å³ä¾§åŠ¨æ€æ¨¡å—åŒºåŸŸ -->
        <div class="dynamic-modules-area" id="dynamic-modules-container">
            <!-- åŠ¨æ€æ¨¡å—å°†åœ¨è¿™é‡Œåˆ›å»º -->
        </div>
    </div>

    <script>
        // å‰ç«¯èšåˆç‰ˆæœ¬çš„WebLogç³»ç»Ÿ
        console.log('ğŸš€ WebLogå‰ç«¯èšåˆç‰ˆæœ¬å¯åŠ¨');

        // å…¨å±€çŠ¶æ€ç®¡ç†
        class WebLogState {
            constructor() {
                this.allLogs = [];           // æ‰€æœ‰åŸå§‹æ—¥å¿—
                this.moduleData = new Map(); // æŒ‰æ¨¡å—åˆ†ç±»çš„æ•°æ®
                this.highFreqAggregator = new HighFreqAggregator(); // é«˜é¢‘èšåˆå™¨
                this.isHistoryLoaded = false; // å†å²æ•°æ®æ˜¯å¦åŠ è½½å®Œæˆ
                this.logCount = 0;           // æ—¥å¿—è®¡æ•°
                this.lastLogTime = null;     // æœ€åæ—¥å¿—æ—¶é—´
                this.startTime = Date.now(); // å¯åŠ¨æ—¶é—´

                // èŠ‚æµæ§åˆ¶ - è§£å†³é¡µé¢é—ªçƒé—®é¢˜
                this.isUiUpdateScheduled = false; // æ˜¯å¦å·²æœ‰æ›´æ–°è®¡åˆ’
                this.uiUpdateInterval = 200; // æ›´æ–°é—´éš”ï¼Œå•ä½æ¯«ç§’
                this.pendingUpdates = {
                    moduleNames: false,
                    realtimeLogs: false,
                    highFreqCollapsed: false,
                    dynamicModules: new Set() // éœ€è¦æ›´æ–°çš„æ¨¡å—åç§°
                };
            }

            // å¤„ç†æ–°çš„æ—¥å¿—æ¡ç›®
            processLogEntry(logEntry) {
                this.allLogs.push(logEntry);
                this.logCount++;
                this.lastLogTime = new Date();

                // ã€æ–°å¢ã€‘å®æ—¶æ›´æ–° "å®æ—¶åŸå§‹æ—¥å¿—" é¢æ¿çš„ç»Ÿè®¡æ•°æ®å’ŒçŠ¶æ€
                const countEl = document.getElementById('realtime-log-count');
                const timeEl = document.getElementById('last-log-time');
                const realtimeStatusEl = document.getElementById('realtime-logs-status');

                if (countEl) countEl.textContent = this.logCount;
                if (timeEl && this.lastLogTime) timeEl.textContent = this.lastLogTime.toLocaleTimeString();

                // æ›´æ–°å®æ—¶åŸå§‹æ—¥å¿—çŠ¶æ€ä¸º"è¿è¡Œä¸­"
                if (realtimeStatusEl && this.logCount > 0) {
                    realtimeStatusEl.textContent = 'è¿è¡Œä¸­';
                    realtimeStatusEl.className = 'module-status status-running';
                }

                // ã€æ–°å¢ã€‘æ›´æ–°åŸå§‹æ—¥å¿—æŠ˜å æ¨¡å—çŠ¶æ€ä¸º"è¿è¡Œä¸­"
                const rawLogsStatusEl = document.getElementById('raw-logs-status');
                if (rawLogsStatusEl && this.logCount > 0) {
                    rawLogsStatusEl.textContent = 'è¿è¡Œä¸­';
                    rawLogsStatusEl.className = 'module-status status-running';
                }

                // æŒ‰æ¨¡å—åˆ†ç±»
                const moduleName = logEntry.target;
                if (!this.moduleData.has(moduleName)) {
                    this.moduleData.set(moduleName, {
                        name: moduleName,
                        logs: [],
                        errorCount: 0,
                        warnCount: 0,
                        infoCount: 0,
                        totalLogs: 0
                    });
                }

                const moduleInfo = this.moduleData.get(moduleName);
                moduleInfo.logs.push(logEntry);
                moduleInfo.totalLogs++;

                // ç»Ÿè®¡æ—¥å¿—çº§åˆ«
                switch (logEntry.level.toUpperCase()) {
                    case 'ERROR':
                        moduleInfo.errorCount++;
                        break;
                    case 'WARN':
                        moduleInfo.warnCount++;
                        break;
                    case 'INFO':
                        moduleInfo.infoCount++;
                        break;
                }

                // ä¿æŒæœ€è¿‘1000æ¡æ—¥å¿—
                if (moduleInfo.logs.length > 10000000) {
                    moduleInfo.logs.shift();
                }

                // é«˜é¢‘èšåˆå¤„ç†
                this.highFreqAggregator.processLog(logEntry);

                // ã€æ–°å¢ã€‘ç«‹å³æ›´æ–°å®æ—¶æ—¥å¿—ï¼ˆå¦‚æœæ˜¾ç¤ºï¼‰ï¼Œä½¿å…¶ä¸é«˜é¢‘æŠ˜å è¡Œä¸ºä¸€è‡´
                // æ— è®ºæ˜¯å¦æ˜¯å†å²æ•°æ®ï¼Œéƒ½è¿½åŠ åˆ°å®æ—¶åŸå§‹æ—¥å¿—ç»ˆç«¯
                if (terminalManager) {
                    terminalManager.appendToRealtimeLogs(logEntry);
                }

                // ç«‹å³å¢é‡æ›´æ–° - æ— éœ€èŠ‚æµï¼Œç›´æ¥è¿½åŠ åˆ°ç»ˆç«¯
                // æ³¨æ„ï¼šè¿™é‡Œåªå¤„ç†åŠ¨æ€æ¨¡å—ï¼Œå®æ—¶åŸå§‹æ—¥å¿—å·²åœ¨ä¸Šé¢å¤„ç†
                if (this.isHistoryLoaded && terminalManager) {
                    // ç«‹å³è¿½åŠ åˆ°å¯¹åº”æ¨¡å—ç»ˆç«¯
                    terminalManager.appendLogToTerminal(moduleName, logEntry);

                    // æ›´æ–°æ¨¡å—ç»Ÿè®¡
                    this.updateModuleStatsIncremental(moduleName, moduleInfo);
                }

                // æ³¨æ„ï¼šé«˜é¢‘æŠ˜å ç»ˆç«¯çš„æ›´æ–°å·²ç»åœ¨ highFreqAggregator.processLog() ä¸­è‡ªåŠ¨å¤„ç†

                // åªæœ‰æ¨¡å—åç§°éœ€è¦å»¶è¿Ÿæ›´æ–°ï¼ˆé¿å…é¢‘ç¹DOMæ“ä½œï¼‰
                this.pendingUpdates.moduleNames = true;
                this.scheduleUIUpdate();
            }

            // èŠ‚æµè°ƒåº¦UIæ›´æ–° - é˜²æ­¢é«˜é¢‘é—ªçƒ
            scheduleUIUpdate() {
                if (!this.isUiUpdateScheduled) {
                    this.isUiUpdateScheduled = true;
                    setTimeout(() => {
                        this.performScheduledUpdates();
                        this.isUiUpdateScheduled = false;
                    }, this.uiUpdateInterval);
                }
            }

            // æ‰§è¡Œè®¡åˆ’ä¸­çš„æ›´æ–° - åªæ›´æ–°æ¨¡å—åç§°åˆ—è¡¨ï¼ˆå…¶ä»–éƒ½æ˜¯å®æ—¶å¢é‡æ›´æ–°ï¼‰
            performScheduledUpdates() {
                if (this.pendingUpdates.moduleNames) {
                    this.updateModuleNames();
                    this.pendingUpdates.moduleNames = false;
                }
            }

            // å¢é‡æ›´æ–°æ¨¡å—ç»Ÿè®¡ä¿¡æ¯
            updateModuleStatsIncremental(moduleName, moduleInfo) {
                if (!terminalManager.moduleExists(moduleName)) {
                    terminalManager.createDynamicModule(moduleName, moduleInfo);
                }
                terminalManager.updateModuleStats(moduleName, moduleInfo);
            }

            // æ›´æ–°ç•Œé¢ - ä¿ç•™ç”¨äºå†å²æ•°æ®åŠ è½½æ—¶çš„å…¨é‡æ›´æ–°
            updateUI() {
                this.updateModuleNames();
                // this.updateRealtimeLogs(); // ç¦ç”¨ï¼šé¿å…æ¸…ç©ºå·²å®æ—¶å¡«å……çš„å†…å®¹
                // this.updateHighFreqCollapsed(); // ç¦ç”¨ï¼šé¿å…æ¸…ç©ºå·²å®æ—¶å¡«å……çš„å†…å®¹
                this.updateDynamicModules();
            }

            // æ›´æ–°æ¨¡å—åç§°åˆ—è¡¨
            updateModuleNames() {
                const container = document.getElementById('module-names-list');
                if (this.moduleData.size === 0) {
                    container.innerHTML = '<span class="no-modules">æš‚æ— æ¨¡å—æ•°æ®</span>';
                    return;
                }

                const moduleNames = Array.from(this.moduleData.keys()).sort();
                container.innerHTML = moduleNames.map(name =>
                    `<span class="module-name-tag" onclick="copyModuleName('${name}')">${name}</span>`
                ).join('');
            }

            // æ›´æ–°å®æ—¶æ—¥å¿—æ˜¾ç¤º
            updateRealtimeLogs() {
                const countEl = document.getElementById('realtime-log-count');
                const timeEl = document.getElementById('last-log-time');

                if (countEl) countEl.textContent = this.logCount;
                if (timeEl && this.lastLogTime) {
                    timeEl.textContent = this.lastLogTime.toLocaleTimeString();
                }

                // æ›´æ–°å®æ—¶æ—¥å¿—ç»ˆç«¯
                if (terminalManager && this.isHistoryLoaded) {
                    const recentLogs = this.allLogs.slice(-100); // æœ€è¿‘100æ¡ï¼Œä¸é«˜é¢‘æŠ˜å ä¿æŒä¸€è‡´
                    terminalManager.updateRealtimeLogs(recentLogs);
                }
            }

            // æ›´æ–°é«˜é¢‘æŠ˜å æ—¥å¿— - ä»…ç”¨äºå†å²æ•°æ®åŠ è½½
            updateHighFreqCollapsed() {
                // è·å–é«˜é¢‘èšåˆåçš„æ—¥å¿—
                const aggregatedLogs = this.highFreqAggregator.getAggregatedLogs();

                // æ›´æ–°é«˜é¢‘æŠ˜å æ—¥å¿—ç»ˆç«¯ï¼ˆä»…ç”¨äºå†å²æ•°æ®åŠ è½½ï¼‰
                if (terminalManager && this.isHistoryLoaded) {
                    terminalManager.updateHighFreqCollapsed(aggregatedLogs);
                }
            }

            // æ›´æ–°åŠ¨æ€æ¨¡å— - å…¨é‡æ›´æ–°ï¼ˆç”¨äºå†å²æ•°æ®åŠ è½½ï¼‰
            updateDynamicModules() {
                if (terminalManager && this.isHistoryLoaded) {
                    for (const [moduleName, moduleInfo] of this.moduleData) {
                        terminalManager.updateModuleTerminal(moduleName, moduleInfo);
                    }
                }
            }

            // æ›´æ–°å•ä¸ªåŠ¨æ€æ¨¡å— - å¢é‡æ›´æ–°ï¼ˆç”¨äºå®æ—¶æ—¥å¿—ï¼‰
            updateDynamicModule(moduleName, moduleInfo) {
                if (terminalManager && this.isHistoryLoaded) {
                    terminalManager.updateModuleTerminal(moduleName, moduleInfo);
                }
            }

            // æ¸…ç©ºæ‰€æœ‰æ•°æ® - ç”¨äºæ–°ä¼šè¯å¼€å§‹æ—¶é‡ç½®å‰ç«¯çŠ¶æ€
            clearAllData() {
                console.log('ğŸ§¹ æ¸…ç©ºå‰ç«¯ç¼“å­˜æ•°æ®');

                // é‡ç½®æ‰€æœ‰çŠ¶æ€
                this.allLogs = [];
                this.moduleData.clear();
                this.isHistoryLoaded = false;
                this.logCount = 0;
                this.lastLogTime = null;
                this.startTime = Date.now();

                // é‡ç½®é«˜é¢‘èšåˆå™¨
                this.highFreqAggregator = new HighFreqAggregator();

                // æ¸…ç©ºæ‰€æœ‰ç»ˆç«¯
                if (terminalManager) {
                    // æ¸…ç©ºå®æ—¶æ—¥å¿—ç»ˆç«¯
                    const realtimeTerminal = terminalManager.terminals.get('realtime-logs');
                    if (realtimeTerminal) {
                        realtimeTerminal.clear();
                        terminalManager.logBuffers.set('realtime-logs', []);
                    }

                    // æ¸…ç©ºé«˜é¢‘æŠ˜å ç»ˆç«¯
                    const rawLogsTerminal = terminalManager.terminals.get('raw-logs');
                    if (rawLogsTerminal) {
                        rawLogsTerminal.clear();
                        terminalManager.logBuffers.set('raw-logs', []);
                    }

                    // æ¸…ç©ºæ‰€æœ‰åŠ¨æ€æ¨¡å—ç»ˆç«¯
                    for (const [moduleName, terminal] of terminalManager.terminals) {
                        if (moduleName !== 'realtime-logs' && moduleName !== 'raw-logs') {
                            terminal.clear();
                            terminalManager.logBuffers.set(moduleName, []);
                        }
                    }
                }

                // æ¸…ç©ºUIæ˜¾ç¤º
                this.updateModuleNames();

                // é‡ç½®ç»Ÿè®¡æ˜¾ç¤º
                const countEl = document.getElementById('realtime-log-count');
                const timeEl = document.getElementById('last-log-time');
                const totalCountEl = document.getElementById('total-log-count');
                const displayedCountEl = document.getElementById('displayed-log-count');
                const timestampEl = document.getElementById('collapse-timestamp');

                if (countEl) countEl.textContent = '0';
                if (timeEl) timeEl.textContent = '--';
                if (totalCountEl) totalCountEl.textContent = '0';
                if (displayedCountEl) displayedCountEl.textContent = '0';
                if (timestampEl) timestampEl.textContent = '--';

                // é‡ç½®çŠ¶æ€æ˜¾ç¤º
                const realtimeStatusEl = document.getElementById('realtime-logs-status');
                const rawLogsStatusEl = document.getElementById('raw-logs-status');

                if (realtimeStatusEl) {
                    realtimeStatusEl.textContent = 'ç­‰å¾…æ—¥å¿—';
                    realtimeStatusEl.className = 'module-status status-waiting';
                }

                if (rawLogsStatusEl) {
                    rawLogsStatusEl.textContent = 'ç­‰å¾…æ—¥å¿—';
                    rawLogsStatusEl.className = 'module-status status-waiting';
                }

                console.log('âœ… å‰ç«¯ç¼“å­˜æ¸…ç©ºå®Œæˆ');
            }
        }

        // é«˜é¢‘æ—¥å¿—èšåˆå™¨ - é‡‡ç”¨ is_high_freq å’Œ event_type ç²¾ç¡®æ§åˆ¶
        class HighFreqAggregator {
            constructor() {
                this.aggregatedLogs = []; // æŒä¹…åŒ–çš„æ—¥å¿—åˆ—è¡¨ï¼Œæ˜¯ç»ˆç«¯æ˜¾ç¤ºçš„æœ€ç»ˆæ•°æ®æº
                // è¿½è¸ªæ´»è·ƒçš„ã€å¯è¢«æŠ˜å çš„æ—¥å¿—åˆ†ç»„
                // Key: messageKey (ç”± target:event_type æ„æˆ), Value: { index, count, ... }
                this.activeGroups = new Map();
                this.timeWindow = 5000; // 5ç§’æ—¶é—´çª—å£
            }

            // æ ¸å¿ƒå¤„ç†é€»è¾‘ - å·²é‡æ„ä¸ºç²¾ç¡®åˆ†å‘
            processLog(logEntry) {
                const isHighFreq = logEntry.fields && logEntry.fields.is_high_freq === true;

                // **å…³é”®åˆ†å‘é€»è¾‘**
                if (isHighFreq && logEntry.fields.event_type) {
                    // **è·¯å¾„1ï¼šé«˜é¢‘æ—¥å¿—å¤„ç†**
                    // åªæœ‰æ ‡è®°ä¸ºé«˜é¢‘ä¸”æ‹¥æœ‰event_typeçš„æ—¥å¿—æ‰è¿›å…¥èšåˆæµç¨‹
                    this.processHighFrequencyLog(logEntry);
                } else {
                    // **è·¯å¾„2ï¼šæ™®é€šæ—¥å¿—å¤„ç†**
                    // æ‰€æœ‰å…¶ä»–æ—¥å¿—ï¼ˆéé«˜é¢‘æˆ–ç¼ºå°‘event_typeï¼‰éƒ½ç›´æ¥è¿½åŠ ï¼Œä¸å‚ä¸èšåˆ
                    this.appendAsNormalLog(logEntry);
                }

                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                this.updateStats();
            }

            // å¤„ç†é«˜é¢‘æ—¥å¿—ï¼ˆèšåˆé€»è¾‘ï¼‰
            processHighFrequencyLog(logEntry) {
                const messageKey = this.getMessageKey(logEntry);
                const now = Date.now();

                if (this.activeGroups.has(messageKey)) {
                    const group = this.activeGroups.get(messageKey);

                    // æ£€æŸ¥åˆ†ç»„æ˜¯å¦ä»åœ¨æ—¶é—´çª—å£å†…
                    if (now - group.lastTime < this.timeWindow) {
                        // èšåˆï¼šæ›´æ–°ç°æœ‰åˆ†ç»„
                        group.count++;
                        group.lastTime = now;
                        group.lastEntry = logEntry;

                        const aggregatedEntry = {
                            ...group.lastEntry,
                            message: `[${group.count}x] ${group.firstEntry.message}`,
                            isAggregated: true,
                            count: group.count,
                        };

                        this.aggregatedLogs[group.index] = aggregatedEntry;
                        terminalManager.updateHighFreqLogInPlace(group.index, aggregatedEntry, this.aggregatedLogs);
                    } else {
                        // è¶…æ—¶ï¼šç»“æŸæ—§åˆ†ç»„ï¼Œå°†æ­¤æ—¥å¿—ä½œä¸ºæ–°åˆ†ç»„çš„å¼€å§‹
                        this.activeGroups.delete(messageKey);
                        this.addNewHighFreqGroup(logEntry, messageKey, now);
                    }
                } else {
                    // å…¨æ–°ï¼šä¸ºæ­¤ event_type åˆ›å»ºä¸€ä¸ªæ–°çš„èšåˆåˆ†ç»„
                    this.addNewHighFreqGroup(logEntry, messageKey, now);
                }
            }

            // å°†æ—¥å¿—ä½œä¸ºæ™®é€šã€éèšåˆæ¡ç›®ç›´æ¥è¿½åŠ 
            appendAsNormalLog(logEntry) {
                // ç›´æ¥æ·»åŠ åˆ°æ•°æ®æº
                this.aggregatedLogs.push(logEntry);
                // ç›´æ¥é€šçŸ¥ç»ˆç«¯ç®¡ç†å™¨è¿½åŠ æ˜¾ç¤º
                terminalManager.appendHighFreqLog(logEntry, this.aggregatedLogs);
            }

            // è·å–é«˜é¢‘æ—¥å¿—çš„åˆ†ç»„é”®
            getMessageKey(logEntry) {
                // æ­¤æ–¹æ³•ç°åœ¨åªè¢«é«˜é¢‘æ—¥å¿—è·¯å¾„è°ƒç”¨ï¼Œå› æ­¤å¯ä»¥ç¡®ä¿¡ event_type å­˜åœ¨
                return `${logEntry.target}:${logEntry.fields.event_type}`;
            }

            // è¾…åŠ©å‡½æ•°ï¼šä¸ºé«˜é¢‘æ—¥å¿—åˆ›å»ºä¸€ä¸ªæ–°çš„èšåˆåˆ†ç»„
            addNewHighFreqGroup(logEntry, messageKey, now) {
                this.aggregatedLogs.push(logEntry);
                const newIndex = this.aggregatedLogs.length - 1;

                // åˆ›å»ºä¸€ä¸ªæ–°çš„æ´»è·ƒåˆ†ç»„ï¼Œä»¥ä¾¿åç»­çš„æ—¥å¿—å¯ä»¥åŒ¹é…å¹¶æŠ˜å 
                this.activeGroups.set(messageKey, {
                    index: newIndex,
                    count: 1,
                    lastTime: now,
                    firstEntry: logEntry,
                    lastEntry: logEntry
                });

                // é€šçŸ¥ç»ˆç«¯ç®¡ç†å™¨è¿½åŠ æ˜¾ç¤ºè¿™ä¸ªæ–°åˆ†ç»„çš„åˆå§‹æ—¥å¿—
                terminalManager.appendHighFreqLog(logEntry, this.aggregatedLogs);
            }

            // åªæ›´æ–°ç»Ÿè®¡éƒ¨åˆ†çš„UI
            updateStats() {
                const timestampEl = document.getElementById('collapse-timestamp');
                const totalCountEl = document.getElementById('total-log-count');
                const displayedCountEl = document.getElementById('displayed-log-count');

                if (timestampEl) timestampEl.textContent = new Date().toLocaleTimeString();
                if (totalCountEl) totalCountEl.textContent = webLogState.allLogs.length;
                if (displayedCountEl) displayedCountEl.textContent = this.aggregatedLogs.length;
            }

            // è·å–èšåˆåçš„æ—¥å¿—ï¼ˆç”¨äºå†å²åŠ è½½ï¼‰
            getAggregatedLogs() {
                return this.aggregatedLogs;
            }

            // å®Œæ•´é‡ç»˜ç»ˆç«¯ï¼ˆä»…ç”¨äºåˆå§‹åŒ–æˆ–ç‰¹æ®Šæƒ…å†µï¼‰
            updateHighFreqCollapsed(logs) {
                const terminal = terminalManager.terminals.get('raw-logs');
                if (!terminal) return;

                const displayLogs = logs ? logs.slice(-100) : this.aggregatedLogs.slice(-100);

                terminal.clear();
                const logBuffer = [];
                displayLogs.forEach(log => {
                    const formattedLog = terminalManager.formatLogEntry(log);
                    logBuffer.push(formattedLog);
                    terminal.write(formattedLog + '\r\n');
                });
                terminalManager.logBuffers.set('raw-logs', logBuffer);
                this.updateStats();
            }
        }

        // [ä¿®æ”¹] SearchManager å®Œå…¨é‡æ„ï¼Œä½¿ç”¨ xterm-addon-search
        class SearchManager {
            constructor() {
                this.terminalName = '';
                this.searchAddon = null;
                this.isSearchActive = false;
                this.lastSearchTerm = '';
            }

            initializeSearch(terminalName) {
                this.terminalName = terminalName;
                this.searchAddon = terminalManager.searchAddons.get(terminalName);

                if (!this.searchAddon) {
                    console.error(`æœç´¢æ’ä»¶åˆå§‹åŒ–å¤±è´¥: ${terminalName}`);
                    return;
                }

                const searchInput = document.getElementById(`${terminalName}-search-input`);
                const searchBtn = document.getElementById(`${terminalName}-search-btn`);
                const clearBtn = document.getElementById(`${terminalName}-search-clear`);
                const prevBtn = document.getElementById(`${terminalName}-search-prev`);
                const nextBtn = document.getElementById(`${terminalName}-search-next`);
                const caseCheckbox = document.getElementById(`${terminalName}-search-case`);
                const regexCheckbox = document.getElementById(`${terminalName}-search-regex`);

                this.searchAddon.onDidChangeResults((results) => {
                    this.updateSearchStatus(results.resultCount, results.resultIndex);
                    this.updateNavigationButtons(results.resultCount > 0);
                });

                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        if(searchInput.value !== this.lastSearchTerm) {
                            this.performSearch();
                        } else {
                            this.navigateMatch(1);
                        }
                    } else if (e.key === 'Escape') {
                        this.clearSearch();
                    }
                });

                searchBtn?.addEventListener('click', () => this.performSearch());
                clearBtn?.addEventListener('click', () => this.clearSearch());
                prevBtn?.addEventListener('click', () => this.navigateMatch(-1));
                nextBtn?.addEventListener('click', () => this.navigateMatch(1));

                const performSearchIfActive = () => {
                    if (this.isSearchActive) this.performSearch();
                };

                caseCheckbox?.addEventListener('change', performSearchIfActive);
                regexCheckbox?.addEventListener('change', performSearchIfActive);
            }

            getSearchOptions() {
                const caseCheckbox = document.getElementById(`${this.terminalName}-search-case`);
                const regexCheckbox = document.getElementById(`${this.terminalName}-search-regex`);
                return {
                    regex: regexCheckbox ? regexCheckbox.checked : false,
                    caseSensitive: caseCheckbox ? caseCheckbox.checked : false,
                    incremental: false, // æˆ‘ä»¬æ‰‹åŠ¨è§¦å‘æœç´¢ï¼Œè€Œéè¾“å…¥æ—¶å³æ—¶æœç´¢
                    decorations: {
                        // ä¸è®¾ç½®èƒŒæ™¯è‰²ï¼Œä¿æŒé€æ˜
                        matchBorder: '#FF0000',            // çº¢è‰²è¾¹æ¡† - æ™®é€šåŒ¹é…é¡¹
                        matchOverviewRuler: '#FF0000',     // çº¢è‰²æ¦‚è§ˆæ ‡å°º - æ™®é€šåŒ¹é…é¡¹
                        // ä¸è®¾ç½®èƒŒæ™¯è‰²ï¼Œä¿æŒé€æ˜
                        activeMatchBorder: '#FFFF00',      // é»„è‰²è¾¹æ¡† - å½“å‰æ¿€æ´»åŒ¹é…é¡¹
                        activeMatchColorOverviewRuler: '#FFFF00' // é»„è‰²æ¦‚è§ˆæ ‡å°º - å½“å‰æ¿€æ´»åŒ¹é…é¡¹
                    }
                };
            }

            performSearch() {
                const searchInput = document.getElementById(`${this.terminalName}-search-input`);
                const term = searchInput.value;

                if (!term) {
                    this.clearSearch();
                    return;
                }

                this.isSearchActive = true;
                this.lastSearchTerm = term;
                this.searchAddon.findNext(term, this.getSearchOptions());
            }

            navigateMatch(direction) {
                if (!this.isSearchActive) return;
                const term = this.lastSearchTerm;
                if (direction > 0) {
                    this.searchAddon.findNext(term, this.getSearchOptions());
                } else {
                    this.searchAddon.findPrevious(term, this.getSearchOptions());
                }
            }

            clearSearch() {
                this.searchAddon.clearDecorations();
                this.isSearchActive = false;
                this.lastSearchTerm = '';

                const searchInput = document.getElementById(`${this.terminalName}-search-input`);
                if (searchInput) searchInput.value = '';

                this.updateSearchStatus(0, -1);
                this.updateNavigationButtons(false);
                const statusEl = document.getElementById(`${this.terminalName}-search-status`);
                if(statusEl) {
                    statusEl.textContent = 'è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢';
                    statusEl.className = 'search-status';
                }
            }

            updateSearchStatus(count, index) {
                const statusEl = document.getElementById(`${this.terminalName}-search-status`);
                if (!statusEl) return;

                if (!this.isSearchActive || count === 0) {
                    if(this.isSearchActive) {
                        statusEl.textContent = `æœªæ‰¾åˆ°åŒ¹é…é¡¹: "${this.lastSearchTerm}"`;
                        statusEl.className = 'search-status no-results';
                    } else {
                         statusEl.textContent = 'è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢';
                         statusEl.className = 'search-status';
                    }
                } else {
                    statusEl.textContent = `ğŸ” æ‰¾åˆ° ${count} ä¸ªåŒ¹é…é¡¹ | å½“å‰: ${index + 1}/${count}`;
                    statusEl.className = 'search-status has-results';
                }
            }

            updateNavigationButtons(hasMatches) {
                const prevBtn = document.getElementById(`${this.terminalName}-search-prev`);
                const nextBtn = document.getElementById(`${this.terminalName}-search-next`);

                if (prevBtn) prevBtn.disabled = !hasMatches;
                if (nextBtn) nextBtn.disabled = !hasMatches;
            }
        }

        // å…¨å±€çŠ¶æ€å®ä¾‹
        const webLogState = new WebLogState();

        // ç»ˆç«¯ç®¡ç†å™¨
        class TerminalManager {
            constructor() {
                this.terminals = new Map();
                this.fitAddons = new Map();
                this.searchAddons = new Map(); // [æ–°å¢] ç”¨äºå­˜å‚¨æœç´¢æ’ä»¶å®ä¾‹
                this.logBuffers = new Map(); // æ—¥å¿—ç¼“å†²åŒºï¼Œç”¨äºç®¡ç†æ¯ä¸ªç»ˆç«¯çš„æ—¥å¿—
                this.searchManagers = new Map(); // æœç´¢ç®¡ç†å™¨
                this.maxLines = 100000000; // æ¯ä¸ªç»ˆç«¯æœ€å¤§è¡Œæ•°

                this.terminalTheme = {
                    background: '#000000',
                    foreground: '#00ff00',
                    cursor: '#00ff00',
                    cursorAccent: '#000000',
                    // [ä¿®æ”¹] selectionçš„é¢œè‰²ç°åœ¨åªç”¨äºæ‰‹åŠ¨é€‰æ‹©ï¼Œä¸å†å½±å“æœç´¢
                    selectionBackground: 'rgba(255, 255, 255, 0.3)',
                    selectionForeground: '#000000', // å¯é€‰ï¼Œä¸ºé€‰æ‹©æ–‡æœ¬æ·»åŠ å‰æ™¯è‰²
                    black: '#000000',
                    red: '#ff0000',
                    green: '#00ff00',
                    yellow: '#ffff00',
                    blue: '#0066ff',
                    magenta: '#ff00ff',
                    cyan: '#00ffff',
                    white: '#ffffff',
                    brightBlack: '#666666',
                    brightRed: '#ff6666',
                    brightGreen: '#66ff66',
                    brightYellow: '#ffff66',
                    brightBlue: '#6666ff',
                    brightMagenta: '#ff66ff',
                    brightCyan: '#66ffff',
                    brightWhite: '#ffffff'
                };
            }

            // [ä¿®æ”¹] åˆ›å»ºç»ˆç«¯æ—¶åŠ è½½æœç´¢æ’ä»¶
            createTerminal(containerId, moduleName) {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error(`æ‰¾ä¸åˆ°å®¹å™¨: ${containerId}`);
                    return null;
                }

                const terminal = new Terminal({
                    theme: this.terminalTheme,
                    fontFamily: 'Consolas, Monaco, "Courier New", monospace',
                    fontSize: 15,  // å¢å¤§å­—ä½“ä»13åˆ°15
                    lineHeight: 1.2,
                    cursorBlink: false,
                    scrollback: this.maxLines,
                    convertEol: true,
                    disableStdin: true,
                    allowTransparency: true,
                    allowProposedApi: true  // å¯ç”¨æè®®APIä»¥æ”¯æŒæœç´¢è£…é¥°åŠŸèƒ½
                });

                // [ä¿®æ­£] é€šè¿‡ "å‘½åç©ºé—´.æ„é€ å‡½æ•°" çš„æ–¹å¼å®ä¾‹åŒ–æ’ä»¶
                const fitAddon = new FitAddon.FitAddon();
                const webLinksAddon = new WebLinksAddon.WebLinksAddon();

                let searchAddon = null;
                try {
                    // [ä¿®æ­£] ä½¿ç”¨æ­£ç¡®çš„å…¨å±€å˜é‡ SearchAddon å’Œæ­£ç¡®çš„å®ä¾‹åŒ–æ–¹å¼
                    if (window.SearchAddon && typeof window.SearchAddon.SearchAddon === 'function') {
                        // åˆ›å»ºæœç´¢æ’ä»¶æ—¶é…ç½®è¾¹æ¡†è£…é¥°é¢œè‰²ï¼ˆæ— èƒŒæ™¯ï¼‰
                        const searchOptions = {
                            decorations: {
                                // ä¸è®¾ç½®èƒŒæ™¯è‰²ï¼Œä¿æŒé€æ˜
                                matchBorder: '#FF0000',            // çº¢è‰²è¾¹æ¡† - æ™®é€šåŒ¹é…é¡¹
                                matchOverviewRuler: '#FF0000',     // çº¢è‰²æ¦‚è§ˆæ ‡å°º - æ™®é€šåŒ¹é…é¡¹
                                // ä¸è®¾ç½®èƒŒæ™¯è‰²ï¼Œä¿æŒé€æ˜
                                activeMatchBorder: '#FFFF00',      // é»„è‰²è¾¹æ¡† - å½“å‰æ¿€æ´»åŒ¹é…é¡¹
                                activeMatchColorOverviewRuler: '#FFFF00' // é»„è‰²æ¦‚è§ˆæ ‡å°º - å½“å‰æ¿€æ´»åŒ¹é…é¡¹
                            }
                        };
                        searchAddon = new window.SearchAddon.SearchAddon(searchOptions);
                        console.log(`âœ… æœç´¢æ’ä»¶åˆ›å»ºæˆåŠŸ for ${moduleName} (é«˜å¯¹æ¯”åº¦é…è‰²)`);
                    } else {
                        // æ›´æ–°é”™è¯¯ä¿¡æ¯ä»¥åæ˜ æ­£ç¡®çš„å˜é‡å
                        throw new Error('SearchAddon æœªåœ¨ window å¯¹è±¡ä¸Šæ­£ç¡®å®šä¹‰ã€‚è¯·æ£€æŸ¥ xterm-addon-search è„šæœ¬æ˜¯å¦æ­£ç¡®åŠ è½½ã€‚');
                    }
                } catch (error) {
                    console.error('âŒ åˆ›å»ºæœç´¢æ’ä»¶å¤±è´¥:', error);
                    // åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿçš„æœç´¢æ’ä»¶å¯¹è±¡ï¼Œé¿å…åç»­ä»£ç å´©æºƒ
                    searchAddon = {
                        activate: () => {},
                        onDidChangeResults: () => {},
                        findNext: () => {},
                        findPrevious: () => {},
                        clearDecorations: () => {},
                        clearActiveDecoration: () => {}
                    };
                    console.log('âš ï¸ å·²åˆ›å»ºæ¨¡æ‹Ÿæœç´¢å¯¹è±¡ï¼Œæœç´¢åŠŸèƒ½å°†ä¸å¯ç”¨ã€‚');
                }

                terminal.loadAddon(fitAddon);
                terminal.loadAddon(webLinksAddon);
                terminal.loadAddon(searchAddon); // åŠ è½½çœŸå®çš„æˆ–æ¨¡æ‹Ÿçš„æ’ä»¶

                terminal.open(container);
                setTimeout(() => fitAddon.fit(), 0);

                this.terminals.set(moduleName, terminal);
                this.fitAddons.set(moduleName, fitAddon);
                this.searchAddons.set(moduleName, searchAddon);
                this.logBuffers.set(moduleName, []); // åˆå§‹åŒ–æ—¥å¿—ç¼“å†²åŒº

                return terminal;
            }

            // è¿½åŠ ä¸€è¡Œåˆ°é«˜é¢‘æŠ˜å ç»ˆç«¯ï¼Œæ— é—ªçƒ
            appendHighFreqLog(logEntry, allAggregatedLogs) {
                const terminal = this.terminals.get('raw-logs');
                if (!terminal) return;

                const buffer = this.logBuffers.get('raw-logs');
                if (!buffer) return;

                // å¦‚æœç¼“å†²åŒºè¶…è¿‡æœ€å¤§è¡Œæ•°ï¼Œéœ€è¦è¿›è¡Œä¸€æ¬¡å®Œæ•´çš„é‡ç»˜ä»¥åŒæ­¥è§†å›¾
                // è¿™æ˜¯ä¸ºäº†å¤„ç†æ»šåŠ¨åé¡¶éƒ¨æ—¥å¿—è¢«ä¸¢å¼ƒçš„æƒ…å†µï¼Œé¿å…ç´¢å¼•é”™ä¹±
                // è¿™ç§æƒ…å†µå‘ç”Ÿé¢‘ç‡è¾ƒä½ï¼Œå¯ä»¥æ¥å—å¶å°”çš„é‡ç»˜
                if (buffer.length >= this.maxLines) {
                    this.updateHighFreqCollapsed(allAggregatedLogs);
                    return;
                }

                // æ­£å¸¸è¿½åŠ 
                const formattedLog = this.formatLogEntry(logEntry);
                buffer.push(formattedLog);
                terminal.write(formattedLog + '\r\n');
            }

            // åŸåœ°æ›´æ–°é«˜é¢‘æŠ˜å ç»ˆç«¯çš„æŸä¸€è¡Œï¼Œæ— é—ªçƒ
            updateHighFreqLogInPlace(globalIndex, logEntry, allAggregatedLogs) {
                const terminal = this.terminals.get('raw-logs');
                if (!terminal) return;

                // è®¡ç®—è¯¥æ—¥å¿—åœ¨å½“å‰æ˜¾ç¤ºçš„100æ¡ä¸­çš„ä½ç½®
                const displaySize = Math.min(allAggregatedLogs.length, 100);
                const startIndex = allAggregatedLogs.length - displaySize;
                const lineOnScreen = globalIndex - startIndex;

                // å¦‚æœæ—¥å¿—ä¸åœ¨å½“å‰å±å¹•æ˜¾ç¤ºçš„èŒƒå›´å†…ï¼Œåˆ™æ— éœ€æ›´æ–°
                if (lineOnScreen < 0 || lineOnScreen >= displaySize) {
                    return;
                }

                const formattedLog = this.formatLogEntry(logEntry);

                // ä½¿ç”¨ANSIè½¬ä¹‰åºåˆ—å®ç°åŸåœ°æ›´æ–°
                // \x1b[s       : ä¿å­˜å½“å‰å…‰æ ‡ä½ç½®
                // \x1b[${N};1H : ç§»åŠ¨å…‰æ ‡åˆ°ç¬¬ N è¡Œ, ç¬¬ 1 åˆ— (è¡Œå·æ˜¯1-based)
                // \x1b[2K      : æ¸…é™¤æ•´è¡Œ
                // ... write ...: å†™å…¥æ–°å†…å®¹
                // \x1b[u       : æ¢å¤ä¹‹å‰ä¿å­˜çš„å…‰æ ‡ä½ç½®
                const command = `\x1b[s\x1b[${lineOnScreen + 1};1H\x1b[2K${formattedLog}\x1b[u`;

                terminal.write(command);
            }

            // æ ¼å¼åŒ–æ—¥å¿—æ¡ç›® - ç”¨äºæ¨¡å—ç»ˆç«¯å’Œé«˜é¢‘æŠ˜å 
            formatLogEntry(logEntry) {
                const timestamp = new Date(logEntry.timestamp).toLocaleTimeString();
                const level = logEntry.level.padEnd(5);
                const target = logEntry.target.padEnd(20);

                let color = '';
                switch (logEntry.level.toUpperCase()) {
                    case 'ERROR': color = '\x1b[31m'; break; // çº¢è‰²
                    case 'WARN': color = '\x1b[33m'; break;  // é»„è‰²
                    case 'INFO': color = '\x1b[32m'; break;  // ç»¿è‰²
                    case 'DEBUG': color = '\x1b[36m'; break; // é’è‰²
                    default: color = '\x1b[37m'; break;      // ç™½è‰²
                }

                const reset = '\x1b[0m';
                const aggregatedPrefix = logEntry.isAggregated ? '\x1b[35m[èšåˆ]\x1b[0m ' : '';

                return `${color}[${timestamp}] ${level} ${target}${reset} ${aggregatedPrefix}${logEntry.message}`;
            }

            // æ ¼å¼åŒ–åŸå§‹æ—¥å¿—æ¡ç›® - ç”¨äºå®æ—¶åŸå§‹æ—¥å¿—ï¼Œæ˜¾ç¤ºå®Œæ•´JSONæ ¼å¼
            formatRawLogEntry(logEntry) {
                // åˆ›å»ºä¸€ä¸ªå¹²å‡€çš„æ—¥å¿—å¯¹è±¡ï¼Œç§»é™¤å†…éƒ¨å¤„ç†å­—æ®µ
                const cleanLogEntry = {
                    timestamp: logEntry.timestamp,
                    level: logEntry.level,
                    target: logEntry.target,
                    message: logEntry.message
                };

                // å¦‚æœæœ‰fieldså­—æ®µï¼Œæ·»åŠ åˆ°è¾“å‡ºä¸­
                if (logEntry.fields && Object.keys(logEntry.fields).length > 0) {
                    cleanLogEntry.fields = logEntry.fields;
                }

                // å¦‚æœæœ‰spanä¿¡æ¯ï¼Œæ·»åŠ åˆ°è¾“å‡ºä¸­
                if (logEntry.span) {
                    cleanLogEntry.span = logEntry.span;
                }

                // æ ¹æ®æ—¥å¿—çº§åˆ«è®¾ç½®é¢œè‰²
                let color = '';
                switch (logEntry.level.toUpperCase()) {
                    case 'ERROR': color = '\x1b[31m'; break; // çº¢è‰²
                    case 'WARN': color = '\x1b[33m'; break;  // é»„è‰²
                    case 'INFO': color = '\x1b[32m'; break;  // ç»¿è‰²
                    case 'DEBUG': color = '\x1b[36m'; break; // é’è‰²
                    default: color = '\x1b[37m'; break;      // ç™½è‰²
                }

                const reset = '\x1b[0m';

                // æ ¼å¼åŒ–JSONï¼Œä½¿å…¶æ›´æ˜“è¯»
                const jsonString = JSON.stringify(cleanLogEntry, null, 2);

                // ä¸ºJSONæ·»åŠ é¢œè‰²
                return `${color}${jsonString}${reset}`;
            }

            // å¢é‡è¿½åŠ æ—¥å¿—åˆ°æŒ‡å®šæ¨¡å—ç»ˆç«¯ - å…³é”®æ–¹æ³•ï¼Œæ— é—ªçƒ
            appendLogToTerminal(moduleName, logEntry) {
                let terminal = this.terminals.get(moduleName);
                if (!terminal) {
                    // å¦‚æœæ¨¡å—ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
                    const moduleInfo = webLogState.moduleData.get(moduleName);
                    if (moduleInfo) {
                        this.createDynamicModule(moduleName, moduleInfo);
                        terminal = this.terminals.get(moduleName);
                    }
                }

                if (terminal) {
                    const formattedLog = this.formatLogEntry(logEntry);

                    // è·å–æ—¥å¿—ç¼“å†²åŒº
                    let logBuffer = this.logBuffers.get(moduleName);
                    if (!logBuffer) {
                        logBuffer = [];
                        this.logBuffers.set(moduleName, logBuffer);
                    }

                    // æ·»åŠ åˆ°ç¼“å†²åŒº
                    logBuffer.push(formattedLog);

                    // é™åˆ¶ç¼“å†²åŒºå¤§å°
                    if (logBuffer.length > this.maxLines) {
                        logBuffer.shift(); // ç§»é™¤æœ€è€çš„æ—¥å¿—
                    }

                    // å…³é”®ï¼šç›´æ¥è¿½åŠ åˆ°ç»ˆç«¯ï¼Œä¸æ¸…ç©ºï¼
                    terminal.write(formattedLog + '\r\n');
                }
            }

            // è¿½åŠ åˆ°å®æ—¶æ—¥å¿—ç»ˆç«¯ - æ˜¾ç¤ºåŸå§‹JSONæ ¼å¼
            appendToRealtimeLogs(logEntry) {
                const terminal = this.terminals.get('realtime-logs');
                if (terminal) {
                    const formattedLog = this.formatRawLogEntry(logEntry);

                    // è·å–å®æ—¶æ—¥å¿—ç¼“å†²åŒº
                    let logBuffer = this.logBuffers.get('realtime-logs');
                    if (!logBuffer) {
                        logBuffer = [];
                        this.logBuffers.set('realtime-logs', logBuffer);
                    }

                    // æ·»åŠ åˆ°ç¼“å†²åŒº
                    logBuffer.push(formattedLog);

                    // å®æ—¶æ—¥å¿—ä¿ç•™å¤§é‡å†å²æ•°æ®ï¼Œè®©å†å²åŠ è½½è¿‡ç¨‹èƒ½å¤Ÿå¡«æ»¡ç»ˆç«¯
                    if (logBuffer.length > 50000000) {
                        logBuffer.shift();
                    }

                    // ç›´æ¥è¿½åŠ åˆ°ç»ˆç«¯
                    terminal.write(formattedLog + '\r\n');
                }
            }

            // æ£€æŸ¥æ¨¡å—æ˜¯å¦å­˜åœ¨
            moduleExists(moduleName) {
                return this.terminals.has(moduleName);
            }

            // æ›´æ–°å®æ—¶æ—¥å¿— - ä»…ç”¨äºå†å²æ•°æ®åŠ è½½ï¼Œæ˜¾ç¤ºåŸå§‹JSONæ ¼å¼
            updateRealtimeLogs(logs) {
                const terminal = this.terminals.get('realtime-logs');
                if (!terminal) return;

                // æ¸…ç©ºç»ˆç«¯å’Œç¼“å†²åŒº
                terminal.clear();
                this.logBuffers.set('realtime-logs', []);

                // é‡æ–°åŠ è½½æ‰€æœ‰å†å²æ—¥å¿—ï¼Œä½¿ç”¨åŸå§‹JSONæ ¼å¼
                const logBuffer = [];
                logs.forEach(log => {
                    const formattedLog = this.formatRawLogEntry(log);
                    logBuffer.push(formattedLog);
                    terminal.write(formattedLog + '\r\n');
                });

                this.logBuffers.set('realtime-logs', logBuffer);
            }

            // æ›´æ–°é«˜é¢‘æŠ˜å æ—¥å¿— - ä»…ç”¨äºå†å²æ•°æ®åŠ è½½ï¼Œå®æ—¶æ›´æ–°é€šè¿‡é«˜é¢‘èšåˆå™¨å¤„ç†
            updateHighFreqCollapsed(aggregatedLogs) {
                const terminal = this.terminals.get('raw-logs');
                if (!terminal) return;

                // æ¸…ç©ºç»ˆç«¯å’Œç¼“å†²åŒº
                terminal.clear();
                this.logBuffers.set('raw-logs', []);

                // é‡æ–°åŠ è½½æ‰€æœ‰èšåˆæ—¥å¿—
                const displayLogs = aggregatedLogs.slice(-100); // æ˜¾ç¤ºæœ€è¿‘100æ¡
                const logBuffer = [];
                displayLogs.forEach(log => {
                    const formattedLog = this.formatLogEntry(log);
                    logBuffer.push(formattedLog);
                    terminal.write(formattedLog + '\r\n');
                });

                this.logBuffers.set('raw-logs', logBuffer);
            }

            // æ›´æ–°æ¨¡å—ç»ˆç«¯ - ä»…ç”¨äºå†å²æ•°æ®åŠ è½½
            updateModuleTerminal(moduleName, moduleInfo) {
                let terminal = this.terminals.get(moduleName);
                if (!terminal) {
                    // åˆ›å»ºæ–°çš„åŠ¨æ€æ¨¡å—
                    this.createDynamicModule(moduleName, moduleInfo);
                    terminal = this.terminals.get(moduleName);
                }

                if (terminal) {
                    // æ¸…ç©ºç»ˆç«¯å’Œç¼“å†²åŒº
                    terminal.clear();
                    this.logBuffers.set(moduleName, []);

                    // é‡æ–°åŠ è½½å†å²æ—¥å¿—
                    const displayLogs = moduleInfo.logs.slice(-50); // æ˜¾ç¤ºæœ€è¿‘50æ¡
                    const logBuffer = [];
                    displayLogs.forEach(log => {
                        const formattedLog = this.formatLogEntry(log);
                        logBuffer.push(formattedLog);
                        terminal.write(formattedLog + '\r\n');
                    });

                    this.logBuffers.set(moduleName, logBuffer);

                    // æ›´æ–°æ¨¡å—ç»Ÿè®¡ä¿¡æ¯
                    this.updateModuleStats(moduleName, moduleInfo);
                }
            }

            // åˆ›å»ºåŠ¨æ€æ¨¡å—
            createDynamicModule(moduleName, moduleInfo) {
                const container = document.getElementById('dynamic-modules-container');
                const moduleDiv = document.createElement('div');
                moduleDiv.className = 'module';
                moduleDiv.id = `module-${moduleName}`;

                moduleDiv.innerHTML = `
                    <div class="module-header">
                        <div class="module-title">${moduleName} | æ€»æ—¥å¿—: <span id="stats-${moduleName}-total">${moduleInfo.totalLogs}</span></div>
                        <div class="module-status status-running">è¿è¡Œä¸­</div>
                    </div>
                    <!-- æœç´¢æ§åˆ¶é¢æ¿ -->
                    <div class="search-panel" id="${moduleName}-search-panel">
                        <div class="search-controls">
                            <input type="text" id="${moduleName}-search-input" placeholder="æœç´¢æ—¥å¿—å†…å®¹..." class="search-input">
                            <button id="${moduleName}-search-btn" class="search-btn" title="å¼€å§‹æœç´¢">ğŸ”</button>
                            <button id="${moduleName}-search-clear" class="search-btn" title="æ¸…é™¤æœç´¢">âœ–</button>
                            <button id="${moduleName}-search-prev" class="search-nav-btn" title="ä¸Šä¸€ä¸ªåŒ¹é…" disabled>â†‘</button>
                            <button id="${moduleName}-search-next" class="search-nav-btn" title="ä¸‹ä¸€ä¸ªåŒ¹é…" disabled>â†“</button>
                            <label class="search-option">
                                <input type="checkbox" id="${moduleName}-search-case"> åŒºåˆ†å¤§å°å†™
                            </label>
                            <label class="search-option">
                                <input type="checkbox" id="${moduleName}-search-regex"> æ­£åˆ™è¡¨è¾¾å¼
                            </label>
                        </div>
                        <div class="search-status" id="${moduleName}-search-status">è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢</div>
                    </div>
                    <div class="module-terminal" id="terminal-${moduleName}"></div>
                `;

                container.appendChild(moduleDiv);
                this.createTerminal(`terminal-${moduleName}`, moduleName);

                // ä¸ºåŠ¨æ€æ¨¡å—åˆå§‹åŒ–æœç´¢åŠŸèƒ½
                const searchManager = new SearchManager();
                searchManager.initializeSearch(moduleName);
                this.searchManagers.set(moduleName, searchManager);

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                this.updateModuleStats(moduleName, moduleInfo);
            }

            // æ›´æ–°æ¨¡å—ç»Ÿè®¡ä¿¡æ¯
            updateModuleStats(moduleName, moduleInfo) {
                const totalEl = document.getElementById(`stats-${moduleName}-total`);
                if (totalEl) totalEl.textContent = moduleInfo.totalLogs;
            }

            // åˆå§‹åŒ–é™æ€ç»ˆç«¯
            initializeStaticTerminals() {
                this.createTerminal('realtime-logs-terminal', 'realtime-logs');
                this.createTerminal('raw-logs-terminal', 'raw-logs');

                // ä¸ºå®æ—¶æ—¥å¿—ç»ˆç«¯åˆå§‹åŒ–æœç´¢åŠŸèƒ½
                const realtimeSearchManager = new SearchManager();
                realtimeSearchManager.initializeSearch('realtime-logs');
                this.searchManagers.set('realtime-logs', realtimeSearchManager);

                // ä¸ºåŸå§‹æ—¥å¿—æŠ˜å ç»ˆç«¯åˆå§‹åŒ–æœç´¢åŠŸèƒ½
                const rawLogsSearchManager = new SearchManager();
                rawLogsSearchManager.initializeSearch('raw-logs');
                this.searchManagers.set('raw-logs', rawLogsSearchManager);
            }
        }

        // å…¨å±€ç»ˆç«¯ç®¡ç†å™¨å®ä¾‹
        const terminalManager = new TerminalManager();

        // WebSocketè¿æ¥ç®¡ç†
        class WebSocketManager {
            constructor() {
                this.ws = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 1000;
                this.isConnected = false;
            }

            // è¿æ¥WebSocket
            connect() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws`;

                console.log('ğŸ”— è¿æ¥WebSocket:', wsUrl);
                this.updateConnectionStatus('è¿æ¥ä¸­...');

                try {
                    this.ws = new WebSocket(wsUrl);
                    this.setupEventHandlers();
                } catch (error) {
                    console.error('WebSocketè¿æ¥å¤±è´¥:', error);
                    this.handleConnectionError();
                }
            }

            // è®¾ç½®äº‹ä»¶å¤„ç†å™¨
            setupEventHandlers() {
                this.ws.onopen = () => {
                    console.log('âœ… WebSocketè¿æ¥æˆåŠŸ');
                    this.isConnected = true;
                    this.reconnectAttempts = 0;
                    this.updateConnectionStatus('å·²è¿æ¥');
                };

                this.ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        this.handleMessage(message);
                    } catch (error) {
                        console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', error, event.data);
                    }
                };

                this.ws.onclose = (event) => {
                    console.log('ğŸ”Œ WebSocketè¿æ¥å…³é—­:', event.code, event.reason);
                    this.isConnected = false;
                    this.updateConnectionStatus('è¿æ¥æ–­å¼€');

                    if (!event.wasClean) {
                        this.handleConnectionError();
                    }
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocketé”™è¯¯:', error);
                    this.handleConnectionError();
                };
            }

            // å¤„ç†æ¶ˆæ¯
            handleMessage(message) {
                switch (message.type) {
                    case 'SessionStart':
                        console.log('ğŸ†• æ–°ä¼šè¯å¼€å§‹:', message.session_id);
                        this.updateConnectionStatus('æ–°ä¼šè¯å¼€å§‹');
                        // æ¸…ç©ºå‰ç«¯ç¼“å­˜å¹¶é‡æ–°åˆå§‹åŒ–
                        webLogState.clearAllData();
                        break;
                    case 'LogEntry':
                        webLogState.processLogEntry(message.data);
                        break;
                    case 'HistoryComplete':
                        console.log('ğŸ“š å†å²æ•°æ®åŠ è½½å®Œæˆ');
                        webLogState.isHistoryLoaded = true;
                        this.updateConnectionStatus('å†å²æ•°æ®å·²åŠ è½½');
                        // å†å²æ•°æ®åŠ è½½å®Œæˆåï¼Œæ‰§è¡Œä¸€æ¬¡å…¨é‡UIæ›´æ–°
                        webLogState.updateUI();
                        break;
                    default:
                        console.warn('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', message.type);
                }
            }

            // å¤„ç†è¿æ¥é”™è¯¯
            handleConnectionError() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    const delay = this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1);

                    console.log(`ğŸ”„ ${delay}msåå°è¯•é‡è¿ (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
                    this.updateConnectionStatus(`é‡è¿ä¸­... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);

                    setTimeout(() => this.connect(), delay);
                } else {
                    console.error('âŒ è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œåœæ­¢é‡è¿');
                    this.updateConnectionStatus('è¿æ¥å¤±è´¥');
                }
            }

            // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
            updateConnectionStatus(status) {
                const statusEl = document.getElementById('connection-status');
                if (statusEl) {
                    statusEl.textContent = status;
                    statusEl.className = 'connection-status ' +
                        (this.isConnected ? 'connected' : 'disconnected');
                }
            }
        }

        // å…¨å±€WebSocketç®¡ç†å™¨å®ä¾‹
        const wsManager = new WebSocketManager();

        // å·¥å…·å‡½æ•°
        function copyModuleName(moduleName) {
            navigator.clipboard.writeText(moduleName).then(() => {
                console.log('ğŸ“‹ å·²å¤åˆ¶æ¨¡å—åç§°:', moduleName);
                // ä¸´æ—¶é«˜äº®æ˜¾ç¤º
                const tag = event.target;
                tag.classList.add('copied');
                setTimeout(() => tag.classList.remove('copied'), 1000);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
            });
        }

        function copyAllModules() {
            const moduleNames = Array.from(webLogState.moduleData.keys()).sort();
            const text = moduleNames.join('\n');

            navigator.clipboard.writeText(text).then(() => {
                console.log('ğŸ“‹ å·²å¤åˆ¶æ‰€æœ‰æ¨¡å—åç§°');
                const button = document.getElementById('header-copy-modules');
                button.classList.add('copied');
                button.textContent = 'âœ… å·²å¤åˆ¶';
                setTimeout(() => {
                    button.classList.remove('copied');
                    button.textContent = 'ğŸ”¥ å¤åˆ¶å…¨éƒ¨æ¨¡å—';
                }, 2000);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
            });
        }

        function toggleRealtimeLogs() {
            const realtimeModule = document.getElementById('realtime-logs-module');
            const rawLogsModule = document.getElementById('raw-logs-module');
            const button = document.getElementById('toggle-realtime-logs');

            // æ£€æŸ¥å®æ—¶æ—¥å¿—æ¨¡å—å½“å‰æ˜¯å¦æ˜¯éšè—çš„
            if (realtimeModule.style.display === 'none') {
                // å¦‚æœæ˜¯éšè—çš„ï¼Œå°±æ˜¾ç¤ºå®ƒï¼Œå¹¶ã€éšè—ã€‘å¦ä¸€ä¸ª
                realtimeModule.style.display = 'flex';
                rawLogsModule.style.display = 'none'; // <-- å…³é”®ï¼šéšè—é«˜é¢‘æŠ˜å æ¨¡å—

                button.classList.add('active');
                button.textContent = 'ğŸ“Š æ˜¾ç¤ºé«˜é¢‘æŠ˜å æ—¥å¿—'; // <-- ä¿®æ”¹æŒ‰é’®æ–‡æœ¬ï¼Œæ›´ç¬¦åˆå½“å‰çŠ¶æ€
            } else {
                // å¦‚æœæ˜¯æ˜¾ç¤ºçš„ï¼Œå°±éšè—å®ƒï¼Œå¹¶ã€æ˜¾ç¤ºã€‘å¦ä¸€ä¸ª
                realtimeModule.style.display = 'none';
                rawLogsModule.style.display = 'flex'; // <-- å…³é”®ï¼šæ˜¾ç¤ºé«˜é¢‘æŠ˜å æ¨¡å—

                button.classList.remove('active');
                button.textContent = 'ğŸ“Š æ˜¾ç¤ºå®æ—¶åŸå§‹æ—¥å¿—'; // <-- æ¢å¤æŒ‰é’®é»˜è®¤æ–‡æœ¬
            }

            // ã€é‡è¦ã€‘åˆ‡æ¢æ˜¾ç¤ºåï¼Œéœ€è¦è®©ä¸¤ä¸ªæ¨¡å—çš„ç»ˆç«¯é‡æ–°è®¡ç®—å°ºå¯¸
            // å› ä¸ºæ¨¡å—çš„å°ºå¯¸å‘ç”Ÿäº†å˜åŒ–ï¼Œxterm.jséœ€è¦é‡æ–°é€‚é…
            // æˆ‘ä»¬å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿DOMæ›´æ–°å®Œæˆ
            setTimeout(() => {
                try {
                    if (rawLogsModule.style.display !== 'none') {
                        terminalManager.fitAddons.get('raw-logs')?.fit();
                    }
                    if (realtimeModule.style.display !== 'none') {
                        terminalManager.fitAddons.get('realtime-logs')?.fit();
                    }
                } catch(e) {
                    console.error("Error fitting terminal:", e);
                }
            }, 10);
        }

        // é¡µé¢åˆå§‹åŒ–
        window.addEventListener('load', function() {
            // ================== æ’ä»¶åŠ è½½çŠ¶æ€è¯Šæ–­ ==================
            console.log('--- æ’ä»¶åŠ è½½çŠ¶æ€è¯Šæ–­ ---');
            console.log('1. Terminal æ ¸å¿ƒåº“:', typeof Terminal);
            console.log('2. FitAddon æ’ä»¶å¯¹è±¡:', window.FitAddon);
            console.log('3. WebLinksAddon æ’ä»¶å¯¹è±¡:', window.WebLinksAddon);
            // ä¿®æ­£äº†è¯Šæ–­ä»£ç ï¼Œæ£€æŸ¥æ­£ç¡®çš„å…¨å±€å˜é‡ SearchAddon
            console.log('4. SearchAddon æ’ä»¶å¯¹è±¡ (å…³é”®):', window.SearchAddon);

            // æ›´è¯¦ç»†çš„ SearchAddon è¯Šæ–­
            if (window.SearchAddon) {
                console.log('   SearchAddon è¯¦ç»†ä¿¡æ¯:');
                console.log('   - ç±»å‹:', typeof window.SearchAddon);
                console.log('   - å±æ€§:', Object.keys(window.SearchAddon));
                console.log('   - SearchAddon æ„é€ å‡½æ•°ç±»å‹:', typeof window.SearchAddon.SearchAddon);
            } else {
                console.log('   âŒ SearchAddon å®Œå…¨æœªå®šä¹‰');

                // æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–å¯èƒ½çš„å…¨å±€å˜é‡å
                console.log('5. æ£€æŸ¥å…¶ä»–å¯èƒ½çš„æœç´¢æ’ä»¶å…¨å±€å˜é‡:');
                console.log('   - window.XtermAddonSearch:', window.XtermAddonSearch);
                console.log('   - window.AddonSearch:', window.AddonSearch);
                console.log('   - window.xtermAddonSearch:', window.xtermAddonSearch);

                // æ£€æŸ¥æ‰€æœ‰ä»¥ 'Search' å¼€å¤´çš„å…¨å±€å˜é‡
                const searchGlobals = Object.keys(window).filter(key => key.toLowerCase().includes('search'));
                console.log('   - æ‰€æœ‰åŒ…å«"search"çš„å…¨å±€å˜é‡:', searchGlobals);

                // æ£€æŸ¥è„šæœ¬æ˜¯å¦æˆåŠŸåŠ è½½
                const scripts = Array.from(document.querySelectorAll('script[src*="addon-search"]'));
                console.log('   - æœç´¢æ’ä»¶è„šæœ¬æ ‡ç­¾:', scripts.map(s => ({src: s.src, loaded: s.readyState || 'unknown'})));
            }

            console.log('--- è¯Šæ–­ç»“æŸ ---');
            // =======================================================

            console.log('ğŸ¯ é¡µé¢åŠæ‰€æœ‰èµ„æºåŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–WebLogç³»ç»Ÿ');

            // åˆå§‹åŒ–ç»ˆç«¯
            terminalManager.initializeStaticTerminals();

            // ç»‘å®šäº‹ä»¶
            document.getElementById('header-copy-modules').addEventListener('click', copyAllModules);
            document.getElementById('toggle-realtime-logs').addEventListener('click', toggleRealtimeLogs);

            // è¿æ¥WebSocket
            wsManager.connect();

            console.log('âœ… WebLogå‰ç«¯èšåˆç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');

            // æ·»åŠ çª—å£å¤§å°è°ƒæ•´çš„ç›‘å¬å™¨ï¼Œä»¥é‡æ–°é€‚é…æ‰€æœ‰ç»ˆç«¯
            let resizeTimer;
            window.addEventListener('resize', () => {
                // ä½¿ç”¨èŠ‚æµé˜²æ­¢é«˜é¢‘è§¦å‘
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    console.log('ğŸ”„ çª—å£å¤§å°æ”¹å˜ï¼Œé€‚é…æ‰€æœ‰ç»ˆç«¯');
                    terminalManager.fitAddons.forEach(fitAddon => {
                        try {
                            fitAddon.fit();
                        } catch (e) {
                            // å¿½ç•¥å¯èƒ½çš„é”™è¯¯ï¼Œä¾‹å¦‚å½“ç»ˆç«¯å®¹å™¨è¢«éšè—æ—¶
                        }
                    });
                }, 250); // 250mså»¶è¿Ÿ
            });
        });
    </script>
</body>
</html>
