<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K线聚合系统 - 模块监控 v4.2 (增量流式+聚合)</title>
    
    <!-- Xterm.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/xterm@4.19.0/css/xterm.css" />

    <!-- Xterm.js JavaScript - 使用更稳定的版本和CDN -->
    <script src="https://unpkg.com/xterm@4.19.0/lib/xterm.js"></script>
    <script src="https://unpkg.com/xterm-addon-fit@0.5.0/lib/xterm-addon-fit.js"></script>
    <script src="https://unpkg.com/xterm-addon-web-links@0.6.0/lib/xterm-addon-web-links.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background-color: #1a1a1a;
            color: #00ff00;
            padding: 10px;
            font-size: 16px;
            line-height: 1.5;
        }

        .header {
            text-align: center;
            padding: 10px;
            border-bottom: 2px solid #333;
            margin-bottom: 15px;
        }

        .header h1 {
            color: #00ffff;
            font-size: 24px;
            margin-bottom: 8px;
        }

        .system-status {
            color: #ffff00;
            font-size: 14px;
        }

        .modules-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 15px;
            height: calc(100vh - 120px);
        }

        .module {
            border: 1px solid #333;
            border-radius: 5px;
            background-color: #0a0a0a;
            display: flex;
            flex-direction: column;
        }

        .module-header {
            padding: 8px 12px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .module-title {
            font-weight: bold;
            font-size: 16px;
            color: #00ffff;
        }

        .module-status {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-running { background-color: #006600; color: #00ff00; }
        .status-waiting { background-color: #666600; color: #ffff00; }
        .status-error { background-color: #660000; color: #ff0000; }
        .status-disconnected { background-color: #663300; color: #ff9900; }

        .module-stats {
            padding: 10px 15px;
            border-bottom: 1px solid #333;
            font-size: 13px;
            color: #cccccc;
        }

        .stat-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }

        /* Xterm.js 终端容器样式 */
        .module-terminal {
            flex: 1;
            padding: 5px;
            background-color: #000000;
            overflow: hidden;
            min-height: 200px;
        }

        /* 自定义 Xterm.js 主题 */
        .xterm {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;
            font-size: 13px !important;
        }

        .xterm .xterm-viewport {
            background-color: #000000 !important;
        }

        .xterm .xterm-screen {
            background-color: #000000 !important;
        }

        .connection-status {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
        }

        .connected { background-color: #006600; color: #00ff00; }
        .disconnected { background-color: #660000; color: #ff0000; }

        /* 顶部按钮样式 */
        .header-copy-button {
            background-color: #ff6600;
            color: #ffffff;
            border: 2px solid #ff8833;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Consolas', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(255, 102, 0, 0.4);
            margin-left: 15px;
        }

        .header-copy-button:hover {
            background-color: #ff8833;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(255, 102, 0, 0.6);
        }

        .header-copy-button.copied {
            background-color: #44ff44;
            color: #000000;
            border-color: #66ff66;
        }

        .header-toggle-button {
            background-color: #0066ff;
            color: #ffffff;
            border: 2px solid #3388ff;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Consolas', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 102, 255, 0.4);
            margin-left: 10px;
        }

        .header-toggle-button:hover {
            background-color: #3388ff;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 102, 255, 0.6);
        }

        .header-toggle-button.active {
            background-color: #44ff44;
            color: #000000;
            border-color: #66ff66;
            box-shadow: 0 2px 6px rgba(68, 255, 68, 0.4);
        }

        /* 模块名称显示区域样式 */
        .module-names-section {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 5px;
            background-color: #0a0a0a;
        }

        .module-names-header {
            color: #00ffff;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .module-names-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 30px;
            align-items: center;
        }

        .module-name-tag {
            background-color: #1a4a1a;
            color: #00ff00;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-family: 'Consolas', monospace;
            cursor: pointer;
            border: 1px solid #006600;
            transition: all 0.2s ease;
        }

        .module-name-tag:hover {
            background-color: #2a5a2a;
            border-color: #00ff00;
            transform: scale(1.05);
        }

        .module-name-tag.copied {
            background-color: #4a4a1a;
            color: #ffff00;
            border-color: #ffff00;
        }

        .no-modules {
            color: #666;
            font-style: italic;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">连接中...</div>
    
    <div class="header">
        <h1>K线聚合系统 - 模块监控 v4.2 (增量流式+聚合)
            <button class="header-copy-button" id="header-copy-modules" title="复制所有模块名称">🔥 复制全部模块</button>
            <button class="header-toggle-button" id="toggle-realtime-logs" title="显示/隐藏实时原始日志">📊 显示实时原始日志</button>
        </h1>
        <div class="system-status">
            运行时间: <span id="uptime">--:--:--</span> |
            健康分数: <span id="health-score">--%</span> |
            验证事件: <span id="validation-events">--</span> |
            性能监控: <span id="performance-spans">--</span>
        </div>

        <!-- 模块名称显示区域 -->
        <div class="module-names-section">
            <div class="module-names-header">
                <span>📋 检测到的模块名称 (点击单个复制):</span>
            </div>
            <div class="module-names-list" id="module-names-list">
                <span class="no-modules">暂无模块数据</span>
            </div>
        </div>
    </div>

    <div class="modules-container">
        <!-- 实时原始日志模块 (默认隐藏) -->
        <div class="module" id="realtime-logs-module" style="display: none;">
            <div class="module-header">
                <div class="module-title">实时原始日志 (RealtimeLogs)</div>
                <div class="module-status status-waiting" id="realtime-logs-status">等待日志</div>
            </div>
            <div class="module-stats">
                <div class="stat-line">
                    <span>实时日志数:</span>
                    <span id="realtime-log-count">0</span>
                </div>
                <div class="stat-line">
                    <span>最后更新:</span>
                    <span id="last-log-time">--:--:--</span>
                </div>
                <div class="stat-line">
                    <span>日志频率:</span>
                    <span id="log-frequency">-- 条/秒</span>
                </div>
            </div>
            <div class="module-terminal" id="realtime-logs-terminal"></div>
        </div>

        <!-- 原始日志快照模块 -->
        <div class="module" id="raw-logs-module">
            <div class="module-header">
                <div class="module-title">原始日志高频折叠 (RawLogSnapshot)</div>
                <div class="module-status status-waiting" id="raw-logs-status">等待折叠</div>
            </div>
            <div class="module-stats">
                <div class="stat-line">
                    <span>折叠时间:</span>
                    <span id="snapshot-timestamp">--:--:--</span>
                </div>
                <div class="stat-line">
                    <span>原始日志数:</span>
                    <span id="total-log-count">--</span>
                </div>
                <div class="stat-line">
                    <span>折叠后条数:</span>
                    <span id="displayed-log-count">--</span>
                </div>
            </div>
            <div class="module-terminal" id="raw-logs-terminal"></div>
        </div>

        <!-- 动态模块将在这里创建 -->
    </div>

    <script>
        // Xterm.js 终端管理
        class TerminalManager {
            constructor() {
                this.terminals = new Map(); // 存储所有终端实例
                this.fitAddons = new Map(); // 存储FitAddon实例
                this.maxLines = 1000; // 每个终端最大行数

                // Xterm.js 主题配置
                this.terminalTheme = {
                    background: '#000000',
                    foreground: '#00ff00',
                    cursor: '#00ff00',
                    cursorAccent: '#000000',
                    selection: 'rgba(255, 255, 255, 0.3)',
                    black: '#000000',
                    red: '#ff0000',
                    green: '#00ff00',
                    yellow: '#ffff00',
                    blue: '#0066ff',
                    magenta: '#ff00ff',
                    cyan: '#00ffff',
                    white: '#ffffff',
                    brightBlack: '#666666',
                    brightRed: '#ff6666',
                    brightGreen: '#66ff66',
                    brightYellow: '#ffff66',
                    brightBlue: '#6666ff',
                    brightMagenta: '#ff66ff',
                    brightCyan: '#66ffff',
                    brightWhite: '#ffffff'
                };
            }

            // 创建新的终端实例
            createTerminal(containerId, moduleName) {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error(`找不到容器: ${containerId}`);
                    return null;
                }

                // 创建终端实例
                const terminal = new Terminal({
                    theme: this.terminalTheme,
                    fontFamily: 'Consolas, Monaco, "Courier New", monospace',
                    fontSize: 13,
                    lineHeight: 1.2,
                    cursorBlink: false,
                    scrollback: this.maxLines,
                    convertEol: true,
                    disableStdin: true, // 禁用输入，只用于显示
                    allowTransparency: true
                });

                // 暂时跳过插件，先让基本功能工作
                let fitAddon = null;
                let webLinksAddon = null;

                console.log('跳过插件加载，使用基本终端功能');

                // 打开终端
                terminal.open(container);

                // 调整大小（如果有fitAddon的话）
                if (fitAddon && fitAddon.fit) {
                    fitAddon.fit();
                } else {
                    console.log('FitAddon不可用，跳过自动调整大小');
                }

                // 存储终端实例
                this.terminals.set(moduleName, terminal);
                this.fitAddons.set(moduleName, fitAddon);

                // 监听窗口大小变化
                window.addEventListener('resize', () => {
                    setTimeout(() => fitAddon.fit(), 100);
                });

                console.log(`✅ 为模块 [${moduleName}] 创建了Xterm.js终端`);
                return terminal;
            }

            // 获取终端实例
            getTerminal(moduleName) {
                return this.terminals.get(moduleName);
            }

            // 向终端写入日志
            writeLog(moduleName, logText, level = 'INFO') {
                const terminal = this.getTerminal(moduleName);
                if (!terminal) {
                    console.warn(`终端不存在: ${moduleName}`);
                    return;
                }

                // 根据日志级别设置颜色
                let colorCode = '';
                switch (level.toUpperCase()) {
                    case 'ERROR':
                        colorCode = '\x1b[31m'; // 红色
                        break;
                    case 'WARN':
                        colorCode = '\x1b[33m'; // 黄色
                        break;
                    case 'INFO':
                        colorCode = '\x1b[32m'; // 绿色
                        break;
                    case 'DEBUG':
                        colorCode = '\x1b[36m'; // 青色
                        break;
                    default:
                        colorCode = '\x1b[37m'; // 白色
                }

                // 写入带颜色的日志
                const resetCode = '\x1b[0m'; // 重置颜色
                const formattedLog = `${colorCode}${logText}${resetCode}\r\n`;
                terminal.write(formattedLog);

                // 自动滚动到底部
                terminal.scrollToBottom();
            }

            // 清空终端
            clearTerminal(moduleName) {
                const terminal = this.getTerminal(moduleName);
                if (terminal) {
                    terminal.clear();
                }
            }

            // 调整终端大小
            resizeTerminal(moduleName) {
                const fitAddon = this.fitAddons.get(moduleName);
                if (fitAddon && fitAddon.fit) {
                    fitAddon.fit();
                } else {
                    console.log(`模块 ${moduleName} 的FitAddon不可用`);
                }
            }

            // 销毁终端
            destroyTerminal(moduleName) {
                const terminal = this.getTerminal(moduleName);
                if (terminal) {
                    terminal.dispose();
                    this.terminals.delete(moduleName);
                    this.fitAddons.delete(moduleName);
                }
            }
        }

        // 全局终端管理器实例
        const terminalManager = new TerminalManager();

        // WebSocket连接管理
        let ws = null;
        let reconnectInterval = null;
        let createdModules = new Set();
        let currentModuleNames = [];

        // 初始化固定终端
        function initializeFixedTerminals() {
            // 创建实时日志终端
            terminalManager.createTerminal('realtime-logs-terminal', 'RealtimeLogs');

            // 创建原始日志快照终端
            terminalManager.createTerminal('raw-logs-terminal', 'RawLogSnapshot');

            console.log('🚀 固定终端初始化完成');
        }

        // WebSocket连接函数
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                console.log('🔗 WebSocket已连接');
                updateConnectionStatus(true);
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };

            ws.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);

                    // 处理不同类型的消息
                    if (message.type === 'SystemStatus') {
                        // 处理系统状态更新（低频）
                        updateSystemStatus(message.data);
                    } else if (message.type === 'LogEntry') {
                        // 处理单个日志条目 - 立即增量显示
                        const logEntry = message.data;
                        addLogEntryIncremental(logEntry);
                    } else if (message.type === 'DashboardUpdate') {
                        // 处理聚合数据更新 - 更新统计信息和原始日志快照
                        updateDashboardData(message.data);
                    } else {
                        console.log('未知消息类型:', message.type);
                    }
                } catch (e) {
                    console.error('解析WebSocket消息失败:', e);
                }
            };

            ws.onclose = function() {
                console.log('WebSocket连接已关闭');
                updateConnectionStatus(false);
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(connectWebSocket, 5000);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocket错误:', error);
                updateConnectionStatus(false);
            };
        }

        // 更新连接状态
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');

            if (connected) {
                statusEl.textContent = '已连接';
                statusEl.className = 'connection-status connected';
            } else {
                statusEl.textContent = '连接断开';
                statusEl.className = 'connection-status disconnected';
            }
        }

        // 处理系统状态更新（简化版）
        function updateSystemStatus(data) {
            console.log('📊 收到系统状态更新:', data);

            // 更新系统状态信息
            if (data.uptime_seconds !== undefined) {
                const hours = Math.floor(data.uptime_seconds / 3600);
                const minutes = Math.floor((data.uptime_seconds % 3600) / 60);
                const seconds = data.uptime_seconds % 60;
                document.getElementById('uptime').textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            if (data.health_score !== undefined) {
                document.getElementById('health-score').textContent = Math.round(data.health_score) + '%';
            }

            // 更新验证事件和性能统计（如果有的话）
            if (data.validation_stats && data.validation_stats.total_events !== undefined) {
                document.getElementById('validation-events').textContent = data.validation_stats.total_events;
            }
            if (data.performance_stats && data.performance_stats.total_spans !== undefined) {
                document.getElementById('performance-spans').textContent = data.performance_stats.total_spans;
            }
        }

        // 处理聚合数据更新
        function updateDashboardData(data) {
            console.log('📈 收到聚合数据更新:', data);

            // 更新实时日志统计
            if (data.realtime_log_data) {
                const realtimeData = data.realtime_log_data;
                if (realtimeData.total_count !== undefined) {
                    document.getElementById('realtime-log-count').textContent = realtimeData.total_count;
                }
                if (realtimeData.last_update_time) {
                    document.getElementById('last-log-time').textContent = realtimeData.last_update_time;
                }
                if (realtimeData.logs_per_second !== undefined) {
                    document.getElementById('log-frequency').textContent = realtimeData.logs_per_second.toFixed(1) + ' 条/秒';
                }
            }

            // 更新原始日志快照统计
            if (data.raw_log_snapshot) {
                const snapshotData = data.raw_log_snapshot;
                if (snapshotData.timestamp) {
                    document.getElementById('snapshot-timestamp').textContent = new Date(snapshotData.timestamp).toLocaleTimeString();
                }
                if (snapshotData.total_count !== undefined) {
                    document.getElementById('total-log-count').textContent = snapshotData.total_count;
                }
                if (snapshotData.displayed_logs && snapshotData.displayed_logs.length !== undefined) {
                    document.getElementById('displayed-log-count').textContent = snapshotData.displayed_logs.length;
                }
            }
        }









        // 确保模块容器存在
        function ensureModuleContainer(moduleName) {
            if (createdModules.has(moduleName)) {
                return; // 模块已存在
            }

            console.log('🆕 创建模块:', moduleName);
            const containerId = getModuleContainerId(moduleName);
            const terminalId = containerId + '-terminal';

            // 创建模块容器
            const moduleDiv = document.createElement('div');
            moduleDiv.className = 'module';
            moduleDiv.innerHTML = `
                <div class="module-header">
                    <div class="module-title">${moduleName}</div>
                    <div class="module-status status-running" id="${containerId}-status">运行中</div>
                </div>
                <div class="module-stats">
                    <div class="stat-line">
                        <span>总日志数:</span>
                        <span id="${containerId}-total">0</span>
                    </div>
                    <div class="stat-line">
                        <span>错误数:</span>
                        <span id="${containerId}-errors">0</span>
                    </div>
                    <div class="stat-line">
                        <span>最后更新:</span>
                        <span id="${containerId}-last-update">--:--:--</span>
                    </div>
                </div>
                <div class="module-terminal" id="${terminalId}"></div>
            `;

            // 添加到模块容器中
            const modulesContainer = document.querySelector('.modules-container');
            modulesContainer.appendChild(moduleDiv);

            // 创建终端
            terminalManager.createTerminal(terminalId, moduleName);

            createdModules.add(moduleName);
        }



        // 增量添加日志条目 - 核心函数
        function addLogEntryIncremental(logEntry) {
            // 1. 添加到实时日志终端
            const logText = formatLogEntry(logEntry);
            const level = extractLogLevel(logEntry);
            terminalManager.writeLog('RealtimeLogs', logText, level);

            // 2. 根据target添加到对应模块终端
            const moduleName = logEntry.target || 'unknown';
            ensureModuleContainer(moduleName);
            terminalManager.writeLog(moduleName, logText, level);

            // 3. 添加到原始日志快照终端
            terminalManager.writeLog('RawLogSnapshot', logText, level);

            // 4. 更新模块名称列表
            updateModuleNamesList([moduleName]);

            // 5. 更新统计信息
            updateModuleStats(moduleName, logEntry);
        }

        // 格式化日志条目
        function formatLogEntry(logEntry) {
            if (typeof logEntry === 'string') {
                return logEntry;
            }

            if (logEntry.message) {
                const timestamp = logEntry.timestamp ? new Date(logEntry.timestamp).toLocaleTimeString() : '';
                const level = logEntry.level || 'INFO';
                const module = logEntry.module || '';

                if (timestamp && module) {
                    return `[${timestamp}] ${level} ${module}: ${logEntry.message}`;
                } else if (timestamp) {
                    return `[${timestamp}] ${level}: ${logEntry.message}`;
                } else {
                    return `${level}: ${logEntry.message}`;
                }
            }

            return JSON.stringify(logEntry);
        }

        // 提取日志级别
        function extractLogLevel(logEntry) {
            if (typeof logEntry === 'object' && logEntry.level) {
                return logEntry.level.toUpperCase();
            }

            if (typeof logEntry === 'string') {
                if (logEntry.includes('ERROR')) return 'ERROR';
                if (logEntry.includes('WARN')) return 'WARN';
                if (logEntry.includes('INFO')) return 'INFO';
                if (logEntry.includes('DEBUG')) return 'DEBUG';
            }

            return 'INFO';
        }

        // 获取模块容器ID
        function getModuleContainerId(moduleName) {
            return 'module-' + moduleName.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
        }

        // 更新模块名称列表（增量版本）
        function updateModuleNamesList(newModuleNames) {
            const container = document.getElementById('module-names-list');

            // 合并新模块名到现有列表
            newModuleNames.forEach(moduleName => {
                if (!currentModuleNames.includes(moduleName)) {
                    currentModuleNames.push(moduleName);

                    // 创建新的模块标签
                    const tag = document.createElement('span');
                    tag.className = 'module-name-tag';
                    tag.textContent = moduleName;
                    tag.title = '点击复制模块名称';
                    tag.id = `module-tag-${moduleName}`;

                    // 添加点击复制功能
                    tag.addEventListener('click', function() {
                        copyToClipboard(moduleName, tag);
                    });

                    // 如果容器是空的，先清空"暂无模块"提示
                    if (container.querySelector('.no-modules')) {
                        container.innerHTML = '';
                    }

                    container.appendChild(tag);
                }
            });
        }

        // 更新模块统计信息（增量版本）
        function updateModuleStats(moduleName, logEntry) {
            const containerId = getModuleContainerId(moduleName);

            // 更新总日志数
            const totalEl = document.getElementById(`${containerId}-total`);
            if (totalEl) {
                const current = parseInt(totalEl.textContent) || 0;
                totalEl.textContent = current + 1;
            }

            // 更新错误数
            if (logEntry.level === 'ERROR') {
                const errorsEl = document.getElementById(`${containerId}-errors`);
                if (errorsEl) {
                    const current = parseInt(errorsEl.textContent) || 0;
                    errorsEl.textContent = current + 1;
                }
            }

            // 更新最后更新时间
            const lastUpdateEl = document.getElementById(`${containerId}-last-update`);
            if (lastUpdateEl) {
                lastUpdateEl.textContent = new Date().toLocaleTimeString();
            }

            // 更新状态为运行中
            const statusEl = document.getElementById(`${containerId}-status`);
            if (statusEl) {
                statusEl.textContent = '运行中';
                statusEl.className = 'module-status status-running';
            }
        }

        // 复制到剪贴板功能
        function copyToClipboard(text, element) {
            navigator.clipboard.writeText(text).then(function() {
                // 显示复制成功的视觉反馈
                element.classList.add('copied');
                const originalText = element.textContent;
                element.textContent = '已复制!';

                setTimeout(function() {
                    element.classList.remove('copied');
                    element.textContent = originalText;
                }, 1000);
            }).catch(function(err) {
                console.error('复制失败:', err);
            });
        }

        // 复制所有模块名称
        function copyAllModuleNames() {
            if (currentModuleNames.length === 0) {
                alert('暂无模块数据可复制');
                return;
            }

            const allModuleNames = currentModuleNames.join('\n');
            const button = document.getElementById('header-copy-modules');

            navigator.clipboard.writeText(allModuleNames).then(function() {
                button.classList.add('copied');
                const originalText = button.textContent;
                button.textContent = '✅ 已复制!';

                setTimeout(function() {
                    button.classList.remove('copied');
                    button.textContent = originalText;
                }, 2000);
            }).catch(function(err) {
                console.error('复制失败:', err);
            });
        }

        // 切换实时日志显示
        function toggleRealtimeLogs() {
            const realtimeModule = document.getElementById('realtime-logs-module');
            const button = document.getElementById('toggle-realtime-logs');

            if (!realtimeModule) return;

            const isCurrentlyHidden = realtimeModule.style.display === 'none';

            if (isCurrentlyHidden) {
                realtimeModule.style.display = '';
                button.classList.add('active');
                button.textContent = '📊 隐藏实时原始日志';

                // 调整终端大小
                setTimeout(() => {
                    terminalManager.resizeTerminal('RealtimeLogs');
                }, 100);
            } else {
                realtimeModule.style.display = 'none';
                button.classList.remove('active');
                button.textContent = '📊 显示实时原始日志';
            }
        }

        // 检查Xterm.js是否加载完成
        function checkXtermLoaded() {
            const terminalLoaded = typeof Terminal !== 'undefined';
            const fitAddonLoaded = typeof FitAddon !== 'undefined';
            const webLinksLoaded = typeof WebLinksAddon !== 'undefined';

            console.log('库加载状态:', {
                Terminal: terminalLoaded,
                FitAddon: fitAddonLoaded,
                WebLinksAddon: webLinksLoaded
            });

            // 至少Terminal必须加载，插件是可选的
            return terminalLoaded;
        }

        // 等待Xterm.js加载完成后初始化
        function waitForXtermAndInitialize() {
            if (checkXtermLoaded()) {
                console.log('✅ Xterm.js 库加载完成');

                // 初始化固定终端
                initializeFixedTerminals();

                // 连接WebSocket
                connectWebSocket();

                // 绑定按钮事件
                document.getElementById('header-copy-modules').addEventListener('click', copyAllModuleNames);
                document.getElementById('toggle-realtime-logs').addEventListener('click', toggleRealtimeLogs);

                console.log('✅ 初始化完成');
            } else {
                console.log('⏳ 等待 Xterm.js 库加载...');
                setTimeout(waitForXtermAndInitialize, 100);
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 页面加载完成，开始初始化...');

            // 等待Xterm.js库加载完成
            waitForXtermAndInitialize();
        });

        // 窗口大小变化时调整所有终端
        window.addEventListener('resize', function() {
            setTimeout(() => {
                terminalManager.terminals.forEach((terminal, moduleName) => {
                    terminalManager.resizeTerminal(moduleName);
                });
            }, 100);
        });
    </script>
</body>
</html>
