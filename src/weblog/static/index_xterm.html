<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kçº¿èšåˆç³»ç»Ÿ - æ¨¡å—ç›‘æ§ v4.2 (å¢é‡æµå¼+èšåˆ)</title>
    
    <!-- Xterm.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/xterm@4.19.0/css/xterm.css" />

    <!-- Xterm.js JavaScript - ä½¿ç”¨æ›´ç¨³å®šçš„ç‰ˆæœ¬å’ŒCDN -->
    <script src="https://unpkg.com/xterm@4.19.0/lib/xterm.js"></script>
    <script src="https://unpkg.com/xterm-addon-fit@0.5.0/lib/xterm-addon-fit.js"></script>
    <script src="https://unpkg.com/xterm-addon-web-links@0.6.0/lib/xterm-addon-web-links.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background-color: #1a1a1a;
            color: #00ff00;
            padding: 10px;
            font-size: 16px;
            line-height: 1.5;
        }

        .header {
            text-align: center;
            padding: 10px;
            border-bottom: 2px solid #333;
            margin-bottom: 15px;
        }

        .header h1 {
            color: #00ffff;
            font-size: 24px;
            margin-bottom: 8px;
        }

        .system-status {
            color: #ffff00;
            font-size: 14px;
        }

        .modules-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 15px;
            height: calc(100vh - 120px);
        }

        .module {
            border: 1px solid #333;
            border-radius: 5px;
            background-color: #0a0a0a;
            display: flex;
            flex-direction: column;
        }

        .module-header {
            padding: 8px 12px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .module-title {
            font-weight: bold;
            font-size: 16px;
            color: #00ffff;
        }

        .module-status {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-running { background-color: #006600; color: #00ff00; }
        .status-waiting { background-color: #666600; color: #ffff00; }
        .status-error { background-color: #660000; color: #ff0000; }
        .status-disconnected { background-color: #663300; color: #ff9900; }

        .module-stats {
            padding: 10px 15px;
            border-bottom: 1px solid #333;
            font-size: 13px;
            color: #cccccc;
        }

        .stat-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }

        /* Xterm.js ç»ˆç«¯å®¹å™¨æ ·å¼ */
        .module-terminal {
            flex: 1;
            padding: 5px;
            background-color: #000000;
            overflow: hidden;
            min-height: 200px;
        }

        /* è‡ªå®šä¹‰ Xterm.js ä¸»é¢˜ */
        .xterm {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;
            font-size: 13px !important;
        }

        .xterm .xterm-viewport {
            background-color: #000000 !important;
        }

        .xterm .xterm-screen {
            background-color: #000000 !important;
        }

        .connection-status {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
        }

        .connected { background-color: #006600; color: #00ff00; }
        .disconnected { background-color: #660000; color: #ff0000; }

        /* é¡¶éƒ¨æŒ‰é’®æ ·å¼ */
        .header-copy-button {
            background-color: #ff6600;
            color: #ffffff;
            border: 2px solid #ff8833;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Consolas', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(255, 102, 0, 0.4);
            margin-left: 15px;
        }

        .header-copy-button:hover {
            background-color: #ff8833;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(255, 102, 0, 0.6);
        }

        .header-copy-button.copied {
            background-color: #44ff44;
            color: #000000;
            border-color: #66ff66;
        }

        .header-toggle-button {
            background-color: #0066ff;
            color: #ffffff;
            border: 2px solid #3388ff;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Consolas', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 102, 255, 0.4);
            margin-left: 10px;
        }

        .header-toggle-button:hover {
            background-color: #3388ff;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 102, 255, 0.6);
        }

        .header-toggle-button.active {
            background-color: #44ff44;
            color: #000000;
            border-color: #66ff66;
            box-shadow: 0 2px 6px rgba(68, 255, 68, 0.4);
        }

        /* æ¨¡å—åç§°æ˜¾ç¤ºåŒºåŸŸæ ·å¼ */
        .module-names-section {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 5px;
            background-color: #0a0a0a;
        }

        .module-names-header {
            color: #00ffff;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .module-names-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 30px;
            align-items: center;
        }

        .module-name-tag {
            background-color: #1a4a1a;
            color: #00ff00;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-family: 'Consolas', monospace;
            cursor: pointer;
            border: 1px solid #006600;
            transition: all 0.2s ease;
        }

        .module-name-tag:hover {
            background-color: #2a5a2a;
            border-color: #00ff00;
            transform: scale(1.05);
        }

        .module-name-tag.copied {
            background-color: #4a4a1a;
            color: #ffff00;
            border-color: #ffff00;
        }

        .no-modules {
            color: #666;
            font-style: italic;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">è¿æ¥ä¸­...</div>
    
    <div class="header">
        <h1>Kçº¿èšåˆç³»ç»Ÿ - æ¨¡å—ç›‘æ§ v4.2 (å¢é‡æµå¼+èšåˆ)
            <button class="header-copy-button" id="header-copy-modules" title="å¤åˆ¶æ‰€æœ‰æ¨¡å—åç§°">ğŸ”¥ å¤åˆ¶å…¨éƒ¨æ¨¡å—</button>
            <button class="header-toggle-button" id="toggle-realtime-logs" title="æ˜¾ç¤º/éšè—å®æ—¶åŸå§‹æ—¥å¿—">ğŸ“Š æ˜¾ç¤ºå®æ—¶åŸå§‹æ—¥å¿—</button>
        </h1>
        <div class="system-status">
            è¿è¡Œæ—¶é—´: <span id="uptime">--:--:--</span> |
            å¥åº·åˆ†æ•°: <span id="health-score">--%</span> |
            éªŒè¯äº‹ä»¶: <span id="validation-events">--</span> |
            æ€§èƒ½ç›‘æ§: <span id="performance-spans">--</span>
        </div>

        <!-- æ¨¡å—åç§°æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="module-names-section">
            <div class="module-names-header">
                <span>ğŸ“‹ æ£€æµ‹åˆ°çš„æ¨¡å—åç§° (ç‚¹å‡»å•ä¸ªå¤åˆ¶):</span>
            </div>
            <div class="module-names-list" id="module-names-list">
                <span class="no-modules">æš‚æ— æ¨¡å—æ•°æ®</span>
            </div>
        </div>
    </div>

    <div class="modules-container">
        <!-- å®æ—¶åŸå§‹æ—¥å¿—æ¨¡å— (é»˜è®¤éšè—) -->
        <div class="module" id="realtime-logs-module" style="display: none;">
            <div class="module-header">
                <div class="module-title">å®æ—¶åŸå§‹æ—¥å¿— (RealtimeLogs)</div>
                <div class="module-status status-waiting" id="realtime-logs-status">ç­‰å¾…æ—¥å¿—</div>
            </div>
            <div class="module-stats">
                <div class="stat-line">
                    <span>å®æ—¶æ—¥å¿—æ•°:</span>
                    <span id="realtime-log-count">0</span>
                </div>
                <div class="stat-line">
                    <span>æœ€åæ›´æ–°:</span>
                    <span id="last-log-time">--:--:--</span>
                </div>
                <div class="stat-line">
                    <span>æ—¥å¿—é¢‘ç‡:</span>
                    <span id="log-frequency">-- æ¡/ç§’</span>
                </div>
            </div>
            <div class="module-terminal" id="realtime-logs-terminal"></div>
        </div>

        <!-- åŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å— -->
        <div class="module" id="raw-logs-module">
            <div class="module-header">
                <div class="module-title">åŸå§‹æ—¥å¿—é«˜é¢‘æŠ˜å  (RawLogSnapshot)</div>
                <div class="module-status status-waiting" id="raw-logs-status">ç­‰å¾…æŠ˜å </div>
            </div>
            <div class="module-stats">
                <div class="stat-line">
                    <span>æŠ˜å æ—¶é—´:</span>
                    <span id="snapshot-timestamp">--:--:--</span>
                </div>
                <div class="stat-line">
                    <span>åŸå§‹æ—¥å¿—æ•°:</span>
                    <span id="total-log-count">--</span>
                </div>
                <div class="stat-line">
                    <span>æŠ˜å åæ¡æ•°:</span>
                    <span id="displayed-log-count">--</span>
                </div>
            </div>
            <div class="module-terminal" id="raw-logs-terminal"></div>
        </div>

        <!-- åŠ¨æ€æ¨¡å—å°†åœ¨è¿™é‡Œåˆ›å»º -->
    </div>

    <script>
        // Xterm.js ç»ˆç«¯ç®¡ç†
        class TerminalManager {
            constructor() {
                this.terminals = new Map(); // å­˜å‚¨æ‰€æœ‰ç»ˆç«¯å®ä¾‹
                this.fitAddons = new Map(); // å­˜å‚¨FitAddonå®ä¾‹
                this.maxLines = 1000; // æ¯ä¸ªç»ˆç«¯æœ€å¤§è¡Œæ•°

                // Xterm.js ä¸»é¢˜é…ç½®
                this.terminalTheme = {
                    background: '#000000',
                    foreground: '#00ff00',
                    cursor: '#00ff00',
                    cursorAccent: '#000000',
                    selection: 'rgba(255, 255, 255, 0.3)',
                    black: '#000000',
                    red: '#ff0000',
                    green: '#00ff00',
                    yellow: '#ffff00',
                    blue: '#0066ff',
                    magenta: '#ff00ff',
                    cyan: '#00ffff',
                    white: '#ffffff',
                    brightBlack: '#666666',
                    brightRed: '#ff6666',
                    brightGreen: '#66ff66',
                    brightYellow: '#ffff66',
                    brightBlue: '#6666ff',
                    brightMagenta: '#ff66ff',
                    brightCyan: '#66ffff',
                    brightWhite: '#ffffff'
                };
            }

            // åˆ›å»ºæ–°çš„ç»ˆç«¯å®ä¾‹
            createTerminal(containerId, moduleName) {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error(`æ‰¾ä¸åˆ°å®¹å™¨: ${containerId}`);
                    return null;
                }

                // åˆ›å»ºç»ˆç«¯å®ä¾‹
                const terminal = new Terminal({
                    theme: this.terminalTheme,
                    fontFamily: 'Consolas, Monaco, "Courier New", monospace',
                    fontSize: 13,
                    lineHeight: 1.2,
                    cursorBlink: false,
                    scrollback: this.maxLines,
                    convertEol: true,
                    disableStdin: true, // ç¦ç”¨è¾“å…¥ï¼Œåªç”¨äºæ˜¾ç¤º
                    allowTransparency: true
                });

                // æš‚æ—¶è·³è¿‡æ’ä»¶ï¼Œå…ˆè®©åŸºæœ¬åŠŸèƒ½å·¥ä½œ
                let fitAddon = null;
                let webLinksAddon = null;

                console.log('è·³è¿‡æ’ä»¶åŠ è½½ï¼Œä½¿ç”¨åŸºæœ¬ç»ˆç«¯åŠŸèƒ½');

                // æ‰“å¼€ç»ˆç«¯
                terminal.open(container);

                // è°ƒæ•´å¤§å°ï¼ˆå¦‚æœæœ‰fitAddonçš„è¯ï¼‰
                if (fitAddon && fitAddon.fit) {
                    fitAddon.fit();
                } else {
                    console.log('FitAddonä¸å¯ç”¨ï¼Œè·³è¿‡è‡ªåŠ¨è°ƒæ•´å¤§å°');
                }

                // å­˜å‚¨ç»ˆç«¯å®ä¾‹
                this.terminals.set(moduleName, terminal);
                this.fitAddons.set(moduleName, fitAddon);

                // ç›‘å¬çª—å£å¤§å°å˜åŒ–
                window.addEventListener('resize', () => {
                    setTimeout(() => fitAddon.fit(), 100);
                });

                console.log(`âœ… ä¸ºæ¨¡å— [${moduleName}] åˆ›å»ºäº†Xterm.jsç»ˆç«¯`);
                return terminal;
            }

            // è·å–ç»ˆç«¯å®ä¾‹
            getTerminal(moduleName) {
                return this.terminals.get(moduleName);
            }

            // å‘ç»ˆç«¯å†™å…¥æ—¥å¿—
            writeLog(moduleName, logText, level = 'INFO') {
                const terminal = this.getTerminal(moduleName);
                if (!terminal) {
                    console.warn(`ç»ˆç«¯ä¸å­˜åœ¨: ${moduleName}`);
                    return;
                }

                // æ ¹æ®æ—¥å¿—çº§åˆ«è®¾ç½®é¢œè‰²
                let colorCode = '';
                switch (level.toUpperCase()) {
                    case 'ERROR':
                        colorCode = '\x1b[31m'; // çº¢è‰²
                        break;
                    case 'WARN':
                        colorCode = '\x1b[33m'; // é»„è‰²
                        break;
                    case 'INFO':
                        colorCode = '\x1b[32m'; // ç»¿è‰²
                        break;
                    case 'DEBUG':
                        colorCode = '\x1b[36m'; // é’è‰²
                        break;
                    default:
                        colorCode = '\x1b[37m'; // ç™½è‰²
                }

                // å†™å…¥å¸¦é¢œè‰²çš„æ—¥å¿—
                const resetCode = '\x1b[0m'; // é‡ç½®é¢œè‰²
                const formattedLog = `${colorCode}${logText}${resetCode}\r\n`;
                terminal.write(formattedLog);

                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                terminal.scrollToBottom();
            }

            // æ¸…ç©ºç»ˆç«¯
            clearTerminal(moduleName) {
                const terminal = this.getTerminal(moduleName);
                if (terminal) {
                    terminal.clear();
                }
            }

            // è°ƒæ•´ç»ˆç«¯å¤§å°
            resizeTerminal(moduleName) {
                const fitAddon = this.fitAddons.get(moduleName);
                if (fitAddon && fitAddon.fit) {
                    fitAddon.fit();
                } else {
                    console.log(`æ¨¡å— ${moduleName} çš„FitAddonä¸å¯ç”¨`);
                }
            }

            // é”€æ¯ç»ˆç«¯
            destroyTerminal(moduleName) {
                const terminal = this.getTerminal(moduleName);
                if (terminal) {
                    terminal.dispose();
                    this.terminals.delete(moduleName);
                    this.fitAddons.delete(moduleName);
                }
            }
        }

        // å…¨å±€ç»ˆç«¯ç®¡ç†å™¨å®ä¾‹
        const terminalManager = new TerminalManager();

        // WebSocketè¿æ¥ç®¡ç†
        let ws = null;
        let reconnectInterval = null;
        let createdModules = new Set();
        let currentModuleNames = [];

        // åˆå§‹åŒ–å›ºå®šç»ˆç«¯
        function initializeFixedTerminals() {
            // åˆ›å»ºå®æ—¶æ—¥å¿—ç»ˆç«¯
            terminalManager.createTerminal('realtime-logs-terminal', 'RealtimeLogs');

            // åˆ›å»ºåŸå§‹æ—¥å¿—å¿«ç…§ç»ˆç«¯
            terminalManager.createTerminal('raw-logs-terminal', 'RawLogSnapshot');

            console.log('ğŸš€ å›ºå®šç»ˆç«¯åˆå§‹åŒ–å®Œæˆ');
        }

        // WebSocketè¿æ¥å‡½æ•°
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                console.log('ğŸ”— WebSocketå·²è¿æ¥');
                updateConnectionStatus(true);
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };

            ws.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);

                    // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯
                    if (message.type === 'SystemStatus') {
                        // å¤„ç†ç³»ç»ŸçŠ¶æ€æ›´æ–°ï¼ˆä½é¢‘ï¼‰
                        updateSystemStatus(message.data);
                    } else if (message.type === 'LogEntry') {
                        // å¤„ç†å•ä¸ªæ—¥å¿—æ¡ç›® - ç«‹å³å¢é‡æ˜¾ç¤º
                        const logEntry = message.data;
                        addLogEntryIncremental(logEntry);
                    } else if (message.type === 'DashboardUpdate') {
                        // å¤„ç†èšåˆæ•°æ®æ›´æ–° - æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å’ŒåŸå§‹æ—¥å¿—å¿«ç…§
                        updateDashboardData(message.data);
                    } else {
                        console.log('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', message.type);
                    }
                } catch (e) {
                    console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', e);
                }
            };

            ws.onclose = function() {
                console.log('WebSocketè¿æ¥å·²å…³é—­');
                updateConnectionStatus(false);
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(connectWebSocket, 5000);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocketé”™è¯¯:', error);
                updateConnectionStatus(false);
            };
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');

            if (connected) {
                statusEl.textContent = 'å·²è¿æ¥';
                statusEl.className = 'connection-status connected';
            } else {
                statusEl.textContent = 'è¿æ¥æ–­å¼€';
                statusEl.className = 'connection-status disconnected';
            }
        }

        // å¤„ç†ç³»ç»ŸçŠ¶æ€æ›´æ–°ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function updateSystemStatus(data) {
            console.log('ğŸ“Š æ”¶åˆ°ç³»ç»ŸçŠ¶æ€æ›´æ–°:', data);

            // æ›´æ–°ç³»ç»ŸçŠ¶æ€ä¿¡æ¯
            if (data.uptime_seconds !== undefined) {
                const hours = Math.floor(data.uptime_seconds / 3600);
                const minutes = Math.floor((data.uptime_seconds % 3600) / 60);
                const seconds = data.uptime_seconds % 60;
                document.getElementById('uptime').textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            if (data.health_score !== undefined) {
                document.getElementById('health-score').textContent = Math.round(data.health_score) + '%';
            }

            // æ›´æ–°éªŒè¯äº‹ä»¶å’Œæ€§èƒ½ç»Ÿè®¡ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            if (data.validation_stats && data.validation_stats.total_events !== undefined) {
                document.getElementById('validation-events').textContent = data.validation_stats.total_events;
            }
            if (data.performance_stats && data.performance_stats.total_spans !== undefined) {
                document.getElementById('performance-spans').textContent = data.performance_stats.total_spans;
            }
        }

        // å¤„ç†èšåˆæ•°æ®æ›´æ–°
        function updateDashboardData(data) {
            console.log('ğŸ“ˆ æ”¶åˆ°èšåˆæ•°æ®æ›´æ–°:', data);

            // æ›´æ–°å®æ—¶æ—¥å¿—ç»Ÿè®¡
            if (data.realtime_log_data) {
                const realtimeData = data.realtime_log_data;
                if (realtimeData.total_count !== undefined) {
                    document.getElementById('realtime-log-count').textContent = realtimeData.total_count;
                }
                if (realtimeData.last_update_time) {
                    document.getElementById('last-log-time').textContent = realtimeData.last_update_time;
                }
                if (realtimeData.logs_per_second !== undefined) {
                    document.getElementById('log-frequency').textContent = realtimeData.logs_per_second.toFixed(1) + ' æ¡/ç§’';
                }
            }

            // æ›´æ–°åŸå§‹æ—¥å¿—å¿«ç…§ç»Ÿè®¡
            if (data.raw_log_snapshot) {
                const snapshotData = data.raw_log_snapshot;
                if (snapshotData.timestamp) {
                    document.getElementById('snapshot-timestamp').textContent = new Date(snapshotData.timestamp).toLocaleTimeString();
                }
                if (snapshotData.total_count !== undefined) {
                    document.getElementById('total-log-count').textContent = snapshotData.total_count;
                }
                if (snapshotData.displayed_logs && snapshotData.displayed_logs.length !== undefined) {
                    document.getElementById('displayed-log-count').textContent = snapshotData.displayed_logs.length;
                }
            }
        }









        // ç¡®ä¿æ¨¡å—å®¹å™¨å­˜åœ¨
        function ensureModuleContainer(moduleName) {
            if (createdModules.has(moduleName)) {
                return; // æ¨¡å—å·²å­˜åœ¨
            }

            console.log('ğŸ†• åˆ›å»ºæ¨¡å—:', moduleName);
            const containerId = getModuleContainerId(moduleName);
            const terminalId = containerId + '-terminal';

            // åˆ›å»ºæ¨¡å—å®¹å™¨
            const moduleDiv = document.createElement('div');
            moduleDiv.className = 'module';
            moduleDiv.innerHTML = `
                <div class="module-header">
                    <div class="module-title">${moduleName}</div>
                    <div class="module-status status-running" id="${containerId}-status">è¿è¡Œä¸­</div>
                </div>
                <div class="module-stats">
                    <div class="stat-line">
                        <span>æ€»æ—¥å¿—æ•°:</span>
                        <span id="${containerId}-total">0</span>
                    </div>
                    <div class="stat-line">
                        <span>é”™è¯¯æ•°:</span>
                        <span id="${containerId}-errors">0</span>
                    </div>
                    <div class="stat-line">
                        <span>æœ€åæ›´æ–°:</span>
                        <span id="${containerId}-last-update">--:--:--</span>
                    </div>
                </div>
                <div class="module-terminal" id="${terminalId}"></div>
            `;

            // æ·»åŠ åˆ°æ¨¡å—å®¹å™¨ä¸­
            const modulesContainer = document.querySelector('.modules-container');
            modulesContainer.appendChild(moduleDiv);

            // åˆ›å»ºç»ˆç«¯
            terminalManager.createTerminal(terminalId, moduleName);

            createdModules.add(moduleName);
        }



        // å¢é‡æ·»åŠ æ—¥å¿—æ¡ç›® - æ ¸å¿ƒå‡½æ•°
        function addLogEntryIncremental(logEntry) {
            // 1. æ·»åŠ åˆ°å®æ—¶æ—¥å¿—ç»ˆç«¯
            const logText = formatLogEntry(logEntry);
            const level = extractLogLevel(logEntry);
            terminalManager.writeLog('RealtimeLogs', logText, level);

            // 2. æ ¹æ®targetæ·»åŠ åˆ°å¯¹åº”æ¨¡å—ç»ˆç«¯
            const moduleName = logEntry.target || 'unknown';
            ensureModuleContainer(moduleName);
            terminalManager.writeLog(moduleName, logText, level);

            // 3. æ·»åŠ åˆ°åŸå§‹æ—¥å¿—å¿«ç…§ç»ˆç«¯
            terminalManager.writeLog('RawLogSnapshot', logText, level);

            // 4. æ›´æ–°æ¨¡å—åç§°åˆ—è¡¨
            updateModuleNamesList([moduleName]);

            // 5. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateModuleStats(moduleName, logEntry);
        }

        // æ ¼å¼åŒ–æ—¥å¿—æ¡ç›®
        function formatLogEntry(logEntry) {
            if (typeof logEntry === 'string') {
                return logEntry;
            }

            if (logEntry.message) {
                const timestamp = logEntry.timestamp ? new Date(logEntry.timestamp).toLocaleTimeString() : '';
                const level = logEntry.level || 'INFO';
                const module = logEntry.module || '';

                if (timestamp && module) {
                    return `[${timestamp}] ${level} ${module}: ${logEntry.message}`;
                } else if (timestamp) {
                    return `[${timestamp}] ${level}: ${logEntry.message}`;
                } else {
                    return `${level}: ${logEntry.message}`;
                }
            }

            return JSON.stringify(logEntry);
        }

        // æå–æ—¥å¿—çº§åˆ«
        function extractLogLevel(logEntry) {
            if (typeof logEntry === 'object' && logEntry.level) {
                return logEntry.level.toUpperCase();
            }

            if (typeof logEntry === 'string') {
                if (logEntry.includes('ERROR')) return 'ERROR';
                if (logEntry.includes('WARN')) return 'WARN';
                if (logEntry.includes('INFO')) return 'INFO';
                if (logEntry.includes('DEBUG')) return 'DEBUG';
            }

            return 'INFO';
        }

        // è·å–æ¨¡å—å®¹å™¨ID
        function getModuleContainerId(moduleName) {
            return 'module-' + moduleName.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
        }

        // æ›´æ–°æ¨¡å—åç§°åˆ—è¡¨ï¼ˆå¢é‡ç‰ˆæœ¬ï¼‰
        function updateModuleNamesList(newModuleNames) {
            const container = document.getElementById('module-names-list');

            // åˆå¹¶æ–°æ¨¡å—ååˆ°ç°æœ‰åˆ—è¡¨
            newModuleNames.forEach(moduleName => {
                if (!currentModuleNames.includes(moduleName)) {
                    currentModuleNames.push(moduleName);

                    // åˆ›å»ºæ–°çš„æ¨¡å—æ ‡ç­¾
                    const tag = document.createElement('span');
                    tag.className = 'module-name-tag';
                    tag.textContent = moduleName;
                    tag.title = 'ç‚¹å‡»å¤åˆ¶æ¨¡å—åç§°';
                    tag.id = `module-tag-${moduleName}`;

                    // æ·»åŠ ç‚¹å‡»å¤åˆ¶åŠŸèƒ½
                    tag.addEventListener('click', function() {
                        copyToClipboard(moduleName, tag);
                    });

                    // å¦‚æœå®¹å™¨æ˜¯ç©ºçš„ï¼Œå…ˆæ¸…ç©º"æš‚æ— æ¨¡å—"æç¤º
                    if (container.querySelector('.no-modules')) {
                        container.innerHTML = '';
                    }

                    container.appendChild(tag);
                }
            });
        }

        // æ›´æ–°æ¨¡å—ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¢é‡ç‰ˆæœ¬ï¼‰
        function updateModuleStats(moduleName, logEntry) {
            const containerId = getModuleContainerId(moduleName);

            // æ›´æ–°æ€»æ—¥å¿—æ•°
            const totalEl = document.getElementById(`${containerId}-total`);
            if (totalEl) {
                const current = parseInt(totalEl.textContent) || 0;
                totalEl.textContent = current + 1;
            }

            // æ›´æ–°é”™è¯¯æ•°
            if (logEntry.level === 'ERROR') {
                const errorsEl = document.getElementById(`${containerId}-errors`);
                if (errorsEl) {
                    const current = parseInt(errorsEl.textContent) || 0;
                    errorsEl.textContent = current + 1;
                }
            }

            // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
            const lastUpdateEl = document.getElementById(`${containerId}-last-update`);
            if (lastUpdateEl) {
                lastUpdateEl.textContent = new Date().toLocaleTimeString();
            }

            // æ›´æ–°çŠ¶æ€ä¸ºè¿è¡Œä¸­
            const statusEl = document.getElementById(`${containerId}-status`);
            if (statusEl) {
                statusEl.textContent = 'è¿è¡Œä¸­';
                statusEl.className = 'module-status status-running';
            }
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿åŠŸèƒ½
        function copyToClipboard(text, element) {
            navigator.clipboard.writeText(text).then(function() {
                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„è§†è§‰åé¦ˆ
                element.classList.add('copied');
                const originalText = element.textContent;
                element.textContent = 'å·²å¤åˆ¶!';

                setTimeout(function() {
                    element.classList.remove('copied');
                    element.textContent = originalText;
                }, 1000);
            }).catch(function(err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
            });
        }

        // å¤åˆ¶æ‰€æœ‰æ¨¡å—åç§°
        function copyAllModuleNames() {
            if (currentModuleNames.length === 0) {
                alert('æš‚æ— æ¨¡å—æ•°æ®å¯å¤åˆ¶');
                return;
            }

            const allModuleNames = currentModuleNames.join('\n');
            const button = document.getElementById('header-copy-modules');

            navigator.clipboard.writeText(allModuleNames).then(function() {
                button.classList.add('copied');
                const originalText = button.textContent;
                button.textContent = 'âœ… å·²å¤åˆ¶!';

                setTimeout(function() {
                    button.classList.remove('copied');
                    button.textContent = originalText;
                }, 2000);
            }).catch(function(err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
            });
        }

        // åˆ‡æ¢å®æ—¶æ—¥å¿—æ˜¾ç¤º
        function toggleRealtimeLogs() {
            const realtimeModule = document.getElementById('realtime-logs-module');
            const button = document.getElementById('toggle-realtime-logs');

            if (!realtimeModule) return;

            const isCurrentlyHidden = realtimeModule.style.display === 'none';

            if (isCurrentlyHidden) {
                realtimeModule.style.display = '';
                button.classList.add('active');
                button.textContent = 'ğŸ“Š éšè—å®æ—¶åŸå§‹æ—¥å¿—';

                // è°ƒæ•´ç»ˆç«¯å¤§å°
                setTimeout(() => {
                    terminalManager.resizeTerminal('RealtimeLogs');
                }, 100);
            } else {
                realtimeModule.style.display = 'none';
                button.classList.remove('active');
                button.textContent = 'ğŸ“Š æ˜¾ç¤ºå®æ—¶åŸå§‹æ—¥å¿—';
            }
        }

        // æ£€æŸ¥Xterm.jsæ˜¯å¦åŠ è½½å®Œæˆ
        function checkXtermLoaded() {
            const terminalLoaded = typeof Terminal !== 'undefined';
            const fitAddonLoaded = typeof FitAddon !== 'undefined';
            const webLinksLoaded = typeof WebLinksAddon !== 'undefined';

            console.log('åº“åŠ è½½çŠ¶æ€:', {
                Terminal: terminalLoaded,
                FitAddon: fitAddonLoaded,
                WebLinksAddon: webLinksLoaded
            });

            // è‡³å°‘Terminalå¿…é¡»åŠ è½½ï¼Œæ’ä»¶æ˜¯å¯é€‰çš„
            return terminalLoaded;
        }

        // ç­‰å¾…Xterm.jsåŠ è½½å®Œæˆååˆå§‹åŒ–
        function waitForXtermAndInitialize() {
            if (checkXtermLoaded()) {
                console.log('âœ… Xterm.js åº“åŠ è½½å®Œæˆ');

                // åˆå§‹åŒ–å›ºå®šç»ˆç«¯
                initializeFixedTerminals();

                // è¿æ¥WebSocket
                connectWebSocket();

                // ç»‘å®šæŒ‰é’®äº‹ä»¶
                document.getElementById('header-copy-modules').addEventListener('click', copyAllModuleNames);
                document.getElementById('toggle-realtime-logs').addEventListener('click', toggleRealtimeLogs);

                console.log('âœ… åˆå§‹åŒ–å®Œæˆ');
            } else {
                console.log('â³ ç­‰å¾… Xterm.js åº“åŠ è½½...');
                setTimeout(waitForXtermAndInitialize, 100);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');

            // ç­‰å¾…Xterm.jsåº“åŠ è½½å®Œæˆ
            waitForXtermAndInitialize();
        });

        // çª—å£å¤§å°å˜åŒ–æ—¶è°ƒæ•´æ‰€æœ‰ç»ˆç«¯
        window.addEventListener('resize', function() {
            setTimeout(() => {
                terminalManager.terminals.forEach((terminal, moduleName) => {
                    terminalManager.resizeTerminal(moduleName);
                });
            }, 100);
        });
    </script>
</body>
</html>
