<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kçº¿èšåˆç³»ç»Ÿ - æ¨¡å—ç›‘æ§ v6.0 (Xterm.js 5.5.0 + æ— è‡ªåŠ¨æ»šåŠ¨)</title>

    <!-- Xterm.js CSS - å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ 5.5.0 -->
    <link rel="stylesheet" href="https://unpkg.com/@xterm/xterm@5.5.0/css/xterm.css" />

    <!-- Xterm.js JavaScript - å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œä½¿ç”¨æ–°çš„ @xterm ä½œç”¨åŸŸ -->
    <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-web-links@0.11.0/lib/addon-web-links.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background-color: #1a1a1a;
            color: #00ff00;
            padding: 10px;
            font-size: 16px;
            line-height: 1.5;
        }

        .header {
            padding: 5px 10px;
            border-bottom: 2px solid #333;
            margin-bottom: 10px;
        }

        .header-top-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            flex-wrap: wrap;
        }

        .header h1 {
            color: #00ffff;
            font-size: 18px;
            margin: 0;
            flex-shrink: 0;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .main-content {
            display: flex;
            gap: 15px;
            height: calc(100vh - 120px); /* å‡å°‘å¤´éƒ¨é¢„ç•™ç©ºé—´åˆ°120px */
        }

        .static-modules-area {
            flex: 0 0 820px; /* å›ºå®šå®½åº¦820pxï¼Œè€ƒè™‘è¾¹æ¡†å’Œå†…è¾¹è· */
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: 100%; /* ç¡®ä¿å æ»¡çˆ¶å®¹å™¨é«˜åº¦ */
            border: 2px solid #444; /* æ·»åŠ è¾¹æ¡† */
            border-radius: 8px; /* åœ†è§’ */
            padding: 10px; /* å†…è¾¹è· */
            background-color: #0f0f0f; /* ç¨å¾®ä¸åŒçš„èƒŒæ™¯è‰²ä»¥åŒºåˆ† */
        }

        .static-modules-title {
            color: #00ffff;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            padding: 5px 0;
            border-bottom: 1px solid #444;
            margin-bottom: 5px;
            flex-shrink: 0;
        }

        .static-modules-content {
            flex: 1;
            display: flex;
            gap: 15px;
            min-height: 0; /* å…è®¸flexå­é¡¹æ”¶ç¼© */
        }

        .dynamic-modules-area {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 15px;
            overflow-y: auto;
            height: 100%; /* ç¡®ä¿å æ»¡çˆ¶å®¹å™¨é«˜åº¦ */
        }

        .module {
            border: 1px solid #333;
            border-radius: 5px;
            background-color: #0a0a0a;
            display: flex;
            flex-direction: column;
        }

        .static-module {
            flex: 1; /* åœ¨é™æ€åŒºåŸŸä¸­å¹³åˆ†ç©ºé—´ */
            display: flex;
            flex-direction: column;
            min-height: 0; /* å…è®¸flexå­é¡¹æ”¶ç¼© */
        }

        /* é™æ€æ¨¡å—åŒºåŸŸçš„ç‰¹æ®Šæ ·å¼ */
        .static-modules-area .module-header {
            background-color: #1a1a2e;
            border-bottom: 2px solid #16213e;
            flex-shrink: 0; /* é˜²æ­¢å¤´éƒ¨è¢«å‹ç¼© */
        }

        .static-modules-area .module-title {
            color: #0ff;
            font-weight: bold;
        }

        .static-modules-area .module-stats {
            flex-shrink: 0; /* é˜²æ­¢ç»Ÿè®¡åŒºåŸŸè¢«å‹ç¼© */
        }

        .static-modules-area .module-terminal {
            flex: 1; /* ç»ˆç«¯åŒºåŸŸå ç”¨å‰©ä½™ç©ºé—´ */
            /* ç§»é™¤å›ºå®šæœ€å°é«˜åº¦ï¼Œå®Œå…¨ä¾èµ–flexå¸ƒå±€è‡ªåŠ¨è®¡ç®— */
        }

        .module-header {
            padding: 8px 12px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .module-title {
            font-weight: bold;
            font-size: 16px;
            color: #00ffff;
        }

        .module-status {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-running { background-color: #006600; color: #00ff00; }
        .status-waiting { background-color: #666600; color: #ffff00; }
        .status-error { background-color: #660000; color: #ff0000; }
        .status-disconnected { background-color: #663300; color: #ff9900; }

        .module-stats {
            padding: 10px 15px;
            border-bottom: 1px solid #333;
            font-size: 13px;
            color: #cccccc;
        }

        .stat-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }

        /* Xterm.js ç»ˆç«¯å®¹å™¨æ ·å¼ */
        .module-terminal {
            flex: 1;
            padding: 5px;
            background-color: #000000;
            overflow: hidden;
            min-height: 100px; /* å‡å°‘æœ€å°é«˜åº¦ï¼Œä¸»è¦ä¾èµ–flexå¸ƒå±€ */
        }

        /* è‡ªå®šä¹‰ Xterm.js ä¸»é¢˜ */
        .xterm {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;
            font-size: 13px !important;
        }

        .xterm .xterm-viewport {
            background-color: #000000 !important;
        }

        .xterm .xterm-screen {
            background-color: #000000 !important;
        }

        .connection-status {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
        }

        .connected { background-color: #006600; color: #00ff00; }
        .disconnected { background-color: #660000; color: #ff0000; }

        /* é¡¶éƒ¨æŒ‰é’®æ ·å¼ */
        .header-copy-button {
            background-color: #ff6600;
            color: #ffffff;
            border: 2px solid #ff8833;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-family: 'Consolas', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(255, 102, 0, 0.4);
        }

        .header-copy-button:hover {
            background-color: #ff8833;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(255, 102, 0, 0.6);
        }

        .header-copy-button.copied {
            background-color: #44ff44;
            color: #000000;
            border-color: #66ff66;
        }

        .header-toggle-button {
            background-color: #0066ff;
            color: #ffffff;
            border: 2px solid #3388ff;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-family: 'Consolas', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 102, 255, 0.4);
        }

        .header-toggle-button:hover {
            background-color: #3388ff;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 102, 255, 0.6);
        }

        .header-toggle-button.active {
            background-color: #44ff44;
            color: #000000;
            border-color: #66ff66;
            box-shadow: 0 2px 6px rgba(68, 255, 68, 0.4);
        }

        /* æ¨¡å—åç§°æ˜¾ç¤ºåŒºåŸŸæ ·å¼ - ç´§å‡‘ç‰ˆ */
        .module-names-section {
            flex: 1;
            min-width: 300px;
        }

        .module-names-header {
            color: #00ffff;
            font-size: 14px;
            font-weight: bold;
            margin: 0 0 5px 0;
        }

        .module-names-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .module-name-tag {
            background-color: #1a4a1a;
            color: #00ff00;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-family: 'Consolas', monospace;
            cursor: pointer;
            border: 1px solid #006600;
            transition: all 0.2s ease;
        }

        .module-name-tag:hover {
            background-color: #2a5a2a;
            border-color: #00ff00;
            transform: scale(1.05);
        }

        .module-name-tag.copied {
            background-color: #4a4a1a;
            color: #ffff00;
            border-color: #ffff00;
        }

        .no-modules {
            color: #666;
            font-style: italic;
            font-size: 12px;
        }

        /* ç¡®ä¿é¡µé¢å¸ƒå±€ç¨³å®šæ€§ */
        html, body {
            height: 100%;
            overflow-x: hidden;
        }

        /* åŠ¨æ€æ¨¡å—çš„æ ·å¼ä¼˜åŒ– */
        .dynamic-modules-area .module {
            min-height: 400px; /* åŠ¨æ€æ¨¡å—æœ€å°é«˜åº¦ */
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 1200px) {
            .static-modules-area {
                flex: 0 0 600px; /* å°å±å¹•æ—¶å‡å°‘é™æ€åŒºåŸŸå®½åº¦ */
            }

            .static-modules-area .module-terminal {
                min-height: 200px; /* å°å±å¹•æ—¶å‡å°‘æœ€å°é«˜åº¦ */
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">è¿æ¥ä¸­...</div>

    <div class="header">
        <div class="header-top-row">
            <h1>Kçº¿èšåˆç³»ç»Ÿ - æ¨¡å—ç›‘æ§ v6</h1>

            <!-- æ¨¡å—åç§°æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="module-names-section">
                
                <div class="module-names-list" id="module-names-list">
                    <span class="no-modules">æš‚æ— æ¨¡å—æ•°æ®</span>
                </div>
            </div>

            <div class="header-buttons">
                <button class="header-copy-button" id="header-copy-modules" title="å¤åˆ¶æ‰€æœ‰æ¨¡å—åç§°">ğŸ”¥ å¤åˆ¶å…¨éƒ¨æ¨¡å—</button>
                <button class="header-toggle-button" id="toggle-realtime-logs" title="æ˜¾ç¤º/éšè—å®æ—¶åŸå§‹æ—¥å¿—">ğŸ“Š æ˜¾ç¤ºå®æ—¶åŸå§‹æ—¥å¿—</button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <!-- å·¦ä¾§é™æ€æ¨¡å—åŒºåŸŸ -->
        <div class="static-modules-area">
            <div class="static-modules-title">ğŸ“Š é™æ€æ¨¡å—åŒºåŸŸ - æ—¥å¿—ç›‘æ§</div>
            <div class="static-modules-content">
                <!-- å®æ—¶åŸå§‹æ—¥å¿—æ¨¡å— (é»˜è®¤éšè—) -->
                <div class="module static-module" id="realtime-logs-module" style="display: none;">
                    <div class="module-header">
                        <div class="module-title">å®æ—¶åŸå§‹æ—¥å¿— (RealtimeLogs)</div>
                        <div class="module-status status-waiting" id="realtime-logs-status">ç­‰å¾…æ—¥å¿—</div>
                    </div>
                    <div class="module-stats">
                        <div class="stat-line">
                            <span>å®æ—¶æ—¥å¿—æ•°:</span>
                            <span id="realtime-log-count">0</span>
                        </div>
                        <div class="stat-line">
                            <span>æœ€åæ›´æ–°:</span>
                            <span id="last-log-time">--:--:--</span>
                        </div>
                        <div class="stat-line">
                            <span>æ—¥å¿—é¢‘ç‡:</span>
                            <span id="log-frequency">-- æ¡/ç§’</span>
                        </div>
                    </div>
                    <div class="module-terminal" id="realtime-logs-terminal"></div>
                </div>

                <!-- åŸå§‹æ—¥å¿—å¿«ç…§æ¨¡å— -->
                <div class="module static-module" id="raw-logs-module">
                    <div class="module-header">
                        <div class="module-title">åŸå§‹æ—¥å¿—é«˜é¢‘æŠ˜å  (RawLogSnapshot)</div>
                        <div class="module-status status-waiting" id="raw-logs-status">ç­‰å¾…æŠ˜å </div>
                    </div>
                    <div class="module-stats">
                        <div class="stat-line">
                            <span>æŠ˜å æ—¶é—´:</span>
                            <span id="snapshot-timestamp">--:--:--</span>
                        </div>
                        <div class="stat-line">
                            <span>åŸå§‹æ—¥å¿—æ•°:</span>
                            <span id="total-log-count">--</span>
                        </div>
                        <div class="stat-line">
                            <span>æŠ˜å åæ¡æ•°:</span>
                            <span id="displayed-log-count">--</span>
                        </div>
                    </div>
                    <div class="module-terminal" id="raw-logs-terminal"></div>
                </div>

            </div>
        </div>

        <!-- å³ä¾§åŠ¨æ€æ¨¡å—åŒºåŸŸ -->
        <div class="dynamic-modules-area" id="dynamic-modules-container">
            <!-- åŠ¨æ€æ¨¡å—å°†åœ¨è¿™é‡Œåˆ›å»º -->
        </div>
    </div>

    <script>
        // Xterm.js ç»ˆç«¯ç®¡ç† (æœ€ç»ˆç‰ˆï¼šæ–°æ—¥å¿—æ˜¾ç¤ºåœ¨é¡¶éƒ¨)
        class TerminalManager {
            constructor() {
                this.terminals = new Map();
                this.fitAddons = new Map();
                this.logBuffers = new Map(); // å­˜å‚¨æ¯ä¸ªæ¨¡å—çš„æ—¥å¿—ç¼“å†²åŒº
                this.maxLines = 10000000;

                this.terminalTheme = {
                    background: '#000000',
                    foreground: '#00ff00',
                    cursor: '#00ff00',
                    cursorAccent: '#000000',
                    selection: 'rgba(255, 255, 255, 0.3)',
                    black: '#000000',
                    red: '#ff0000',
                    green: '#00ff00',
                    yellow: '#ffff00',
                    blue: '#0066ff',
                    magenta: '#ff00ff',
                    cyan: '#00ffff',
                    white: '#ffffff',
                    brightBlack: '#666666',
                    brightRed: '#ff6666',
                    brightGreen: '#66ff66',
                    brightYellow: '#ffff66',
                    brightBlue: '#6666ff',
                    brightMagenta: '#ff66ff',
                    brightCyan: '#66ffff',
                    brightWhite: '#ffffff'
                };
            }

            // åˆ›å»ºæ–°çš„ç»ˆç«¯å®ä¾‹
            createTerminal(containerId, moduleName) {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error(`æ‰¾ä¸åˆ°å®¹å™¨: ${containerId}`);
                    return null;
                }

                const terminal = new Terminal({
                    theme: this.terminalTheme,
                    fontFamily: 'Consolas, Monaco, "Courier New", monospace',
                    fontSize: 13,
                    lineHeight: 1.2,
                    cursorBlink: false,
                    scrollback: this.maxLines,
                    convertEol: true,
                    disableStdin: true, // ç¦ç”¨è¾“å…¥ï¼Œåªç”¨äºæ˜¾ç¤º
                    allowTransparency: true,
                    // 1GB å†™å…¥ç¼“å†²åŒºï¼Œæ”¯æŒå¤§é‡æ—¥å¿—
                    writeBufferSize: 1024 * 1024 * 1024
                });

                // æ­£ç¡®å®ä¾‹åŒ– v5 æ’ä»¶
                const fitAddon = new FitAddon.FitAddon();
                const webLinksAddon = new WebLinksAddon.WebLinksAddon();

                // åŠ è½½æ’ä»¶
                terminal.loadAddon(fitAddon);
                terminal.loadAddon(webLinksAddon);

                // æ— éœ€ä»»ä½•æ»šåŠ¨çŠ¶æ€ç®¡ç†å’Œæ£€æµ‹
                // ç”¨æˆ·å®Œå…¨æ§åˆ¶æ»šåŠ¨æ¡ä½ç½®

                // æ‰“å¼€ç»ˆç«¯
                terminal.open(container);

                // ç«‹å³è°ƒæ•´å¤§å°ä»¥å¡«æ»¡å®¹å™¨
                setTimeout(() => fitAddon.fit(), 0);

                // å­˜å‚¨å®ä¾‹
                this.terminals.set(moduleName, terminal);
                this.fitAddons.set(moduleName, fitAddon);
                this.logBuffers.set(moduleName, []); // åˆå§‹åŒ–æ—¥å¿—ç¼“å†²åŒº

                console.log(`âœ… ä¸ºæ¨¡å— [${moduleName}] åˆ›å»ºäº†æ–°æ—¥å¿—æ˜¾ç¤ºåœ¨é¡¶éƒ¨çš„ç»ˆç«¯`);
                return terminal;
            }

            // è·å–ç»ˆç«¯å®ä¾‹
            getTerminal(moduleName) {
                return this.terminals.get(moduleName);
            }

            // å‘ç»ˆç«¯å†™å…¥æ—¥å¿— (å‘½ä»¤è¡Œæƒ¯ä¾‹ï¼šæ–°æ—¥å¿—åœ¨åº•éƒ¨)
            writeLog(moduleName, logText, level = 'INFO') {
                const terminal = this.getTerminal(moduleName);
                if (!terminal) {
                    console.warn(`ç»ˆç«¯ä¸å­˜åœ¨: ${moduleName}`);
                    return;
                }

                // æ ¹æ®æ—¥å¿—çº§åˆ«è®¾ç½®é¢œè‰²
                let colorCode = '';
                switch (level.toUpperCase()) {
                    case 'ERROR': colorCode = '\x1b[31m'; break; // çº¢è‰²
                    case 'WARN':  colorCode = '\x1b[33m'; break; // é»„è‰²
                    case 'INFO':  colorCode = '\x1b[32m'; break; // ç»¿è‰²
                    case 'DEBUG': colorCode = '\x1b[36m'; break; // é’è‰²
                    default:      colorCode = '\x1b[37m'; break; // ç™½è‰²
                }

                const resetCode = '\x1b[0m'; // é‡ç½®é¢œè‰²
                const formattedLog = `${colorCode}${logText}${resetCode}`;

                // è·å–æ—¥å¿—ç¼“å†²åŒº
                let logBuffer = this.logBuffers.get(moduleName);
                if (!logBuffer) {
                    logBuffer = [];
                    this.logBuffers.set(moduleName, logBuffer);
                }

                // å°†æ–°æ—¥å¿—è¿½åŠ åˆ°ç¼“å†²åŒºåº•éƒ¨ï¼ˆå‘½ä»¤è¡Œæƒ¯ä¾‹ï¼‰
                logBuffer.push(formattedLog);

                // é™åˆ¶ç¼“å†²åŒºå¤§å°ï¼Œé˜²æ­¢å†…å­˜æº¢å‡ºï¼ˆç§»é™¤æœ€è€çš„æ—¥å¿—ï¼‰
                if (logBuffer.length > this.maxLines) {
                    logBuffer.shift(); // ç§»é™¤æœ€è€çš„æ—¥å¿—ï¼ˆæ•°ç»„å¼€å¤´ï¼‰
                }

                // ç›´æ¥è¿½åŠ åˆ°ç»ˆç«¯åº•éƒ¨ï¼Œæ— éœ€åˆ·æ–°æ•´ä¸ªç»ˆç«¯
                terminal.write(formattedLog + '\r\n');
            }

            // åˆ·æ–°ç»ˆç«¯æ˜¾ç¤ºï¼ˆå¸¦æµæ§åˆ¶ï¼‰
            refreshTerminal(moduleName) {
                const terminal = this.getTerminal(moduleName);
                const logBuffer = this.logBuffers.get(moduleName);

                if (!terminal || !logBuffer) {
                    return;
                }

                // æ¸…ç©ºç»ˆç«¯
                terminal.clear();

                // åˆ†æ‰¹å†™å…¥æ—¥å¿—ä»¥é¿å…ç¼“å†²åŒºæº¢å‡º
                this.writeLogsInBatches(terminal, logBuffer);
            }

            // ç›´æ¥å†™å…¥æ‰€æœ‰æ—¥å¿—åˆ°ç»ˆç«¯
            writeLogsInBatches(terminal, logBuffer) {
                if (!logBuffer || logBuffer.length === 0) {
                    return;
                }

                try {
                    // ç›´æ¥å†™å…¥æ‰€æœ‰æ—¥å¿—ï¼Œä¸åˆ†æ‰¹
                    logBuffer.forEach(formattedLog => {
                        terminal.write(formattedLog + '\r\n');
                    });
                    // åªåœ¨å†å²æ—¥å¿—åŠ è½½æ—¶æ˜¾ç¤ºæ—¥å¿—ï¼Œæ–°æ—¥å¿—è¿½åŠ æ—¶ä¸æ˜¾ç¤º
                    // console.log(`ğŸ”„ [${moduleName}] åˆ·æ–°ç»ˆç«¯ï¼Œå†™å…¥ ${logBuffer.length} æ¡æ—¥å¿—`);
                } catch (error) {
                    console.error(`âŒ å†™å…¥æ—¥å¿—å¤±è´¥: ${error.message}`);
                }
            }

            // æ¸…ç©ºç»ˆç«¯
            clearTerminal(moduleName) {
                const terminal = this.getTerminal(moduleName);
                if (terminal) {
                    terminal.clear();
                    // åŒæ—¶æ¸…ç©ºæ—¥å¿—ç¼“å†²åŒº
                    this.logBuffers.set(moduleName, []);
                }
            }

            // è°ƒæ•´ç»ˆç«¯å¤§å°
            resizeTerminal(moduleName) {
                const fitAddon = this.fitAddons.get(moduleName);
                if (fitAddon && fitAddon.fit) {
                    fitAddon.fit();
                } else {
                    console.log(`æ¨¡å— ${moduleName} çš„FitAddonä¸å¯ç”¨`);
                }
            }

            // é”€æ¯ç»ˆç«¯
            destroyTerminal(moduleName) {
                const terminal = this.getTerminal(moduleName);
                if (terminal) {
                    terminal.dispose();
                    this.terminals.delete(moduleName);
                    this.fitAddons.delete(moduleName);
                    this.logBuffers.delete(moduleName); // æ¸…ç†æ—¥å¿—ç¼“å†²åŒº
                }
            }
        }

        // å…¨å±€ç»ˆç«¯ç®¡ç†å™¨å®ä¾‹
        const terminalManager = new TerminalManager();

        // WebSocketè¿æ¥ç®¡ç†
        let ws = null;
        let reconnectInterval = null;
        let createdModules = new Set();
        let currentModuleNames = [];
        let isInitialDataLoaded = false; // æ ‡è®°æ˜¯å¦å·²åŠ è½½åˆå§‹å†å²æ•°æ®

        // åˆå§‹åŒ–å›ºå®šç»ˆç«¯
        function initializeFixedTerminals() {
            // åˆ›å»ºåŸå§‹æ—¥å¿—å¿«ç…§ç»ˆç«¯
            terminalManager.createTerminal('raw-logs-terminal', 'RawLogSnapshot');

            console.log('ğŸš€ å›ºå®šç»ˆç«¯åˆå§‹åŒ–å®Œæˆ');
        }

        // WebSocketè¿æ¥å‡½æ•°
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                console.log('ğŸ”— WebSocketå·²è¿æ¥');
                updateConnectionStatus(true);
                // é‡ç½®åˆå§‹æ•°æ®åŠ è½½æ ‡å¿—ï¼Œå‡†å¤‡æ¥æ”¶æ–°çš„å†å²æ•°æ®
                isInitialDataLoaded = false;
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };

            ws.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);

                    // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯
                    if (message.type === 'SystemStatus') {
                        // å¤„ç†ç³»ç»ŸçŠ¶æ€æ›´æ–°ï¼ˆä½é¢‘ï¼‰
                        updateSystemStatus(message.data);
                    } else if (message.type === 'LogEntry') {
                        // å¤„ç†å•ä¸ªæ—¥å¿—æ¡ç›® - ç«‹å³å¢é‡æ˜¾ç¤º
                        const logEntry = message.data;
                        addLogEntryIncremental(logEntry);
                    } else if (message.type === 'DashboardUpdate') {
                        // å¤„ç†èšåˆæ•°æ®æ›´æ–° - æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å’ŒåŸå§‹æ—¥å¿—å¿«ç…§
                        updateDashboardData(message.data);
                    } else {
                        console.log('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', message.type);
                    }
                } catch (e) {
                    console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', e);
                }
            };

            ws.onclose = function() {
                console.log('WebSocketè¿æ¥å·²å…³é—­');
                updateConnectionStatus(false);
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(connectWebSocket, 5000);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocketé”™è¯¯:', error);
                updateConnectionStatus(false);
            };
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');

            if (connected) {
                statusEl.textContent = 'å·²è¿æ¥';
                statusEl.className = 'connection-status connected';
            } else {
                statusEl.textContent = 'è¿æ¥æ–­å¼€';
                statusEl.className = 'connection-status disconnected';
            }
        }

        // å¤„ç†ç³»ç»ŸçŠ¶æ€æ›´æ–°ï¼ˆç®€åŒ–ç‰ˆ - ä»…è®°å½•æ—¥å¿—ï¼‰
        function updateSystemStatus(data) {
            console.log('ğŸ“Š æ”¶åˆ°ç³»ç»ŸçŠ¶æ€æ›´æ–°:', data);
            // ç³»ç»ŸçŠ¶æ€ä¿¡æ¯å·²ä»ç•Œé¢ç§»é™¤ï¼Œä»…ä¿ç•™æ—¥å¿—è®°å½•
        }

        // å¤„ç†èšåˆæ•°æ®æ›´æ–°
        function updateDashboardData(data) {
           // console.log('ğŸ“ˆ æ”¶åˆ°èšåˆæ•°æ®æ›´æ–°:', data);

            // æ›´æ–°èšåˆæ—¥å¿—è§†å›¾ (æŒç»­æ›´æ–°çš„å…¨é‡æ•°æ®)
            if (data.raw_log_snapshot) {
                const aggregatedData = data.raw_log_snapshot;

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                if (aggregatedData.timestamp) {
                    document.getElementById('snapshot-timestamp').textContent = aggregatedData.timestamp;
                }
                if (aggregatedData.total_count !== undefined) {
                    document.getElementById('total-log-count').textContent = aggregatedData.total_count;
                }
                if (aggregatedData.logs && aggregatedData.logs.length !== undefined) {
                    document.getElementById('displayed-log-count').textContent = aggregatedData.logs.length;
                }

                // æ›´æ–°çŠ¶æ€ä¸ºè¿è¡Œä¸­
                const statusEl = document.getElementById('raw-logs-status');
                if (statusEl) {
                    statusEl.textContent = 'è¿è¡Œä¸­';
                    statusEl.className = 'module-status status-running';
                }

                // å…³é”®ä¿®å¤ï¼šæ¯æ¬¡æ”¶åˆ°æ•°æ®éƒ½åˆ·æ–°ç»ˆç«¯å†…å®¹
                // å› ä¸ºæ­¤æ¨¡å—çš„æ•°æ®æ˜¯å…¨é‡ä¸‹å‘çš„ï¼Œæ‰€ä»¥æ¯æ¬¡éƒ½éœ€è¦å®Œå…¨æ›¿æ¢
                if (aggregatedData.logs) { // åªè¦æœ‰logså­—æ®µå°±åˆ·æ–°ï¼Œå³ä½¿æ˜¯ç©ºæ•°ç»„ä¹Ÿè¦æ¸…ç©ºç»ˆç«¯
                    loadHistoryRawLogsToTerminal('RawLogSnapshot', aggregatedData.logs);
                }
            }

            // å¤„ç†æ¨¡å—æ•°æ®ï¼ˆç»Ÿä¸€çš„æ˜¾ç¤ºæ—¥å¿—ï¼‰
            if (data.module_logs) {
                for (const [moduleName, moduleData] of Object.entries(data.module_logs)) {
                    // ç¡®ä¿æ¨¡å—å®¹å™¨å­˜åœ¨
                    ensureModuleContainer(moduleName);

                    // æ›´æ–°æ¨¡å—ç»Ÿè®¡ä¿¡æ¯
                    updateModuleStatsFromData(moduleName, moduleData);

                    // åªåœ¨åˆå§‹è¿æ¥æ—¶åŠ è½½å†å²æ•°æ®
                    if (!isInitialDataLoaded) {
                        // åŠ è½½ç»Ÿä¸€çš„æ˜¾ç¤ºæ—¥å¿—ï¼ˆåŒ…å«æ™®é€šæ—¥å¿—å’Œèšåˆæ—¥å¿—ï¼‰
                        if (moduleData.display_logs && moduleData.display_logs.length > 0) {
                            loadHistoryDisplayLogsToTerminal(moduleName, moduleData.display_logs);
                        }
                    }

                    // æ›´æ–°æ¨¡å—åç§°åˆ—è¡¨
                    updateModuleNamesList([moduleName]);
                }
            }

            // æ ‡è®°åˆå§‹æ•°æ®å·²åŠ è½½
            if (!isInitialDataLoaded) {
                isInitialDataLoaded = true;
                console.log('âœ… åˆå§‹å†å²æ•°æ®åŠ è½½å®Œæˆ');
            }
        }
        // åŠ è½½å†å²æ—¥å¿—åˆ°ç»ˆç«¯ï¼ˆç”¨äºå­—ç¬¦ä¸²æ ¼å¼çš„æ—¥å¿—ï¼‰
        function loadHistoryLogsToTerminal(moduleName, historyLogs) {
            const terminal = terminalManager.getTerminal(moduleName);
            if (!terminal || !historyLogs || historyLogs.length === 0) {
                return;
            }

            console.log(`ğŸ“š ä¸ºæ¨¡å— [${moduleName}] åŠ è½½ ${historyLogs.length} æ¡å†å²æ—¥å¿—`);

            // æ¸…ç©ºç»ˆç«¯å’Œç¼“å†²åŒº
            terminalManager.clearTerminal(moduleName);

            // æŒ‰ç…§å‘½ä»¤è¡Œæƒ¯ä¾‹ï¼šæœ€è€çš„æ—¥å¿—åœ¨ä¸Šæ–¹ï¼Œæœ€æ–°çš„åœ¨ä¸‹æ–¹
            // å¦‚æœåç«¯å‘é€çš„æ˜¯æœ€æ–°åœ¨å‰çš„é¡ºåºï¼Œéœ€è¦åè½¬
            // å…ˆæ£€æŸ¥å¹¶è°ƒè¯•å†å²æ—¥å¿—çš„é¡ºåº
            console.log(`ğŸ” [${moduleName}] å†å²æ—¥å¿—é¡ºåºæ£€æŸ¥:`, {
                æ€»æ•°: historyLogs.length,
                ç¬¬ä¸€æ¡: historyLogs[0]?.substring(0, 50) + '...',
                æœ€åä¸€æ¡: historyLogs[historyLogs.length - 1]?.substring(0, 50) + '...'
            });

            // åè½¬å†å²æ—¥å¿—é¡ºåºï¼Œç¡®ä¿æœ€è€çš„åœ¨ä¸Šæ–¹
            const orderedLogs = [...historyLogs].reverse();

            const logBuffer = terminalManager.logBuffers.get(moduleName) || [];
            orderedLogs.forEach(logText => {
                const level = extractLogLevelFromText(logText);
                const colorCode = getColorCodeForLevel(level);
                const resetCode = '\x1b[0m';
                const formattedLog = `${colorCode}${logText}${resetCode}`;
                logBuffer.push(formattedLog); // è¿½åŠ åˆ°åº•éƒ¨
            });
            terminalManager.logBuffers.set(moduleName, logBuffer);

            // åˆ·æ–°ç»ˆç«¯æ˜¾ç¤º
            terminalManager.refreshTerminal(moduleName);
            console.log(`ğŸ“ æ¨¡å— [${moduleName}] å†å²æ—¥å¿—åŠ è½½å®Œæˆï¼Œæ–°æ—¥å¿—å°†æ˜¾ç¤ºåœ¨åº•éƒ¨`);
        }

        // è·å–æ—¥å¿—çº§åˆ«å¯¹åº”çš„é¢œè‰²ä»£ç 
        function getColorCodeForLevel(level) {
            switch (level.toUpperCase()) {
                case 'ERROR': return '\x1b[31m'; // çº¢è‰²
                case 'WARN':  return '\x1b[33m'; // é»„è‰²
                case 'INFO':  return '\x1b[32m'; // ç»¿è‰²
                case 'DEBUG': return '\x1b[36m'; // é’è‰²
                case 'AGGREGATE': return '\x1b[93m'; // äº®é»„è‰²ï¼ˆé«˜é¢‘èšåˆï¼‰
                default:      return '\x1b[37m'; // ç™½è‰²
            }
        }

        // åŠ è½½å†å²æ˜¾ç¤ºæ—¥å¿—åˆ°ç»ˆç«¯ï¼ˆç”¨äºDisplayLogEntryæ ¼å¼çš„æ—¥å¿—ï¼‰
        function loadHistoryDisplayLogsToTerminal(moduleName, displayLogs) {
            const terminal = terminalManager.getTerminal(moduleName);
            if (!terminal || !displayLogs || displayLogs.length === 0) {
                return;
            }

            console.log(`ğŸ“š ä¸ºæ¨¡å— [${moduleName}] åŠ è½½ ${displayLogs.length} æ¡å†å²æ˜¾ç¤ºæ—¥å¿—`);

            // æ¸…ç©ºç»ˆç«¯å’Œç¼“å†²åŒº
            terminalManager.clearTerminal(moduleName);

            // æŒ‰ç…§å‘½ä»¤è¡Œæƒ¯ä¾‹ï¼šæœ€è€çš„æ—¥å¿—åœ¨ä¸Šæ–¹ï¼Œæœ€æ–°çš„åœ¨ä¸‹æ–¹
            // æ£€æŸ¥æ˜¾ç¤ºæ—¥å¿—çš„æ—¶é—´æˆ³é¡ºåº
            if (displayLogs.length > 1) {
                const firstTime = new Date(displayLogs[0].timestamp);
                const lastTime = new Date(displayLogs[displayLogs.length - 1].timestamp);
                console.log(`ğŸ” [${moduleName}] æ˜¾ç¤ºæ—¥å¿—æ—¶é—´é¡ºåº:`, {
                    æ€»æ•°: displayLogs.length,
                    ç¬¬ä¸€æ¡æ—¶é—´: firstTime.toLocaleTimeString(),
                    æœ€åä¸€æ¡æ—¶é—´: lastTime.toLocaleTimeString(),
                    æ˜¯å¦éœ€è¦åè½¬: firstTime > lastTime ? 'æ˜¯' : 'å¦'
                });
            }

            // æ ¹æ®æ—¶é—´æˆ³æ’åºï¼Œç¡®ä¿æœ€è€çš„åœ¨å‰é¢
            const orderedDisplayLogs = [...displayLogs].sort((a, b) =>
                new Date(a.timestamp) - new Date(b.timestamp)
            );

            const logBuffer = terminalManager.logBuffers.get(moduleName) || [];
            orderedDisplayLogs.forEach(displayEntry => {
                const timestamp = new Date(displayEntry.timestamp).toLocaleTimeString();
                // èšåˆæ—¥å¿—çš„æ¶ˆæ¯å·²ç»åŒ…å«äº†èšåˆä¿¡æ¯ï¼Œä¸éœ€è¦é¢å¤–æ·»åŠ 
                const logText = `[${timestamp}] ${displayEntry.level} ${displayEntry.message}`;

                // èšåˆæ—¥å¿—ä½¿ç”¨ç‰¹æ®Šé¢œè‰²
                const level = displayEntry.is_aggregated ? 'AGGREGATE' : displayEntry.level;
                const colorCode = getColorCodeForLevel(level);
                const resetCode = '\x1b[0m';
                const formattedLog = `${colorCode}${logText}${resetCode}`;
                logBuffer.push(formattedLog); // è¿½åŠ åˆ°åº•éƒ¨
            });
            terminalManager.logBuffers.set(moduleName, logBuffer);

            // åˆ·æ–°ç»ˆç«¯æ˜¾ç¤º
            terminalManager.refreshTerminal(moduleName);
            console.log(`ğŸ“ æ¨¡å— [${moduleName}] å†å²æ˜¾ç¤ºæ—¥å¿—åŠ è½½å®Œæˆï¼Œæ–°æ—¥å¿—å°†æ˜¾ç¤ºåœ¨åº•éƒ¨`);
        }

        // åŠ è½½åŸå§‹æ—¥å¿—å¿«ç…§åˆ°ç»ˆç«¯
        function loadHistoryRawLogsToTerminal(moduleName, rawLogs) {
            const terminal = terminalManager.getTerminal(moduleName);
            if (!terminal || !rawLogs || rawLogs.length === 0) {
                return;
            }

            console.log(`ğŸ“š ä¸ºæ¨¡å— [${moduleName}] åŠ è½½ ${rawLogs.length} æ¡åŸå§‹æ—¥å¿—å¿«ç…§`);

            // æ¸…ç©ºç»ˆç«¯å’Œç¼“å†²åŒº
            terminalManager.clearTerminal(moduleName);

            const logBuffer = terminalManager.logBuffers.get(moduleName) || [];
            rawLogs.forEach(logText => {
                // ä»æ—¥å¿—æ–‡æœ¬ä¸­æå–çº§åˆ«å¹¶åº”ç”¨ç›¸åº”é¢œè‰²
                const level = extractLogLevelFromText(logText);

                // æ£€æŸ¥æ˜¯å¦æ˜¯èšåˆæ—¥å¿—
                const isAggregated = logText.includes('ğŸ”„') && logText.includes('èšåˆ');
                const finalLevel = isAggregated ? 'AGGREGATE' : level;

                const colorCode = getColorCodeForLevel(finalLevel);
                const resetCode = '\x1b[0m';
                const formattedLog = `${colorCode}${logText}${resetCode}`;
                logBuffer.push(formattedLog);
            });
            terminalManager.logBuffers.set(moduleName, logBuffer);

            // åˆ·æ–°ç»ˆç«¯æ˜¾ç¤º
            terminalManager.refreshTerminal(moduleName);
            console.log(`ğŸ“ æ¨¡å— [${moduleName}] åŸå§‹æ—¥å¿—å¿«ç…§åŠ è½½å®Œæˆ`);
        }





        // ä»æ–‡æœ¬ä¸­æå–æ—¥å¿—çº§åˆ«
        function extractLogLevelFromText(logText) {
            if (typeof logText === 'string') {
                if (logText.includes('ERROR')) return 'ERROR';
                if (logText.includes('WARN')) return 'WARN';
                if (logText.includes('INFO')) return 'INFO';
                if (logText.includes('DEBUG')) return 'DEBUG';
            }
            return 'INFO';
        }

        // ä»æ•°æ®æ›´æ–°æ¨¡å—ç»Ÿè®¡ä¿¡æ¯
        function updateModuleStatsFromData(moduleName, moduleData) {
            const containerId = getModuleContainerId(moduleName);

            // æ›´æ–°æ€»æ—¥å¿—æ•°
            const totalEl = document.getElementById(`${containerId}-total`);
            if (totalEl && moduleData.total_logs !== undefined) {
                totalEl.textContent = moduleData.total_logs;
            }

            // æ›´æ–°é”™è¯¯æ•°
            const errorsEl = document.getElementById(`${containerId}-errors`);
            if (errorsEl && moduleData.error_count !== undefined) {
                errorsEl.textContent = moduleData.error_count;
            }

            // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
            const lastUpdateEl = document.getElementById(`${containerId}-last-update`);
            if (lastUpdateEl) {
                lastUpdateEl.textContent = new Date().toLocaleTimeString();
            }

            // æ›´æ–°çŠ¶æ€ä¸ºè¿è¡Œä¸­
            const statusEl = document.getElementById(`${containerId}-status`);
            if (statusEl) {
                statusEl.textContent = 'è¿è¡Œä¸­';
                statusEl.className = 'module-status status-running';
            }
        }









        // ç¡®ä¿æ¨¡å—å®¹å™¨å­˜åœ¨
        function ensureModuleContainer(moduleName) {
            if (createdModules.has(moduleName)) {
                return; // æ¨¡å—å·²å­˜åœ¨
            }

            console.log('ğŸ†• åˆ›å»ºæ¨¡å—:', moduleName);
            const containerId = getModuleContainerId(moduleName);
            const terminalId = containerId + '-terminal';

            // åˆ›å»ºæ¨¡å—å®¹å™¨
            const moduleDiv = document.createElement('div');
            moduleDiv.className = 'module';
            moduleDiv.innerHTML = `
                <div class="module-header">
                    <div class="module-title">${moduleName}</div>
                    <div class="module-status status-running" id="${containerId}-status">è¿è¡Œä¸­</div>
                </div>
                <div class="module-stats">
                    <div class="stat-line">
                        <span>æ€»æ—¥å¿—æ•°:</span>
                        <span id="${containerId}-total">0</span>
                    </div>
                    <div class="stat-line">
                        <span>é”™è¯¯æ•°:</span>
                        <span id="${containerId}-errors">0</span>
                    </div>
                    <div class="stat-line">
                        <span>æœ€åæ›´æ–°:</span>
                        <span id="${containerId}-last-update">--:--:--</span>
                    </div>
                </div>
                <div class="module-terminal" id="${terminalId}"></div>
            `;

            // æ·»åŠ åˆ°åŠ¨æ€æ¨¡å—å®¹å™¨ä¸­
            const dynamicModulesContainer = document.querySelector('.dynamic-modules-area');
            dynamicModulesContainer.appendChild(moduleDiv);

            // åˆ›å»ºç»ˆç«¯
            terminalManager.createTerminal(terminalId, moduleName);

            createdModules.add(moduleName);
        }

        // æ›´æ–°å›ºå®šæ¨¡å—çŠ¶æ€
        function updateFixedModuleStatus() {
            // æ›´æ–°åŸå§‹å¿«ç…§æ¨¡å—çŠ¶æ€
            const rawLogsStatusEl = document.getElementById('raw-logs-status');
            if (rawLogsStatusEl) {
                rawLogsStatusEl.textContent = 'è¿è¡Œä¸­';
                rawLogsStatusEl.className = 'module-status status-running';
            }
        }



        // å¢é‡æ·»åŠ æ—¥å¿—æ¡ç›® - ç®€åŒ–ç‰ˆï¼ˆä¸»è¦é€šè¿‡ DashboardUpdate å¤„ç†ï¼‰
        function addLogEntryIncremental(logEntry) {
            // åªå¤„ç†æœªè¢«èšåˆçš„æ—¥å¿—ï¼Œç›´æ¥æ·»åŠ åˆ°å¯¹åº”æ¨¡å—ç»ˆç«¯
            const moduleName = logEntry.target || 'unknown';
            ensureModuleContainer(moduleName);

            const logText = formatLogEntry(logEntry);
            const level = extractLogLevel(logEntry);
            terminalManager.writeLog(moduleName, logText, level);

            // æ›´æ–°å›ºå®šæ¨¡å—çŠ¶æ€
            updateFixedModuleStatus();

            // æ›´æ–°æ¨¡å—åç§°åˆ—è¡¨
            updateModuleNamesList([moduleName]);

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateModuleStats(moduleName, logEntry);
        }

        // æ ¼å¼åŒ–æ—¥å¿—æ¡ç›®
        function formatLogEntry(logEntry) {
            if (typeof logEntry === 'string') {
                return logEntry;
            }

            if (logEntry.message) {
                const timestamp = logEntry.timestamp ? new Date(logEntry.timestamp).toLocaleTimeString() : '';
                const level = logEntry.level || 'INFO';
                const module = logEntry.module || '';

                if (timestamp && module) {
                    return `[${timestamp}] ${level} ${module}: ${logEntry.message}`;
                } else if (timestamp) {
                    return `[${timestamp}] ${level}: ${logEntry.message}`;
                } else {
                    return `${level}: ${logEntry.message}`;
                }
            }

            return JSON.stringify(logEntry);
        }

        // æå–æ—¥å¿—çº§åˆ«
        function extractLogLevel(logEntry) {
            if (typeof logEntry === 'object' && logEntry.level) {
                return logEntry.level.toUpperCase();
            }

            if (typeof logEntry === 'string') {
                if (logEntry.includes('ERROR')) return 'ERROR';
                if (logEntry.includes('WARN')) return 'WARN';
                if (logEntry.includes('INFO')) return 'INFO';
                if (logEntry.includes('DEBUG')) return 'DEBUG';
            }

            return 'INFO';
        }

        // è·å–æ¨¡å—å®¹å™¨ID
        function getModuleContainerId(moduleName) {
            return 'module-' + moduleName.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
        }

        // æ›´æ–°æ¨¡å—åç§°åˆ—è¡¨ï¼ˆå¢é‡ç‰ˆæœ¬ï¼‰
        function updateModuleNamesList(newModuleNames) {
            const container = document.getElementById('module-names-list');

            // åˆå¹¶æ–°æ¨¡å—ååˆ°ç°æœ‰åˆ—è¡¨
            newModuleNames.forEach(moduleName => {
                if (!currentModuleNames.includes(moduleName)) {
                    currentModuleNames.push(moduleName);

                    // åˆ›å»ºæ–°çš„æ¨¡å—æ ‡ç­¾
                    const tag = document.createElement('span');
                    tag.className = 'module-name-tag';
                    tag.textContent = moduleName;
                    tag.title = 'ç‚¹å‡»å¤åˆ¶æ¨¡å—åç§°';
                    tag.id = `module-tag-${moduleName}`;

                    // æ·»åŠ ç‚¹å‡»å¤åˆ¶åŠŸèƒ½
                    tag.addEventListener('click', function() {
                        copyToClipboard(moduleName, tag);
                    });

                    // å¦‚æœå®¹å™¨æ˜¯ç©ºçš„ï¼Œå…ˆæ¸…ç©º"æš‚æ— æ¨¡å—"æç¤º
                    if (container.querySelector('.no-modules')) {
                        container.innerHTML = '';
                    }

                    container.appendChild(tag);
                }
            });
        }

        // æ›´æ–°æ¨¡å—ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¢é‡ç‰ˆæœ¬ï¼‰
        function updateModuleStats(moduleName, logEntry) {
            const containerId = getModuleContainerId(moduleName);

            // æ›´æ–°æ€»æ—¥å¿—æ•°
            const totalEl = document.getElementById(`${containerId}-total`);
            if (totalEl) {
                const current = parseInt(totalEl.textContent) || 0;
                totalEl.textContent = current + 1;
            }

            // æ›´æ–°é”™è¯¯æ•°
            if (logEntry.level === 'ERROR') {
                const errorsEl = document.getElementById(`${containerId}-errors`);
                if (errorsEl) {
                    const current = parseInt(errorsEl.textContent) || 0;
                    errorsEl.textContent = current + 1;
                }
            }

            // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
            const lastUpdateEl = document.getElementById(`${containerId}-last-update`);
            if (lastUpdateEl) {
                lastUpdateEl.textContent = new Date().toLocaleTimeString();
            }

            // æ›´æ–°çŠ¶æ€ä¸ºè¿è¡Œä¸­
            const statusEl = document.getElementById(`${containerId}-status`);
            if (statusEl) {
                statusEl.textContent = 'è¿è¡Œä¸­';
                statusEl.className = 'module-status status-running';
            }
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿åŠŸèƒ½
        function copyToClipboard(text, element) {
            navigator.clipboard.writeText(text).then(function() {
                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„è§†è§‰åé¦ˆ
                element.classList.add('copied');
                const originalText = element.textContent;
                element.textContent = 'å·²å¤åˆ¶!';

                setTimeout(function() {
                    element.classList.remove('copied');
                    element.textContent = originalText;
                }, 1000);
            }).catch(function(err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
            });
        }

        // å¤åˆ¶æ‰€æœ‰æ¨¡å—åç§°
        function copyAllModuleNames() {
            if (currentModuleNames.length === 0) {
                alert('æš‚æ— æ¨¡å—æ•°æ®å¯å¤åˆ¶');
                return;
            }

            const allModuleNames = currentModuleNames.join('\n');
            const button = document.getElementById('header-copy-modules');

            navigator.clipboard.writeText(allModuleNames).then(function() {
                button.classList.add('copied');
                const originalText = button.textContent;
                button.textContent = 'âœ… å·²å¤åˆ¶!';

                setTimeout(function() {
                    button.classList.remove('copied');
                    button.textContent = originalText;
                }, 2000);
            }).catch(function(err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
            });
        }

        // åˆ‡æ¢å®æ—¶æ—¥å¿—æ˜¾ç¤º
        function toggleRealtimeLogs() {
            const realtimeModule = document.getElementById('realtime-logs-module');
            const button = document.getElementById('toggle-realtime-logs');
            const staticArea = document.querySelector('.static-modules-area');

            if (!realtimeModule || !staticArea) return;

            const isCurrentlyHidden = realtimeModule.style.display === 'none';

            if (isCurrentlyHidden) {
                // æ˜¾ç¤ºå®æ—¶æ—¥å¿—æ¨¡å—
                realtimeModule.style.display = '';
                button.classList.add('active');
                button.textContent = 'ğŸ“Š éšè—å®æ—¶åŸå§‹æ—¥å¿—';

                // è°ƒæ•´é™æ€æ¨¡å—åŒºåŸŸå®½åº¦ä¸º800pxï¼ˆä¸¤ä¸ªæ¨¡å—ï¼‰
                staticArea.style.flex = '0 0 820px'; // è€ƒè™‘è¾¹æ¡†å’Œå†…è¾¹è·

                // è°ƒæ•´ç»ˆç«¯å¤§å°
                setTimeout(() => {
                    terminalManager.resizeTerminal('RealtimeLogs');
                    terminalManager.resizeTerminal('RawLogSnapshot');
                }, 150);
            } else {
                // éšè—å®æ—¶æ—¥å¿—æ¨¡å—
                realtimeModule.style.display = 'none';
                button.classList.remove('active');
                button.textContent = 'ğŸ“Š æ˜¾ç¤ºå®æ—¶åŸå§‹æ—¥å¿—';

                // è°ƒæ•´é™æ€æ¨¡å—åŒºåŸŸå®½åº¦ä¸º420pxï¼ˆä¸€ä¸ªæ¨¡å—ï¼‰
                staticArea.style.flex = '0 0 420px'; // è€ƒè™‘è¾¹æ¡†å’Œå†…è¾¹è·

                // è°ƒæ•´å‰©ä½™æ¨¡å—çš„ç»ˆç«¯å¤§å°
                setTimeout(() => {
                    terminalManager.resizeTerminal('RawLogSnapshot');
                }, 150);
            }
        }

        // æ£€æŸ¥Xterm.jsæ˜¯å¦åŠ è½½å®Œæˆ (é€‚é…æ–°ç‰ˆæœ¬ @xterm/* åŒ…)
        function checkXtermLoaded() {
            const terminalLoaded = typeof Terminal !== 'undefined';
            const fitAddonLoaded = typeof FitAddon !== 'undefined';
            const webLinksLoaded = typeof WebLinksAddon !== 'undefined';

            console.log('Xterm.js 5.5.0 åº“åŠ è½½çŠ¶æ€:', {
                Terminal: terminalLoaded,
                FitAddon: fitAddonLoaded,
                WebLinksAddon: webLinksLoaded,
                // æ£€æŸ¥å…¨å±€å¯¹è±¡ä¸­çš„æ‰€æœ‰å¯ç”¨å˜é‡
                globalKeys: Object.keys(window).filter(key => key.toLowerCase().includes('addon') || key.toLowerCase().includes('fit') || key.toLowerCase().includes('weblinks')),
                // æ£€æŸ¥å…·ä½“çš„æ„é€ å‡½æ•°
                FitAddonType: typeof window.FitAddon,
                WebLinksAddonType: typeof window.WebLinksAddon,
                // æ£€æŸ¥æ˜¯å¦å¯ä»¥å®ä¾‹åŒ–
                canCreateFitAddon: typeof window.FitAddon === 'function',
                canCreateWebLinksAddon: typeof window.WebLinksAddon === 'function'
            });

            // è‡³å°‘Terminalå¿…é¡»åŠ è½½ï¼Œæ’ä»¶æ˜¯å¯é€‰çš„
            return terminalLoaded;
        }

        // ç­‰å¾…Xterm.jsåŠ è½½å®Œæˆååˆå§‹åŒ–
        function waitForXtermAndInitialize() {
            if (checkXtermLoaded()) {
                console.log('âœ… Xterm.js åº“åŠ è½½å®Œæˆ');

                // åˆå§‹åŒ–å›ºå®šç»ˆç«¯
                initializeFixedTerminals();

                // è¿æ¥WebSocket
                connectWebSocket();

                // ç»‘å®šæŒ‰é’®äº‹ä»¶
                document.getElementById('header-copy-modules').addEventListener('click', copyAllModuleNames);
                document.getElementById('toggle-realtime-logs').addEventListener('click', toggleRealtimeLogs);

                console.log('âœ… åˆå§‹åŒ–å®Œæˆ');
            } else {
                console.log('â³ ç­‰å¾… Xterm.js åº“åŠ è½½...');
                setTimeout(waitForXtermAndInitialize, 300);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');

            // ç­‰å¾…Xterm.jsåº“åŠ è½½å®Œæˆ
            waitForXtermAndInitialize();
        });

        // çª—å£å¤§å°å˜åŒ–æ—¶è°ƒæ•´æ‰€æœ‰ç»ˆç«¯
        window.addEventListener('resize', function() {
            setTimeout(() => {
                terminalManager.terminals.forEach((terminal, moduleName) => {
                    terminalManager.resizeTerminal(moduleName);
                });
            }, 100);
        });
    </script>
</body>
</html>
