<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡½æ•°æ‰§è¡Œè·¯å¾„å¯è§†åŒ– - Trace Viewer</title>
    
    <!-- Xterm.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/@xterm/xterm@5.5.0/css/xterm.css" />
    
    <!-- Xterm.js JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-web-links@0.11.0/lib/addon-web-links.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-search@0.15.0/lib/addon-search.js" defer></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background-color: #1a1a1a;
            color: #00ff00;
            padding: 10px;
            font-size: 16px;
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            padding: 10px;
            border-bottom: 2px solid #333;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header h1 {
            color: #00ffff;
            font-size: 20px;
            margin: 0;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .nav-button {
            background-color: #0066ff;
            color: #ffffff;
            border: 2px solid #3388ff;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-family: 'Consolas', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .nav-button:hover {
            background-color: #3388ff;
            transform: scale(1.05);
        }

        .connection-status {
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
        }

        .connected { background-color: #006600; color: #00ff00; }
        .disconnected { background-color: #660000; color: #ff0000; }

        .main-content {
            display: flex;
            gap: 15px;
            height: calc(100vh - 120px);
        }

        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 400px;
            transition: all 0.3s ease;
            height: 100%;
        }

        .left-panel.hidden {
            flex: 0;
            min-width: 0;
            width: 0;
            overflow: hidden;
        }

        .right-panel {
            flex: 3; /* è®©å³ä¾§æ•´ä½“æ›´å®½ */
            display: flex;
            flex-direction: row; /* è®©åˆ—è¡¨å’Œè¯¦æƒ…å·¦å³æ’åˆ— */
            gap: 15px;
            transition: all 0.3s ease;
        }

        .right-panel.full-width {
            flex: 1;
        }

        .trace-list-panel {
            flex: 0.2; /* ç¼©å°ä¸ºåŸæ¥çš„äº”åˆ†ä¹‹ä¸€ */
            min-width: 200px; /* å‡å°æœ€å°å®½åº¦ */
            height: 100%;
        }

        .trace-detail-panel {
            flex: 2.8; /* ç›¸åº”å¢åŠ è¯¦æƒ…é¢æ¿çš„å®½åº¦ */
            height: 100%;
        }

        .trace-list-container {
            padding: 5px;
        }

        .trace-list-item {
            padding: 8px 10px;
            margin-bottom: 3px;
            background-color: #111;
            border-left: 3px solid #0066ff;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            border-radius: 3px;
        }

        .trace-list-item:hover {
            background-color: #222;
            transform: translateX(2px);
        }

        .trace-list-item.selected {
            background-color: #0066ff;
            color: white;
            border-left-color: #fff;
            box-shadow: 0 2px 8px rgba(0, 102, 255, 0.3);
        }

        .trace-list-item.has-error {
            border-left-color: #ff0000;
            background-color: rgba(255, 0, 0, 0.1);
        }

        .trace-list-item .trace-name {
            font-weight: bold;
            color: #00ffff;
            margin-bottom: 2px;
        }

        .trace-list-item .trace-id {
            color: #888;
            font-size: 10px;
            margin-bottom: 2px;
        }

        .trace-list-item .trace-duration {
            color: #ff6600;
            font-size: 11px;
        }

        .trace-list-item.selected .trace-name,
        .trace-list-item.selected .trace-id,
        .trace-list-item.selected .trace-duration {
            color: white;
        }

        .panel {
            border: 1px solid #333;
            border-radius: 5px;
            background-color: #0a0a0a;
            display: flex;
            flex-direction: column;
            min-height: 0;
            height: 100%;
        }

        .panel-header {
            padding: 8px 12px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #1a1a2e;
            flex-shrink: 0;
        }

        .panel-title {
            font-weight: bold;
            font-size: 16px;
            color: #00ffff;
        }

        .panel-status {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-running { background-color: #006600; color: #00ff00; }
        .status-waiting { background-color: #666600; color: #ffff00; }
        .status-error { background-color: #660000; color: #ff0000; }

        .panel-content {
            flex: 1;
            padding: 5px;
            background-color: #000000;
            overflow-y: auto;
            min-height: 100px;
        }

        .xterm {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;
            font-size: 13px !important;
        }

        .xterm .xterm-viewport {
            background-color: #000000 !important;
        }

        .xterm .xterm-screen {
            background-color: #000000 !important;
        }

        .panel-content .xterm,
        .panel-content .xterm-viewport,
        .panel-content .xterm-screen {
            height: 100% !important;
        }

        .search-panel {
            padding: 8px 12px;
            border-bottom: 1px solid #333;
            background-color: #1a1a1a;
            font-size: 12px;
            flex-shrink: 0;
        }

        .search-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 5px;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 4px 8px;
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 3px;
            color: #00ff00;
            font-family: 'Consolas', monospace;
            font-size: 12px;
        }

        .search-input:focus {
            outline: none;
            border-color: #00ff00;
            box-shadow: 0 0 3px rgba(0, 255, 0, 0.3);
        }

        .search-btn {
            padding: 4px 8px;
            background-color: #0066ff;
            color: white;
            border: 1px solid #3388ff;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .search-btn:hover:not(:disabled) {
            background-color: #3388ff;
            transform: scale(1.05);
        }

        .search-btn:disabled {
            background-color: #333;
            color: #666;
            cursor: not-allowed;
            border-color: #444;
        }

        .search-status {
            color: #888;
            font-size: 11px;
            font-style: italic;
            padding: 2px 4px;
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        .search-status.has-results {
            color: #00ff00;
            background-color: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
        }

        .search-status.no-results {
            color: #ff6600;
            background-color: rgba(255, 102, 0, 0.1);
            border: 1px solid rgba(255, 102, 0, 0.3);
        }

        .stats-panel {
            padding: 10px 15px;
            border-bottom: 1px solid #333;
            font-size: 13px;
            color: #cccccc;
            flex-shrink: 0;
        }

        .stat-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }

        .view-toggle {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .toggle-btn {
            padding: 4px 8px;
            background-color: #333;
            color: #ccc;
            border: 1px solid #555;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .toggle-btn.active {
            background-color: #0066ff;
            color: white;
            border-color: #3388ff;
        }

        .toggle-btn:hover {
            background-color: #555;
        }

        .toggle-btn.active:hover {
            background-color: #3388ff;
        }

        .placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        /* è°ƒç”¨æ ‘æ ·å¼ */
        .trace-tree-view {
            height: 100%;
            overflow-y: auto;
        }

        .tree-container {
            padding: 10px;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.4;
        }

        .span-node {
            margin: 2px 0;
            padding: 4px 8px;
            border-left: 2px solid #333;
            background-color: rgba(0, 255, 0, 0.05);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .span-node:hover {
            background-color: rgba(0, 255, 0, 0.1);
            border-left-color: #00ff00;
        }

        .span-node.expanded {
            background-color: rgba(0, 255, 255, 0.05);
            border-left-color: #00ffff;
        }

        .span-node.completed {
            border-left-color: #00ff00;
        }

        .span-node.running {
            border-left-color: #ffff00;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { border-left-color: #ffff00; }
            50% { border-left-color: #ff6600; }
            100% { border-left-color: #ffff00; }
        }

        .span-status {
            width: 20px;
            text-align: center;
            font-size: 12px;
        }

        .span-node.critical-path {
            border-left-color: #ff6600 !important;
            background-color: rgba(255, 102, 0, 0.1) !important;
            box-shadow: 0 0 5px rgba(255, 102, 0, 0.3);
        }

        .span-node.critical-path .span-name {
            color: #ff6600;
            font-weight: bold;
        }

        .span-log-entry.critical {
            background-color: rgba(255, 102, 0, 0.2);
            border-radius: 3px;
            padding: 2px 4px;
        }

        .span-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .span-toggle {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 12px;
            cursor: pointer;
        }

        .span-name {
            color: #00ffff;
            font-weight: bold;
        }

        .span-target {
            color: #ffff00;
            font-size: 11px;
            padding: 1px 4px;
            background-color: rgba(255, 255, 0, 0.1);
            border-radius: 2px;
        }

        .span-duration {
            color: #ff6600;
            font-size: 11px;
            margin-left: auto;
        }

        .span-children {
            /* è¿™ä¸ª margin-left æ˜¯æ—§çš„ï¼Œæ–°çš„å®ç°é‡Œæˆ‘ä»¬ç”¨çˆ¶èŠ‚ç‚¹çš„marginï¼Œè¿™é‡Œåªéœ€è¦è¿æ¥çº¿ */
            padding-left: 10px; /* æ§åˆ¶è¿æ¥çº¿å’Œå­èŠ‚ç‚¹çš„é—´è· */
            border-left: 1px dashed #444; /* å·¦ä¾§çš„å‚ç›´è¿æ¥çº¿ */
        }

        .span-node.selected {
            background-color: rgba(0, 255, 255, 0.15);
            border-left-color: #00ffff !important;
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
        }

        .span-logs {
            margin-top: 4px;
            margin-left: 20px;
            font-size: 11px;
            color: #ccc;
            max-height: 100px;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 4px;
            border-radius: 2px;
        }

        .span-log-entry {
            margin: 1px 0;
            padding: 1px 0;
        }

        .span-log-time {
            color: #666;
        }

        .span-log-message {
            color: #00ff00;
        }

        /* æ—¶é—´è½´æ ·å¼ */
        .timeline-view {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .timeline-header {
            padding: 10px;
            border-bottom: 1px solid #333;
            background-color: #1a1a1a;
            flex-shrink: 0;
        }

        .timeline-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
        }

        .timeline-controls label {
            color: #ccc;
        }

        .timeline-controls input {
            width: 60px;
            padding: 2px 4px;
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 3px;
            color: #00ff00;
            font-size: 11px;
        }

        .timeline-container {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        .timeline-ruler {
            height: 30px;
            background-color: #1a1a1a;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 11px;
            color: #888;
        }

        .timeline-content {
            padding: 10px;
            min-height: 200px;
        }

        .timeline-track {
            margin-bottom: 2px;
            height: 24px;
            position: relative;
            border-bottom: 1px solid #222;
        }

        .timeline-track-label {
            position: absolute;
            left: 0;
            top: 0;
            width: 200px;
            height: 24px;
            background-color: #1a1a1a;
            border-right: 1px solid #333;
            padding: 4px 8px;
            font-size: 11px;
            color: #ccc;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            z-index: 5;
        }

        .timeline-track-content {
            margin-left: 200px;
            height: 24px;
            position: relative;
        }

        .timeline-span-bar {
            position: absolute;
            height: 20px;
            top: 2px;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            padding: 0 4px;
            font-size: 10px;
            color: white;
            overflow: hidden;
            white-space: nowrap;
        }

        .timeline-span-bar:hover {
            transform: scaleY(1.2);
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .timeline-span-bar.completed {
            background-color: #006600;
            border: 1px solid #00aa00;
        }

        .timeline-span-bar.running {
            background-color: #666600;
            border: 1px solid #aaaa00;
            animation: timeline-pulse 2s infinite;
        }

        .timeline-span-bar.critical-path {
            background-color: #cc4400 !important;
            border: 1px solid #ff6600 !important;
            box-shadow: 0 0 4px rgba(255, 102, 0, 0.5);
        }

        @keyframes timeline-pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        .timeline-tick {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 1px;
            background-color: #333;
        }

        .timeline-tick-label {
            position: absolute;
            top: 5px;
            left: 2px;
            font-size: 10px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ” å‡½æ•°æ‰§è¡Œè·¯å¾„å¯è§†åŒ–</h1>
        <div class="header-controls">
            <button id="toggle-raw-logs-btn" class="nav-button">ğŸ“‹ éšè—åŸå§‹æ—¥å¿—</button>
            <div class="connection-status" id="connection-status">è¿æ¥ä¸­...</div>
        </div>
    </div>

    <div class="main-content">
        <!-- å·¦ä¾§é¢æ¿ï¼šå®æ—¶åŸå§‹æ—¥å¿— -->
        <div class="left-panel">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">å®æ—¶åŸå§‹æ—¥å¿—</div>
                    <div class="panel-status status-waiting" id="raw-logs-status">ç­‰å¾…è¿æ¥</div>
                </div>
                <div class="stats-panel">
                    <div class="stat-line">
                        <span>æ—¥å¿—æ€»æ•°:</span>
                        <span id="total-logs-count">0</span>
                    </div>
                    <div class="stat-line">
                        <span>æœ€åæ›´æ–°:</span>
                        <span id="last-update-time">--:--:--</span>
                    </div>
                    <div class="stat-line">
                        <span>è¿æ¥æ—¶é•¿:</span>
                        <span id="connection-duration">00:00:00</span>
                    </div>
                </div>
                <div class="search-panel">
                    <div class="search-controls">
                        <input type="text" id="raw-logs-search-input" placeholder="æœç´¢æ—¥å¿—å†…å®¹..." class="search-input">
                        <button id="raw-logs-search-btn" class="search-btn" title="å¼€å§‹æœç´¢">ğŸ”</button>
                        <button id="raw-logs-search-clear" class="search-btn" title="æ¸…é™¤æœç´¢">âœ–</button>
                        <button id="raw-logs-search-prev" class="search-btn" title="ä¸Šä¸€ä¸ªåŒ¹é…" disabled>â†‘</button>
                        <button id="raw-logs-search-next" class="search-btn" title="ä¸‹ä¸€ä¸ªåŒ¹é…" disabled>â†“</button>
                        <button id="raw-logs-save-btn" class="search-btn" title="ä¿å­˜æ‰€æœ‰æ—¥å¿—åˆ°æ–‡ä»¶">ğŸ’¾</button>
                        <button id="raw-logs-clear-btn" class="search-btn" title="æ¸…ç©ºæ‰€æœ‰æ—¥å¿—">ğŸ—‘ï¸</button>
                    </div>
                    <div class="search-status" id="raw-logs-search-status">è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢</div>
                </div>
                <div class="panel-content" id="raw-logs-terminal"></div>
            </div>
        </div>

        <!-- å³ä¾§é¢æ¿ï¼šç°åœ¨æ‹†åˆ†ä¸ºä¸¤ä¸ª -->
        <div class="right-panel">

            <!-- æ–°å¢: Traceåˆ—è¡¨é¢æ¿ -->
            <div class="panel trace-list-panel">
                <div class="panel-header">
                    <div class="panel-title">è¿½è¸ªåˆ—è¡¨ (Traces)</div>
                    <div class="panel-status" id="trace-list-status">ç­‰å¾…æ•°æ®</div>
                </div>
                <div class="stats-panel">
                    <div class="stat-line">
                        <span>æ´»è·ƒTrace:</span>
                        <span id="active-traces-count">0</span>
                    </div>
                    <div class="stat-line">
                        <span>æ€»Spanæ•°:</span>
                        <span id="total-spans-count">0</span>
                    </div>
                </div>
                <div class="panel-content trace-list-container" id="trace-list-container">
                    <div class="placeholder">ç­‰å¾…è¿½è¸ªæ•°æ®...</div>
                </div>
            </div>

            <!-- Traceè¯¦æƒ…é¢æ¿ -->
            <div class="panel trace-detail-panel">
                <div class="panel-header">
                    <div class="panel-title">è°ƒç”¨è·¯å¾„è¯¦æƒ…</div>
                    <div class="view-toggle">
                        <button class="toggle-btn active" id="tree-view-btn">ğŸŒ³ è°ƒç”¨æ ‘</button>
                        <button class="toggle-btn" id="timeline-view-btn">ğŸ“Š æ—¶é—´è½´</button>
                    </div>
                </div>
                <div class="stats-panel" id="trace-detail-stats">
                    <div class="stat-line">
                        <span>é€‰ä¸­Trace:</span>
                        <span id="selected-trace-id">æ— </span>
                    </div>
                    <div class="stat-line">
                        <span>æ€»è€—æ—¶:</span>
                        <span id="selected-trace-duration">--</span>
                    </div>
                </div>
                <div class="panel-content" id="trace-visualization-content">
                    <div class="trace-tree-view" id="trace-tree-view" style="display: block;">
                        <div class="tree-container" id="tree-container">
                            <div class="placeholder">ç‚¹å‡»å·¦ä¾§åˆ—è¡¨ä¸­çš„ä¸€ä¸ªTraceæ¥æŸ¥çœ‹è¯¦æƒ…</div>
                        </div>
                    </div>
                    <div class="timeline-view" id="timeline-view" style="display: none;">
                        <div class="timeline-header">
                            <div class="timeline-controls">
                                <label>æœ€å°è€—æ—¶è¿‡æ»¤: <input type="number" id="min-duration-filter" value="0" min="0" step="0.1"> ms</label>
                                <button id="apply-filter-btn" class="search-btn">åº”ç”¨è¿‡æ»¤</button>
                                <button id="reset-filter-btn" class="search-btn">é‡ç½®</button>
                            </div>
                        </div>
                        <div class="timeline-container" id="timeline-container">
                            <div class="timeline-ruler" id="timeline-ruler"></div>
                            <div class="timeline-content" id="timeline-content">
                                <div class="placeholder">
                                    <div>
                                        <h3>ğŸ“Š æ—¶é—´è½´è§†å›¾</h3>
                                        <p>ç­‰å¾…spanæ•°æ®...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        console.log('ğŸš€ Trace Viewer å¯åŠ¨');

        // Traceæ•°æ®å¤„ç†å™¨ - é‡æ–°è®¾è®¡çš„æ ¸å¿ƒæ•°æ®å¤„ç†å™¨
        class TraceProcessor {
            constructor() {
                // æ•°æ®å­˜å‚¨æ ¸å¿ƒï¼šä¸€ä¸ªMapï¼Œé”®æ˜¯trace_idï¼Œå€¼æ˜¯è¯¥Traceçš„æ‰€æœ‰ä¿¡æ¯
                this.traces = new Map();
            }

            // æ ¹æ®trace_idè·å–æˆ–åˆ›å»ºä¸€ä¸ªæ–°çš„Traceå¯¹è±¡
            getOrCreateTrace(traceId) {
                if (!this.traces.has(traceId)) {
                    this.traces.set(traceId, {
                        id: traceId,
                        spans: new Map(),      // å­˜å‚¨è¿™ä¸ªTraceä¸‹çš„æ‰€æœ‰Spanå¯¹è±¡ (id -> span)
                        rootSpans: [],       // å­˜å‚¨æ ¹Spanå¯¹è±¡ï¼ˆæ²¡æœ‰çˆ¶IDçš„ï¼‰
                        startTime: null,     // Traceçš„å¼€å§‹æ—¶é—´
                        duration: null,      // Traceçš„æ€»æ—¶é•¿
                        hasError: false
                    });
                }
                return this.traces.get(traceId);
            }

            // å¤„ç†ä¸€ä¸ªå·²ç»è½¬æ¢å¥½çš„ã€å¹²å‡€çš„spanäº‹ä»¶
            processSpanEvent(event) {
                const trace = this.getOrCreateTrace(event.trace_id);
                const spanId = event.span_id;

                if (event.type === 'span_start') {
                    const span = {
                        id: spanId,
                        parentId: event.parent_id,
                        name: event.name,
                        target: event.target,
                        startTime: new Date(event.timestamp),
                        children: [],
                        logs: [],
                        status: 'running',
                        duration: null,
                        selfTime: null,
                        isCritical: false
                    };

                    trace.spans.set(spanId, span);

                    if (span.parentId) {
                        const parentSpan = trace.spans.get(span.parentId);
                        if (parentSpan) {
                            parentSpan.children.push(span);
                        }
                    } else {
                        trace.rootSpans.push(span);
                        if (!trace.startTime) trace.startTime = span.startTime;
                    }

                } else if (event.type === 'span_end') {
                    const span = trace.spans.get(spanId);
                    if (span) {
                        span.duration = event.duration_ms;
                        span.status = 'completed';

                        // è®¡ç®—è‡ªèº«è€—æ—¶
                        this.calculateSelfTime(span, trace);

                        // å¦‚æœæ˜¯æ ¹Spanç»“æŸï¼Œå¯ä»¥æ›´æ–°Traceæ€»æ—¶é•¿å¹¶è®¡ç®—å…³é”®è·¯å¾„
                        if (!span.parentId) {
                            trace.duration = span.duration;
                            this.calculateCriticalPath(span, trace);
                        }
                    }
                } else if (event.type === 'log' && event.level === 'ERROR') {
                     const span = trace.spans.get(spanId);
                     if(span) span.logs.push(event);
                }
            }

            calculateSelfTime(span, trace) {
                let childrenDuration = 0;
                for (const child of span.children) {
                    childrenDuration += child.duration || 0;
                }
                span.selfTime = Math.max(0, (span.duration || 0) - childrenDuration);
            }

            calculateCriticalPath(rootSpan, trace) {
                // ç®€åŒ–çš„é€»è¾‘ï¼šç›´æ¥æ ‡è®°è€—æ—¶æœ€é•¿çš„å­èŠ‚ç‚¹é“¾
                let current = rootSpan;
                while(current) {
                    trace.spans.get(current.id).isCritical = true;
                    if(current.children.length === 0) break;
                    current = current.children.reduce((max, child) => (child.duration > (max?.duration || 0) ? child : max), null);
                }
            }

            // è·å–æ‰€æœ‰æ ¹Spanï¼Œç”¨äºæ¸²æŸ“
            getAllRootSpansForRender() {
                const trees = [];
                for (const trace of this.traces.values()) {
                    // ä¸ºæ¯ä¸ªæ ¹spanæ·»åŠ traceä¿¡æ¯
                    trace.rootSpans.forEach(rootSpan => {
                        rootSpan.traceId = trace.id;
                        trees.push(rootSpan);
                    });
                }
                trees.sort((a, b) => b.startTime - a.startTime); // æœ€æ–°åœ¨æœ€å‰
                return trees;
            }

            // è·å–æ‰€æœ‰Traceçš„æ‘˜è¦ä¿¡æ¯ï¼Œç”¨äºæ¸²æŸ“å·¦ä¾§åˆ—è¡¨
            getTraceSummaries() {
                const summaries = [];
                for (const trace of this.traces.values()) {
                    if (trace.rootSpans.length > 0) {
                        const rootSpan = trace.rootSpans[0];
                        summaries.push({
                            id: trace.id,
                            name: rootSpan.name,
                            duration: trace.duration,
                            startTime: trace.startTime,
                            hasError: trace.hasError
                        });
                    }
                }
                summaries.sort((a, b) => b.startTime - a.startTime);
                return summaries;
            }

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateTraceStats() {
                const activeTracesEl = document.getElementById('active-traces-count');
                const totalSpansEl = document.getElementById('total-spans-count');

                if (activeTracesEl) activeTracesEl.textContent = this.traces.size;

                let totalSpans = 0;
                for (const trace of this.traces.values()) {
                    totalSpans += trace.spans.size;
                }
                if (totalSpansEl) totalSpansEl.textContent = totalSpans;
            }
        }

        // å…¨å±€çŠ¶æ€ç®¡ç†
        class TraceViewerState {
            constructor() {
                this.allLogs = [];
                this.logCount = 0;
                this.lastLogTime = null;
                this.startTime = Date.now();
                this.isConnected = false;
                this.traceProcessor = new TraceProcessor();

                // æ–°å¢ï¼šå¼‚æ­¥äº‹ä»¶å¤„ç†é˜Ÿåˆ—
                this.eventQueue = [];
                this.isProcessing = false;

                // æ–°å¢ï¼šå½“å‰é€‰ä¸­çš„Trace ID
                this.activeTraceId = null;
            }

            // æ–°å¢æ–¹æ³•ï¼šå°†äº‹ä»¶æ”¾å…¥å¼‚æ­¥å¤„ç†é˜Ÿåˆ—
            queueEventForProcessing(eventData) {
                this.eventQueue.push(eventData);
                // å¦‚æœå¤„ç†å¾ªç¯æ²¡æœ‰åœ¨è¿è¡Œï¼Œå°±å¯åŠ¨å®ƒ
                if (!this.isProcessing) {
                    this.startProcessingLoop();
                }
            }

            // æ–°å¢æ–¹æ³•ï¼šå¯åŠ¨å¼‚æ­¥å¤„ç†å¾ªç¯
            startProcessingLoop() {
                this.isProcessing = true;
                const process = () => {
                    // æ¯æ¬¡å¤„ç†ä¸€å°æ‰¹äº‹ä»¶ï¼Œé¿å…é•¿æ—¶é—´å ç”¨ä¸»çº¿ç¨‹
                    const batchSize = 50; // å¯è°ƒæ•´
                    let processedCount = 0;

                    while (this.eventQueue.length > 0 && processedCount < batchSize) {
                        const event = this.eventQueue.shift();
                        this.handleEvent(event); // è°ƒç”¨åŸæ¥çš„å¤„ç†é€»è¾‘
                        processedCount++;
                    }

                    // å¦‚æœé˜Ÿåˆ—ä¸­è¿˜æœ‰äº‹ä»¶ï¼Œç»§ç»­è°ƒåº¦ä¸‹ä¸€æ¬¡å¤„ç†
                    if (this.eventQueue.length > 0) {
                        requestAnimationFrame(process);
                    } else {
                        this.isProcessing = false; // é˜Ÿåˆ—ç©ºäº†ï¼Œåœæ­¢å¾ªç¯
                    }
                };
                requestAnimationFrame(process);
            }

            // ä¿®æ­£åçš„ handleEvent å‡½æ•°
            handleEvent(data) {
                // æ£€æŸ¥æ–°çš„æ—¥å¿—æ ¼å¼ï¼Œåªå¤„ç†ç”¨äºå¯è§†åŒ–çš„ trace æ—¥å¿—
                if (data.log_type === 'trace') {
                    // ç›´æ¥å°†æ•´ä¸ªæ—¥å¿—å¯¹è±¡ä¼ é€’ç»™è½¬æ¢å™¨
                    // å› ä¸ºspanäº‹ä»¶ä¿¡æ¯ç°åœ¨ç›´æ¥åœ¨ 'fields' å­—æ®µä¸­
                    const spanEvent = this.convertLogEntryToSpanEvent(data);
                    if (spanEvent) {
                        this.processSpanEvent(spanEvent);
                    }
                }
                // log_type ä¸º 'module' æˆ–å…¶ä»–ç±»å‹çš„æ—¥å¿—å°†è¢«å¿½ç•¥ï¼Œä¸ä¼šè¿›å…¥è°ƒç”¨æ ‘çš„æ„å»ºè¿‡ç¨‹
            }

            // ä¿®æ­£åçš„ convertLogEntryToSpanEvent å‡½æ•°
            convertLogEntryToSpanEvent(logData) {
                const fields = logData.fields;

                // å¢åŠ ä¸€ä¸ªæ£€æŸ¥ï¼Œç¡®ä¿è¿™æ˜¯ä¸€ä¸ªæˆ‘ä»¬èƒ½å¤„ç†çš„spanäº‹ä»¶
                if (!fields || !fields.event_type) {
                    return null;
                }

                return {
                    type: fields.event_type, // "span_start", "span_end", "log"
                    timestamp: logData.timestamp,
                    trace_id: fields.trace_id,
                    span_id: fields.span_id,
                    parent_id: fields.parent_id || null,
                    name: fields.span_name || 'unknown_span_name', // nameç°åœ¨æ€»æ˜¯åœ¨fieldsé‡Œ
                    target: logData.target, // targetåœ¨é¡¶å±‚
                    duration_ms: fields.duration_ms || 0,
                    level: logData.level,     // levelåœ¨é¡¶å±‚
                    message: logData.message, // messageåœ¨é¡¶å±‚
                };
            }

            // è¿™ä¸ªæ–¹æ³•ç°åœ¨åªå¤„ç†spanäº‹ä»¶
            processSpanEvent(spanEvent) {
                this.traceProcessor.processSpanEvent(spanEvent);
                this.traceProcessor.updateTraceStats(); // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                this.updateTraceVisualization(); // è§¦å‘UIæ›´æ–°
            }



            updateTraceVisualization() {
                if (this.updateTimer) clearTimeout(this.updateTimer);

                this.updateTimer = setTimeout(() => {
                    // 1. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    this.traceProcessor.updateTraceStats(); // ç¡®ä¿è¿™ä¸ªæ–¹æ³•å­˜åœ¨å¹¶æ›´æ–°UI
                    // 2. æ›´æ–°å·¦ä¾§Traceåˆ—è¡¨
                    this.renderTraceList();
                    // 3. æ›´æ–°å³ä¾§é€‰ä¸­çš„Traceè¯¦æƒ…
                    this.renderActiveTraceDetail();
                    // 4. æ›´æ–°æ—¶é—´è½´è§†å›¾ï¼ˆå¦‚æœå®ç°äº†ï¼‰
                    this.renderTimeline();
                }, 250);
            }

            renderTraceList() {
                const listContainer = document.getElementById('trace-list-container');
                const summaries = this.traceProcessor.getTraceSummaries();

                if (summaries.length === 0) {
                    listContainer.innerHTML = `<div class="placeholder">ç­‰å¾…è¿½è¸ªæ•°æ®...</div>`;
                    return;
                }

                listContainer.innerHTML = summaries.map(trace => {
                    const duration = trace.duration !== null ? `${trace.duration.toFixed(2)}ms` : 'è¿è¡Œä¸­...';
                    const errorClass = trace.hasError ? 'has-error' : '';
                    const selectedClass = trace.id === this.activeTraceId ? 'selected' : '';
                    return `
                        <div class="trace-list-item ${errorClass} ${selectedClass}" data-trace-id="${trace.id}">
                            <div class="trace-name">${trace.name}</div>
                            <div class="trace-id">${trace.id}</div>
                            <div class="trace-duration">è€—æ—¶: ${duration}</div>
                        </div>
                    `;
                }).join('');

                this.attachListEventListeners();
            }

            renderActiveTraceDetail() {
                const treeContainer = document.getElementById('tree-container');
                if (!this.activeTraceId) {
                    treeContainer.innerHTML = `<div class="placeholder">ç‚¹å‡»å·¦ä¾§åˆ—è¡¨ä¸­çš„ä¸€ä¸ªTraceæ¥æŸ¥çœ‹è¯¦æƒ…</div>`;
                    this.updateTraceDetailStats(null);
                    return;
                }

                const trace = this.traceProcessor.traces.get(this.activeTraceId);

                if (trace && trace.rootSpans.length > 0) {
                    let html = '';
                    // ä¸€ä¸ªTraceå¯èƒ½æœ‰å¤šä¸ªæ ¹èŠ‚ç‚¹ï¼ˆå¹¶è¡Œä»»åŠ¡ï¼‰
                    trace.rootSpans.forEach(rootSpan => {
                        html += this.renderSpanNode(rootSpan, 0);
                    });
                    treeContainer.innerHTML = html;
                    this.attachTreeEventListeners();
                    this.updateTraceDetailStats(trace);
                } else {
                    treeContainer.innerHTML = `<div class="placeholder">åŠ è½½ä¸­æˆ–æœªæ‰¾åˆ°Trace...</div>`;
                    this.updateTraceDetailStats(null);
                }
            }

            // æœ€ç»ˆç‰ˆçš„é€’å½’æ¸²æŸ“å‡½æ•°
            renderSpanNode(span, depth) {
                const hasChildren = span.children.length > 0;

                // **æ ¸å¿ƒä¿®æ­£ 1: ä½¿ç”¨ depth æ¥è®¡ç®—ç¼©è¿›**
                const indentStyle = `margin-left: ${depth * 25}px;`;

                // æ„å»ºè¯¦ç»†çš„æ—¶é—´ä¿¡æ¯ï¼ˆè¿™éƒ¨åˆ†ä½ åšå¾—å¾ˆå¥½ï¼Œä¿æŒä¸å˜ï¼‰
                let timeInfo = '';
                if (span.duration !== null) {
                    timeInfo = `${span.duration.toFixed(2)}ms`;
                    if (span.selfTime !== null && span.selfTime < span.duration) {
                        timeInfo += ` (è‡ªèº«: ${span.selfTime.toFixed(2)}ms)`;
                    }
                } else {
                    timeInfo = 'è¿è¡Œä¸­...';
                }

                // è®¾ç½®CSS class
                let statusClass = span.status === 'completed' ? 'completed' : 'running';
                if (span.isCritical) {
                    statusClass += ' critical-path';
                }
                const statusIcon = span.isCritical ? 'ğŸ”¥' : (span.status === 'completed' ? 'âœ…' : 'ğŸ”„');
                const toggleIcon = hasChildren ? 'â–¶' : 'â€¢';

                // 1. åˆ›å»ºå½“å‰èŠ‚ç‚¹çš„HTMLéª¨æ¶
                let html = `
                    <div class="span-node ${statusClass}" style="${indentStyle}" data-span-id="${span.id}">
                        <div class="span-header">
                            <span class="span-toggle">${toggleIcon}</span>
                            <span class="span-status">${statusIcon}</span>
                            <span class="span-name">${span.name}</span>
                            <span class="span-target">${span.target}</span>
                            <span class="span-duration">${timeInfo}</span>
                        </div>
                `;

                // 2. å¦‚æœæœ‰å­èŠ‚ç‚¹ï¼Œåˆ›å»ºä¸€ä¸ªå­å®¹å™¨ï¼Œå¹¶åœ¨è¿™é‡Œè¿›è¡Œé€’å½’
                if (hasChildren) {
                    html += `<div class="span-children" style="display: none;">`;

                    // **æ ¸å¿ƒä¿®æ­£ 2: é€’å½’è°ƒç”¨æ—¶ï¼Œæ·±åº¦+1**
                    const sortedChildren = [...span.children].sort((a,b) => (b.duration || 0) - (a.duration || 0));
                    html += sortedChildren.map(child => this.renderSpanNode(child, depth + 1)).join(''); // æ·±åº¦åŠ 1

                    html += `</div>`;
                }

                // 3. (å¯é€‰) æ·»åŠ æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯çš„æ—¥å¿—div
                if (span.startTime) {
                    html += `<div class="span-logs" style="display: none;">`;

                    // åŸºæœ¬æ—¶é—´ä¿¡æ¯
                    html += `<div class="span-log-entry">`;
                    html += `<span class="span-log-time">å¼€å§‹: ${span.startTime.toLocaleTimeString()}</span>`;
                    html += `</div>`;

                    // æ€§èƒ½ä¿¡æ¯
                    if (span.duration !== null) {
                        html += `<div class="span-log-entry">`;
                        html += `<span class="span-log-message">æ€»è€—æ—¶: ${span.duration.toFixed(2)}ms</span>`;
                        html += `</div>`;

                        if (span.selfTime !== null) {
                            html += `<div class="span-log-entry">`;
                            html += `<span class="span-log-message">è‡ªèº«è€—æ—¶: ${span.selfTime.toFixed(2)}ms</span>`;
                            html += `</div>`;

                            const waitTime = span.duration - span.selfTime;
                            if (waitTime > 0.1) {
                                html += `<div class="span-log-entry">`;
                                html += `<span class="span-log-message">ç­‰å¾…æ—¶é—´: ${waitTime.toFixed(2)}ms</span>`;
                                html += `</div>`;
                            }
                        }

                        if (span.isCritical) {
                            html += `<div class="span-log-entry critical">`;
                            html += `<span class="span-log-message">ğŸ”¥ å…³é”®è·¯å¾„</span>`;
                            html += `</div>`;
                        }
                    }

                    html += `</div>`;
                }

                html += `</div>`;
                return html;
            }

            // æ–°å¢ï¼šç»‘å®šTraceåˆ—è¡¨çš„ç‚¹å‡»äº‹ä»¶
            attachListEventListeners() {
                const listContainer = document.getElementById('trace-list-container');
                if (!listContainer) return;

                listContainer.addEventListener('click', (e) => {
                    const item = e.target.closest('.trace-list-item');
                    if (item) {
                        const newTraceId = item.dataset.traceId;
                        // å¦‚æœç‚¹å‡»çš„å·²ç»æ˜¯å½“å‰é€‰ä¸­çš„ï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
                        if (newTraceId === this.activeTraceId) return;

                        // æ›´æ–° activeTraceId
                        this.activeTraceId = newTraceId;

                        // ä¼˜åŒ–ï¼šä¸å†é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨ï¼Œè€Œæ˜¯æ‰‹åŠ¨æ›´æ–°class
                        // 1. ç§»é™¤æ—§çš„é€‰ä¸­é¡¹çš„ 'selected' class
                        const currentSelected = listContainer.querySelector('.trace-list-item.selected');
                        if (currentSelected) {
                            currentSelected.classList.remove('selected');
                        }
                        // 2. ç»™æ–°ç‚¹å‡»çš„é¡¹æ·»åŠ  'selected' class
                        item.classList.add('selected');

                        // æ¸²æŸ“è¯¦æƒ…ï¼ˆè¿™æ˜¯ä¸»è¦ä»»åŠ¡ï¼‰
                        this.renderActiveTraceDetail();
                    }
                });
            }

            // æ›´æ–°è¯¦æƒ…é¢æ¿çš„ç»Ÿè®¡æ•°æ®
            updateTraceDetailStats(trace) {
                const selectedTraceIdEl = document.getElementById('selected-trace-id');
                const selectedTraceDurationEl = document.getElementById('selected-trace-duration');

                if (selectedTraceIdEl) {
                    selectedTraceIdEl.textContent = trace ? trace.id : 'æ— ';
                }
                if (selectedTraceDurationEl) {
                    selectedTraceDurationEl.textContent = (trace && trace.duration !== null) ? `${trace.duration.toFixed(2)}ms` : '--';
                }
            }

            attachTreeEventListeners() {
                const treeContainer = document.getElementById('tree-container');
                if (!treeContainer) return;

                // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œæ€§èƒ½æ›´å¥½ï¼Œä¸”èƒ½å¤„ç†åŠ¨æ€æ·»åŠ çš„å…ƒç´ 
                treeContainer.addEventListener('click', (e) => {
                    const target = e.target;

                    // å¤„ç†å±•å¼€/æŠ˜å 
                    if (target.classList.contains('span-toggle')) {
                        e.stopPropagation();
                        const header = target.closest('.span-header');
                        const childrenContainer = header.nextElementSibling;

                        if (childrenContainer && childrenContainer.classList.contains('span-children')) {
                            const isExpanded = childrenContainer.style.display !== 'none';
                            childrenContainer.style.display = isExpanded ? 'none' : 'block';
                            target.textContent = isExpanded ? 'â–¶' : 'â–¼';
                            header.parentElement.classList.toggle('expanded', !isExpanded);
                        }
                    }
                    // å¤„ç†ç‚¹å‡»æ•´ä¸ªèŠ‚ç‚¹ï¼Œå¯ä»¥ç”¨æ¥æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                    else if (target.closest('.span-node')) {
                        const node = target.closest('.span-node');
                        const logs = node.querySelector('.span-logs');

                        // åˆ‡æ¢æ—¥å¿—æ˜¾ç¤º
                        if (logs) {
                            const isVisible = logs.style.display !== 'none';
                            logs.style.display = isVisible ? 'none' : 'block';
                        }

                        // å¯ä»¥æŠŠè¿™ä¸ªèŠ‚ç‚¹è®¾ä¸º"é€‰ä¸­"çŠ¶æ€ï¼Œå¹¶æ˜¾ç¤ºæ›´è¯¦ç»†çš„ä¿¡æ¯
                        console.log('Clicked span:', node.dataset.spanId);

                        // ç¤ºä¾‹ï¼šåˆ‡æ¢ä¸€ä¸ª .selected class
                        // å…ˆç§»é™¤å…¶ä»–èŠ‚ç‚¹çš„é€‰ä¸­çŠ¶æ€
                        treeContainer.querySelectorAll('.span-node.selected').forEach(n => n.classList.remove('selected'));
                        node.classList.add('selected');
                    }
                });
            }

            renderTimeline() {
                const timelineContent = document.getElementById('timeline-content');
                const timelineRuler = document.getElementById('timeline-ruler');
                if (!timelineContent || !timelineRuler) return;

                const rootSpans = this.traceProcessor.getAllRootSpansForRender();
                if (rootSpans.length === 0) {
                    timelineContent.innerHTML = `
                        <div class="placeholder">
                            <div>
                                <h3>ğŸ“Š æ—¶é—´è½´è§†å›¾</h3>
                                <p>ç­‰å¾…spanæ•°æ®...</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                // è·å–æœ€å°è€—æ—¶è¿‡æ»¤å™¨çš„å€¼
                const minDurationFilter = parseFloat(document.getElementById('min-duration-filter')?.value || 0);

                // æ”¶é›†æ‰€æœ‰spanå¹¶æŒ‰å¼€å§‹æ—¶é—´æ’åº
                const allSpans = [];
                this.collectAllSpans(rootSpans, allSpans);

                // åº”ç”¨è¿‡æ»¤å™¨
                const filteredSpans = allSpans.filter(span =>
                    span.duration === null || span.duration >= minDurationFilter
                );

                if (filteredSpans.length === 0) {
                    timelineContent.innerHTML = `
                        <div class="placeholder">
                            <div>
                                <h3>ğŸ“Š æ—¶é—´è½´è§†å›¾</h3>
                                <p>æ²¡æœ‰ç¬¦åˆè¿‡æ»¤æ¡ä»¶çš„spanæ•°æ®</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                // è®¡ç®—æ—¶é—´èŒƒå›´
                const timeRange = this.calculateTimeRange(filteredSpans);
                if (timeRange.duration <= 0) return;

                // æ¸²æŸ“æ—¶é—´æ ‡å°º
                this.renderTimelineRuler(timelineRuler, timeRange);

                // æ¸²æŸ“æ—¶é—´è½´å†…å®¹
                this.renderTimelineContent(timelineContent, filteredSpans, timeRange);
            }

            collectAllSpans(spans, result) {
                for (const span of spans) {
                    result.push(span);
                    if (span.children && span.children.length > 0) {
                        this.collectAllSpans(span.children, result);
                    }
                }
            }

            calculateTimeRange(spans) {
                let minStart = Infinity;
                let maxEnd = -Infinity;

                // æ‰¾åˆ°æœ€æ—©çš„å¼€å§‹æ—¶é—´ä½œä¸ºåŸºå‡†
                let baseTime = null;
                for (const span of spans) {
                    if (span.startTime) {
                        if (!baseTime || span.startTime < baseTime) {
                            baseTime = span.startTime;
                        }
                    }
                }

                if (!baseTime) {
                    return { start: 0, end: 100, duration: 100 };
                }

                for (const span of spans) {
                    if (span.startTime) {
                        const relativeStart = span.startTime - baseTime;
                        minStart = Math.min(minStart, relativeStart);
                        if (span.duration !== null) {
                            maxEnd = Math.max(maxEnd, relativeStart + span.duration);
                        }
                    }
                }

                return {
                    start: minStart === Infinity ? 0 : minStart,
                    end: maxEnd === -Infinity ? 100 : maxEnd,
                    duration: maxEnd === -Infinity || minStart === Infinity ? 100 : maxEnd - minStart
                };
            }

            renderTimelineRuler(ruler, timeRange) {
                const tickCount = 10;
                const tickInterval = timeRange.duration / tickCount;

                let rulerHTML = '';
                for (let i = 0; i <= tickCount; i++) {
                    const time = timeRange.start + (i * tickInterval);
                    const position = (i / tickCount) * 100;
                    rulerHTML += `
                        <div class="timeline-tick" style="left: ${position}%;">
                            <div class="timeline-tick-label">${time.toFixed(1)}ms</div>
                        </div>
                    `;
                }

                ruler.innerHTML = rulerHTML;
            }

            renderTimelineContent(container, spans, timeRange) {
                // æŒ‰å±‚çº§åˆ†ç»„span
                const tracks = this.groupSpansIntoTracks(spans);

                let html = '';
                tracks.forEach((trackSpans, trackIndex) => {
                    html += `<div class="timeline-track">`;
                    html += `<div class="timeline-track-label">Track ${trackIndex + 1}</div>`;
                    html += `<div class="timeline-track-content">`;

                    trackSpans.forEach(span => {
                        html += this.renderTimelineSpanBar(span, timeRange);
                    });

                    html += `</div></div>`;
                });

                container.innerHTML = html;

                // æ·»åŠ hoveräº‹ä»¶
                this.attachTimelineEventListeners();
            }

            groupSpansIntoTracks(spans) {
                // ç®€å•çš„åˆ†ç»„ç®—æ³•ï¼šæŒ‰æ·±åº¦åˆ†ç»„
                const tracks = [];
                const spanDepths = new Map();

                // è®¡ç®—æ¯ä¸ªspançš„æ·±åº¦
                for (const span of spans) {
                    const depth = this.calculateSpanDepth(span, spans);
                    spanDepths.set(span.id, depth);
                }

                // æŒ‰æ·±åº¦åˆ†ç»„
                for (const span of spans) {
                    const depth = spanDepths.get(span.id);
                    if (!tracks[depth]) {
                        tracks[depth] = [];
                    }
                    tracks[depth].push(span);
                }

                return tracks.filter(track => track && track.length > 0);
            }

            calculateSpanDepth(span, allSpans) {
                // é€šè¿‡parentIdæ¥è®¡ç®—æ·±åº¦
                let depth = 0;
                let currentSpan = span;

                while (currentSpan && currentSpan.parentId) {
                    const parent = allSpans.find(s => s.id === currentSpan.parentId);
                    if (parent) {
                        depth++;
                        currentSpan = parent;
                    } else {
                        break;
                    }
                }

                return depth;
            }

            renderTimelineSpanBar(span, timeRange) {
                if (!span.startTime || span.duration === null) {
                    return '';
                }

                // è®¡ç®—ç›¸å¯¹äºæ—¶é—´èŒƒå›´å¼€å§‹çš„åç§»
                const baseTime = new Date(timeRange.start);
                const relativeStart = span.startTime - baseTime;

                const leftPercent = (relativeStart / timeRange.duration) * 100;
                const widthPercent = (span.duration / timeRange.duration) * 100;

                const statusClass = span.status === 'completed' ? 'completed' : 'running';
                const criticalClass = span.isCritical ? 'critical-path' : '';

                const title = `${span.name} (${span.target})\\nè€—æ—¶: ${span.duration.toFixed(2)}ms\\nå¼€å§‹: +${relativeStart.toFixed(1)}ms`;

                return `
                    <div class="timeline-span-bar ${statusClass} ${criticalClass}"
                         style="left: ${leftPercent}%; width: ${Math.max(widthPercent, 0.5)}%;"
                         title="${title}"
                         data-span-id="${span.id}">
                        ${span.name}
                    </div>
                `;
            }

            attachTimelineEventListeners() {
                const spanBars = document.querySelectorAll('.timeline-span-bar');
                spanBars.forEach(bar => {
                    bar.addEventListener('click', (e) => {
                        const spanId = e.target.getAttribute('data-span-id');
                        console.log('ç‚¹å‡»äº†span:', spanId);
                        // TODO: å¯ä»¥æ·»åŠ æ›´å¤šäº¤äº’åŠŸèƒ½ï¼Œå¦‚é«˜äº®å¯¹åº”çš„æ ‘èŠ‚ç‚¹
                    });
                });
            }
            
            updateStats() {
                const countEl = document.getElementById('total-logs-count');
                const timeEl = document.getElementById('last-update-time');
                const durationEl = document.getElementById('connection-duration');
                
                if (countEl) countEl.textContent = this.logCount;
                if (timeEl && this.lastLogTime) {
                    timeEl.textContent = this.lastLogTime.toLocaleTimeString();
                }
                if (durationEl) {
                    const duration = Math.floor((Date.now() - this.startTime) / 1000);
                    const hours = Math.floor(duration / 3600).toString().padStart(2, '0');
                    const minutes = Math.floor((duration % 3600) / 60).toString().padStart(2, '0');
                    const seconds = (duration % 60).toString().padStart(2, '0');
                    durationEl.textContent = `${hours}:${minutes}:${seconds}`;
                }
            }
            
            setConnectionStatus(connected) {
                this.isConnected = connected;
                const statusEl = document.getElementById('connection-status');
                const rawLogsStatusEl = document.getElementById('raw-logs-status');
                
                if (statusEl) {
                    statusEl.textContent = connected ? 'å·²è¿æ¥' : 'è¿æ¥æ–­å¼€';
                    statusEl.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
                }
                
                if (rawLogsStatusEl) {
                    rawLogsStatusEl.textContent = connected ? 'è¿è¡Œä¸­' : 'è¿æ¥æ–­å¼€';
                    rawLogsStatusEl.className = `panel-status ${connected ? 'status-running' : 'status-error'}`;
                }
            }
        }
        
        // å…¨å±€çŠ¶æ€å®ä¾‹
        const traceViewerState = new TraceViewerState();
        
        // ç»ˆç«¯ç®¡ç†å™¨
        class TerminalManager {
            constructor() {
                this.terminals = new Map();
                this.fitAddons = new Map();
                this.searchAddons = new Map();
                this.logBuffers = new Map();
                this.maxLines = 10000000;
                
                this.terminalTheme = {
                    background: '#000000',
                    foreground: '#00ff00',
                    cursor: '#00ff00',
                    cursorAccent: '#000000',
                    selectionBackground: 'rgba(255, 255, 255, 0.3)',
                    black: '#000000',
                    red: '#ff0000',
                    green: '#00ff00',
                    yellow: '#ffff00',
                    blue: '#0066ff',
                    magenta: '#ff00ff',
                    cyan: '#00ffff',
                    white: '#ffffff'
                };
            }
            
            createTerminal(containerId, terminalName) {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error(`æ‰¾ä¸åˆ°å®¹å™¨: ${containerId}`);
                    return null;
                }
                
                const terminal = new Terminal({
                    theme: this.terminalTheme,
                    fontFamily: 'Consolas, Monaco, "Courier New", monospace',
                    fontSize: 13,
                    lineHeight: 1.2,
                    cursorBlink: false,
                    scrollback: this.maxLines,
                    convertEol: true,
                    disableStdin: true,
                    allowTransparency: true
                });
                
                const fitAddon = new FitAddon.FitAddon();
                const webLinksAddon = new WebLinksAddon.WebLinksAddon();
                
                let searchAddon = null;
                try {
                    if (window.SearchAddon && typeof window.SearchAddon.SearchAddon === 'function') {
                        searchAddon = new window.SearchAddon.SearchAddon();
                    }
                } catch (error) {
                    console.error('åˆ›å»ºæœç´¢æ’ä»¶å¤±è´¥:', error);
                    searchAddon = {
                        onDidChangeResults: () => {},
                        findNext: () => {},
                        findPrevious: () => {},
                        clearDecorations: () => {}
                    };
                }
                
                terminal.loadAddon(fitAddon);
                terminal.loadAddon(webLinksAddon);
                if (searchAddon) terminal.loadAddon(searchAddon);
                
                terminal.open(container);
                setTimeout(() => fitAddon.fit(), 0);
                
                this.terminals.set(terminalName, terminal);
                this.fitAddons.set(terminalName, fitAddon);
                this.searchAddons.set(terminalName, searchAddon);
                this.logBuffers.set(terminalName, []);
                
                return terminal;
            }
            
            // æ–°å¢æ–¹æ³•ï¼šç›´æ¥æ˜¾ç¤ºåŸå§‹JSONå­—ç¬¦ä¸²ï¼ˆæé€Ÿé€šé“ï¼‰
            appendRawJsonToLogs(jsonString) {
                const terminal = this.terminals.get('raw-logs');
                if (!terminal) return;

                const buffer = this.logBuffers.get('raw-logs');
                if (!buffer) return;

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆç§»åˆ°è¿™é‡Œï¼Œé¿å…åœ¨ä¸»å¤„ç†æµç¨‹ä¸­è®¡ç®—ï¼‰
                traceViewerState.logCount++;
                traceViewerState.lastLogTime = new Date();
                traceViewerState.updateStats();

                // ç›´æ¥æ˜¾ç¤ºåŸå§‹JSONï¼Œä¸åšä»»ä½•æ ¼å¼åŒ–
                buffer.push(jsonString);
                terminal.write(jsonString + '\r\n');

                // ä¿æŒæœ€å¤§è¡Œæ•°é™åˆ¶
                if (buffer.length > this.maxLines) {
                    buffer.shift();
                }
            }

            // æ–°å¢æ–¹æ³•ï¼šä¿å­˜æ‰€æœ‰æ—¥å¿—åˆ°æ–‡ä»¶
            saveLogsToFile(terminalName = 'raw-logs') {
                const buffer = this.logBuffers.get(terminalName);
                if (!buffer || buffer.length === 0) {
                    alert('æ²¡æœ‰æ—¥å¿—æ•°æ®å¯ä»¥ä¿å­˜');
                    return;
                }

                try {
                    // ç”Ÿæˆæ–‡ä»¶åï¼ˆåŒ…å«æ—¶é—´æˆ³ï¼‰
                    const now = new Date();
                    const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, -5);
                    const filename = `trace-logs-${timestamp}.json`;

                    // å°†æ‰€æœ‰æ—¥å¿—åˆå¹¶ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²
                    const logContent = buffer.join('\n');

                    // åˆ›å»ºBlobå¹¶ä¸‹è½½
                    const blob = new Blob([logContent], { type: 'application/json;charset=utf-8' });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    console.log(`âœ… æ—¥å¿—å·²ä¿å­˜åˆ°æ–‡ä»¶: ${filename} (${buffer.length} æ¡è®°å½•)`);

                    // æ˜¾ç¤ºä¿å­˜æˆåŠŸçš„æç¤º
                    const statusEl = document.getElementById('raw-logs-search-status');
                    if (statusEl) {
                        const originalText = statusEl.textContent;
                        const originalClass = statusEl.className;
                        statusEl.textContent = `ğŸ’¾ å·²ä¿å­˜ ${buffer.length} æ¡æ—¥å¿—åˆ° ${filename}`;
                        statusEl.className = 'search-status has-results';

                        setTimeout(() => {
                            statusEl.textContent = originalText;
                            statusEl.className = originalClass;
                        }, 3000);
                    }
                } catch (error) {
                    console.error('ä¿å­˜æ—¥å¿—æ–‡ä»¶å¤±è´¥:', error);
                    alert('ä¿å­˜æ—¥å¿—æ–‡ä»¶å¤±è´¥: ' + error.message);
                }
            }

            // æ–°å¢æ–¹æ³•ï¼šæ¸…ç©ºæ‰€æœ‰æ—¥å¿—
            clearLogs(terminalName = 'raw-logs') {
                const terminal = this.terminals.get(terminalName);
                const buffer = this.logBuffers.get(terminalName);

                if (!terminal || !buffer) return;

                // ç¡®è®¤æ¸…ç©ºæ“ä½œ
                if (!confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿå½“å‰æœ‰ ${buffer.length} æ¡è®°å½•ã€‚`)) {
                    return;
                }

                try {
                    // æ¸…ç©ºç¼“å†²åŒº
                    buffer.length = 0;

                    // æ¸…ç©ºç»ˆç«¯æ˜¾ç¤º
                    terminal.clear();

                    // é‡ç½®ç»Ÿè®¡ä¿¡æ¯
                    traceViewerState.logCount = 0;
                    traceViewerState.updateStats();

                    console.log('âœ… æ—¥å¿—å·²æ¸…ç©º');

                    // æ˜¾ç¤ºæ¸…ç©ºæˆåŠŸçš„æç¤º
                    const statusEl = document.getElementById('raw-logs-search-status');
                    if (statusEl) {
                        const originalText = statusEl.textContent;
                        const originalClass = statusEl.className;
                        statusEl.textContent = 'ğŸ—‘ï¸ æ—¥å¿—å·²æ¸…ç©º';
                        statusEl.className = 'search-status';

                        setTimeout(() => {
                            statusEl.textContent = originalText;
                            statusEl.className = originalClass;
                        }, 2000);
                    }
                } catch (error) {
                    console.error('æ¸…ç©ºæ—¥å¿—å¤±è´¥:', error);
                    alert('æ¸…ç©ºæ—¥å¿—å¤±è´¥: ' + error.message);
                }
            }


            

        }
        
        // å…¨å±€ç»ˆç«¯ç®¡ç†å™¨å®ä¾‹
        let terminalManager = null;
        
        // WebSocketè¿æ¥ç®¡ç†
        class WebSocketManager {
            constructor() {
                this.ws = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 3000;
            }
            
            connect() {
                try {
                    // åŠ¨æ€è·å–å½“å‰é¡µé¢çš„ç«¯å£
                    const wsUrl = `ws://${window.location.host}/ws`;
                    this.ws = new WebSocket(wsUrl);
                    
                    this.ws.onopen = () => {
                        console.log('âœ… WebSocketè¿æ¥å·²å»ºç«‹');
                        this.reconnectAttempts = 0;
                        traceViewerState.setConnectionStatus(true);

                        // âœ¨ å‘é€è®¢é˜…æ¶ˆæ¯ - è¿™ä¸ªé¡µé¢åªå…³å¿ƒTraceæ—¥å¿—
                        const subscriptionMessage = {
                            subscribe: 'trace'
                        };
                        this.ws.send(JSON.stringify(subscriptionMessage));
                        console.log('ğŸ“¤ å·²å‘é€è®¢é˜…è¯·æ±‚: trace');
                    };
                    
                    this.ws.onmessage = (event) => {
                        // ç®¡é“ Aï¼šåŸå§‹æ—¥å¿—å¿«é€Ÿé€šé“
                        // ç«‹å³å°†åŸå§‹å­—ç¬¦ä¸²å‘é€ç»™TerminalManagerï¼Œä¸åšä»»ä½•è§£æå’Œç­‰å¾…
                        if (terminalManager) {
                            terminalManager.appendRawJsonToLogs(event.data);
                        }

                        // ç®¡é“ Bï¼šè·¯å¾„å¯è§†åŒ–å¼‚æ­¥å¤„ç†é€šé“
                        try {
                            // 1. è§£æå®Œæ•´çš„JSONå­—ç¬¦ä¸²
                            const parsedData = JSON.parse(event.data);

                            // 2. æ£€æŸ¥æ˜¯å¦å­˜åœ¨ "data" å­—æ®µï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™ä½¿ç”¨å…¶å†…éƒ¨çš„å¯¹è±¡
                            //    è¿™ä½¿å¾—ä»£ç èƒ½å¤Ÿå…¼å®¹ä¸¤ç§æ ¼å¼ï¼ˆæœ‰åŒ…è£…å’Œæ— åŒ…è£…ï¼‰
                            const eventObject = parsedData.data || parsedData;

                            // 3. å°†è§£åŒ…åçš„ã€æ­£ç¡®çš„äº‹ä»¶å¯¹è±¡æ”¾å…¥å¤„ç†é˜Ÿåˆ—
                            traceViewerState.queueEventForProcessing(eventObject);
                        } catch (e) {
                            console.error('è§£ææ¶ˆæ¯å¤±è´¥:', e, 'åŸå§‹æ•°æ®:', event.data);
                            // å³ä½¿è§£æå¤±è´¥ï¼ŒåŸå§‹æ—¥å¿—ä¹Ÿå·²ç»æ˜¾ç¤ºäº†ï¼Œä¸å½±å“ç”¨æˆ·è§‚å¯Ÿ
                        }
                    };
                    
                    this.ws.onclose = () => {
                        console.log('âŒ WebSocketè¿æ¥å·²æ–­å¼€');
                        traceViewerState.setConnectionStatus(false);
                        this.scheduleReconnect();
                    };
                    
                    this.ws.onerror = (error) => {
                        console.error('WebSocketé”™è¯¯:', error);
                        traceViewerState.setConnectionStatus(false);
                    };
                } catch (error) {
                    console.error('WebSocketè¿æ¥å¤±è´¥:', error);
                    this.scheduleReconnect();
                }
            }
            
            // handleMessage æ–¹æ³•ç°åœ¨ä¸å†éœ€è¦ï¼Œå› ä¸ºåˆ†å‘é€»è¾‘å·²ç»åœ¨ onmessage ä¸­å®Œæˆ
            // æ‰€æœ‰å¤„ç†é€»è¾‘éƒ½ç§»åˆ°äº† TraceViewerState.handleEvent ä¸­è¿›è¡Œå¼‚æ­¥å¤„ç†

            scheduleReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    console.log(`ğŸ”„ ${this.reconnectDelay/1000}ç§’åå°è¯•é‡è¿ (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
                    setTimeout(() => this.connect(), this.reconnectDelay);
                } else {
                    console.log('âŒ è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œåœæ­¢é‡è¿');
                }
            }
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        function initializeApp() {
            console.log('ğŸ”§ åˆå§‹åŒ–Trace Vieweråº”ç”¨');
            
            // åˆ›å»ºç»ˆç«¯ç®¡ç†å™¨
            terminalManager = new TerminalManager();
            
            // åˆ›å»ºåŸå§‹æ—¥å¿—ç»ˆç«¯
            terminalManager.createTerminal('raw-logs-terminal', 'raw-logs');
            
            // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
            initializeSearch();
            
            // åˆå§‹åŒ–è§†å›¾åˆ‡æ¢
            initializeViewToggle();

            // åˆå§‹åŒ–è¿‡æ»¤å™¨
            initializeFilters();

            // åˆå§‹åŒ–åŸå§‹æ—¥å¿—æ˜¾ç¤º/éšè—åŠŸèƒ½
            initializeRawLogsToggle();

            // è¿æ¥WebSocket
            const wsManager = new WebSocketManager();
            wsManager.connect();
            
            // å¯åŠ¨è¿æ¥æ—¶é•¿è®¡æ—¶å™¨
            setInterval(() => {
                traceViewerState.updateStats();
            }, 1000);
            
            console.log('âœ… Trace Vieweråˆå§‹åŒ–å®Œæˆ');
        }
        
        // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
        function initializeSearch() {
            const searchInput = document.getElementById('raw-logs-search-input');
            const searchBtn = document.getElementById('raw-logs-search-btn');
            const clearBtn = document.getElementById('raw-logs-search-clear');
            const prevBtn = document.getElementById('raw-logs-search-prev');
            const nextBtn = document.getElementById('raw-logs-search-next');
            const saveBtn = document.getElementById('raw-logs-save-btn');
            const clearLogsBtn = document.getElementById('raw-logs-clear-btn');

            if (!searchInput || !terminalManager.searchAddons.get('raw-logs')) return;
            
            const searchAddon = terminalManager.searchAddons.get('raw-logs');
            let isSearchActive = false;
            let lastSearchTerm = '';
            
            searchAddon.onDidChangeResults((results) => {
                updateSearchStatus(results.resultCount, results.resultIndex);
                updateNavigationButtons(results.resultCount > 0);
            });
            
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                } else if (e.key === 'Escape') {
                    clearSearch();
                }
            });
            
            searchBtn?.addEventListener('click', performSearch);
            clearBtn?.addEventListener('click', clearSearch);
            prevBtn?.addEventListener('click', () => navigateMatch(-1));
            nextBtn?.addEventListener('click', () => navigateMatch(1));
            saveBtn?.addEventListener('click', () => terminalManager.saveLogsToFile('raw-logs'));
            clearLogsBtn?.addEventListener('click', () => terminalManager.clearLogs('raw-logs'));
            
            function performSearch() {
                const term = searchInput.value;
                if (!term) {
                    clearSearch();
                    return;
                }
                
                isSearchActive = true;
                lastSearchTerm = term;
                searchAddon.findNext(term, { caseSensitive: false, regex: false });
            }
            
            function navigateMatch(direction) {
                if (!isSearchActive) return;
                if (direction > 0) {
                    searchAddon.findNext(lastSearchTerm, { caseSensitive: false, regex: false });
                } else {
                    searchAddon.findPrevious(lastSearchTerm, { caseSensitive: false, regex: false });
                }
            }
            
            function clearSearch() {
                searchAddon.clearDecorations();
                isSearchActive = false;
                lastSearchTerm = '';
                searchInput.value = '';
                updateSearchStatus(0, -1);
                updateNavigationButtons(false);
            }
            
            function updateSearchStatus(count, index) {
                const statusEl = document.getElementById('raw-logs-search-status');
                if (!statusEl) return;
                
                if (!isSearchActive || count === 0) {
                    if (isSearchActive) {
                        statusEl.textContent = `æœªæ‰¾åˆ°åŒ¹é…é¡¹: "${lastSearchTerm}"`;
                        statusEl.className = 'search-status no-results';
                    } else {
                        statusEl.textContent = 'è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢';
                        statusEl.className = 'search-status';
                    }
                } else {
                    statusEl.textContent = `ğŸ” æ‰¾åˆ° ${count} ä¸ªåŒ¹é…é¡¹ | å½“å‰: ${index + 1}/${count}`;
                    statusEl.className = 'search-status has-results';
                }
            }
            
            function updateNavigationButtons(hasMatches) {
                if (prevBtn) prevBtn.disabled = !hasMatches;
                if (nextBtn) nextBtn.disabled = !hasMatches;
            }
        }
        
        // åˆå§‹åŒ–è§†å›¾åˆ‡æ¢
        function initializeViewToggle() {
            const treeViewBtn = document.getElementById('tree-view-btn');
            const timelineViewBtn = document.getElementById('timeline-view-btn');
            const treeView = document.getElementById('trace-tree-view');
            const timelineView = document.getElementById('timeline-view');

            treeViewBtn?.addEventListener('click', () => {
                treeViewBtn.classList.add('active');
                timelineViewBtn.classList.remove('active');

                if (treeView) treeView.style.display = 'block';
                if (timelineView) timelineView.style.display = 'none';

                console.log('åˆ‡æ¢åˆ°è°ƒç”¨æ ‘è§†å›¾');
            });

            timelineViewBtn?.addEventListener('click', () => {
                timelineViewBtn.classList.add('active');
                treeViewBtn.classList.remove('active');

                if (treeView) treeView.style.display = 'none';
                if (timelineView) timelineView.style.display = 'block';

                console.log('åˆ‡æ¢åˆ°æ—¶é—´è½´è§†å›¾');
            });
        }

        // åˆå§‹åŒ–è¿‡æ»¤å™¨
        function initializeFilters() {
            const applyFilterBtn = document.getElementById('apply-filter-btn');
            const resetFilterBtn = document.getElementById('reset-filter-btn');
            const minDurationInput = document.getElementById('min-duration-filter');

            applyFilterBtn?.addEventListener('click', () => {
                traceViewerState.renderTimeline();
            });

            resetFilterBtn?.addEventListener('click', () => {
                if (minDurationInput) {
                    minDurationInput.value = '0';
                }
                traceViewerState.renderTimeline();
            });

            // å›è½¦é”®åº”ç”¨è¿‡æ»¤
            minDurationInput?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    traceViewerState.renderTimeline();
                }
            });
        }

        // åˆå§‹åŒ–åŸå§‹æ—¥å¿—æ˜¾ç¤º/éšè—åŠŸèƒ½
        function initializeRawLogsToggle() {
            const toggleBtn = document.getElementById('toggle-raw-logs-btn');
            const leftPanel = document.querySelector('.left-panel');
            const rightPanel = document.querySelector('.right-panel');

            let isRawLogsVisible = true; // é»˜è®¤æ˜¾ç¤º

            toggleBtn?.addEventListener('click', () => {
                isRawLogsVisible = !isRawLogsVisible;

                if (isRawLogsVisible) {
                    // æ˜¾ç¤ºåŸå§‹æ—¥å¿—
                    leftPanel.classList.remove('hidden');
                    rightPanel.classList.remove('full-width');
                    toggleBtn.textContent = 'ğŸ“‹ éšè—åŸå§‹æ—¥å¿—';
                } else {
                    // éšè—åŸå§‹æ—¥å¿—
                    leftPanel.classList.add('hidden');
                    rightPanel.classList.add('full-width');
                    toggleBtn.textContent = 'ğŸ“‹ æ˜¾ç¤ºåŸå§‹æ—¥å¿—';
                }
            });
        }

        // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // ç­‰å¾…xterm.jsåº“åŠ è½½å®Œæˆ
            const checkLibraries = () => {
                if (typeof Terminal !== 'undefined' && 
                    typeof FitAddon !== 'undefined' && 
                    typeof WebLinksAddon !== 'undefined') {
                    initializeApp();
                } else {
                    setTimeout(checkLibraries, 100);
                }
            };
            checkLibraries();
        });
    </script>
</body>
</html>
