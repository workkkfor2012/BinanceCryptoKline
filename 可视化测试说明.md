# K线聚合服务可视化测试说明

## 快速启动

### 1. 启用可视化测试模式

编辑 `src\bin\klagg_sub_threads.rs` 文件开头的常量：

```rust
// ==================== 运行模式配置 ====================
// 修改这些常量来控制程序运行模式，无需设置环境变量

/// 可视化测试模式开关
/// - true: 启动Web服务器进行K线数据可视化验证，禁用数据库持久化
/// - false: 正常生产模式，启用数据库持久化，禁用Web服务器
const VISUAL_TEST_MODE: bool = true;  // <-- 改为 true

/// 测试模式开关（影响数据源）
/// - true: 使用少量测试品种（BTCUSDT等8个品种）
/// - false: 从币安API获取所有U本位永续合约品种
const TEST_MODE: bool = true;  // <-- 建议改为 true 以便快速测试
```

### 2. 启动服务器

```powershell
cargo run --release --bin klagg_sub_threads
```

或者使用提供的脚本：

```powershell
powershell -ExecutionPolicy Bypass -File start_visual_test.ps1
```

### 3. 访问Web界面

打开浏览器访问：http://localhost:9090

## 功能说明

### Web界面功能
- **实时K线图表**：使用 LightweightCharts 显示多周期K线数据
- **品种订阅**：输入交易品种符号（如 BTCUSDT）进行订阅
- **多周期显示**：同时显示所有配置的K线周期（1m, 3m, 5m, 15m, 30m, 1h, 2h, 4h, 6h, 8h, 12h, 1d）
- **实时更新**：WebSocket推送实时K线数据更新

### 测试数据
当 `TEST_MODE = true` 时，系统使用以下测试品种：
- 初始品种：BTCUSDT, ETHUSDT, SOLUSDT, XRPUSDT, DOGEUSDT, ADAUSDT, BNBUSDT, LTCUSDT
- 动态添加：每60秒模拟添加一个新品种（AVAXUSDT, MATICUSDT, LINKUSDT 等）

## 运行模式对比

| 模式 | VISUAL_TEST_MODE | TEST_MODE | 功能 |
|------|------------------|-----------|------|
| 可视化测试 | true | true | Web服务器 + 少量测试品种 |
| 可视化生产 | true | false | Web服务器 + 所有币安品种 |
| 生产模式 | false | false | 数据库持久化 + 所有币安品种 |
| 测试模式 | false | true | 数据库持久化 + 少量测试品种 |

## 注意事项

1. **可视化测试模式下数据库持久化被禁用**，数据仅在内存中处理
2. **建议先使用 TEST_MODE = true** 进行快速验证，再切换到生产数据
3. **Web服务器占用端口 9090**，确保端口未被占用
4. **按 Ctrl+C 可优雅关闭服务器**

## 故障排除

### 端口占用
如果 9090 端口被占用，可以修改 `src/klagg_sub_threads/web_server.rs` 中的端口：

```rust
let listener = match tokio::net::TcpListener::bind("0.0.0.0:9090").await {
```

### 连接问题
- 检查防火墙设置
- 确认服务器启动日志中显示 "可视化Web服务器已启动"
- 查看浏览器控制台是否有WebSocket连接错误

### 数据问题
- 确认网络连接正常，能够访问币安API
- 查看服务器日志中的WebSocket连接和数据接收情况
- 测试模式下会有模拟的品种动态添加日志
